<!doctype html>
<!-- Tech App ‚Äì LOOKS FIRST + LIGHT CLICKABLES (single-file prototype) -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tech App ‚Äì Prototype</title>
  <style>
    :root{
      --bg:#0f1216;
      --panel:#151a20;
      --panel2:#1b222b;
      --text:#e9eef5;
      --muted:#a9b4c2;
      --line:#2a3442;

      --green:#27ae60;
      --blue:#2c6ed5;
      --orange: rgba(242,153,74,.18);
      --red:#eb5757;
      --purple:#9b51e0;

      --radius:16px;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1100px 700px at 15% -10%, rgba(44,110,213,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(235,87,87,.12), transparent 50%),
        var(--bg);
      color:var(--text);
      /* Helps native selects render dark in supporting browsers */
      color-scheme: dark;
    }
    button, input, select, textarea{ font:inherit; color:inherit; -webkit-tap-highlight-color: transparent; }

    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Title block */
    .titleBlock{
      position:sticky;
      top:0;
      z-index:40;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(21,26,32,.98), rgba(15,18,22,.92));
      backdrop-filter: blur(8px);
    }
    .titleRow{
      display:grid;
      grid-template-columns: 44px 44px 1fr auto;
      align-items:center;
      gap:10px;
    }

    .iconBtn{
      width:44px;height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition:.15s;
      font-size:18px;
      font-weight:900;
      user-select:none;
    }
    .iconBtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .iconBtn:active{ transform: translateY(1px); }

    .hamburgerLines{ width:18px; height:12px; display:flex; flex-direction:column; justify-content:space-between; }
    .hamburgerLines span{ display:block; height:2px; border-radius:2px; background: rgba(233,238,245,.9); }

    .truckId{ text-align:center; min-width:0; }
    .titleLink{
      width:100%;
      text-align:center;
      border:none;
      background: transparent;
      color: var(--text);
      padding:0;
      margin:0;
      font-size:18px;
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      cursor:pointer;
    }
    .titleLink.right{ text-align:right; font-size:14px; }
    .titleLink:active{ transform: translateY(1px); }

    .techBox{
      text-align:right;
      line-height:1.1;
      max-width: 46vw;
    }
    .helpers{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Main */
    .main{
      padding:14px;
      display:flex;
      flex:1;
      justify-content:center;
    }
    .panel{
      width:100%;
      max-width:560px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-self:flex-start;
    }

    .screenTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .screenTitle h2{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      white-space:nowrap;
    }
    .sectionHint{
      font-size:12px;
      color:var(--muted);
      margin:2px 2px 6px;
    }
    .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Buttons */
    .btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:16px 14px;
      font-size:16px;
      font-weight:850;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 12px 22px rgba(0,0,0,.28);
      transition: transform .12s ease, filter .12s ease;
      text-align:center;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }
    .create{ background: linear-gradient(180deg, rgba(39,174,96,.98), rgba(39,174,96,.72)); }
    .openjobs{ background: linear-gradient(180deg, rgba(44,110,213,.98), rgba(44,110,213,.72)); }
    .stock{ background: linear-gradient(180deg, rgba(242,153,74,.98), rgba(242,153,74,.72)); }
    .refuel{ background: linear-gradient(180deg, rgba(235,87,87,.98), rgba(235,87,87,.72)); }

    /* Drawer */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index:50;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .drawer{
      position:fixed; top:0; left:0; height:100%; width:min(86vw, 340px);
      background: linear-gradient(180deg, rgba(21,26,32,.98), rgba(15,18,22,.95));
      border-right:1px solid rgba(255,255,255,.08);
      transform: translateX(-102%);
      transition: transform .18s ease;
      z-index:60;
      box-shadow: 18px 0 40px rgba(0,0,0,.5);
      display:flex;
      flex-direction:column;
    }
    .drawer.show{ transform: translateX(0); }

    .drawerHeader{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .drawerHeader .title{ font-weight:900; letter-spacing:.2px; }
    .drawerHeader .sub{ margin-top:6px; font-size:12px; color:var(--muted); }

    .menu{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .menuBtn{
      width:100%;
      text-align:left;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .menuBtn:active{ transform: translateY(1px); }
    .menuLeft{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .menuBtn .name{ font-weight:850; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .menuBtn .desc{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chev{ color: var(--muted); font-weight:900; }

    /* Header truck dropdown */
    .truckDrop{
      position:fixed;
      top:74px;
      left:50%;
      transform: translateX(-50%);
      width: min(92vw, 420px);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(21,26,32,.98), rgba(15,18,22,.96));
      border-radius:14px;
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      padding:10px;
      display:none;
      z-index:70;
    }
    .truckDrop.show{ display:block; }
    .truckOpt{
      width:100%;
      text-align:left;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      border-radius:12px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      cursor:pointer;
      font-weight:900;
    }
    .truckOpt:last-child{ margin-bottom:0; }
    .truckOpt:active{ transform: translateY(1px); }
    .truckOpt.on{
      border-color: rgba(39,174,96,.35);
      background: rgba(39,174,96,.12);
    }
    .mutedSmall{ font-size:12px; color: var(--muted); font-weight:800; }

    /* List cards */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; }
    .itemTitle{ font-weight:950; letter-spacing:.2px; }
    .itemSub{ margin-top:4px; font-size:12px; color:var(--muted); }
    .pills{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.blue{ border-color: rgba(44,110,213,.35); background: rgba(44,110,213,.12); color: rgba(233,238,245,.95); }
    .pill.green{ border-color: rgba(39,174,96,.35); background: rgba(39,174,96,.12); color: rgba(233,238,245,.95); }
    .pill.orange{ border-color: rgba(242,153,74,.35); background: rgba(242,153,74,.12); color: rgba(233,238,245,.95); }
    .pill.purple{ border-color: rgba(155,81,224,.35); background: rgba(155,81,224,.12); color: rgba(233,238,245,.95); }

    /* Segment toggle */
    .seg{
      display:flex;
      gap:8px;
      padding:8px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
    }
    .segBtn{
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: rgba(233,238,245,.95);
      border-radius:12px;
      padding:12px 10px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .segBtn:active{ transform: translateY(1px); }
    .segBtn.active{
      border-color: rgba(44,110,213,.38);
      background: rgba(44,110,213,.14);
    }

    /* Stock list */
    .tableWrap{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px;
      box-shadow: var(--shadow);
    }
    .stockHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .stockHead h3{
      margin:0;
      font-size:14px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      font-weight:850;
      cursor:pointer;
    }
    .miniBtn:active{ transform: translateY(1px); }

    .stockRow{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      margin-bottom:8px;
    }
    .stockRow.low{
      border-color: rgba(235,87,87,.28);
      background: rgba(235,87,87,.08);
    }
    .colPN{
      flex:0 0 108px;
      font-weight:950;
      font-size:12px;
      letter-spacing:.2px;
      color: rgba(233,238,245,.95);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .colDesc{
      flex:1 1 auto;
      min-width:0;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .qtyCol{ display:flex; gap:10px; align-items:center; flex:0 0 auto; }
    .qtyBlock{ display:flex; flex-direction:column; align-items:center; gap:5px; min-width:52px; }
    .qtyLabel{ font-size:10px; letter-spacing:.12em; text-transform:uppercase; color: var(--muted); }
    .qtyCircle{
      width:28px; height:28px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-weight:950;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      color: rgba(233,238,245,.95);
    }
    .qtyCircle.ok{ border-color: rgba(39,174,96,.35); background: rgba(39,174,96,.14); }
    .qtyCircle.warn{ border-color: rgba(242,153,74,.40); background: rgba(242,153,74,.14); }
    .qtyCircle.low{ border-color: rgba(235,87,87,.45); background: rgba(235,87,87,.16); }

    /* Forms */
    .formCard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .input, .select, .textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      color: var(--text);
    }
    .textarea{ min-height:88px; resize:vertical; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .checkline{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      margin-bottom:10px;
    }
    .checkline input{ margin-top:3px; }
    .checkline .ct{ font-weight:900; letter-spacing:.2px; }
    .checkline .cd{ font-size:12px; color: var(--muted); margin-top:2px; line-height:1.35; }

    .submitBtn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:16px 14px;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
      box-shadow: 0 12px 22px rgba(0,0,0,.28);
      background: linear-gradient(180deg, rgba(44,110,213,.98), rgba(44,110,213,.72));
      opacity:.45;
      cursor:not-allowed;
      transition: opacity .12s ease, transform .12s ease, filter .12s ease;
    }
    .submitBtn.enabled{ opacity:1; cursor:pointer; }
    .submitBtn.enabled:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }

    .hint{ font-size:12px; color: var(--muted); line-height:1.35; margin-top:8px; }

    /* Themed select / dropdown */
    select.select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      color-scheme: dark;
      background:
        rgba(2,6,23,.55);
      background-color: var(--panel2);
      color: var(--text);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    select.select:focus{
      border-color: rgba(44,110,213,.55);
      outline: none;
      box-shadow: 0 0 0 2px rgba(44,110,213,.25);
    }
    select.select option{
      background-color: var(--panel2);
      color: var(--text);
    }

    /* Helper chips */
    .chipList{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      color: rgba(233,238,245,.95);
      font-size:13px;
      font-weight:850;
      cursor:pointer;
      user-select:none;
    }
    .chip:active{ transform: translateY(1px); }
    .chip.on{
      border-color: rgba(39,174,96,.35);
      background: rgba(39,174,96,.14);
    }
  
    /* Map view */
    .mapHeaderRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }

    /* Smaller inline buttons (for map top bar) */
    .btn.inline{ display:inline-block; width:auto; padding:10px 12px; font-size:12.5px; border-radius:12px; box-shadow: 0 10px 18px rgba(0,0,0,.22); }
    .btn.tiny{ display:inline-block; width:auto; padding:6px 8px; font-size:12px; border-radius:12px; box-shadow: 0 10px 18px rgba(0,0,0,.20); }

    .btn.mapTop{ padding:10px 12px; font-weight:800; letter-spacing:.2px; }
    #jobMap{ height: 62vh; min-height: 420px; border-radius: 18px; overflow:hidden; border: 1px solid rgba(255,255,255,.08); }
    .mapCard{
      position: sticky;
      bottom: 0;
      margin-top: 12px;
      background: rgba(16,18,22,.92);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .mapCard.hidden{ display:none; }
    .mapCard .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .mapCard .title{ font-weight:900; }
    .mapCard .sub{ color: rgba(233,238,245,.78); font-size: 13px; margin-top:2px; line-height:1.35; }
    .mapCard .desc{ margin-top:8px; padding:10px; border-radius:14px; border:1px dashed rgba(255,255,255,.14); color: rgba(233,238,245,.92); font-size: 13px; line-height:1.35; }
    .mapPin{
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.85);
      box-shadow: 0 10px 18px rgba(0,0,0,.45);
    }
    .mapPin.blue{ background: var(--blue); }
    .mapPin.orange{ background: var(--orange); }
    .mapPin.green{ background: #27ae60; }
    .mapPin.purple{ background: #9b51e0; }
    .mapPin.red{ background: var(--red); }
    .mapPin.gray{ background: rgba(233,238,245,.50); }


    /* Map pin uses a PNG body + a colored status dot */
    .mapPinWrap{ position:relative; width:40px; height:40px; }
    .mapPinIcon{
      width:40px; height:40px;
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAABIklEQVR4nO2XYQ7CIAyFH8YD9hw7kOfoqbwG/lAiwth4LUvmtpeQ6ErplwcdCly6dOm/FQatIwsx9SzsBRRirloKeAAl/xJjfFSLhzAVj5QtYgWU9GEOrCryC6pMIQugAH1gVbEvqPbm3MgaQs53r8MCAmi7F0KY0mDylnQn5korMAeUni1ACTq2mnZwxQXNhiW/kmmLcy0cfC3iJrkBt9bxAbMzJUVIirhJTBcDeJ+plc5czWfqMYDaAkjAefEO57SnKHvVCQFQFzPcyea72CntnWj+NeNwUJkcaxcre9gtcMDB34PdLlrdA/7AwRGSGOOzNeDs+t07uCmg5+wljQCkXzmMdr/FIyUjmyPpVA4CHxcx7v/z+RwEBroHnNTBoXoBdcR/2PAdrWEAAAAASUVORK5CYII=");
      background-size: contain;
      background-repeat: no-repeat;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
    }
    .mapPinDot{
      position:absolute;
      left:50%;
      top:14px;
      transform: translate(-50%, -50%);
      width:12px; height:12px;
      border-radius:999px;
      border: 2px solid rgba(255,255,255,.88);
      box-shadow: 0 8px 14px rgba(0,0,0,.35);
    }
    .mapPinDot.blue{ background: var(--blue); }
    .mapPinDot.orange{ background: var(--orange); }
    .mapPinDot.green{ background: #27ae60; }
    .mapPinDot.purple{ background: #9b51e0; }
    .mapPinDot.red{ background: var(--red); }
    .mapPinDot.gray{ background: rgba(233,238,245,.50); }


    /* Leaflet popup bubble */
    .mapPopup .leaflet-popup-content-wrapper{
      background: rgba(19,25,35,.96);
      color: rgba(233,238,245,.96);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      box-shadow: 0 14px 28px rgba(0,0,0,.55);
    }
    .mapPopup .leaflet-popup-tip{
      background: rgba(19,25,35,.96);
      border: 1px solid rgba(255,255,255,.10);
    }
    .mapPopup .leaflet-popup-content{ margin: 8px 10px; }

    .mapBubble{ min-width: 200px; max-width: 260px; }
    .mapBubble .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:4px; }
    .mapBubble .title{ font-weight: 800; letter-spacing:.2px; }
    .mapBubble .sub{ opacity:.9; font-size: 11.75px; margin-top:2px; }
    .mapBubble .desc{
      margin-top:8px;
      padding:7px 9px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 11px;
      background: rgba(255,255,255,.04);
      font-size: 11.75px;
      line-height: 1.25;
      max-height: 90px;
      overflow:auto;
    }
    .mapBubble .mapOpenBtn{ margin-top:10px; display:inline-block; width:auto; padding:10px 12px; font-size:13px; border-radius:12px; background: linear-gradient(180deg, rgba(39,174,96,.98), rgba(39,174,96,.72)); box-shadow: 0 10px 18px rgba(0,0,0,.28); }



/* === Job info readability boxes (Customer/Job/Field) === */
.infoBox{
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  margin-top: 10px;
}
.infoBoxTitle{
  background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(59,130,246,.70));
  padding: 10px 12px;
  font-weight: 900;
  letter-spacing: .2px;
  color: #061a3a; /* title text is a separate color */
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.infoBoxBody{
  padding: 10px 12px 12px;
}
.infoLine{
  display:flex;
  justify-content:space-between;
  gap:12px;
  padding: 8px 0;
  border-bottom: 1px dashed rgba(255,255,255,.10);
  font-size: 13px;
}
.infoLine:last-child{border-bottom:none;padding-bottom:0}
.infoKey{color: rgba(229,231,235,.70); font-weight: 700;}
.infoVal{color: rgba(229,231,235,.92); font-weight: 800; text-align:right;}
.infoBig{
  font-size: 15px;
  font-weight: 800;
  color: rgba(229,231,235,.92);
}


/* === Pause modal === */
.modalOverlay{
  position:fixed; inset:0; z-index:9999;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
}
.modalOverlay.show{display:flex;}
.modalCard{
  width:min(520px, 100%);
  background: rgba(2,6,23,.96);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow: 0 18px 50px rgba(0,0,0,.55);
  overflow:hidden;
}
.modalHeader{
  padding:12px 14px;
  background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(124,58,237,.65));
  color:#140a2b;
  font-weight:900;
  letter-spacing:.2px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.modalBody{padding:12px 14px;}
.modalActions{
  padding:12px 14px;
  border-top:1px solid rgba(255,255,255,.10);
  display:flex;
  gap:10px;
  justify-content:flex-end;
}
.modalBody .label{margin-top:4px}
.modalBody textarea.input{width:100%}


.btn.inlineRemove{
  padding:4px 8px;
  font-size:11px;
  line-height:1;
  border-radius:8px;
  height:auto;
  align-self:center;
}
.inlineRow{
  display:flex;
  align-items:center;
  gap:8px;
}
.inlineRow .grow{flex:1;}

/* === Repair used parts inline remove === */
.partHeaderRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.partHeaderRight{display:flex; align-items:center; gap:8px;}
.btn.microRemove{padding:3px 6px; font-size:10px; line-height:1; border-radius:7px; height:auto; white-space:nowrap;}
.btn.unableBtn{padding:3px 6px; font-size:10px; line-height:1; border-radius:7px; height:auto;}

/* Restock single-line numeric bubbles */
.badge.success{
  background:#2e7d32;
  color:#fff;
}

</style>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>
  <div class="app">
    <header class="titleBlock">
      <div class="titleRow">
        <button class="iconBtn" id="openMenu" aria-label="Menu">
          <div class="hamburgerLines"><span></span><span></span><span></span></div>
        </button>

        <button class="iconBtn" id="goHome" title="Home" aria-label="Home">üè†</button>

        <div class="truckId">
          <button class="titleLink" id="truckLabel" type="button">Truck 03</button>
        </div>

        <div class="techBox">
          <button class="titleLink right" id="techName" type="button">Adam Pracht</button>
          <div class="helpers" id="helperLine">Helpers: Jake, Cole</div>
        </div>
      </div>
    </header>

    <div class="truckDrop" id="truckDrop" aria-hidden="true"></div>

    <main class="main">
      <section class="panel" id="panel"></section>
    </main>
  </div>

  <div class="overlay" id="overlay"></div>

  <aside class="drawer" id="drawer">
    <div class="drawerHeader">
      <div class="title">Information</div>
      <div class="sub">Lists ‚Ä¢ Requests ‚Ä¢ Receipts ‚Ä¢ Settings</div>
    </div>

    <div class="menu">
      <button class="menuBtn" data-nav="lists">
        <div class="menuLeft">
          <div class="name">Lists</div>
          <div class="desc">Truck stock + tools</div>
        </div>
        <span class="chev">‚Ä∫</span>
      </button>

      <button class="menuBtn" data-nav="requests">
        <div class="menuLeft">
          <div class="name">Requests</div>
          <div class="desc">Tool, time off, purchase, maintenance</div>
        </div>
        <span class="chev">‚Ä∫</span>
      </button>

      <button class="menuBtn" data-nav="receipts">
        <div class="menuLeft">
          <div class="name">Receipts</div>
          <div class="desc">Fuel, parts, misc expenses</div>
        </div>
        <span class="chev">‚Ä∫</span>
      </button>

      <button class="menuBtn" data-nav="settings">
        <div class="menuLeft">
          <div class="name">Settings</div>
          <div class="desc">*setting* placeholders live here</div>
        </div>
        <span class="chev">‚Ä∫</span>
      </button>
    </div>
  </aside>

<script>
/* =======================================================================
   SAMPLE DATA (easy to remove later)
   ======================================================================= */
const SAMPLE = {
  techName: "Adam Pracht",
  helpers: ["Jake","Cole"],
  helperRoster: ["Jake","Cole","Evan","Trey"],
  truckId: "Truck 03",
  availableTrucks: ["Truck 01","Truck 02","Truck 03","Truck 04"],

  // Truck inventory (sample)
  truckInventory: {
    "Truck 03": [
      { id:"P-001", name:"20A Fuse", qty: 18 },
      { id:"P-002", name:"Contactor (3-pole)", qty: 2 },
      { id:"P-003", name:"Reinke Microswitch", qty: 4 },
      { id:"P-004", name:"Gearbox Oil (Qt)", qty: 6 },
      { id:"P-005", name:"1/2\" Bolts (bag)", qty: 3 }
    ],
    "Truck 01": [ { id:"P-001", name:"20A Fuse", qty: 10 } ],
    "Truck 02": [ { id:"P-001", name:"20A Fuse", qty: 6 } ],
    "Truck 04": [ { id:"P-001", name:"20A Fuse", qty: 12 } ]
  },

  
  // Customers + Fields (sample for Create Job)
  customers: [
    { id:"C-100", name:"Smith Farms", phone:"(555) 201-8841", fields:[
      { id:"F-210", name:"North Quarter", brand:"Reinke", lat:41.40, lng:-99.75 },
      { id:"F-211", name:"West Circle", brand:"Valley", lat:41.39, lng:-99.77 }
    ]},
    { id:"C-101", name:"Miller Ag", phone:"(555) 904-1137", fields:[
      { id:"F-300", name:"South Pivot", brand:"Valley", lat:41.35, lng:-99.70 }
    ]},
    { id:"C-102", name:"Ridgeview", phone:"(555) 771-2209", fields:[
      { id:"F-410", name:"East Circle", brand:"Zimmatic", lat:41.44, lng:-99.72 }
    ]}
  ],


  // Open/Paused Jobs (sample for Open Jobs + Job Screen)
  jobs: [
    {
      id: "J-1041",
      number: 1041,
      customerId: "C-101",
      fieldId: "F-300",
      jobType: "General Repair",
      description: "Tower 4 running hot ‚Ä¢ check gearbox + contactor",
      status: "Paused", // Paused, Open, On the way, Travel, Arrived, On Job Diagnostics, On Job Repair
      createdAt: "2025-12-30T14:10:00",
      statusHistory: [
        { status: "Open", start: "2025-12-30T14:10:00", end: "2025-12-31T09:42:00" },
        { status: "Paused", start: "2025-12-31T09:42:00", end: null }
      ]
    },
    {
      id: "J-1042",
      number: 1042,
      customerId: "C-100",
      fieldId: "F-210",
      jobType: "Pivot Inspection",
      description: "Annual inspection + electrical check",
      status: "Open",
      createdAt: "2025-12-31T08:25:00",
      statusHistory: [
        { status: "Open", start: "2025-12-31T08:25:00", end: null }
      ]
    },
    {
      id: "J-1043",
      number: 1043,
      customerId: "C-102",
      fieldId: "F-410",
      jobType: "General Repair",
      description: "No start ‚Ä¢ MCP dead ‚Ä¢ verify power",
      status: "Open",
      createdAt: "2025-12-31T12:05:00",
      statusHistory: [
        { status: "Open", start: "2025-12-31T12:05:00", end: null }
      ]
    }
  ],

// Pending requests tied to a truck (sample)
  pendingRequests: [
    { truck:"Truck 03", type:"Purchase", title:"Purchase request", sub:"(2) gear reducers ‚Ä¢ Reinke", status:"Pending", date:"Dec 31" },
    { truck:"Truck 03", type:"Tool", title:"Tool request", sub:"Need another grease gun", status:"Pending", date:"Dec 30" },
    { truck:"Truck 02", type:"Truck Maintenance", title:"Truck maintenance", sub:"Brake light out", status:"Pending", date:"Dec 29" }
  ],

  receipts: [
    { vendor: "Casey's", amount: "$84.17", note: "Diesel", date: "Dec 31", category:"Supply", qty: 1, cost: 84.17, job: "" },
    { vendor: "NAPA", amount: "$236.40", note: "U-joints", date: "Dec 30", category:"Purchase for job", qty: 2, cost: 236.40, job: "Job #1041 ‚Ä¢ Miller Ag ‚Ä¢ South Pivot" }
  ],

  // Truck stock sample (same list shown; later filter by truck in backend)
  truckParts: [
    { pn: "RK-SSK-100", desc: "Seal kit ‚Ä¢ center drive", qty: 1, min: 2 },
    { pn: "FUSE-30A", desc: "Fuse ‚Ä¢ 30A blade", qty: 12, min: 10 },
    { pn: "FUSE-10A", desc: "Fuse ‚Ä¢ 10A blade", qty: 2, min: 8 },
    { pn: "BOLT-1/2-13", desc: "Bolt ‚Ä¢ 1/2-13 x 1.5", qty: 4, min: 6 },
    { pn: "CPLR-REINKE", desc: "Drive coupler ‚Ä¢ Reinke", qty: 0, min: 1 }
  ],
  truckTools: [
    { code: "T-001", desc: "1/2\" impact", qty: 1 },
    { code: "T-014", desc: "Fluke multimeter", qty: 1 },
    { code: "T-021", desc: "Grease gun", qty: 1 },
    { code: "T-030", desc: "Torque wrench", qty: 0 }
  ]
};

// UI state (sample). Later: pull from dashboard + persist per tech session.
const STATE = {
  restockAdds: {},
  outOfStockParts: [],
  _unableModalWired: false,
  unableKey: null,
  unableReasonDraft: '',
  outlineEditMode: false,
  _pauseModalWired: false,
  truckId: SAMPLE.truckId,
  helpers: Array.isArray(SAMPLE.helpers) ? [...SAMPLE.helpers] : [],
  currentJobId: "",
  jobDraft: {
    mode: "",
    customerId: "",
    customerName: "",
    fieldId: "",
    fieldName: "",
    brand: "",
    jobType: "Pivot Inspection",
    description: ""
  }
};

(function(){
  let currentView = 'home';
  const VIEW_STACK = ['home'];
  const panel = document.getElementById('panel');

  const drawer = document.getElementById('drawer');
  const overlay = document.getElementById('overlay');
  const openBtn = document.getElementById('openMenu');
  const homeBtn = document.getElementById('goHome');

  const truckBtn = document.getElementById('truckLabel');
  const techBtn = document.getElementById('techName');
  const helperLine = document.getElementById('helperLine');
  const truckDrop = document.getElementById('truckDrop');

  // init header
  document.getElementById('techName').textContent = SAMPLE.techName;
  truckBtn.textContent = STATE.truckId;
  helperLine.textContent = STATE.helpers.length ? ('Helpers: ' + STATE.helpers.join(', ')) : 'Helpers: None';

  function openMenu(){ drawer.classList.add('show'); overlay.classList.add('show'); }
  function closeMenu(){ drawer.classList.remove('show'); overlay.classList.remove('show'); }
  openBtn.addEventListener('click', openMenu);
  overlay.addEventListener('click', closeMenu);

  homeBtn.addEventListener('click', ()=> show('home'));

  // Drawer nav
  drawer.querySelectorAll('[data-nav]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const view = btn.getAttribute('data-nav');
      closeMenu();
      show(view);
    });
  });

  // Truck dropdown
  function closeTruckDrop(){
    truckDrop.classList.remove('show');
    truckDrop.setAttribute('aria-hidden','true');
  }
  function renderTruckDrop(){
    const list = (SAMPLE.availableTrucks || []).map(t=>{
      const on = (t === STATE.truckId) ? "on" : "";
      return `<button class="truckOpt ${on}" type="button" data-truck="${t}">
        <div>
          <div>${t}</div>
          <div class="mutedSmall">Tap to switch</div>
        </div>
        <div>${t === STATE.truckId ? "‚úì" : ""}</div>
      </button>`;
    }).join("");

    truckDrop.innerHTML = `
      <div class="note">Select a truck. Inventory + lists reflect the selected truck. Jobs affect the selected truck only.</div>
      <div style="height:8px"></div>
      ${list}
    `;
    truckDrop.querySelectorAll('[data-truck]').forEach(b=>{
      b.addEventListener('click', ()=>{
        STATE.truckId = b.getAttribute('data-truck');
        truckBtn.textContent = STATE.truckId;
        show(currentView);
        closeTruckDrop();
      });
    });
  }

  truckBtn.addEventListener('click', ()=>{
    const isOpen = truckDrop.classList.contains('show');
    if(isOpen){ closeTruckDrop(); return; }
    renderTruckDrop();
    truckDrop.classList.add('show');
    truckDrop.setAttribute('aria-hidden','false');
  });

  document.addEventListener('click', (e)=>{
    const withinHeader = e.target.closest('.titleBlock');
    const withinDrop = e.target.closest('#truckDrop');
    if(!withinHeader && !withinDrop) closeTruckDrop();
  });

  // Tech name -> helper configuration screen
  techBtn.addEventListener('click', ()=> { closeTruckDrop(); show('helpers'); });

  /* ---------------- Views ---------------- */

  function renderHome(){
    return `
      <div class="screenTitle">
        <h2>Home</h2>
        <span class="badge">${STATE.truckId}</span>
      </div>
      <div class="sectionHint">Quick actions</div>
      <button class="btn create" id="btnCreateJob">Create Job</button>
      <button class="btn openjobs" id="btnOpenJobs">Open Jobs</button>
      <button class="btn stock" id="btnRestock">Restock <span class="countBadge" id="restockCount">0</span></button>
      <button class="btn refuel" id="btnRefuel">Re-Fuel</button>
      <div class="note">Looks-first build with sample data. Functions later.</div>
    `;
  }


  function getRestockNeedTotal(){
    // Total qty needed to reach min across all parts
    try{
      return (SAMPLE.truckParts||[]).reduce((sum,p)=>{
        const need = Math.max(0, (Number(p.min)||0) - (Number(p.qty)||0));
        return sum + need;
      },0);
    }catch(e){ return 0; }
  }

  function renderRestock(){
    const lowParts = (SAMPLE.truckParts||[]).filter(p => (Number(p.qty)||0) < (Number(p.min)||0));
    const rows = lowParts.map(p=>{
      const need = Math.max(0, (Number(p.min)||0) - (Number(p.qty)||0));
      const pending = Number(STATE.restockAdds[p.pn]||0);
      const displayNeed = pending ? Math.max(0, need - pending) : need;

      return `
        <button class="pill stockPill" data-restock="${p.pn}">
          <div style="display:flex;align-items:center;gap:12px;width:100%;">
            <div style="flex:1;min-width:0;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              ${p.desc}
            </div>
            <span class="badge danger">${displayNeed}</span>
            <span class="badge success">${p.qty}</span>
          </div>
        </button>
      `;
    }).join("");

    return `
      <div class="screenTitle">
        <button class="backBtn" id="btnRestockBack">‚Üê</button>
        <h2>Restock</h2>
        <span class="badge">${STATE.truckId}</span>
      </div>

      <div class="stockHead" style="margin-top:10px;">
        <div class="note" style="margin:0;">Tap a part to enter what you grabbed.</div>
        <button class="miniBtn" id="btnApplyRestock">Restock</button>
      </div>

      <div class="list">
        ${rows || `<div class="note">All stocked to min.</div>`}
      </div>
    `;
  }

  function openRestockModal(pn){
    const part = (SAMPLE.truckParts||[]).find(x=>x.pn===pn);
    if(!part) return;
    const modal = document.getElementById('restockModal');
    if(!modal) return;

    const title = document.getElementById('restockModalTitle');
    const meta = document.getElementById('restockModalMeta');
    const qtyInput = document.getElementById('restockQty');

    if(title) title.textContent = pn;
    if(meta) meta.textContent = `${part.desc} ‚Ä¢ On truck: ${part.qty} ‚Ä¢ Min: ${part.min}`;
    if(qtyInput){
      qtyInput.value = '';
      qtyInput.focus();
    }

    modal.setAttribute('data-pn', pn);
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
  }

  function closeRestockModal(){
    const modal = document.getElementById('restockModal');
    if(!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    modal.removeAttribute('data-pn');
  }

  function applyRestock(){
    // Apply all pending additions to truck qty, then clear pending
    const adds = STATE.restockAdds || {};
    (SAMPLE.truckParts||[]).forEach(p=>{
      const add = Number(adds[p.pn]||0);
      if(add > 0){
        p.qty = (Number(p.qty)||0) + add;
      }
    });
    STATE.restockAdds = {};
  }


  function renderLists(){
    return `
      <div class="screenTitle">
        <h2>Lists</h2>
        <span class="badge">${STATE.truckId}</span>
      </div>
      <div class="note">Choose one list at a time.</div>
      <div style="height:10px"></div>

      <div class="seg">
        <button class="segBtn active" id="segParts">Parts</button>
        <button class="segBtn" id="segTools">Tools</button>
      </div>

      <div style="height:12px"></div>
      <div id="listsBody"></div>
    `;
  }

  function renderPartsList(){
    const partsRows = SAMPLE.truckParts.map(p=>{
      const isLow = (p.qty || 0) < (p.min || 0);
      const qtyClass = (p.qty || 0) <= 0 ? "low" : (p.qty < p.min ? "warn" : "ok");
      return `
        <div class="stockRow ${isLow ? "low" : ""}">
          <div class="colPN">${p.pn}</div>
          <div class="colDesc">${p.desc}</div>
          <div class="qtyCol">
            <div class="qtyBlock">
              <div class="qtyLabel">On truck</div>
              <div class="qtyCircle ${qtyClass}">${p.qty}</div>
            </div>
            <div class="qtyBlock">
              <div class="qtyLabel">Min</div>
              <div class="qtyCircle ok">${p.min}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="tableWrap">
        <div class="stockHead">
          <h3>Truck Stock ‚Ä¢ Parts</h3>
          <button class="miniBtn" id="btnAddPart">Add Parts</button>
        </div>
        ${partsRows || `<div class="note">No parts (sample).</div>`}
      </div>
    `;
  }

  function renderToolsList(){
    const toolsRows = SAMPLE.truckTools.map(t=>{
      const qtyClass = (t.qty || 0) <= 0 ? "low" : "ok";
      return `
        <div class="stockRow ${((t.qty||0) <= 0) ? "low" : ""}">
          <div class="colPN">${t.code}</div>
          <div class="colDesc">${t.desc}</div>
          <div class="qtyCol">
            <div class="qtyBlock">
              <div class="qtyLabel">Qty</div>
              <div class="qtyCircle ${qtyClass}">${t.qty}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="tableWrap">
        <div class="stockHead">
          <h3>Tools</h3>
          <div style="display:flex; gap:8px;">
            <button class="miniBtn" id="btnAddTool">Add Tool</button>
            <button class="miniBtn" id="btnToolRequest">Tool Request</button>
          </div>
        </div>
        ${toolsRows || `<div class="note">No tools (sample).</div>`}
      </div>
    `;
  }

  function renderRequests(){
    const pending = (SAMPLE.pendingRequests || []).filter(r => r.truck === STATE.truckId);
    const pendingHtml = pending.map(r => `
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="itemTitle">${r.title}</div>
            <div class="itemSub">${r.sub}</div>
          </div>
          <div class="pill purple">${r.status}</div>
        </div>
        <div class="pills">
          <span class="pill">${r.type}</span>
          <span class="pill">${r.date}</span>
          <span class="pill">${STATE.truckId}</span>
        </div>
      </div>
    `).join("");

    return `
      <div class="screenTitle">
        <h2>Requests</h2>
        <span class="badge">${STATE.truckId}</span>
      </div>
      <div class="note">Initial view: pending requests tied to this truck.</div>
      <div style="height:10px"></div>

      <button class="btn openjobs" id="btnMakeRequest">Make Request</button>

      <div style="height:14px"></div>
      <div class="sectionHint">Pending (sample)</div>
      <div class="list">
        ${pendingHtml || `<div class="note">No pending requests for this truck (sample).</div>`}
      </div>
    `;
  }

  function renderMakeRequest(){
    return `
      <div class="screenTitle">
        <h2>Make Request</h2>
        <span class="badge">All required</span>
      </div>
      <div class="note">Select a request type. Submit enables when all required fields are filled.</div>
      <div style="height:10px"></div>

      <div class="formCard">
        <div class="field">
          <label for="reqType">Request type</label>
          <select class="select" id="reqType">
            <option value="">Select‚Ä¶</option>
            <option value="tool">Tool</option>
            <option value="timeoff">Time Off</option>
            <option value="purchase">Purchase</option>
            <option value="truckmaint">Truck Maintenance</option>
          </select>
        </div>

        <div id="reqFields"></div>

        <button class="submitBtn" id="reqSubmit" disabled>Submit Request</button>
        <div class="hint">Look-first: submit shows an alert for now.</div>
      </div>

      <button class="btn stock" id="backToRequests" style="margin-top:10px;">Back</button>
    `;
  }

  function fieldsFor(type){
    if(type === "tool"){
      return `
        <div class="field">
          <label for="toolDesc">Tool description</label>
          <textarea class="textarea" id="toolDesc" placeholder="Describe the tool needed‚Ä¶"></textarea>
        </div>
        <div class="field">
          <label for="toolQty">Quantity</label>
          <input class="input" id="toolQty" type="number" inputmode="numeric" min="1" placeholder="1"/>
        </div>

        <div class="checkline">
          <input type="checkbox" id="toolReplace"/>
          <div>
            <div class="ct">Replacement</div>
            <div class="cd">Check if this replaces an existing tool.</div>
          </div>
        </div>

        <div class="field" id="replaceReasonWrap" style="display:none;">
          <label for="replaceReason">Reason for replacement (required)</label>
          <textarea class="textarea" id="replaceReason" placeholder="Broken, lost, worn out, etc‚Ä¶"></textarea>
        </div>
      `;
    }

    if(type === "timeoff"){
      const people = [SAMPLE.techName, ...(STATE.helpers || [])];
      const opts = people.map(p=>`<option value="${p}">${p}</option>`).join("");
      return `
        <div class="field">
          <label for="timeoffPerson">Who is requesting time off</label>
          <select class="select" id="timeoffPerson">
            <option value="">Select‚Ä¶</option>
            ${opts}
          </select>
        </div>

        <div class="row2">
          <div class="field">
            <label for="startDT">Start date & time</label>
            <input class="input" id="startDT" type="datetime-local"/>
          </div>
          <div class="field">
            <label for="endDT">End date & time</label>
            <input class="input" id="endDT" type="datetime-local"/>
          </div>
        </div>
        <div class="field">
          <label for="timeoffReason">Reason (required)</label>
          <textarea class="textarea" id="timeoffReason" placeholder="Reason for time off‚Ä¶"></textarea>
        </div>
      `;
    }

    if(type === "purchase"){
      return `
        <div class="field">
          <label for="purchaseDesc">Purchase description</label>
          <textarea class="textarea" id="purchaseDesc" placeholder="Describe what needs purchased‚Ä¶"></textarea>
        </div>
        <div class="field">
          <label for="purchaseQty">Quantity</label>
          <input class="input" id="purchaseQty" type="number" inputmode="numeric" min="1" placeholder="1"/>
        </div>
      `;
    }

    if(type === "truckmaint"){
      return `
        <div class="field">
          <label for="maintDesc">Maintenance needed</label>
          <textarea class="textarea" id="maintDesc" placeholder="Describe maintenance needed‚Ä¶"></textarea>
        </div>
      `;
    }

    return `<div class="note">Select a type to continue.</div>`;
  }

  function wireMakeRequest(){
    const typeSel = document.getElementById('reqType');
    const fields = document.getElementById('reqFields');
    const submit = document.getElementById('reqSubmit');

    function setSubmitEnabled(on){
      submit.disabled = !on;
      submit.classList.toggle('enabled', on);
    }

    function validate(){
      const t = typeSel.value;
      if(!t) return setSubmitEnabled(false);

      if(t === "tool"){
        const desc = (document.getElementById('toolDesc')?.value || "").trim();
        const qty = (document.getElementById('toolQty')?.value || "").trim();
        const rep = document.getElementById('toolReplace')?.checked;
        const reason = (document.getElementById('replaceReason')?.value || "").trim();
        if(!desc) return setSubmitEnabled(false);
        if(!qty || Number(qty) <= 0) return setSubmitEnabled(false);
        if(rep && !reason) return setSubmitEnabled(false);
        return setSubmitEnabled(true);
      }

      if(t === "timeoff"){
        const who = (document.getElementById('timeoffPerson')?.value || "").trim();
        const s = (document.getElementById('startDT')?.value || "").trim();
        const e = (document.getElementById('endDT')?.value || "").trim();
        const r = (document.getElementById('timeoffReason')?.value || "").trim();
        if(!who || !s || !e || !r) return setSubmitEnabled(false);
        if(new Date(e).getTime() <= new Date(s).getTime()) return setSubmitEnabled(false);
        return setSubmitEnabled(true);
      }

      if(t === "purchase"){
        const desc = (document.getElementById('purchaseDesc')?.value || "").trim();
        const qty = (document.getElementById('purchaseQty')?.value || "").trim();
        if(!desc) return setSubmitEnabled(false);
        if(!qty || Number(qty) <= 0) return setSubmitEnabled(false);
        return setSubmitEnabled(true);
      }

      if(t === "truckmaint"){
        const desc = (document.getElementById('maintDesc')?.value || "").trim();
        if(!desc) return setSubmitEnabled(false);
        return setSubmitEnabled(true);
      }

      setSubmitEnabled(false);
    }

    function bindAllInputs(){
      fields.querySelectorAll('input, textarea, select').forEach(el=>{
        el.addEventListener('input', validate);
        el.addEventListener('change', validate);
      });
    }

    typeSel.addEventListener('change', ()=>{
      fields.innerHTML = fieldsFor(typeSel.value);

      // Tool replacement toggle
      const rep = document.getElementById('toolReplace');
      if(rep){
        rep.addEventListener('change', ()=>{
          const wrap = document.getElementById('replaceReasonWrap');
          if(wrap) wrap.style.display = rep.checked ? "block" : "none";
          validate();
        });
      }

      bindAllInputs();
      validate();
    });

    submit.addEventListener('click', ()=>{
      if(submit.disabled) return;
      alert("Request submitted (look-only). Next step: save to dashboard + show in pending list.");
    });

    setSubmitEnabled(false);
  }

  function renderReceipts(){
    const items = (SAMPLE.receipts || []).map(r => `
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="itemTitle">${r.vendor} ‚Ä¢ ${r.amount}</div>
            <div class="itemSub">${r.note} ‚Ä¢ ${r.date}</div>
          </div>
          <div class="pill orange">${r.category || "Receipt"}</div>
        </div>
        <div class="pills">
          <span class="pill">Qty ${r.qty ?? "-"}</span>
          <span class="pill">Cost $${(r.cost ?? "").toString()}</span>
          ${r.category === "Purchase for job" ? `<span class="pill blue">${r.job}</span>` : `<span class="pill">Sample</span>`}
        </div>
      </div>
    `).join("");

    return `
      <div class="screenTitle">
        <h2>Receipts</h2>
        <span class="badge">${STATE.truckId}</span>
      </div>
      <div class="note">Add receipts here. Look-first; backend later.</div>
      <div style="height:10px"></div>

      <button class="btn stock" id="btnAddReceiptTop">Add Receipt</button>

      <div style="height:14px"></div>
      <div class="sectionHint">Recent Receipts (sample)</div>
      <div class="list">
        ${items || `<div class="note">No receipts yet (sample).</div>`}
      </div>
    `;
  }

  function renderAddReceipt(){
    return `
      <div class="screenTitle">
        <h2>Add Receipt</h2>
        <span class="badge">All required</span>
      </div>
      <div class="note">Enter purchase info, then choose a category. Submit enables when complete.</div>
      <div style="height:10px"></div>

      <div class="formCard">
        <div class="field">
          <label for="rcDesc">Description of purchase</label>
          <textarea class="textarea" id="rcDesc" placeholder="Describe what was purchased‚Ä¶"></textarea>
        </div>

        <div class="row2">
          <div class="field">
            <label for="rcQty">Qty</label>
            <input class="input" id="rcQty" type="number" inputmode="numeric" min="1" placeholder="1"/>
          </div>
          <div class="field">
            <label for="rcCost">Cost</label>
            <input class="input" id="rcCost" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0.00"/>
          </div>
        </div>

        <div class="field">
          <label for="rcCat">Category</label>
          <select class="select" id="rcCat">
            <option value="">Select‚Ä¶</option>
            <option value="Tool">Tool</option>
            <option value="Supply">Supply</option>
            <option value="Purchase for job">Purchase for job</option>
            <option value="Office purchase">Office purchase</option>
            <option value="Repair">Repair</option>
          </select>
        </div>

        <div class="field" id="jobDescWrap" style="display:none;">
          <label for="rcJob">Job description (required)</label>
          <textarea class="textarea" id="rcJob" placeholder="Describe the job this was for‚Ä¶"></textarea>
        </div>

        <button class="submitBtn" id="rcSubmit" disabled>Submit Receipt</button>
        <div class="hint">Look-first: submit just shows an alert for now.</div>
      </div>

      <button class="btn openjobs" id="backToReceipts" style="margin-top:10px;">Back</button>
    `;
  }

  function wireAddReceipt(){
    const desc = document.getElementById('rcDesc');
    const qty = document.getElementById('rcQty');
    const cost = document.getElementById('rcCost');
    const cat = document.getElementById('rcCat');
    const jobWrap = document.getElementById('jobDescWrap');
    const job = document.getElementById('rcJob');
    const submit = document.getElementById('rcSubmit');

    function setEnabled(on){
      submit.disabled = !on;
      submit.classList.toggle('enabled', on);
    }

    function validate(){
      const d = (desc?.value || "").trim();
      const q = (qty?.value || "").trim();
      const c = (cost?.value || "").trim();
      const k = (cat?.value || "").trim();

      if(!d) return setEnabled(false);
      if(!q || Number(q) <= 0) return setEnabled(false);
      if(c === "" || Number(c) < 0) return setEnabled(false);
      if(!k) return setEnabled(false);

      if(k === "Purchase for job"){
        const j = (job?.value || "").trim();
        if(!j) return setEnabled(false);
      }
      return setEnabled(true);
    }

    cat.addEventListener('change', ()=>{
      const isJob = cat.value === "Purchase for job";
      jobWrap.style.display = isJob ? "block" : "none";
      validate();
    });

    [desc, qty, cost, cat, job].forEach(el=>{
      if(!el) return;
      el.addEventListener('input', validate);
      el.addEventListener('change', validate);
    });

    submit.addEventListener('click', ()=>{
      if(submit.disabled) return;
      alert("Receipt submitted (look-only). Next step: save + optionally link to a job.");
    });

    setEnabled(false);
  }

  
  /* ===================== Open Jobs + Job Flow ===================== */

  function nowISO(){ return new Date().toISOString(); }

  function getCustomerById(id){
    return (SAMPLE.customers || []).find(c => c.id === id) || null;
  }
  function getFieldById(customerId, fieldId){
    const c = getCustomerById(customerId);
    return (c?.fields || []).find(f => f.id === fieldId) || null;
  }
  function getJobById(id){
    return (SAMPLE.jobs || []).find(j => j.id === id) || null;
  }

  function ms(n){ return (typeof n === "number" && isFinite(n)) ? n : 0; }
  function fmtDuration(msVal){
    const s = Math.max(0, Math.floor(ms(msVal)/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    if(h <= 0) return `${m}m`;
    return `${h}h ${m}m`;
  }
  function parseDT(v){
    const t = new Date(v).getTime();
    return isFinite(t) ? t : Date.now();
  }
  function jobOpenAge(job){
    return Date.now() - parseDT(job?.createdAt || nowISO());
  }
  function jobStatusDuration(job, status){
    const hist = Array.isArray(job?.statusHistory) ? job.statusHistory : [];
    const seg = hist.find(x => x.status === status && !x.end) || hist[hist.length-1];
    if(!seg) return 0;
    const start = parseDT(seg.start);
    const end = seg.end ? parseDT(seg.end) : Date.now();
    return Math.max(0, end - start);
  }
  function setJobStatus(job, newStatus){
    if(!job) return;
    if(!Array.isArray(job.statusHistory)) job.statusHistory = [];
    const hist = job.statusHistory;
    const last = hist.length ? hist[hist.length-1] : null;
    const now = nowISO();

    if(last && !last.end) last.end = now;
    hist.push({ status: newStatus, start: now, end: null });
    job.status = newStatus;
  }

  
/* ==== SAFETY FALLBACKS (hotfix) ==== */
if (typeof getCustomerById !== "function") {
  function getCustomerById(customerId){
    try{
      // Try SAMPLE/customers if present
      if (typeof SAMPLE !== "undefined" && Array.isArray(SAMPLE.customers)) {
        return SAMPLE.customers.find(c => c.id === customerId) || null;
      }
    }catch(e){}
    return null;
  }
}
if (typeof getFieldById !== "function") {
  function getFieldById(customerId, fieldId){
    try{
      if (typeof SAMPLE !== "undefined" && Array.isArray(SAMPLE.customers)) {
        const c = SAMPLE.customers.find(c => c.id === customerId);
        if (!c || !Array.isArray(c.fields)) return null;
        return c.fields.find(f => f.id === fieldId) || null;
      }
    }catch(e){}
    return null;
  }
}
/* ==== END SAFETY FALLBACKS ==== */


function jobCard(job, opts={}){
    const c = getCustomerById(job.customerId);
    const f = getFieldById(job.customerId, job.fieldId);

    const status = job.status || "Open";
    const age = fmtDuration(jobOpenAge(job));
    const brand = (f?.brand || job.brand || "‚Äî");
    const fieldName = (f?.name || job.fieldName || "Field");
    const custName = (c?.name || job.customerName || "Customer");

    const pillClass =
      status === "Paused" ? "purple" :
      status === "Open" ? "blue" :
      status === "On the way" ? "orange" :
      status === "Travel" ? "orange" :
      status === "Arrived" ? "green" :
      status.includes("On Job") ? "green" : "blue";

    const topRight = opts.rightPill || `<div class="pill ${pillClass}">${status}</div>`;

    return `
      <div class="item" ${opts.dataAttr || ""}>
        <div class="itemTop">
          <div>
            <div class="itemTitle">Job #${job.number || job.id} ‚Ä¢ ${job.jobType || "Job"}</div>
            <div class="itemSub">${custName} ‚Ä¢ ${fieldName} ‚Ä¢ ${brand}</div>
          </div>
          ${topRight}
        </div>
        <div class="pills">
          <span class="pill">Open: ${age}</span>
          ${job.description ? `<span class="pill">${job.description}</span>` : ""}
        </div>
      </div>
    `;
  }

  function renderOpenJobs(){
    const jobs = Array.isArray(SAMPLE.jobs) ? [...SAMPLE.jobs] : [];
    // Sort: Paused first, then Open; within each: longest open first
    jobs.sort((a,b)=>{
      const aGroup = (a.status === "Paused") ? 0 : 1;
      const bGroup = (b.status === "Paused") ? 0 : 1;
      if(aGroup !== bGroup) return aGroup - bGroup;
      return jobOpenAge(b) - jobOpenAge(a);
    });

    const paused = jobs.filter(j => j.status === "Paused");
    const open = jobs.filter(j => j.status !== "Paused");

    const renderSection = (title, arr) => `
      <div class="sectionHint">${title}</div>
      <div class="list">
        ${arr.map(j => jobCard(j, { dataAttr:`data-job="${j.id}"` })).join("") || `<div class="note">None</div>`}
      </div>
      <div style="height:12px"></div>
    `;

    return `
      <div class="screenTitle mapHeaderRow">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">Open Jobs</h2>
          <span class="badge">${STATE.truckId}</span>
        </div>
        <button class="btn stock mapTop" id="btnMapView" title="View all jobs on a map">View on map</button>
      </div>
      <div class="note">Tap a job to open it.</div>
      <div style="height:10px"></div>

      ${renderSection("Paused Job Status", paused)}
      ${renderSection("Open Jobs", open)}

      <button class="btn stock" id="btnOpenJobsBack" style="margin-top:4px;">Back</button>
    `;
  }
  
  // Open a job directly from the map popup
  function openJobFromMap(jobId){
    try{
      STATE.currentJobId = jobId;
      // Navigate to Job Information screen
      try{ show('job_screen'); }catch(e){ /* show may not be ready */ }

      // If map popup is still open, close it
      try{ if(window._jobsMap) window._jobsMap.closePopup(); }catch(e){}
    }catch(err){
      console.error('openJobFromMap error', err);
    }
  }

  // Ensure map popup onclick handler can find this in global scope
  window.openJobFromMap = openJobFromMap;

function renderMapView(){
    return `
      <div class="screenTitle" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">Jobs Map</h2>
          <span class="badge">${STATE.truckId}</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
          <button class="btn stock tiny inline" id="btnMapBack" title="Back to job list">Close</button>
          <button class="btn stock tiny inline" id="btnLocateMe" title="Show my current location">My location</button>
</div>
      </div>

      <div id="jobMap"></div>

      <div id="mapInfoCard" class="mapCard hidden">
        <div class="row">
          <div>
            <div class="title" id="mapCust">‚Äî</div>
            <div class="sub" id="mapField">‚Äî</div>
            <div class="sub" id="mapType">‚Äî</div>
          </div>
          <span class="pill" id="mapStatusPill">‚Äî</span>
        </div>

        <div class="desc" id="mapDesc">Select a pin to see details.</div>

        <button class="btn" id="btnMapOpenJob" style="background: linear-gradient(135deg, rgba(39,174,96,.98), rgba(39,174,96,.72)); margin-top:10px;">
          Open job
        </button>
        <button class="btn stock" id="btnMapBack" style="margin-top:6px;">Back</button>
      </div>
    `;
  }



  
  let _jobsMap = null;
  let _jobsMapLayer = null;

  function statusToPinClass(status){
    if(status === "Paused") return "purple";
    if(status === "Open") return "blue";
    if(status === "On the way") return "orange";
    if(status === "Travel") return "orange";
    if(status === "Arrived") return "green";
    if(status === "On Job Diagnostics") return "green";
    if(status === "On Job Repair") return "green";
    return "gray";
  }

  
  // Map location (current device)
  let _geoWatchId = null;
  let _meMarker = null;
  let _meCircle = null;

  function stopLocationWatch(){
    try{
      if(_geoWatchId !== null && navigator.geolocation){
        navigator.geolocation.clearWatch(_geoWatchId);
      }
    }catch(e){}
    _geoWatchId = null;
  }

  function updateMyLocation(lat, lng, accuracy){
    if(!_jobsMap) return;
    const p = [lat,lng];

    if(!_meMarker){
      _meMarker = L.circleMarker(p, {
        radius: 7,
        weight: 2,
        color: '#fff',
        fillOpacity: 1
      }).addTo(_jobsMap);

      _meCircle = L.circle(p, {
        radius: Math.max(accuracy || 25, 10),
        weight: 1,
        fillOpacity: .15
      }).addTo(_jobsMap);
    }else{
      _meMarker.setLatLng(p);
      if(_meCircle){
        _meCircle.setLatLng(p);
        _meCircle.setRadius(Math.max(accuracy || 25, 10));
      }
    }
  }

  function startLocationWatch(){
    if(!navigator.geolocation) return;
    stopLocationWatch();
    _geoWatchId = navigator.geolocation.watchPosition(
      (pos)=>{
        const { latitude, longitude, accuracy } = pos.coords || {};
        if(typeof latitude==="number" && typeof longitude==="number"){
          updateMyLocation(latitude, longitude, accuracy);
          if(!_autoCentered){
            _autoCentered = true;
            try{ _jobsMap.setView([latitude, longitude], Math.max(_jobsMap.getZoom(), 14)); }catch(e){}
          }
        }
      },
      (err)=>{ console.warn("Geolocation denied/unavailable", err); },
      { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
    );
  }

  function locateMeOnce(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const { latitude, longitude, accuracy } = pos.coords || {};
        if(typeof latitude==="number" && typeof longitude==="number"){
          updateMyLocation(latitude, longitude, accuracy);
          try{ _jobsMap.setView([latitude, longitude], Math.max(_jobsMap.getZoom(), 15)); }catch(e){}
        }
      },
      (err)=>{ console.warn("Geolocation denied/unavailable", err); },
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 }
    );
  }


function openAllJobsInGoogleMaps(){
    // Opens the full Google Maps interface (external) with your jobs as waypoints.
    // Google does NOT allow embedding the full standard Maps UI (layers, locate, etc.)
    // without using the Maps JavaScript API (requires an API key + billing), so this
    // is the closest ‚Äústandard tools‚Äù experience without a key.
    try{
      const jobs = (STATE.jobs || []).filter(j=>{
        const f = getFieldForJob(j);
        return f && isFiniteNumber(f.lat) && isFiniteNumber(f.lng);
      });
      if(!jobs.length){
        toast('No job locations to open.');
        return;
      }

      // Build a directions URL so Google Maps shows the points on the map.
      // Use first job as destination, rest as waypoints (capped by Google).
      const points = jobs.map(j=>{
        const f = getFieldForJob(j);
        return `${f.lat},${f.lng}`;
      });

      const destination = points[0];
      const waypoints = points.slice(1, Math.min(points.length, 10)).join('|'); // keep it reasonable

      const url = new URL('https://www.google.com/maps/dir/');
      url.searchParams.set('api','1');
      url.searchParams.set('origin','Current+Location');
      url.searchParams.set('destination', destination);
      if(waypoints) url.searchParams.set('waypoints', waypoints);

      window.open(url.toString(), '_blank', 'noopener');
    }catch(err){
      console.error('openAllJobsInGoogleMaps error', err);
      toast('Could not open Google Maps.');
    }
  }
function initJobsMap(){
    const el = document.getElementById('jobMap');
    if(!el) return;

    // If we re-enter map view, clean up prior map instance
    try{
      if(_jobsMap){
        _jobsMap.remove();
        _jobsMap = null;
        _jobsMapLayer = null;
      }
    }catch(e){ /* ignore */ }

    const jobs = Array.isArray(SAMPLE.jobs) ? [...SAMPLE.jobs] : [];
    const pts = [];

    jobs.forEach(j=>{
      const c = getCustomerById(j.customerId);
      const f = getFieldById(j.customerId, j.fieldId);
      const lat = Number(f?.lat ?? j.lat);
      const lng = Number(f?.lng ?? j.lng);
      if(Number.isFinite(lat) && Number.isFinite(lng)){
        pts.push([lat,lng,j]);
      }
    });

    // Default center (Nebraska-ish) if nothing has coords
    const fallback = [41.4, -99.75];
    const center = pts.length ? [pts[0][0], pts[0][1]] : fallback;

    _jobsMap = L.map(el, { zoomControl:true }).setView(center, 9);
    _autoCentered = false;

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Tiles &copy; Esri'
    }).addTo(_jobsMap);

    _jobsMapLayer = L.layerGroup().addTo(_jobsMap);

    const bounds = [];

    pts.forEach(([lat,lng,job])=>{
      const pinClass = statusToPinClass(job.status || "Open");
      const icon = L.divIcon({
        className: '',
        html: `<div class="mapPinWrap"><div class="mapPinIcon"></div><div class="mapPinDot ${pinClass}"></div></div>`,
        iconSize: [40,40],
        iconAnchor: [20,40]
      });

      const marker = L.marker([lat,lng], { icon }).addTo(_jobsMapLayer);
      bounds.push([lat,lng]);

      marker.on('click', ()=>{
        try{
          // Build popup content (bubble)
          const c = getCustomerById(job.customerId);
          const f = getFieldById(job.customerId, job.fieldId);

          const custName = (c?.name || job.customerName || "Customer");
          const fieldName = (f?.name || job.fieldName || "Field");
          const brand = (f?.brand || job.brand || "‚Äî");
          const status = (job.status || "Open");
          const desc = (job.description || "‚Äî");
          const type = (job.jobType || "Job");

          const statusClass = (
            status === "Paused" ? "purple" :
            status === "Open" ? "blue" :
            (status === "On the way" || status === "Travel") ? "orange" :
            (status === "Arrived" || status === "On Job Diagnostics" || status === "On Job Repair") ? "green" :
            "gray"
          );

          const safe = (s)=> String(s ?? "").replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
          const popupHtml = `
            <div class="mapBubble">
              <div class="top">
                <div class="title">${safe(custName)}</div>
                <div class="pill ${statusClass}">${safe(status)}</div>
              </div>
              <div class="sub">${safe(fieldName)}${brand && brand!=="‚Äî" ? ` ‚Ä¢ ${safe(brand)}` : ""}</div>
              <div class="sub">${safe(type)}</div>
              <div class="desc">${safe(desc)}</div>
              <button class="btn green mapOpenBtn" onclick="openJobFromMap('${safe(job.id)}')">Open job</button>
            </div>
          `;

          marker.bindPopup(popupHtml, { closeButton:false, autoPan:true, maxWidth: 320, className:'mapPopup' }).openPopup();

        }catch(err){
          console.error('Map pin click error', err);
        }
      });
    });

    if(bounds.length){
      try{ _jobsMap.fitBounds(bounds, { padding:[22,22] }); }catch(e){}
    }

    // Start showing current location (if user allows)
    try{ startLocationWatch(); }catch(e){}
    try{ locateMeOnce(); }catch(e){}

    // Ensure the info card starts hidden each time
    const card = document.getElementById('mapInfoCard');
    if(card) card.classList.add('hidden');
  }


  function infoBox(titleValue, innerHtml){
    return `
      <div class="infoBox">
        <div class="infoBoxTitle">${titleValue}</div>
        <div class="infoBoxBody">${innerHtml}</div>
      </div>
    `;
  }

  function infoLine(k,v){
    if(v === undefined || v === null || v === "") return "";
    return `<div class="infoLine"><div class="infoKey">${k}</div><div class="infoVal">${v}</div></div>`;
  }

function renderJobScreen(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return `
      <div class="screenTitle"><h2>Job</h2><span class="badge">Not found</span></div>
      <div class="note">No job selected.</div>
      <button class="btn stock" id="btnJobBackHome" style="margin-top:10px;">Back</button>
    `;

    const c = getCustomerById(job.customerId) || {};
    const f = getFieldById(job.customerId, job.fieldId) || {};

    const custName = c.name || job.customerName || "Customer";
    const custPhone = c.phone || job.customerPhone || "";

    const fieldName = f.name || job.fieldName || "Field";
    const fieldBrand = f.brand || job.pivotBrand || "";

    const lastReportUrl = f.lastReportUrl || f.lastJobReportUrl || "";

    // Disable "On the way" once the job is already in travel/on-site states
    const st = (job.status || "Open");
    const onWayDisabled = (st === "On the way" || st === "Travel" || st === "Arrived" || st.startsWith("On Job"));

    // Field info rows (show everything we have, without getting too noisy)
    const fieldRows = [];
    const pushRow = (label, val)=>{
      if(val === undefined || val === null || val === "") return;
      fieldRows.push(`<div class="kv"><div class="k grow">${label}</div><div class="v">${val}</div></div>`);
    };

    pushRow("Field", fieldName);
    pushRow("Brand", fieldBrand);
    if(typeof f.lat === "number" && typeof f.lng === "number") pushRow("GPS", `${f.lat}, ${f.lng}`);
    // Include any extra known fields if they exist
    ["address","county","notes","contactName","contactPhone","contactPref","serialNumber","pivotSerial","currentHours"].forEach((k)=>{
      if(f[k] !== undefined && f[k] !== null && f[k] !== "") pushRow(k.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()), f[k]);
    });

    const fieldInfoHtml = fieldRows.length ? fieldRows.join("") : `<div class="note">No field details yet.</div>`;

    return `
      <div class="screenTitle">
        <h2 style="margin:0;">Job Info</h2>
        <span class="badge">#${job.number || job.id}</span>
      </div>

      ${infoBox(custName, `
        <div class="infoBig">${custPhone ? custPhone : '<span style="opacity:.8">No phone on file</span>'}</div>
      `)}

      ${infoBox((job.jobType || "‚Äî"), `
        ${infoLine("Job #", (job.number || job.id))}
        ${infoLine("Status", (job.status || "Open"))}
        <div class="descBox" style="margin-top:10px">${job.description || "‚Äî"}</div>
      `)}

      ${infoBox(fieldName, `
        ${fieldInfoHtml}
      `)}


      <div class="card">
        <div class="cardTitle">Last Job Report</div>
        ${lastReportUrl
          ? `<div class="note" style="margin-bottom:10px;">Most recent completed report for this field.</div>
             <button class="btn stock" id="btnOpenLastReport">Open PDF</button>`
          : `<div class="note">No previous report attached for this field yet.</div>`}
      </div>

      <button class="btn openjobs" id="btnOnTheWay" ${onWayDisabled ? "disabled" : ""} style="${onWayDisabled ? "opacity:.55; cursor:not-allowed;" : ""}">
        On the way
      </button>

      <button class="btn stock" id="btnJobBack" style="margin-top:6px;">Back</button>
    `;
  }

function renderRoutePrompt(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    const c = getCustomerById(job.customerId);
    const f = getFieldById(job.customerId, job.fieldId);
    const hasCoords = (typeof f?.lat === "number" && typeof f?.lng === "number");

    return `
      <div class="screenTitle">
        <h2>Routing</h2>
        <span class="badge">On the way</span>
      </div>

      ${jobCard(job)}

      <div class="note">Route now, or skip routing. Either way, we‚Äôll start the travel screen.</div>
      <div style="height:10px"></div>

      <button class="btn openjobs" id="btnRouteMe" ${hasCoords ? "" : "disabled"} style="${hasCoords ? "" : "opacity:.55; cursor:not-allowed;"}">Route me</button>
      <button class="btn stock" id="btnSkipRouting">Skip routing</button>

      <div class="hint">${hasCoords ? "Uses field lat/lng from the dashboard." : "No lat/lng on this field (sample). Add it in customer setup."}</div>

      <button class="btn stock" id="btnRouteBack" style="margin-top:10px;">Back</button>
    `;
  }

  function renderTravel(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    return `
      <div class="screenTitle">
        <h2>Travel</h2>
        <span class="badge">En route</span>
      </div>

      ${jobCard(job)}

      <div style="height:6px"></div>
      <div class="note">When you arrive, tap the big red button.</div>

      <button class="btn refuel" id="btnArrived" style="margin-top:10px;">Arrived</button>
      <button class="btn stock" id="btnTravelBack" style="margin-top:10px;">Back</button>
    `;
  }

  function renderArrivalIntake(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    const c = getCustomerById(job.customerId);
    const f = getFieldById(job.customerId, job.fieldId);

    const knownBrand = (f?.brand || "").trim();
    const needsBrand = !knownBrand;

    return `
      <div class="screenTitle">
        <h2>Arrival Intake</h2>
        <span class="badge">Required</span>
      </div>

      ${jobCard(job)}

      <div style="height:10px"></div>

      <div class="formCard">
        ${needsBrand ? `
          <div class="field">
            <label for="aiBrand">Pivot brand (required)</label>
            <select class="select" id="aiBrand">
              <option value="">Select‚Ä¶</option>
              <option value="Reinke">Reinke</option>
              <option value="Valley">Valley</option>
              <option value="Zimmatic">Zimmatic</option>
              <option value="T&L">T&L</option>
              <option value="Other">Other</option>
            </select>
          </div>
        ` : `
          <div class="field">
            <label>Pivot brand</label>
            <input class="input" value="${knownBrand}" disabled />
          </div>
        `}

        <div class="field" id="aiSerialWrap" style="display:none;">
          <label for="aiSerial">Serial number (Reinke only)</label>
          <input class="input" id="aiSerial" placeholder="Serial number‚Ä¶"/>
        </div>

        <div class="field">
          <label for="aiHours">Current hours (required)</label>
          <input class="input" id="aiHours" type="number" inputmode="numeric" min="0" placeholder="0"/>
        </div>

        <button class="submitBtn" id="aiSave" disabled>Save Intake</button>
        <div class="hint">After saving, we‚Äôll open the job screen and start diagnostics.</div>
      </div>

      <button class="btn stock" id="btnArrivalBack" style="margin-top:10px;">Back</button>
    `;
  }

  function wireArrivalIntake(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return;

    const field = getFieldById(job.customerId, job.fieldId);
    const knownBrand = (field?.brand || "").trim();
    const needsBrand = !knownBrand;

    const brandSel = document.getElementById('aiBrand');
    const serialWrap = document.getElementById('aiSerialWrap');
    const serial = document.getElementById('aiSerial');
    const hours = document.getElementById('aiHours');
    const save = document.getElementById('aiSave');

    function activeBrand(){
      return needsBrand ? (brandSel?.value || "").trim() : knownBrand;
    }

    function setEnabled(on){
      save.disabled = !on;
      save.classList.toggle('enabled', on);
    }

    function updateSerialVisibility(){
      const b = activeBrand();
      const isReinke = (b === "Reinke");
      if(serialWrap) serialWrap.style.display = isReinke ? "block" : "none";
      if(!isReinke && serial) serial.value = "";
    }

    function validate(){
      const b = activeBrand();
      const h = (hours?.value || "").trim();
      if(needsBrand && !b) return setEnabled(false);
      if(!h || Number(h) < 0) return setEnabled(false);
      // serial not required; just shown for Reinke
      return setEnabled(true);
    }

    if(brandSel){
      brandSel.addEventListener('change', ()=>{
        updateSerialVisibility();
        validate();
      });
    }
    if(hours){
      hours.addEventListener('input', validate);
      hours.addEventListener('change', validate);
    }
    if(serial){
      serial.addEventListener('input', validate);
      serial.addEventListener('change', validate);
    }

    updateSerialVisibility();
    validate();

    if(save){
      save.addEventListener('click', ()=>{
        if(save.disabled) return;

        const b = activeBrand();
        // Store intake onto job (sample)
        job.arrival = {
          brand: b,
          serial: (serial?.value || "").trim(),
          hours: Number((hours?.value || "0").trim())
        };

        // Update status timestamps
        setJobStatus(job, "On Job Diagnostics");
        show('diagnostics_choice');
      });
    }
  }
function renderSettings(){
    return `
      <div class="screenTitle">
        <h2>Settings</h2>
        <span class="badge">Placeholders</span>
      </div>
      <div class="note">When you tell me a new *setting*, I‚Äôll add a spot for it here.</div>

      <div class="item">
        <div class="itemTitle">Tech</div>
        <div class="itemSub">${SAMPLE.techName}</div>
      </div>

      <div class="item">
        <div class="itemTitle">Truck</div>
        <div class="itemSub">${STATE.truckId}</div>
      </div>

      <div class="item">
        <div class="itemTitle">Helpers</div>
        <div class="itemSub">${STATE.helpers.length ? STATE.helpers.join(", ") : "None"}</div>
        <div class="pills"><span class="pill">Tap tech name to edit</span></div>
      </div>
    `;
  }

  
  /* ===================== Create Job (looks-first) ===================== */

  function renderDiagnosticsChoice(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    return `
      <div class="screenTitle">
        <h2>Diagnostics</h2>
        <span class="badge">On Job Diagnostics</span>
      </div>

      ${jobCard(job)}

      <div class="card">
        <div class="cardTitle">Diagnostics Help</div>
        <div class="note">We‚Äôll wire the workflow builder next. For now, this just renders the button.</div>
        <div style="height:10px"></div>
        <button class="btn openjobs" id="btnUseDiagHelp">Use diagnostics help</button>
        <button class="btn stock" id="btnSkipDiagHelp" style="margin-top:8px;">Skip diagnostics help</button>
      </div>

      <button class="btn stock" id="btnDiagChoiceBack" style="margin-top:10px;">Back</button>
    `;
  }

  function wireDiagnosticsChoice(){
    const use = document.getElementById('btnUseDiagHelp');
    const skip = document.getElementById('btnSkipDiagHelp');
    const back = document.getElementById('btnDiagChoiceBack');

    if(use) use.addEventListener('click', ()=>{
      toast('Diagnostics Help (workflow builder) will be wired next.');
    });
    if(skip) skip.addEventListener('click', ()=> show('diagnostics_screen'));
    if(back) back.addEventListener('click', ()=> show('BACK'));
  }

  function renderDiagnosticsScreen(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    job.diagnosticsChecks = Array.isArray(job.diagnosticsChecks) ? job.diagnosticsChecks : [];

    const checksHtml = job.diagnosticsChecks.length
      ? job.diagnosticsChecks.map((c, idx)=>`
          <div class="card" style="margin-top:10px;">
            <div class="cardTitle">Check #${idx+1}</div>
            <div class="kv"><div class="k grow">What checked</div><div class="v">${escapeHtml(c.desc || "‚Äî")}</div></div>
            <div class="kv"><div class="k grow">Result</div><div class="v">${escapeHtml(c.result || "‚Äî")}</div></div>
            <button class="btn stock tiny" data-remove-check="${idx}" style="margin-top:10px;">Remove</button>
          </div>
        `).join("")
      : `<div class="note">No checks added yet.</div>`;

    return `
      <div class="screenTitle">
        <h2>Diagnostics Checks</h2>
        <span class="badge">Notes</span>
      </div>

      ${jobCard(job)}

      <div class="card">
        <div class="cardTitle">Add a Check</div>
        <div class="note" style="margin-bottom:10px;">Add as many as you want. Example: Checked fuses in MCP ‚Üí Found one blown.</div>

        <div class="field">
          <div class="label">What was checked</div>
          <input id="chkDesc" class="input" placeholder="e.g., Checked fuses in main control panel" />
        </div>

        <div class="field">
          <div class="label">Result</div>
          <textarea id="chkResult" class="input" rows="3" placeholder="e.g., Found one fuse blown"></textarea>
        </div>

        <button class="btn openjobs" id="btnAddCheck" style="margin-top:10px;">Add check</button>
      </div>

      ${checksHtml}

      <div style="height:12px"></div>
      <button class="btn openjobs" id="btnFoundProblem">Found problem</button>
      <button class="btn purple" id="btnPauseJob" style="margin-top:8px;">Pause job</button>
      <button class="btn stock" id="btnDiagBack" style="margin-top:10px;">Back</button>
    `;
  }

  function wireDiagnosticsScreen(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return;

    job.diagnosticsChecks = Array.isArray(job.diagnosticsChecks) ? job.diagnosticsChecks : [];

    const add = document.getElementById('btnAddCheck');
    if(add) add.addEventListener('click', ()=>{
      const desc = (document.getElementById('chkDesc')?.value || "").trim();
      const result = (document.getElementById('chkResult')?.value || "").trim();
      if(!desc){ toast('Enter what you checked.'); return; }
      job.diagnosticsChecks.push({ desc, result });
      show('diagnostics_screen');
    });

    document.querySelectorAll('[data-remove-check]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = parseInt(btn.getAttribute('data-remove-check'), 10);
        if(Number.isFinite(idx)) job.diagnosticsChecks.splice(idx,1);
        show('diagnostics_screen');
      });
    });

    const pause = document.getElementById('btnPauseJob');
    if(pause) pause.addEventListener('click', ()=>{
      startPauseFlow('diagnostics_screen');
    });

    const found = document.getElementById('btnFoundProblem');
    if(found) found.addEventListener('click', ()=>{
      show('found_problem');
    });

    const back = document.getElementById('btnDiagBack');
    if(back) back.addEventListener('click', ()=> show('BACK'));
  }



  function renderFoundProblem(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    const existing = (job.foundProblemDesc || "").trim();

    return `
      <div class="screenTitle">
        <h2>Found Problem</h2>
        <span class="badge">Required</span>
      </div>

      ${jobCard(job)}

      <div class="card">
        <div class="cardTitle">Describe the problem found</div>
        <div class="note" style="margin-bottom:10px;">Required. Keep it short and clear.</div>

        <div class="field">
          <div class="label">Problem found</div>
          <textarea id="fpDesc" class="input" rows="4" placeholder="e.g., Main control panel fuse blown; replaced 20A and restored power.">${escapeHtml(existing)}</textarea>
        </div>

        <button class="btn openjobs" id="btnFPSave" style="margin-top:10px;">Save</button>
        <button class="btn purple" id="btnFPPause" style="margin-top:8px;">Pause job</button>
      </div>

      <button class="btn stock" id="btnFPBack" style="margin-top:10px;">Back</button>
    `;
  }

  function wireFoundProblem(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return;

    const back = document.getElementById('btnFPBack');
    if(back) back.addEventListener('click', ()=> show('BACK'));

    const pause = document.getElementById('btnFPPause');
    if(pause) pause.addEventListener('click', ()=> startPauseFlow('found_problem'));

    const save = document.getElementById('btnFPSave');
    if(save) save.addEventListener('click', ()=>{
      const desc = (document.getElementById('fpDesc')?.value || "").trim();
      if(!desc){ toast('Problem description is required.'); return; }
      job.foundProblemDesc = desc;
      // Next step: repair screen
      setJobStatus(job, "On Job Repair");
      show('repair_screen');
    });
  }

  // Placeholder repair screen (we will build next)
  
  function msToHMS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = s%60;
    const pad = (n)=> String(n).padStart(2,'0');
    return (h>0 ? `${h}:${pad(m)}:${pad(ss)}` : `${m}:${pad(ss)}`);
  }

  function computeStatusDurations(job){
    const out = [];
    const hist = Array.isArray(job.statusHistory) ? job.statusHistory : [];
    for(const entry of hist){
      if(!entry || !entry.status || !entry.start) continue;
      const start = Date.parse(entry.start);
      const end = entry.end ? Date.parse(entry.end) : Date.now();
      if(!Number.isFinite(start) || !Number.isFinite(end)) continue;
      out.push({ status: entry.status, ms: Math.max(0, end-start) });
    }
    return out;
  }

  
  function renderJobOutline(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderOpenJobs();

    const editMode = !!STATE.outlineEditMode;

    job.diagnosticsChecks = Array.isArray(job.diagnosticsChecks) ? job.diagnosticsChecks : [];
    job.partsUsed = Array.isArray(job.partsUsed) ? job.partsUsed : [];

    const durations = computeStatusDurations(job);
    const durRows = durations.length ? durations.map(d=>`
      <div class="kv">
        <div class="k grow">${escapeHtml(d.status)}</div>
        <div class="v">${msToHMS(d.ms)}</div>
      </div>
    `).join("") : `<div class="note">No status timing recorded.</div>`;

    // Problem Found
    const problemField = editMode
      ? `<textarea id="olProblem" class="input" rows="4" placeholder="Describe the problem found...">${escapeHtml(job.foundProblemDesc || "")}</textarea>`
      : `<div class="descBox">${escapeHtml(job.foundProblemDesc || "‚Äî")}</div>`;

    // Diagnostics rows
    const diagRows = job.diagnosticsChecks.length
      ? job.diagnosticsChecks.map((c, i)=>{
          if(editMode){
            return `
              <div class="card" style="margin-top:10px;">
                <div class="cardTitle">Diagnostics #${i+1}</div>
                <div class="field">
                  <div class="label">What checked</div>
                  <input class="input" id="olDiagDesc_${i}" value="${escapeHtml(c.desc || "")}" />
                </div>
                <div class="field">
                  <div class="label">Result</div>
                  <textarea class="input" rows="3" id="olDiagRes_${i}">${escapeHtml(c.result || "")}</textarea>
                </div>
                <button class="btn stock" data-ol-remove-diag="${i}" style="margin-top:10px;">Remove</button>
              </div>
            `;
          }
          return `
            <div class="kv inlineRow">
              <div class="k grow">${escapeHtml(c.desc || "Check")}</div>
              <div class="v">${escapeHtml(c.result || "‚Äî")}</div>
            </div>
          `;
        }).join("")
      : `<div class="note">No diagnostics checks recorded.</div>`;

    const diagAdd = editMode ? `
      <div class="card" style="margin-top:10px;">
        <div class="cardTitle">Add Diagnostics Check</div>
        <div class="field">
          <div class="label">What checked</div>
          <input id="olNewDiagDesc" class="input" placeholder="e.g., Checked fuses in MCP" />
        </div>
        <div class="field">
          <div class="label">Result</div>
          <textarea id="olNewDiagRes" class="input" rows="3" placeholder="e.g., Found one fuse blown"></textarea>
        </div>
        <button class="btn openjobs" id="btnOlAddDiag" style="margin-top:10px;">Add</button>
      </div>
    ` : ``;

    // Parts rows
    const partsRows = job.partsUsed.length
      ? job.partsUsed.map((p, i)=>{
          const purchased = !!p.purchased;
          if(editMode){
            return `
              <div class="card" style="margin-top:10px;">
                <div class="cardTitle">Part #${i+1}</div>

                <div class="field">
                  <div class="label">Part</div>
                  <input class="input" id="olPartName_${i}" value="${escapeHtml(p.name || "")}" />
                </div>

                <div class="field">
                  <div class="label">Qty</div>
                  <input class="input" id="olPartQty_${i}" value="${escapeHtml(p.qty ?? "")}" />
                </div>

                <label class="checkRow" style="margin-top:8px;">
                  <input type="checkbox" id="olPartPurchased_${i}" ${purchased ? "checked" : ""} />
                  <div class="checkText">Purchased</div>
                </label>

                <div class="field" id="olPartCostWrap_${i}" style="${purchased ? "" : "display:none;"}">
                  <div class="label">Cost</div>
                  <input class="input" id="olPartCost_${i}" value="${escapeHtml(p.cost ?? "")}" placeholder="e.g., 38.50" />
                </div>

                <button class="btn stock" class="btn stock tiny" data-ol-remove-part="${i}" style="margin-top:10px;">Remove</button>
              </div>
            `;
          }

          return `
            <div class="kv inlineRow">
              <div class="k grow">${escapeHtml(p.name || "Part")}</div>
              <div class="v">
                <div>Qty: <span class="pill">${escapeHtml(p.qty ?? "")}</span></div>
                ${p.purchased ? `<div style="margin-top:6px;">Purchased: <span class="pill green">Yes</span></div>` : ``}
                ${p.purchased ? `<div style="margin-top:6px;">Cost: <span class="pill">${escapeHtml(p.cost ?? "")}</span></div>` : ``}
              </div>
            </div>
          `;
        }).join("")
      : `<div class="note">No parts recorded.</div>`;

    const partsAdd = editMode ? `
      <div class="card" style="margin-top:10px;">
        <div class="cardTitle">Add Part</div>
        <div class="field">
          <div class="label">Part</div>
          <input id="olNewPartName" class="input" placeholder="Part name" />
        </div>
        <div class="field">
          <div class="label">Qty</div>
          <input id="olNewPartQty" class="input" placeholder="1" />
        </div>
        <label class="checkRow" style="margin-top:8px;">
          <input type="checkbox" id="olNewPartPurchased" />
          <div class="checkText">Purchased</div>
        </label>
        <div class="field" id="olNewPartCostWrap" style="display:none;">
          <div class="label">Cost</div>
          <input id="olNewPartCost" class="input" placeholder="e.g., 38.50" />
        </div>
        <button class="btn openjobs" id="btnOlAddPart" style="margin-top:10px;">Add</button>
      </div>
    ` : ``;

    return `
      <div class="screenTitle">
        <h2>Job Outline</h2>
        <span class="badge">Finished</span>
      </div>

      ${jobCard(job)}

      <div class="card">
        <div class="cardTitle">Problem Found</div>
        ${problemField}
      </div>

      <div class="card">
        <div class="cardTitle">Diagnostics</div>
        ${diagRows}
      </div>
      ${diagAdd}

      <div class="card">
        <div class="cardTitle">Parts Used</div>
        ${partsRows}
      </div>
      ${partsAdd}

      <div class="card">
        <div class="cardTitle">Time by Status</div>
        ${durRows}
      </div>

      <div class="card">
        <div class="cardTitle">Review</div>
        <div class="note">Confirm to submit to the office dashboard for invoicing.</div>
        ${editMode
          ? `<button class="btn openjobs" id="btnOutlineSave" style="margin-top:10px;">Save changes</button>
             <button class="btn stock" id="btnOutlineCancel" style="margin-top:8px;">Cancel</button>`
          : `<button class="btn openjobs" id="btnOutlineConfirm" style="margin-top:10px;">Confirm</button>
             <button class="btn stock" id="btnOutlineEdit" style="margin-top:8px;">Edit</button>`
        }
      </div>

      <button class="btn stock" id="btnOutlineBack" style="margin-top:10px;">Back</button>
    `;
  }

  function wireJobOutline(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return;

    job.diagnosticsChecks = Array.isArray(job.diagnosticsChecks) ? job.diagnosticsChecks : [];
    job.partsUsed = Array.isArray(job.partsUsed) ? job.partsUsed : [];

    const back = document.getElementById('btnOutlineBack');
    if(back) back.onclick = ()=> show('BACK');

    const edit = document.getElementById('btnOutlineEdit');
    if(edit) edit.onclick = ()=>{
      STATE.outlineEditMode = true;
      show('job_outline');
    };

    const cancel = document.getElementById('btnOutlineCancel');
    if(cancel) cancel.onclick = ()=>{
      STATE.outlineEditMode = false;
      show('job_outline');
    };

    // Inline edit interactions
    if(STATE.outlineEditMode){
      // Toggle cost field visibility when purchased is toggled
      job.partsUsed.forEach((p, i)=>{
        const chk = document.getElementById(`olPartPurchased_${i}`);
        const wrap = document.getElementById(`olPartCostWrap_${i}`);
        if(chk && wrap){
          chk.onchange = ()=> { wrap.style.display = chk.checked ? "" : "none"; };
        }
      });

      const np = document.getElementById('olNewPartPurchased');
      const npWrap = document.getElementById('olNewPartCostWrap');
      if(np && npWrap){
        np.onchange = ()=> { npWrap.style.display = np.checked ? "" : "none"; };
      }

      // Remove diag
      document.querySelectorAll('[data-ol-remove-diag]').forEach(btn=>{
        btn.onclick = ()=>{
          const idx = parseInt(btn.getAttribute('data-ol-remove-diag'), 10);
          if(Number.isFinite(idx)) job.diagnosticsChecks.splice(idx,1);
          show('job_outline');
        };
      });

      // Remove part (note: outline editing does not restore truck inventory; it's a review screen)
      document.querySelectorAll('[data-ol-remove-part]').forEach(btn=>{
        btn.onclick = ()=>{
          const idx = parseInt(btn.getAttribute('data-ol-remove-part'), 10);
          if(Number.isFinite(idx)) job.partsUsed.splice(idx,1);
          show('job_outline');
        };
      });

      // Add diag
      const addDiag = document.getElementById('btnOlAddDiag');
      if(addDiag) addDiag.onclick = ()=>{
        const desc = (document.getElementById('olNewDiagDesc')?.value || "").trim();
        const res = (document.getElementById('olNewDiagRes')?.value || "").trim();
        if(!desc){ toast('Enter what was checked.'); return; }
        job.diagnosticsChecks.push({ desc, result: res });
        show('job_outline');
      };

      // Add part
      const addPart = document.getElementById('btnOlAddPart');
      if(addPart) addPart.onclick = ()=>{
        const name = (document.getElementById('olNewPartName')?.value || "").trim();
        const qty = (document.getElementById('olNewPartQty')?.value || "").trim();
        const purchased = !!document.getElementById('olNewPartPurchased')?.checked;
        const cost = (document.getElementById('olNewPartCost')?.value || "").trim();
        if(!name){ toast('Enter part name.'); return; }
        job.partsUsed.push({ name, qty, purchased, cost: purchased ? cost : "" });
        show('job_outline');
      };
    }

    const save = document.getElementById('btnOutlineSave');
    if(save) save.onclick = ()=>{
      // Save all edited fields without leaving the outline screen
      const prob = (document.getElementById('olProblem')?.value || "").trim();
      job.foundProblemDesc = prob;

      // Save diagnostics edits
      if(STATE.outlineEditMode){
        job.diagnosticsChecks = job.diagnosticsChecks.map((c, i)=>{
          const d = (document.getElementById(`olDiagDesc_${i}`)?.value || "").trim();
          const r = (document.getElementById(`olDiagRes_${i}`)?.value || "").trim();
          return { desc: d, result: r };
        }).filter(x=> x.desc); // drop blanks

        // Save parts edits
        job.partsUsed = job.partsUsed.map((p, i)=>{
          const name = (document.getElementById(`olPartName_${i}`)?.value || "").trim();
          const qty = (document.getElementById(`olPartQty_${i}`)?.value || "").trim();
          const purchased = !!document.getElementById(`olPartPurchased_${i}`)?.checked;
          const cost = (document.getElementById(`olPartCost_${i}`)?.value || "").trim();
          return { ...p, name, qty, purchased, cost: purchased ? cost : "" };
        }).filter(x=> x.name);
      }

      STATE.outlineEditMode = false;
      toast('Changes saved.');
      show('job_outline');
    };

    const confirm = document.getElementById('btnOutlineConfirm');
    if(confirm) confirm.onclick = ()=>{
      job.submittedForInvoiceAt = nowISO();
      toast('Submitted for invoicing.');
      STATE.outlineEditMode = false;
      show('home');
    };
  }


function renderRepairScreen(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    // Init job repair data
    job.repair = job.repair || { usedParts: [] };
    job.repair.usedParts = Array.isArray(job.repair.usedParts) ? job.repair.usedParts : [];

    const inv = (SAMPLE.truckInventory && SAMPLE.truckInventory[STATE.truckId]) ? SAMPLE.truckInventory[STATE.truckId] : [];
    const invOptions = inv.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (avail ${p.qty})</option>`).join("");

    const usedHtml = job.repair.usedParts.length
      ? job.repair.usedParts.map((p, idx)=>`
          <div class="card" style="margin-top:10px;">
            <div class="cardTitle partHeaderRow">
              <span>${escapeHtml(p.name)}</span>
              <span class="partHeaderRight">
                <span class="badge">x${p.qty}</span>
                <button
                  class="btn stock microRemove"
                  type="button"
                  data-remove-part="${idx}"
                  title="Remove part">‚úï</button>
              </span>
            </div>
            <div class="note">${p.source === 'truck' ? `From truck stock (${STATE.truckId})` : 'Added part'}</div>
            ${p.purchased ? `<div class="note" style="margin-top:6px;font-weight:800;">Purchased ‚Ä¢ Cost: $${escapeHtml(p.cost || '0')}</div>` : ``}
          </div>
        `).join("")
      : `<div class="note">No parts added yet.</div>`;

    return `
      <div class="screenTitle">
        <h2>Repair</h2>
        <span class="badge">${job.status || "On Job Repair"}</span>
      </div>

      ${jobCard(job)}

      <div class="card">
        <div class="cardTitle">Truck Inventory</div>
        <div class="note">Select a part and quantity. This deducts from the current truck qty.</div>

        <div class="field">
          <div class="label">Part</div>
          <select id="invPart" class="input">
            ${invOptions || `<option value="">No inventory loaded</option>`}
          </select>
        </div>

        <div class="field">
          <div class="label">Qty</div>
          <input id="invQty" type="number" min="1" value="1" class="input" />
        </div>

        <button class="btn openjobs" id="btnAddFromTruck" style="margin-top:10px;">Add from truck</button>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="cardTitle">Add a Part</div>
        <div class="note">Free text add. Check ‚ÄúPurchased‚Äù to enter cost.</div>

        <div class="field">
          <div class="label">Part name</div>
          <input id="addPartName" class="input" placeholder="e.g., 3/4&quot; hose clamp" />
        </div>

        <div class="field">
          <div class="label">Qty</div>
          <input id="addPartQty" type="number" min="1" value="1" class="input" />
        </div>

        <div class="field" style="display:flex;align-items:center;gap:10px;">
          <input id="addPurchased" type="checkbox" />
          <div class="label" style="margin:0;">Purchased</div>
        </div>

        <div class="field" id="costWrap" style="display:none;">
          <div class="label">Cost</div>
          <input id="addCost" type="number" min="0" step="0.01" class="input" placeholder="0.00" />
        </div>

        <button class="btn openjobs" id="btnAddCustomPart" style="margin-top:10px;">Add part</button>
      </div>

      <div class="sectionTitle" style="margin-top:14px;">Parts Used</div>
      ${usedHtml}

      <div style="height:12px"></div>
      <button class="btn openjobs" id="btnRepairComplete">Repair complete</button>
      <button class="btn purple" id="btnPauseJobRepair" style="margin-top:8px;">Pause job</button>
      <button class="btn stock" id="btnRepairBack" style="margin-top:10px;">Back</button>
    `;
  }

  function wireRepairScreen(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return;

    job.repair = job.repair || { usedParts: [] };
    job.repair.usedParts = Array.isArray(job.repair.usedParts) ? job.repair.usedParts : [];

    const inv = (SAMPLE.truckInventory && SAMPLE.truckInventory[STATE.truckId]) ? SAMPLE.truckInventory[STATE.truckId] : [];

    const purchased = document.getElementById('addPurchased');
    const costWrap = document.getElementById('costWrap');
    if(purchased && costWrap){
      purchased.onchange = ()=>{ costWrap.style.display = purchased.checked ? 'block' : 'none'; };
    }

    const addTruck = document.getElementById('btnAddFromTruck');
    if(addTruck) addTruck.onclick = ()=>{
      const partId = (document.getElementById('invPart')?.value || '').trim();
      const qty = parseInt(document.getElementById('invQty')?.value || '1', 10);
      if(!partId){ toast('Select a part.'); return; }
      if(!Number.isFinite(qty) || qty < 1){ toast('Enter qty (1+).'); return; }

      const part = inv.find(p => p.id === partId);
      if(!part){ toast('Part not found in inventory.'); return; }
      if(part.qty < qty){ toast(`Not enough on truck. Available: ${part.qty}`); return; }

      // Deduct inventory
      part.qty -= qty;

      // Add to job repair list (merge if same part from truck)
      const existing = job.repair.usedParts.find(x => x.source==='truck' && x.partId===partId);
      if(existing){ existing.qty += qty; }
      else job.repair.usedParts.push({ source:'truck', partId, name: part.name, qty });

      show('repair_screen');
    };

    const addCustom = document.getElementById('btnAddCustomPart');
    if(addCustom) addCustom.onclick = ()=>{
      const name = (document.getElementById('addPartName')?.value || '').trim();
      const qty = parseInt(document.getElementById('addPartQty')?.value || '1', 10);
      const isPurchased = !!document.getElementById('addPurchased')?.checked;
      const costVal = (document.getElementById('addCost')?.value || '').trim();

      if(!name){ toast('Enter part name.'); return; }
      if(!Number.isFinite(qty) || qty < 1){ toast('Enter qty (1+).'); return; }

      if(isPurchased){
        if(costVal === '' || isNaN(Number(costVal))){ toast('Enter cost.'); return; }
      }

      job.repair.usedParts.push({
        source:'added',
        name,
        qty,
        purchased: isPurchased,
        cost: isPurchased ? Number(costVal).toFixed(2) : ""
      });

      show('repair_screen');
    };

    document.querySelectorAll('[data-remove-part]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = parseInt(btn.getAttribute('data-remove-part'), 10);
        if(!Number.isFinite(idx)) return;
        const removed = job.repair.usedParts[idx];
        if(!removed) return;

        // Restore inventory if from truck
        if(removed.source === 'truck' && removed.partId){
          const part = inv.find(p => p.id === removed.partId);
          if(part) part.qty += (removed.qty || 0);
        }

        job.repair.usedParts.splice(idx, 1);
        show('repair_screen');
      };
    });

    const pause = document.getElementById('btnPauseJobRepair');
    if(pause) pause.onclick = ()=> startPauseFlow('repair_screen');

    const back = document.getElementById('btnRepairBack');
    if(back) back.onclick = ()=> show('BACK');

    const done = document.getElementById('btnRepairComplete');
    if(done) done.onclick = ()=>{
      // Next: required closeout checklist
      show('closeout_checklist');
    };
  }
  
  function renderCloseoutChecklist(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderJobScreen();

    job.closeout = job.closeout || { a:false, b:false, c:false, d:false, e:false };
    job.closeoutUnable = job.closeoutUnable || { a:false, b:false, c:false, d:false, e:false };
    job.closeoutUnableReasons = job.closeoutUnableReasons || { a:"", b:"", c:"", d:"", e:"" };

    const ok = (k)=> !!job.closeout[k] || (!!job.closeoutUnable[k] && (job.closeoutUnableReasons[k]||"").trim().length>0);
    const all = ok('a') && ok('b') && ok('c') && ok('d') && ok('e');

    const chk = (k)=> job.closeout[k] ? "checked" : "";
    const unablePill = (k)=> job.closeoutUnable[k] ? `<span class="pill" style="margin-left:8px;">Unable</span>` : "";
    const reasonLine = (k)=> (job.closeoutUnable[k] && (job.closeoutUnableReasons[k]||"").trim())
      ? `<div class="note" style="margin-top:6px; opacity:.9;">Reason: ${escapeHtml(job.closeoutUnableReasons[k])}</div>`
      : ``;

    const row = (k, id, label)=>`
      <div class="checkRow" style="align-items:flex-start;">
        <input type="checkbox" id="${id}" ${chk(k)} />
        <div class="checkText" style="flex:1;">
          ${label}${unablePill(k)}
          ${reasonLine(k)}
        </div>
        <button class="btn stock unableBtn" data-unable="${k}" type="button">Unable</button>
      </div>
    `;

    return `
      <div class="screenTitle">
        <h2>Closeout Checklist</h2>
        <span class="badge">Required</span>
      </div>

      ${jobCard(job)}

      <div class="card">
        <div class="cardTitle">Checklist</div>

        ${row('a','chkA','Verify all components are tight, secured and in factory appearance')}
        ${row('b','chkB','Select system direction from MCP-Set Timer setting to %80-Start Sytem')}
        ${row('c','chkC','Visually confirm the 1st tower has moved 3 or more times')}
        ${row('d','chkD','Contact customer, or supervisor if system needs to be left running-be sure to ask direction and speed if left running is to be desired')}
        ${row('e','chkE','Leave running or shut down system and disconnect incoming power to the MCP')}

        <button class="btn openjobs" id="btnFinishJob" style="margin-top:12px;${all ? "" : "opacity:.5; pointer-events:none;"}">Finish job</button>
      </div>

      <button class="btn stock" id="btnCloseoutBack" style="margin-top:10px;">Back</button>
    `;
  }


  
  
  function wireCloseoutChecklist(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return;

    job.closeout = job.closeout || { a:false, b:false, c:false, d:false, e:false };
    job.closeoutUnable = job.closeoutUnable || { a:false, b:false, c:false, d:false, e:false };
    job.closeoutUnableReasons = job.closeoutUnableReasons || { a:"", b:"", c:"", d:"", e:"" };

    const bindChk = (k, id)=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.onchange = ()=>{
        job.closeout[k] = !!el.checked;
        if(job.closeout[k]){
          job.closeoutUnable[k] = false;
          job.closeoutUnableReasons[k] = "";
        }
        show('closeout_checklist');
      };
    };
    bindChk('a','chkA'); bindChk('b','chkB'); bindChk('c','chkC'); bindChk('d','chkD'); bindChk('e','chkE');

    document.querySelectorAll('[data-unable]').forEach(btn=>{
      btn.onclick = ()=>{
        const k = btn.getAttribute('data-unable');
        STATE.unableKey = k;
        STATE.unableReasonDraft = job.closeoutUnableReasons[k] || '';
        openUnableModal();
      };
    });

    const back = document.getElementById('btnCloseoutBack');
    if(back) back.onclick = ()=> show('BACK');

    const finish = document.getElementById('btnFinishJob');
    if(finish) finish.onclick = ()=>{
      setJobStatus(job, "Finished");
      if(Array.isArray(job.statusHistory) && job.statusHistory.length){
        const last = job.statusHistory[job.statusHistory.length-1];
        if(last && !last.end) last.end = nowISO();
      }
      show('job_outline');
    };
  }

function openUnableModal(){
    if(!STATE._unableModalWired){ try{ wireUnableModal(); STATE._unableModalWired = true; }catch(e){} }
    const modal = document.getElementById('unableModal');
    if(!modal) return;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    const reason = document.getElementById('unableReason');
    if(reason){ reason.value = (STATE.unableReasonDraft || ''); reason.focus(); }
  }
  function closeUnableModal(){
    const modal = document.getElementById('unableModal');
    if(!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    STATE.unableReasonDraft = '';
    STATE.unableKey = null;
  }
  function wireUnableModal(){
    const modal = document.getElementById('unableModal');
    if(!modal) return;

    const btnCancel = document.getElementById('btnUnableCancel');
    const btnSave = document.getElementById('btnUnableSave');
    const btnX = document.getElementById('unableModalX');
    const reasonEl = document.getElementById('unableReason');

    function onCancel(){ closeUnableModal(); }
    function onSave(){
      const job = getJobById(STATE.currentJobId);
      if(!job) { closeUnableModal(); return; }
      const k = STATE.unableKey;
      const reason = (reasonEl?.value || '').trim();
      if(!reason){ toast('Reason is required.'); return; }
      job.closeoutUnable = job.closeoutUnable || {};
      job.closeoutUnableReasons = job.closeoutUnableReasons || {};
      job.closeoutUnable[k] = true;
      job.closeoutUnableReasons[k] = reason;
      closeUnableModal();
      show('closeout_checklist');
    }

    if(btnCancel) btnCancel.onclick = onCancel;
    if(btnX) btnX.onclick = onCancel;
    if(btnSave) btnSave.onclick = onSave;

    modal.addEventListener('click', (e)=>{ if(e.target === modal) onCancel(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.classList.contains('show')) onCancel(); });
  }

function openPauseModal(){
    if(!STATE._pauseModalWired){ try{ wirePauseModal(); STATE._pauseModalWired = true; }catch(e){} }

    const modal = document.getElementById('pauseModal');
    if(!modal) return;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    const reason = document.getElementById('pauseReason');
    if(reason){ reason.value = ''; reason.focus(); }
  }

  function closePauseModal(){
    const modal = document.getElementById('pauseModal');
    if(!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
  }

  function wireRestockModal(){
    const modal = document.getElementById('restockModal');
    if(!modal) return;

    const x = document.getElementById('restockModalX');
    if(x) x.addEventListener('click', closeRestockModal);

    const cancel = document.getElementById('btnRestockCancel');
    if(cancel) cancel.addEventListener('click', closeRestockModal);

    const save = document.getElementById('btnRestockSave');
    if(save) save.addEventListener('click', ()=>{
      const pn = modal.getAttribute('data-pn');
      const qtyInput = document.getElementById('restockQty');
      const add = Math.max(0, Number(qtyInput ? qtyInput.value : 0) || 0);
      if(pn && add > 0){
        STATE.restockAdds[pn] = (Number(STATE.restockAdds[pn]||0) + add);
      }
      closeRestockModal();
      show('restock');
    });

    const oos = document.getElementById('btnRestockOOS');
    if(oos) oos.addEventListener('click', ()=>{
      const pn = modal.getAttribute('data-pn');
      const part = (SAMPLE.truckParts||[]).find(x=>x.pn===pn);
      if(pn){
        // Keep simple: just store pn/desc and time
        const item = { pn, desc: part ? part.desc : "", at: new Date().toISOString() };
        STATE.outOfStockParts = Array.isArray(STATE.outOfStockParts) ? STATE.outOfStockParts : [];
        STATE.outOfStockParts.unshift(item);
      }
      closeRestockModal();
      show('restock');
    });

    // Click outside closes
    modal.addEventListener('click', (e)=>{
      if(e.target === modal) closeRestockModal();
    });
  }


  function wirePauseModal(){
    const modal = document.getElementById('pauseModal');
    if(!modal) return;

    const btnNo = document.getElementById('btnPauseNo');
    const btnYes = document.getElementById('btnPauseYes');
    const btnX = document.getElementById('pauseModalX');
    const reasonEl = document.getElementById('pauseReason');

    function onNo(){
      // No = just close box; keep screen as-is
      closePauseModal();
    }

    function onYes(){
      const job = getJobById(STATE.currentJobId);
      if(!job) { closePauseModal(); return; }
      const reason = (reasonEl?.value || '').trim();
      if(!reason){ toast('Pause reason is required.'); return; }
      job.pauseReason = reason;
      job.pausedFromView = (STATE.pauseReturnView || currentView || "job_screen");
      job.pausedFromStatus = job.status;
      setJobStatus(job, "Paused");
      closePauseModal();
      toast('Job paused.');
      show('open_jobs');
    }

    if(btnNo) btnNo.onclick = onNo;
    if(btnX) btnX.onclick = onNo;
    if(btnYes) btnYes.onclick = onYes;

    // Click outside closes (acts like No)
    modal.addEventListener('click', (e)=>{
      if(e.target === modal) onNo();
    });

    // ESC closes
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && modal.classList.contains('show')) onNo();
    });
  }

function startPauseFlow(returnView){
    // Store where we were so "No" just closes and keeps progress visible
    STATE.pauseReturnView = returnView || currentView || 'job_screen';
    openPauseModal();
  }


  function renderResumeChoice(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return renderOpenJobs();

    return `
      <div class="screenTitle">
        <h2>Arrived</h2>
        <span class="badge">Paused job</span>
      </div>

      ${jobCard(job)}

      <div class="card">
        <div class="cardTitle">Resume options</div>
        <div class="note">This job is paused. Load where you left off, or start over at intake.</div>
        <div style="height:10px"></div>

        <button class="btn openjobs" id="btnLoadJob">Load job</button>
        <button class="btn stock" id="btnStartOver" style="margin-top:8px;">Start over</button>
      </div>

      <button class="btn stock" id="btnResumeBack" style="margin-top:10px;">Back</button>
    `;
  }

  function wireResumeChoice(){
    const job = getJobById(STATE.currentJobId);
    if(!job) return;

    const back = document.getElementById('btnResumeBack');
    if(back) back.onclick = ()=> show('BACK');

    const load = document.getElementById('btnLoadJob');
    if(load) load.onclick = ()=>{
      // Resume where paused from (diagnostics or repair, etc.)
      const v = job.pausedFromView || 'job_screen';
      show(v);
    };

    const start = document.getElementById('btnStartOver');
    if(start) start.onclick = ()=>{
      // Wipe workflow data + restart at intake
      job.intake = null;
      job.diagnosticsChecks = [];
      job.foundProblemDesc = "";
      job.partsUsed = [];
      job.closeout = null;
      // Reset status history for a clean restart (keep job created info)
      job.statusHistory = [];
      // Set to Arrived intake flow (does not auto-claim again)
      setJobStatus(job, "Arrived");
      show('arrival_intake');
    };
  }



  function resetJobDraft(){
    STATE.jobDraft = {
      mode: "",
      customerId: "",
      customerName: "",
      fieldId: "",
      fieldName: "",
      brand: "",
      jobType: "Pivot Inspection",
      description: ""
    };
  }

  function renderCreateJobChoice(){
    return `
      <div class="screenTitle">
        <h2>Create Job</h2>
        <span class="badge">${STATE.truckId}</span>
      </div>
      <div class="note">Choose how you want to start this job.</div>
      <div style="height:10px"></div>

      <button class="btn create" id="btnCJSelectCustomer">Select Customer</button>
      <button class="btn openjobs" id="btnCJQuickAdd">Quick Add</button>

      <button class="btn stock" id="btnCJBackHome" style="margin-top:10px;">Back</button>
    `;
  }

  function renderCreateJobSelectCustomer(){
    const customers = (SAMPLE.customers || []);
    const cards = customers.map(c=>`
      <div class="item" data-customer="${c.id}">
        <div class="itemTop">
          <div>
            <div class="itemTitle">${c.name}</div>
            <div class="itemSub">${c.phone || ""}</div>
          </div>
          <div class="pill blue">${(c.fields||[]).length} fields</div>
        </div>
      </div>
    `).join("");

    return `
      <div class="screenTitle">
        <h2>Select Customer</h2>
        <span class="badge">Required</span>
      </div>
      <div class="note">Tap a customer to choose a field.</div>
      <div style="height:10px"></div>

      <div class="list">
        ${cards || `<div class="note">No customers (sample).</div>`}
      </div>

      <button class="btn stock" id="btnCJBackChoice" style="margin-top:10px;">Back</button>
    `;
  }

  function renderCreateJobSelectField(){
    const c = (SAMPLE.customers || []).find(x=>x.id === STATE.jobDraft.customerId);
    const fields = (c?.fields || []);
    const cards = fields.map(f=>`
      <div class="item" data-field="${f.id}">
        <div class="itemTop">
          <div>
            <div class="itemTitle">${f.name}</div>
            <div class="itemSub">${f.brand}</div>
          </div>
          <div class="pill green">Select</div>
        </div>
      </div>
    `).join("");

    return `
      <div class="screenTitle">
        <h2>Select Field</h2>
        <span class="badge">${c ? c.name : "Customer"}</span>
      </div>
      <div class="note">Tap a field to continue to job details.</div>
      <div style="height:10px"></div>

      <div class="list">
        ${cards || `<div class="note">No fields (sample).</div>`}
      </div>

      <button class="btn stock" id="btnCJBackCustomers" style="margin-top:10px;">Back</button>
    `;
  }

  function renderCreateJobDetails(){
    const d = STATE.jobDraft;
    return `
      <div class="screenTitle">
        <h2>Job Details</h2>
        <span class="badge">Required</span>
      </div>

      <div class="item" style="margin-top:2px;">
        <div class="itemTop">
          <div>
            <div class="itemTitle">${d.customerName}</div>
            <div class="itemSub">${d.fieldName} ‚Ä¢ ${d.brand}</div>
          </div>
          <div class="pill blue">${STATE.truckId}</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="formCard">
        <div class="field">
          <label for="cjType">Job type</label>
          <select class="select" id="cjType">
            <option value="Pivot Inspection">Pivot Inspection</option>
            <option value="General Repair">General Repair</option>
          </select>
        </div>

        <div class="field">
          <label for="cjDesc">Description (required)</label>
          <textarea class="textarea" id="cjDesc" placeholder="Brief description of the problem / reason for visit‚Ä¶"></textarea>
        </div>

        <button class="submitBtn" id="cjCreate" disabled>Create Job</button>
        <div class="hint">Look-first: creates an alert for now.</div>
      </div>

      <button class="btn stock" id="btnCJBackFields" style="margin-top:10px;">Back</button>
    `;
  }

  function renderCreateJobQuickAdd(){
    return `
      <div class="screenTitle">
        <h2>Quick Add</h2>
        <span class="badge">All required</span>
      </div>
      <div class="note">Use this when the customer/field isn't in the dashboard yet. (Sample only for now.)</div>
      <div style="height:10px"></div>

      <div class="formCard">
        <div class="field">
          <label for="qaCustomer">Customer name</label>
          <input class="input" id="qaCustomer" placeholder="Customer name‚Ä¶"/>
        </div>

        <div class="field">
          <label for="qaField">Field name</label>
          <input class="input" id="qaField" placeholder="Field name‚Ä¶"/>
        </div>

        <div class="field">
          <label for="qaBrand">Pivot brand</label>
          <select class="select" id="qaBrand">
            <option value="">Select‚Ä¶</option>
            <option value="Reinke">Reinke</option>
            <option value="Valley">Valley</option>
            <option value="Zimmatic">Zimmatic</option>
            <option value="T&L">T&L</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="qaType">Job type</label>
          <select class="select" id="qaType">
            <option value="Pivot Inspection">Pivot Inspection</option>
            <option value="General Repair">General Repair</option>
          </select>
        </div>

        <div class="field">
          <label for="qaDesc">Description (required)</label>
          <textarea class="textarea" id="qaDesc" placeholder="Brief description‚Ä¶"></textarea>
        </div>

        <button class="submitBtn" id="qaCreate" disabled>Create Job</button>
        <div class="hint">Look-first: creates an alert for now.</div>
      </div>

      <button class="btn stock" id="btnCJBackQuickAdd" style="margin-top:10px;">Back</button>
    `;
  }

  function wireCreateJobDetails(){
    const type = document.getElementById('cjType');
    const desc = document.getElementById('cjDesc');
    const btn = document.getElementById('cjCreate');

    // defaults
    if(type) type.value = STATE.jobDraft.jobType || "Pivot Inspection";
    if(desc) desc.value = STATE.jobDraft.description || "";

    function setEnabled(on){
      btn.disabled = !on;
      btn.classList.toggle('enabled', on);
    }
    function validate(){
      const d = (desc?.value || "").trim();
      setEnabled(Boolean(d));
    }
    if(type) type.addEventListener('change', ()=>{
      STATE.jobDraft.jobType = type.value;
      validate();
    });
    if(desc) desc.addEventListener('input', ()=>{
      STATE.jobDraft.description = desc.value;
      validate();
    });
    if(btn) btn.addEventListener('click', ()=>{
      if(btn.disabled) return;
      alert(`Create Job (look-only)\n\n${STATE.jobDraft.customerName} ‚Ä¢ ${STATE.jobDraft.fieldName}\n${STATE.jobDraft.brand} ‚Ä¢ ${STATE.jobDraft.jobType}\n\n${STATE.jobDraft.description}`);
      resetJobDraft();
      show('BACK');
    });
    validate();
  }

  function wireQuickAdd(){
    const c = document.getElementById('qaCustomer');
    const f = document.getElementById('qaField');
    const b = document.getElementById('qaBrand');
    const t = document.getElementById('qaType');
    const d = document.getElementById('qaDesc');
    const btn = document.getElementById('qaCreate');

    function setEnabled(on){
      btn.disabled = !on;
      btn.classList.toggle('enabled', on);
    }
    function validate(){
      const ok =
        (c?.value || "").trim() &&
        (f?.value || "").trim() &&
        (b?.value || "").trim() &&
        (d?.value || "").trim();
      setEnabled(Boolean(ok));
    }

    [c,f,b,t,d].forEach(el=>{
      if(!el) return;
      el.addEventListener('input', validate);
      el.addEventListener('change', validate);
    });

    btn.addEventListener('click', ()=>{
      if(btn.disabled) return;
      alert(`Create Job (quick add, look-only)\n\n${(c.value||"").trim()} ‚Ä¢ ${(f.value||"").trim()}\n${(b.value||"").trim()} ‚Ä¢ ${(t.value||"").trim()}\n\n${(d.value||"").trim()}`);
      resetJobDraft();
      show('BACK');
    });

    validate();
  }

function renderHelpersConfig(){
    const chips = (SAMPLE.helperRoster || []).map(h=>{
      const on = STATE.helpers.includes(h) ? "on" : "";
      return `<button class="chip ${on}" type="button" data-helper="${h}">${h}</button>`;
    }).join("");

    return `
      <div class="screenTitle">
        <h2>Helper Configuration</h2>
        <span class="badge">${STATE.truckId}</span>
      </div>
      <div class="note">Tap helpers to add/remove. (Roster comes from dashboard later.)</div>
      <div style="height:10px"></div>

      <div class="formCard">
        <div class="sectionHint">Available helpers</div>
        <div class="chipList" id="helperChipList">${chips}</div>
        <div class="hint">Selected helpers show in the header and are available for Time Off requests.</div>
      </div>

      <button class="btn openjobs" id="backHomeFromHelpers" style="margin-top:10px;">Back</button>
    `;
  }

  
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }


  function toast(msg){
    try{
      alert(msg);
    }catch(e){ console.log(msg); }
  }

function show(view){
    if(view === 'BACK'){
      VIEW_STACK.pop();
      currentView = VIEW_STACK[VIEW_STACK.length-1] || 'home';
    } else {
      currentView = view;
      if(VIEW_STACK[VIEW_STACK.length-1] !== view){ VIEW_STACK.push(view); }
    }
    let html = "";

    if(view === 'home') html = renderHome();
    else if(view === 'create_job') html = renderCreateJobChoice();
    else if(view === 'create_job_customers') html = renderCreateJobSelectCustomer();
    else if(view === 'create_job_fields') html = renderCreateJobSelectField();
    else if(view === 'create_job_details') html = renderCreateJobDetails();
    else if(view === 'create_job_quickadd') html = renderCreateJobQuickAdd();
    else if(view === 'lists') html = renderLists();
    else if(view === 'restock') html = renderRestock();
    else if(view === 'requests') html = renderRequests();
    else if(view === 'make_request') html = renderMakeRequest();
    else if(view === 'receipts') html = renderReceipts();
    else if(view === 'add_receipt') html = renderAddReceipt();
    else if(view === 'settings') html = renderSettings();
    else if(view === 'helpers') html = renderHelpersConfig();
    else if(view === 'open_jobs') html = renderOpenJobs();
    else if(view === 'map_view') html = renderMapView();
    else if(view === 'job_screen') html = renderJobScreen();
    else if(view === 'route_prompt') html = renderRoutePrompt();
    else if(view === 'travel') html = renderTravel();
    else if(view === 'arrival_intake') html = renderArrivalIntake();
    else if(view === 'resume_choice') html = renderResumeChoice();
    else if(view === 'diagnostics_choice') html = renderDiagnosticsChoice();
    else if(view === 'diagnostics_screen') html = renderDiagnosticsScreen();
    else if(view === 'found_problem') html = renderFoundProblem();
        else if(view === 'repair_screen') html = renderRepairScreen();
    else if(view === 'job_outline') html = renderJobOutline();
    else if(view === 'closeout_checklist') html = renderCloseoutChecklist();
    else html = renderHome();

    panel.innerHTML = html;

    const byId = (id) => document.getElementById(id);

    // Update home badge counts
    const rc = byId('restockCount');
    if(rc) rc.textContent = String(getRestockNeedTotal());

    // Wire restock modal (safe)
    try{ wireRestockModal(); }catch(e){}


    // Home buttons (look only navigation)
    const btnCreate = byId('btnCreateJob');
    if(btnCreate) btnCreate.addEventListener('click', ()=> { resetJobDraft(); show('create_job'); });

    const btnOpen = byId('btnOpenJobs');
    if(btnOpen) btnOpen.addEventListener('click', ()=> show('open_jobs'));

    // Open Jobs screen
    if(currentView === 'open_jobs'){
      panel.querySelectorAll('[data-job]').forEach(card=>{
        card.addEventListener('click', ()=>{
          STATE.currentJobId = card.getAttribute('data-job') || "";
          show('job_screen');
        });
      });

      const mapBtn = byId('btnMapView');
      if(mapBtn) mapBtn.addEventListener('click', ()=> show('map_view'));

      const back = byId('btnOpenJobsBack');
      if(back) back.addEventListener('click', ()=> show('open_jobs'));
    }

    // Map View screen
    if(currentView === 'map_view'){
      const back = byId('btnMapBack');
      if(back) back.addEventListener('click', ()=> { stopLocationWatch(); show('open_jobs'); });

      const loc = byId('btnLocateMe');
      if(loc) loc.addEventListener('click', ()=> locateMeOnce());
const open = byId('btnMapOpenJob');
      if(open) open.addEventListener('click', ()=>{
        if(!STATE.currentJobId) return;
        show('job_screen');
      });

      // Initialize the map after DOM paints
      requestAnimationFrame(()=> initJobsMap());
    }

    // Job screen actions
    if(currentView === 'job_screen'){
      const job = getJobById(STATE.currentJobId);

      const btnLast = byId('btnOpenLastReport');
      if(btnLast){
        btnLast.addEventListener('click', ()=>{
          try{
            const f = getFieldById(job.customerId, job.fieldId) || {};
            const url = f.lastReportUrl || f.lastJobReportUrl;
            if(url) window.open(url, '_blank');
          }catch(e){}
        });
      }

      const back = byId('btnJobBack');
      if(back) back.addEventListener('click', ()=> show('open_jobs'));

      const backHome = byId('btnJobBackHome');
      if(backHome) backHome.addEventListener('click', ()=> show('BACK'));

      const btnPause = byId('btnPauseJob');
      if(btnPause) btnPause.addEventListener('click', ()=>{
        if(!job) return;
        startPauseFlow('job_screen');
      });

      const btnProblem = byId('btnFoundProblem');
      if(btnProblem) btnProblem.addEventListener('click', ()=> show('found_problem'));

      const btnOTW = byId('btnOnTheWay');
      if(btnOTW) btnOTW.addEventListener('click', ()=>{
        if(!job) return;

        // Claim the job for this truck + tech (lightweight, local-only in this prototype)
        try{
          if(!job.claimedBy){
            job.claimedBy = {
              tech: STATE.techName || SAMPLE.techName || "Tech",
              truckId: STATE.truckId || SAMPLE.truckId || "Truck",
              claimedAt: new Date().toISOString()
            };
          }
        }catch(e){}

        // close current status and start "On the way"
        setJobStatus(job, "On the way");
        show('route_prompt');
      });
    }

    // Route prompt
    if(currentView === 'route_prompt'){
      const job = getJobById(STATE.currentJobId);
      const field = job ? getFieldById(job.customerId, job.fieldId) : null;

      const back = byId('btnRouteBack');
      if(back) back.addEventListener('click', ()=> show('open_jobs'));

      const route = byId('btnRouteMe');
      if(route) route.addEventListener('click', ()=>{
        if(!job || !field) return;
        if(typeof field.lat !== "number" || typeof field.lng !== "number") return;

        const url = `https://www.google.com/maps/dir/?api=1&destination=${field.lat},${field.lng}&travelmode=driving`;
        window.open(url, "_blank");

        setJobStatus(job, "Travel");
        show('travel');
      });

      const skip = byId('btnSkipRouting');
      if(skip) skip.addEventListener('click', ()=>{
        if(!job) return;
        setJobStatus(job, "Travel");
        show('travel');
      });
    }

    // Travel screen
    if(currentView === 'travel'){
      const job = getJobById(STATE.currentJobId);

      const back = byId('btnTravelBack');
      if(back) back.addEventListener('click', ()=> show('open_jobs'));

      const arrived = byId('btnArrived');
      if(arrived) arrived.addEventListener('click', ()=>{
        if(!job) return;
        setJobStatus(job, "Arrived");
        show('arrival_intake');
      });
    }

    // Arrival intake
    if(currentView === 'arrival_intake'){
      const back = byId('btnArrivalBack');
      if(back) back.addEventListener('click', ()=> show('open_jobs'));
      wireArrivalIntake();
    }
    // Diagnostics choice
    if(currentView === 'diagnostics_choice'){
      wireDiagnosticsChoice();
    }

    // Diagnostics checks
    if(currentView === 'diagnostics_screen'){
      wireDiagnosticsScreen();
    }

    if(currentView === 'resume_choice'){
      wireResumeChoice();
    }

    if(currentView === 'found_problem'){
      wireFoundProblem();
    }
    if(currentView === 'repair_screen'){
      wireRepairScreen();
    }
    if(currentView === 'closeout_checklist'){
      wireCloseoutChecklist();
    }

    if(currentView === 'job_outline'){
      wireJobOutline();
    }



    const btnRestock = byId('btnRestock');
    if(btnRestock) btnRestock.addEventListener('click', ()=> show('restock'));

    const btnFuel = byId('btnRefuel');
    if(btnFuel) btnFuel.addEventListener('click', ()=> alert('Re-Fuel (next screen later)'));


    // Restock screen
    if(currentView === 'restock'){
      panel.querySelectorAll('[data-restock]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pn = btn.getAttribute('data-restock');
          openRestockModal(pn);
        });
      });

      const back = byId('btnRestockBack');
      if(back) back.addEventListener('click', ()=> show('home'));

      const applyBtn = byId('btnApplyRestock');
      if(applyBtn) applyBtn.addEventListener('click', ()=>{
        applyRestock();
        show('restock');
      });
    }


    // Lists segmented toggle
    const segParts = byId('segParts');
    const segTools = byId('segTools');
    const listsBody = byId('listsBody');
    function setSeg(active){
      if(!segParts || !segTools || !listsBody) return;
      const isParts = active === 'parts';
      segParts.classList.toggle('active', isParts);
      segTools.classList.toggle('active', !isParts);
      listsBody.innerHTML = isParts ? renderPartsList() : renderToolsList();

      const btnAddPart = byId('btnAddPart');
      if(btnAddPart) btnAddPart.addEventListener('click', ()=> alert('Add Parts (look only)'));

      const btnAddTool = byId('btnAddTool');
      if(btnAddTool) btnAddTool.addEventListener('click', ()=> alert('Add Tool (look only)'));

      const btnToolReq = byId('btnToolRequest');
      if(btnToolReq) btnToolReq.addEventListener('click', ()=> { show('make_request'); setTimeout(()=>{ byId('reqType') && (byId('reqType').value='tool'); byId('reqType') && byId('reqType').dispatchEvent(new Event('change')); }, 0); });
    }
    if(segParts && segTools && listsBody){
      segParts.addEventListener('click', ()=> setSeg('parts'));
      segTools.addEventListener('click', ()=> setSeg('tools'));
      setSeg('parts');
    }

    
    // Create Job wiring
    const btnCJSelectCustomer = byId('btnCJSelectCustomer');
    if(btnCJSelectCustomer) btnCJSelectCustomer.addEventListener('click', ()=> show('create_job_customers'));

    const btnCJQuickAdd = byId('btnCJQuickAdd');
    if(btnCJQuickAdd) btnCJQuickAdd.addEventListener('click', ()=> show('create_job_quickadd'));

    const btnCJBackHome = byId('btnCJBackHome');
    if(btnCJBackHome) btnCJBackHome.addEventListener('click', ()=> show('home'));

    const btnCJBackChoice = byId('btnCJBackChoice');
    if(btnCJBackChoice) btnCJBackChoice.addEventListener('click', ()=> show('create_job'));

    const btnCJBackCustomers = byId('btnCJBackCustomers');
    if(btnCJBackCustomers) btnCJBackCustomers.addEventListener('click', ()=> show('create_job_customers'));

    const btnCJBackFields = byId('btnCJBackFields');
    if(btnCJBackFields) btnCJBackFields.addEventListener('click', ()=> show('create_job_fields'));

    // Customer select
    if(currentView === 'create_job_customers'){
      panel.querySelectorAll('[data-customer]').forEach(card=>{
        card.addEventListener('click', ()=>{
          const id = card.getAttribute('data-customer');
          const c = (SAMPLE.customers||[]).find(x=>x.id===id);
          STATE.jobDraft.mode = "select";
          STATE.jobDraft.customerId = id;
          STATE.jobDraft.customerName = c?.name || "";
          show('create_job_fields');
        });
      });
    }

    // Field select
    if(currentView === 'create_job_fields'){
      panel.querySelectorAll('[data-field]').forEach(card=>{
        card.addEventListener('click', ()=>{
          const id = card.getAttribute('data-field');
          const c = (SAMPLE.customers||[]).find(x=>x.id===STATE.jobDraft.customerId);
          const f = (c?.fields||[]).find(y=>y.id===id);
          STATE.jobDraft.fieldId = id;
          STATE.jobDraft.fieldName = f?.name || "";
          STATE.jobDraft.brand = f?.brand || "";
          show('create_job_details');
        });
      });
    }

    if(currentView === 'create_job_details') wireCreateJobDetails();
    if(currentView === 'create_job_quickadd') wireQuickAdd();

    // Requests
    const btnMake = byId('btnMakeRequest');
    if(btnMake) btnMake.addEventListener('click', ()=> show('make_request'));

    const backReq = byId('backToRequests');
    if(backReq) backReq.addEventListener('click', ()=> show('requests'));

    if(view === 'make_request') wireMakeRequest();

    // Receipts
    const btnAddReceiptTop = byId('btnAddReceiptTop');
    if(btnAddReceiptTop) btnAddReceiptTop.addEventListener('click', ()=> show('add_receipt'));

    const backToReceipts = byId('backToReceipts');
    if(backToReceipts) backToReceipts.addEventListener('click', ()=> show('receipts'));

    if(view === 'add_receipt') wireAddReceipt();

    // Helpers
    if(view === 'helpers'){
      const wrap = byId('helperChipList');
      if(wrap){
        wrap.querySelectorAll('[data-helper]').forEach(b=>{
          b.addEventListener('click', ()=>{
            const h = b.getAttribute('data-helper');
            const idx = STATE.helpers.indexOf(h);
            if(idx >= 0) STATE.helpers.splice(idx,1);
            else STATE.helpers.push(h);
            helperLine.textContent = STATE.helpers.length ? ('Helpers: ' + STATE.helpers.join(', ')) : 'Helpers: None';
            b.classList.toggle('on', STATE.helpers.includes(h));
          });
        });
      }
      const back = byId('backHomeFromHelpers');
      if(back) back.addEventListener('click', ()=> show('home'));
    }
  }

  // Start
  try{ show('BACK'); } catch(e){ console.error(e); panel.innerHTML = '<div class="note">Error rendering view. Check console.</div>'; }
})();

window.addEventListener('DOMContentLoaded', ()=>{ try{ wirePauseModal(); }catch(e){} try{ wireUnableModal(); }catch(e){} });
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Pause confirmation modal -->
  <div id="pauseModal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="pauseModalTitle">
      <div class="modalHeader">
        <div id="pauseModalTitle">Pause job?</div>
        <button class="btn tiny" id="pauseModalX" type="button">Close</button>
      </div>
      <div class="modalBody">
        <div class="note" style="margin-bottom:10px;">Yes requires a reason.</div>
        <div class="field">
          <div class="label">Reason (required)</div>
          <textarea id="pauseReason" class="input" rows="3" placeholder="e.g., Waiting on parts / Weather delay / Customer not available"></textarea>
        </div>
      </div>
      <div class="modalActions">
        <button class="btn stock" id="btnPauseNo" type="button">No</button>
        <button class="btn purple" id="btnPauseYes" type="button">Yes, pause job</button>
      </div>
    </div>
  </div>


  <!-- Closeout: Unable to perform modal -->
  <div id="unableModal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="unableModalTitle">
      <div class="modalHeader">
        <div id="unableModalTitle">Unable to perform</div>
        <button class="btn tiny" id="unableModalX" type="button">Close</button>
      </div>
      <div class="modalBody">
        <div class="note" style="margin-bottom:10px;">Reason is required to continue.</div>
        <div class="field">
          <div class="label">Reason (required)</div>
          <textarea id="unableReason" class="input" rows="3" placeholder="Explain why this could not be performed..."></textarea>
        </div>
      </div>
      <div class="modalActions">
        <button class="btn stock" id="btnUnableCancel" type="button">Cancel</button>
        <button class="btn openjobs" id="btnUnableSave" type="button">Save</button>
      </div>
    </div>
  </div>



  <!-- Restock entry modal -->
  <div id="restockModal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="restockModalTitle">
      <div class="modalHeader">
        <div id="restockModalTitle">Restock</div>
        <button class="btn tiny" id="restockModalX" type="button">Close</button>
      </div>
      <div class="modalBody">
        <div class="note" id="restockModalMeta" style="margin-bottom:10px;"></div>
        <div class="field">
          <div class="label">Qty acquired</div>
          <input id="restockQty" class="input" type="number" min="0" placeholder="0" />
        </div>
      </div>
      <div class="modalActions">
        <button class="btn refuel" id="btnRestockOOS" type="button">Out of stock</button>
        <button class="btn stock" id="btnRestockCancel" type="button">Cancel</button>
        <button class="btn openjobs" id="btnRestockSave" type="button">Save</button>
      </div>
    </div>
  </div>

</body>
</html>

