<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pivot Tower Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PDF library for customer reports -->
<style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }

    h1 {
      text-align: center;
      margin-bottom: 0.75rem;
    }

    form {
      max-width: 1100px;
      margin: 0 auto;
    }

    .section-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #dee2e6;
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #343a40;
    }

    .grid-2 {
      display: grid;
      gap: 0.5rem 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .field label {
      font-size: 0.8rem;
      color: #495057;
    }

    .field input,
    .field select,
    .field textarea {
      font-size: 0.85rem;
      padding: 0.3rem 0.4rem;
      border-radius: 6px;
      border: 1px solid #ced4da;
      box-sizing: border-box;
    }

    .field textarea {
      resize: vertical;
      min-height: 2.2rem;
      max-height: 5rem;
    }

    .tower-layout-wrapper {
      margin: 0 auto;
      width: 1000px;
      max-width: 100%;
    }

    .tower-layout {
      position: relative;
      width: 1000px;
      height: 420px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fafafa;
      overflow: hidden;
      box-sizing: border-box;
    }

    .hotspot {
      position: absolute;
      padding: 0;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
      transform-origin: center center;
      border-radius: 999px;
    }

    .hotspot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      filter: brightness(0) contrast(1);
    }

    .hotspot:hover {
      transform: scale(1.08);
      box-shadow: 0 0 6px rgba(0,0,0,0.35);
    }

    .hotspot.status-good {
      background-color: rgba(76, 175, 80, 0.18);
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.9);
    }
    .hotspot.status-warning {
      background-color: rgba(255, 193, 7, 0.22);
      box-shadow: 0 0 8px rgba(255, 193, 7, 0.9);
    }
    .hotspot.status-bad {
      background-color: rgba(244, 67, 54, 0.22);
      box-shadow: 0 0 8px rgba(244, 67, 54, 0.95);
    }

    .hotspot.status-good img {
      filter: brightness(0) sepia(1) hue-rotate(90deg) saturate(6);
    }
    .hotspot.status-warning img {
      filter: brightness(0) sepia(1) hue-rotate(25deg) saturate(6);
    }
    .hotspot.status-bad img {
      filter: brightness(0) sepia(1) hue-rotate(-10deg) saturate(8);
    }

    .component-card {
      position: absolute;
      min-width: 230px;
      max-width: 260px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #cfd4da;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      background: #ffffff;
      font-size: 0.9rem;
      display: none;
      z-index: 20;
    }

    .component-card.active {
      display: block;
    }

    .component-card-header {
      background: #1865ab;
      color: #ffffff;
      padding: 0.45rem 0.7rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .component-card-body {
      background: #f1f3f5;
      padding: 0.5rem 0.7rem 0.6rem 0.7rem;
    }

    .close-card-btn {
      background: transparent;
      border: none;
      color: #ffffff;
      font-size: 1rem;
      cursor: pointer;
      padding: 0;
    }

    .options-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-bottom: 0.45rem;
    }

    .option-btn {
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #adb5bd;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.8rem;
      line-height: 1.2;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .option-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #ced4da;
      background: #ffffff;
    }

    .option-btn.selected {
      border-width: 2px;
    }

    .option-btn.status-good .option-dot {
      background: #4caf50;
      border-color: #4caf50;
    }
    .option-btn.status-warning .option-dot {
      background: #ffc107;
      border-color: #ffc107;
    }
    .option-btn.status-bad .option-dot {
      background: #f44336;
      border-color: #f44336;
    }

    .option-btn.status-good.selected {
      background: rgba(76, 175, 80, 0.1);
    }
    .option-btn.status-warning.selected {
      background: rgba(255, 193, 7, 0.15);
    }
    .option-btn.status-bad.selected {
      background: rgba(244, 67, 54, 0.12);
    }

    
    /* -------- Tower-level condition buttons -------- */
    .tower-conditions {
      margin-top: 0.55rem;
      display: grid;
      gap: 0.45rem;
    }
    .tower-cond-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem 0.6rem;
    }
    .tower-cond-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #343a40;
      min-width: 110px;
    }
    .tower-cond-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    .tower-cond-btn {
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      border: 1px solid #adb5bd;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.8rem;
      line-height: 1.2;
      white-space: nowrap;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease, border-color 0.12s ease;
    }
    .tower-cond-btn:hover {
      transform: scale(1.03);
      box-shadow: 0 0 6px rgba(0,0,0,0.18);
    }
    .tower-cond-btn.selected {
      border-width: 2px;
    }
    .tower-cond-btn.selected[data-status="good"] {
      background: rgba(76, 175, 80, 0.14);
      border-color: #4caf50;
    }
    .tower-cond-btn.selected[data-status="warning"] {
      background: rgba(255, 193, 7, 0.18);
      border-color: #ffc107;
    }
    .tower-cond-btn.selected[data-status="bad"] {
      background: rgba(244, 67, 54, 0.14);
      border-color: #f44336;
    }
.psi-row {
      margin-top: 0.4rem;
      display: none;
    }

    .psi-row label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
    }

    .psi-input-wrap {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .psi-input-wrap input {
      width: 80px;
      padding: 0.25rem 0.35rem;
      border-radius: 6px;
      border: 1px solid #adb5bd;
      font-size: 0.85rem;
      box-sizing: border-box;
    }

    .psi-error {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: #c92a2a;
      display: none;
    }

    .tower-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .btn-add-tower,
    .btn-remove-tower {
      padding: 0.35rem 0.8rem;
      font-size: 0.8rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .btn-add-tower {
      background: #4caf50;
      color: #fff;
    }

    
    .btn-add-end-tower {
      background: #6f42c1;
      border: 1px solid #5a36a5;
      color: #fff;
    }
    .btn-add-end-tower:hover { filter: brightness(0.95); }
.btn-remove-tower {
      background: #f44336;
      color: #fff;
    }

    #useLocationBtn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      background: #e9ecef;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0;
    }

    .report-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 0.75rem;
    }

    .report-btn {
      padding: 0.4rem 0.9rem;
      font-size: 0.8rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1865ab;
      color: #fff;
    }

    .report-btn.secondary {
      background: #495057;
    }

    @media (max-width: 1024px) {
      .tower-layout-wrapper {
        width: 100%;
      }
      .tower-layout {
        width: 100%;
        height: auto;
        aspect-ratio: 1000 / 420;
      }
    }

    /* -------- Customer-facing report styles (used in pdfContainer) -------- */

    .brand-header {
      border-bottom: 3px solid #1865ab;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }
    .brand-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1865ab;
    }
    .brand-sub {
      font-size: 0.9rem;
      color: #495057;
    }
    .cover-card {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      background: #f8f9fa;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.4rem 1rem;
      font-size: 0.9rem;
    }
    .info-label {
      font-weight: 600;
      color: #343a40;
    }
    .section-title.report-section-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin: 0.6rem 0 0.3rem;
      color: #343a40;
    }
    .tower-card {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 0.5rem 0.7rem;
      margin-bottom: 0.6rem;
    }
    .tower-header-report {
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #1865ab;
    }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .report-table th,
    .report-table td {
      border: 1px solid #dee2e6;
      padding: 0.25rem 0.35rem;
      text-align: left;
    }
    .report-table th {
      background: #f1f3f5;
    }
    .status-pill {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.75rem;
      color: #fff;
    }
    .status-good-pill {
      background: #4caf50;
    }
    .status-warning-pill {
      background: #ffc107;
      color: #212529;
    }
    .status-bad-pill {
      background: #f44336;
    }
    .small-note {
      font-size: 0.75rem;
      color: #868e96;
      margin-top: 0.3rem;
    }
    .notes-block {
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
    }
    .notes-block strong {
      display: inline-block;
      width: 170px;
    }
  
    /* -------- In-app report modal -------- */
    .report-modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 9999;
    }
    .report-modal.open {
      display: block;
    }
    .report-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
    }
    .report-modal-panel {
      position: relative;
      width: min(1100px, calc(100% - 1.2rem));
      height: min(92vh, 900px);
      margin: 0.6rem auto;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #dee2e6;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .report-modal-header {
      background: #1865ab;
      color: #fff;
      padding: 0.55rem 0.8rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .report-modal-title {
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .report-modal-close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.4rem;
      line-height: 1;
      cursor: pointer;
    }
    .report-modal-tabs {
      display: flex;
      gap: 0.4rem;
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
    }
    .report-tab {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #adb5bd;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .report-tab.active {
      border-color: #1865ab;
      box-shadow: 0 0 0 2px rgba(24,101,171,0.15);
    }
    .report-modal-body {
      padding: 0.7rem;
      overflow: auto;
      flex: 1;
      background: #ffffff;
    }
    .report-view {
      display: none;
    }
    .report-view.active {
      display: block;
    }
    /* Ensure reports read nicely in-app (portrait-like flow) */
    .report-page {
      max-width: 850px; /* portrait-ish */
      margin: 0 auto;
    }

  </style>
  <script type="module" src="../shared/supabase.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
  <form id="inspectionForm">
    <h1>Pivot Tower Inspection</h1>

    <!-- 1. General Information -->
    <div class="section-card">
      <div class="section-title">General Information</div>
      <div class="grid-2">
        <div class="field">
          <label for="customerName">Customer Name / Company</label>
          <input id="customerName" name="customerName" type="text" placeholder="Customer or Company" />
        </div>
        <div class="field">
          <label for="systemBrand">System Brand</label>
          <select id="systemBrand" name="systemBrand">
            <option value="">Select brand...</option>
            <option value="Reinke">Reinke</option>
            <option value="Valley">Valley</option>
            <option value="Zimmatic">Zimmatic</option>
            <option value="T&L">T&amp;L</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="field">
          <label for="inspectedBy">Inspection Performed By</label>
          <input id="inspectedBy" name="inspectedBy" type="text" placeholder="Technician name" />
        </div>
        <div class="field">
          <label for="fieldName">Field Name</label>
          <input id="fieldName" name="fieldName" type="text" placeholder="Field name / label" />
        </div>
        <div class="field">
          <label for="locationInput">Location</label>
          <div style="display:flex; gap:0.4rem;">
            <input id="locationInput" name="location" type="text" style="flex:1;" placeholder="GPS or description" />
            <button type="button" id="useLocationBtn" title="Use current location">üìç</button>
          </div>
        </div>
        <div class="field">
          <label for="inspectionDate">Date of Inspection</label>
          <input id="inspectionDate" name="inspectionDate" type="date" />
        </div>
        <div class="field">
          <label for="machineHours">Hours on Machine</label>
          <input id="machineHours" name="machineHours" type="number" min="0" step="1" placeholder="e.g. 1234" />
        </div>
        <div class="field">
          <label for="startTime">Start Time</label>
          <input id="startTime" name="startTime" type="time" />
        </div>
        <div class="field">
          <label for="endTime">End Time</label>
          <input id="endTime" name="endTime" type="time" />
        </div>
      </div>
    </div>

    <!-- 2. Notes & Quick Findings -->
    <div class="section-card">
      <div class="section-title">Notes & Quick Findings</div>
      <div class="grid-2">
        <div class="field">
          <label for="wellMotorOil">Well Motor Oil Level</label>
          <textarea id="wellMotorOil" name="wellMotorOil" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="dripOilSystem">Drip Oil System</label>
          <textarea id="dripOilSystem" name="dripOilSystem" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="WellPanel">Well Panel</label>
          <textarea id="WellPanel" name="WellPanel" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="waterSupply">Water Supply</label>
          <textarea id="waterSupply" name="waterSupply" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="mainControlPanel">Main Control Panel</label>
          <textarea id="mainControlPanel" name="mainControlPanel" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="pivotFoundation">Pivot Foundation</label>
          <textarea id="pivotFoundation" name="pivotFoundation" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="anchoringSystem">Anchoring System</label>
          <textarea id="anchoringSystem" name="anchoringSystem" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="centerPointStructure">Center Point Structure</label>
          <textarea id="centerPointStructure" name="centerPointStructure" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="collectorRing">Collector Ring</label>
          <textarea id="collectorRing" name="collectorRing" placeholder="1‚Äì2 line note..."></textarea>
        </div>
        <div class="field">
          <label for="towerBootNote">Tower Boot</label>
          <textarea id="towerBootNote" name="towerBootNote" placeholder="1‚Äì2 line note..."></textarea>
        </div>
      </div>
    </div>

    <!-- 3. Towers container (repeatable) -->
    <div id="towersContainer"></div>

    <!-- Template for a tower section -->
    <template id="towerTemplate">
      <div class="section-card tower-section">
        <div class="section-title">
          Tower Inspection ‚Äì Tower <span class="tower-number">1</span>
        </div>
        <div class="tower-layout-wrapper">
          <div class="tower-layout">

            <!-- Reverse Tire -->
            <button class="hotspot" type="button" data-component="reverseTire"
                    style="left:221.344px; top:284.016px; width:120px; height:120px;">
              <img src="images/tire.png" alt="Reverse Tire">
            </button>

            <!-- Reverse Wheel Gear -->
            <button class="hotspot" type="button" data-component="reverseWheelGear"
                    style="left:149.266px; top:253.016px; width:80px; height:80px;">
              <img src="images/wheelgear.png" alt="Reverse Wheel Gear">
            </button>

            <!-- Reverse Wheel Coupler -->
            <button class="hotspot" type="button" data-component="reverseWheelCoupler"
                    style="left:196.781px; top:220.297px; width:70px; height:60px;">
              <img src="images/drivecoupler.png" alt="Reverse Wheel Coupler">
            </button>

            <!-- Reverse Drive Line -->
            <button class="hotspot" type="button" data-component="reverseDriveLine"
                    style="left:243.859px; top:190.375px; width:140px; height:40px;">
              <img src="images/driveline.png" alt="Reverse Drive Line">
            </button>

            <!-- Reverse Drive Line Cover -->
            <button class="hotspot" type="button" data-component="reverseDriveLineCover"
                    style="left:301.688px; top:205.984px; width:180px; height:60px;">
              <img src="images/drivelinecover.png" alt="Reverse Drive Line Cover">
            </button>

            <!-- Center Reverse Coupler -->
            <button class="hotspot" type="button" data-component="centerReverseCoupler"
                    style="left:483.344px; top:104.875px; width:70px; height:60px;">
              <img src="images/drivecoupler.png" alt="Center Reverse Coupler">
            </button>

            <!-- Center Drive -->
            <button class="hotspot" type="button" data-component="centerDrive"
                    style="left:415.25px; top:100.719px; width:90px; height:70px;">
              <img src="images/centerdrive.png" alt="Center Drive">
            </button>

            <!-- Center Forward Coupler -->
            <button class="hotspot" type="button" data-component="centerForwardCoupler"
                    style="left:630.828px; top:32.641px; width:70px; height:60px;">
              <img src="images/drivecoupler.png" alt="Center Forward Coupler">
            </button>

            <!-- Forward Drive Line Cover -->
            <button class="hotspot" type="button" data-component="forwardDriveLineCover"
                    style="left:523.062px; top:100.797px; width:200px; height:60px;">
              <img src="images/drivelinecover.png" alt="Forward Drive Line Cover">
            </button>

            <!-- Forward Drive Line -->
            <button class="hotspot" type="button" data-component="forwardDriveLine"
                    style="left:529.094px; top:76.297px; width:140px; height:40px;">
              <img src="images/driveline.png" alt="Forward Drive Line">
            </button>

            <!-- Forward Wheel Coupler -->
            <button class="hotspot" type="button" data-component="forwardWheelCoupler"
                    style="left:346.984px; top:146.875px; width:70px; height:60px;">
              <img src="images/drivecoupler.png" alt="Forward Wheel Coupler">
            </button>

            <!-- Forward Wheel Gear -->
            <button class="hotspot" type="button" data-component="forwardWheelGear"
                    style="left:708.234px; top:6.922px; width:80px; height:80px;">
              <img src="images/wheelgear.png" alt="Forward Wheel Gear">
            </button>

            <!-- Forward Tire -->
            <button class="hotspot" type="button" data-component="forwardTire"
                    style="left:770.641px; top:35.062px; width:120px; height:120px;">
              <img src="images/tire.png" alt="Forward Tire">
            </button>

          </div>
        </div>

        <!-- Tower-specific comments -->
        <div class="field" style="margin-top:0.5rem;">
          <label>Tower Comments / Notes</label>
          <textarea class="tower-comment" name="towerComment" placeholder="Notes specific to this tower..."></textarea>
        </div>

        <!-- Tower-level condition buttons -->
        <div class="tower-conditions">
          <div class="tower-cond-row">
            <div class="tower-cond-label">Tower Boot</div>
            <div class="tower-cond-buttons" data-cond-type="boot">
              <button type="button" class="tower-cond-btn" data-status="good" data-value="Good">Good</button>
              <button type="button" class="tower-cond-btn" data-status="warning" data-value="Cracking">Cracking</button>
              <button type="button" class="tower-cond-btn" data-status="bad" data-value="Replace">Replace</button>
            </div>
          </div>

          <div class="tower-cond-row">
            <div class="tower-cond-label">Tower Box</div>
            <div class="tower-cond-buttons" data-cond-type="box">
              <button type="button" class="tower-cond-btn" data-status="good" data-value="Good">Good</button>
              <button type="button" class="tower-cond-btn" data-status="warning" data-value="Cracked Lid">Cracked Lid</button>
              <button type="button" class="tower-cond-btn" data-status="warning" data-value="Replace Contactor & Micro-switch">Replace Contactor &amp; Micro-switch</button>
              <button type="button" class="tower-cond-btn" data-status="bad" data-value="Replace Box">Replace Box</button>
            </div>
          </div>
        </div>

        <div class="tower-actions">
          <button type="button" class="btn-add-tower">+ Add Tower</button>
          <button type="button" class="btn-remove-tower">Remove Tower</button>
        </div>
      </div>
    </template>

    <!-- Shared component card -->
    <div id="componentCard" class="component-card">
      <div class="component-card-header">
        <span id="cardTitle">Component</span>
        <button class="close-card-btn" id="closeCardBtn" aria-label="Close card">√ó</button>
      </div>
      <div class="component-card-body">
        <div class="options-row" id="optionsRow"></div>

        <div class="psi-row" id="psiRow">
          <label for="psiInput">Tire Pressure (PSI)</label>
          <div class="psi-input-wrap">
            <input type="number" id="psiInput" min="0" step="1" placeholder="e.g. 45" />
            <span>PSI</span>
          </div>
          <div class="psi-error" id="psiError">Enter PSI and choose a condition to continue.</div>
        </div>
      </div>
    </div>

    <!-- Report buttons -->
    <div class="report-actions">
      <button type="button" class="report-btn" id="btnSubmitReports">Submit</button>
    </div>
  </form>


  <!-- In-app Report Viewer -->
  <div id="reportModal" class="report-modal" aria-hidden="true">
    <div class="report-modal-backdrop" id="reportModalBackdrop"></div>
    <div class="report-modal-panel" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle">
      <div class="report-modal-header">
        <div id="reportModalTitle" class="report-modal-title">Reports</div>
        <button type="button" class="report-modal-close" id="reportModalClose" aria-label="Close reports">√ó</button>
      </div>

      <div class="report-modal-tabs">
        <button type="button" class="report-tab active" id="tabCustomer">Customer Report</button>
        <button type="button" class="report-tab" id="tabTech">Tech Report</button>
      </div>

      <div class="report-modal-body">
        <div id="customerReportView" class="report-view active"></div>
        <div id="techReportView" class="report-view"></div>
      </div>
    </div>
  </div>


  <!-- Hidden (off-screen) container for PDF generation -->
  <div id="pdfContainer"
       style="position:absolute; left:-9999px; top:0; width:1000px; background:#ffffff;"></div>

  <script>
    // ---------- CONFIG ----------

    const componentConfigs = {
      reverseTire: {
        label: 'Reverse Tire',
        type: 'tire',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Low PSI', status: 'warning' },
          { label: 'Flat / Severe Cracking', status: 'bad' }
        ]
      },
      forwardTire: {
        label: 'Forward Tire',
        type: 'tire',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Low PSI', status: 'warning' },
          { label: 'Flat / Severe Cracking', status: 'bad' }
        ]
      },
      reverseWheelGear: {
        label: 'Reverse Wheel Gear',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Low Oil', status: 'warning' },
          { label: 'Input Shaft Leaking', status: 'warning' },
          { label: 'Output Shaft Leaking', status: 'bad' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      forwardWheelGear: {
        label: 'Forward Wheel Gear',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Low Oil', status: 'warning' },
          { label: 'Input Shaft Leaking', status: 'warning' },
          { label: 'Output Shaft Leaking', status: 'bad' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      reverseWheelCoupler: {
        label: 'Reverse Wheel Coupler',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Worn', status: 'warning' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      forwardWheelCoupler: {
        label: 'Forward Wheel Coupler',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Worn', status: 'warning' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      reverseDriveLine: {
        label: 'Reverse Drive Line',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      forwardDriveLine: {
        label: 'Forward Drive Line',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      reverseDriveLineCover: {
        label: 'Reverse Drive Line Cover',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      forwardDriveLineCover: {
        label: 'Forward Drive Line Cover',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      centerReverseCoupler: {
        label: 'Center Drive Reverse Coupler',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Worn', status: 'warning' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      centerForwardCoupler: {
        label: 'Center Drive Forward Coupler',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Worn', status: 'warning' },
          { label: 'Replace', status: 'bad' }
        ]
      },
      centerDrive: {
        label: 'Center Drive',
        type: 'normal',
        options: [
          { label: 'Good', status: 'good' },
          { label: 'Low Oil', status: 'warning' },
          { label: 'Output Shaft Leaking', status: 'warning' },
          { label: 'Replace', status: 'bad' }
        ]
      }
    };

    const card = document.getElementById('componentCard');
    const cardTitle = document.getElementById('cardTitle');
    const optionsRow = document.getElementById('optionsRow');
    const psiRow = document.getElementById('psiRow');
    const psiInput = document.getElementById('psiInput');
    const psiError = document.getElementById('psiError');
    const closeCardBtn = document.getElementById('closeCardBtn');

    const towersContainer = document.getElementById('towersContainer');
    const towerTemplate = document.getElementById('towerTemplate');

    const btnSubmitReports = document.getElementById('btnSubmitReports');

let towerCounter = 0;
    let currentTowerId = null;
    let currentComponentId = null;
    let currentCanvasEl = null;

    // selections[towerId][componentId] = { condition, status, psi? }
    const selections = {};

    // towerMeta[towerId] = { boot: { value, status }, box: { value, status } }
    const towerMeta = {};

    // ---------- CARD / HOTSPOT LOGIC ----------

    function clearStatusOnHotspot(hotspot) {
      hotspot.classList.remove('status-good', 'status-warning', 'status-bad');
    }

    function openCardForComponent(towerId, componentId, hotspotEl, canvasEl) {
      const config = componentConfigs[componentId];
      if (!config) return;

      currentTowerId = towerId;
      currentComponentId = componentId;
      currentCanvasEl = canvasEl;

      cardTitle.textContent = `${config.label} ‚Äì Tower ${towerId}`;

      canvasEl.appendChild(card);

      optionsRow.innerHTML = '';
      const existing =
        selections[towerId] && selections[towerId][componentId]
          ? selections[towerId][componentId]
          : null;

      config.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `option-btn status-${opt.status}`;
        btn.dataset.status = opt.status;
        btn.dataset.value = opt.label;

        const dot = document.createElement('span');
        dot.className = 'option-dot';

        const text = document.createElement('span');
        text.textContent = opt.label;

        btn.appendChild(dot);
        btn.appendChild(text);

        if (existing && existing.condition === opt.label) {
          btn.classList.add('selected');
        }

        btn.addEventListener('click', () => {
          handleOptionSelect(towerId, componentId, hotspotEl, opt.status, opt.label, btn);
        });

        optionsRow.appendChild(btn);
      });

      if (config.type === 'tire') {
        psiRow.style.display = 'block';
        if (existing && existing.psi) {
          psiInput.value = existing.psi;
        } else {
          psiInput.value = '';
        }
        psiError.style.display = 'none';
      } else {
        psiRow.style.display = 'none';
        psiInput.value = '';
        psiError.style.display = 'none';
      }

      const canvasRect = canvasEl.getBoundingClientRect();
      const hotRect = hotspotEl.getBoundingClientRect();

      let left = hotRect.right - canvasRect.left + 10;
      let top = hotRect.top - canvasRect.top - 10;

      const maxLeft = canvasRect.width - 270;
      if (left > maxLeft) left = maxLeft;
      if (left < 0) left = 0;

      const maxTop = canvasRect.height - 160;
      if (top > maxTop) top = maxTop;
      if (top < 0) top = 0;

      card.style.left = left + 'px';
      card.style.top = top + 'px';

      card.classList.add('active');
    }

    function handleOptionSelect(towerId, componentId, hotspot, status, label, btnEl) {
      const config = componentConfigs[componentId];
      if (!config || !hotspot) return;

      let finalStatus = status;
      let finalLabel = label;

      if (config.type === 'tire') {
        const psiVal = psiInput.value.trim();
        const psiNum = psiVal ? parseFloat(psiVal) : NaN;

        if (!psiVal || isNaN(psiNum)) {
          psiError.style.display = 'block';
          psiInput.focus();
          return;
        }

        if (psiNum < 20 && status === 'good') {
          finalStatus = 'warning';
        }

        psiError.style.display = 'none';

        if (!selections[towerId]) selections[towerId] = {};
        if (!selections[towerId][componentId]) selections[towerId][componentId] = {};
        selections[towerId][componentId].psi = psiVal;
      }

      optionsRow.querySelectorAll('.option-btn').forEach(b => {
        b.classList.remove('selected');
      });
      btnEl.classList.add('selected');

      clearStatusOnHotspot(hotspot);
      hotspot.classList.add(`status-${finalStatus}`);

      if (!selections[towerId]) selections[towerId] = {};
      if (!selections[towerId][componentId]) selections[towerId][componentId] = {};
      selections[towerId][componentId].condition = finalLabel;
      selections[towerId][componentId].status = finalStatus;

      closeCard();
    }

    function closeCard() {
      card.classList.remove('active');
      currentTowerId = null;
      currentComponentId = null;
      currentCanvasEl = null;
    }

    closeCardBtn.addEventListener('click', () => {
      closeCard();
    });

    function initTowerSection(sectionEl, towerId) {
      sectionEl.dataset.towerId = String(towerId);
      const numSpan = sectionEl.querySelector('.tower-number');
      if (numSpan) numSpan.textContent = String(towerId);

      const canvasEl = sectionEl.querySelector('.tower-layout');
      const hotspots = canvasEl.querySelectorAll('.hotspot');

      hotspots.forEach(h => {
        const compId = h.dataset.component;
        h.addEventListener('click', () => {
          openCardForComponent(towerId, compId, h, canvasEl);
        });
      });
      // Tower-level condition buttons (Tower Boot / Tower Box)
      const condGroups = sectionEl.querySelectorAll('.tower-cond-buttons');
      condGroups.forEach(group => {
        const type = group.dataset.condType; // 'boot' or 'box'
        const buttons = Array.from(group.querySelectorAll('.tower-cond-btn'));

        // Restore existing selection if present
        const existing = towerMeta[towerId] && towerMeta[towerId][type] ? towerMeta[towerId][type] : null;
        if (existing) {
          buttons.forEach(b => {
            if (b.dataset.value === existing.value) {
              b.classList.add('selected');
            } else {
              b.classList.remove('selected');
            }
          });
        }

        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            // Single-select within this group
            buttons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');

            if (!towerMeta[towerId]) towerMeta[towerId] = {};
            towerMeta[towerId][type] = {
              value: btn.dataset.value || '',
              status: btn.dataset.status || ''
            };
          });
        });
      });


      const addBtn = sectionEl.querySelector('.btn-add-tower');
      const addEndBtn = sectionEl.querySelector('.btn-add-end-tower');
      const removeBtn = sectionEl.querySelector('.btn-remove-tower');

      addBtn.addEventListener('click', () => {
        addTower();
      });

      if (addEndBtn) {
        addEndBtn.addEventListener('click', () => {
          addEndTower();
        });
      }

      removeBtn.addEventListener('click', () => {
        const sections = Array.from(
          towersContainer.querySelectorAll('.tower-section')
        );
        if (sections.length <= 1) {
          alert('At least one tower is required.');
          return;
        }
        // Clean up stored data for this tower
        delete selections[towerId];
        delete towerMeta[towerId];
        sectionEl.remove();
      });
    }

    let hasEndTower = false;
    let endTowerSectionEl = null;
    let endTowerId = null;

    function addTower() {
      towerCounter += 1;
      const cloneFrag = towerTemplate.content.cloneNode(true);
      const section = cloneFrag.querySelector('.tower-section');

      // If an end tower exists, always insert new towers BEFORE it so end tower stays last
      if (hasEndTower && endTowerSectionEl && endTowerSectionEl.parentNode === towersContainer) {
        towersContainer.insertBefore(section, endTowerSectionEl);
      } else {
        towersContainer.appendChild(section);
      }

      initTowerSection(section, towerCounter);
    }

    function addEndTower() {
      if (hasEndTower) {
        alert('End tower already added.');
        return;
      }
      hasEndTower = true;

      towerCounter += 1;
      const cloneFrag = towerTemplate.content.cloneNode(true);
      const section = cloneFrag.querySelector('.tower-section');

      section.classList.add('end-tower');
      section.dataset.towerType = 'end';

      // Update title
      const titleEl = section.querySelector('.section-title');
      if (titleEl) {
        titleEl.childNodes.forEach(n => {
          if (n.nodeType === Node.TEXT_NODE) n.textContent = 'End Tower Inspection ‚Äì Tower ';
        });
      }
      const numSpan = section.querySelector('.tower-number');
      if (numSpan) numSpan.textContent = String(towerCounter);

      // Remove Tower Boot condition row
      const bootGroup = section.querySelector('.tower-cond-buttons[data-cond-type="boot"]');
      if (bootGroup) {
        const row = bootGroup.closest('.tower-cond-row');
        if (row) row.remove();
      }

      // Add Cleaned Sand Trap checkbox row (after tower box row)
      const conditions = section.querySelector('.tower-conditions');
      if (conditions) {
        const sandRow = document.createElement('div');
        sandRow.className = 'tower-cond-row';
        sandRow.innerHTML = `
          <div class="tower-cond-label">Cleaned Sand Trap</div>
          <div class="tower-cond-buttons" data-cond-type="sandtrap" style="display:flex;align-items:center;gap:10px;">
            <label style="display:flex;align-items:center;gap:8px;color:#495057;font-weight:600;">
              <input type="checkbox" class="end-sand-trap" />
              Yes
            </label>
          </div>
        `;
        // insert after the first existing cond-row (typically Tower Box) if present
        const firstRow = conditions.querySelector('.tower-cond-row');
        if (firstRow && firstRow.nextSibling) {
          conditions.insertBefore(sandRow, firstRow.nextSibling);
        } else {
          conditions.appendChild(sandRow);
        }
      }

      // Append at end
      towersContainer.appendChild(section);
      endTowerSectionEl = section;
      endTowerId = towerCounter;

      initTowerSection(section, towerCounter);
    }
// Initialize first tower
    addTower();

    // ---------- GEOLOCATION ----------

    const useLocationBtn = document.getElementById('useLocationBtn');
    const locationInput = document.getElementById('locationInput');

    useLocationBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          locationInput.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
        },
        (err) => {
          console.error(err);
          alert('Unable to get current location.');
        }
      );
    });

    // ---------- REPORT DATA HELPERS ----------

    function gatherFormData() {
      const formData = {
        customerName: document.getElementById('customerName').value || '',
        systemBrand: document.getElementById('systemBrand').value || '',
        inspectedBy: document.getElementById('inspectedBy').value || '',
        fieldName: document.getElementById('fieldName').value || '',
        location: document.getElementById('locationInput').value || '',
        inspectionDate: document.getElementById('inspectionDate').value || '',
        machineHours: document.getElementById('machineHours').value || '',
        startTime: document.getElementById('startTime').value || '',
        endTime: document.getElementById('endTime').value || '',
        notes: {
          wellMotorOil: document.getElementById('wellMotorOil').value || '',
          dripOilSystem: document.getElementById('dripOilSystem').value || '',
          wellPanel: document.getElementById('WellPanel').value || '',
          waterSupply: document.getElementById('waterSupply').value || '',
          mainControlPanel: document.getElementById('mainControlPanel').value || '',
          pivotFoundation: document.getElementById('pivotFoundation').value || '',
          anchoringSystem: document.getElementById('anchoringSystem').value || '',
          centerPointStructure: document.getElementById('centerPointStructure').value || '',
          collectorRing: document.getElementById('collectorRing').value || '',
          towerBootNote: document.getElementById('towerBootNote').value || ''
        },
        towers: []
      };

      const towerSections = towersContainer.querySelectorAll('.tower-section');
      towerSections.forEach(section => {
        const towerId = parseInt(section.dataset.towerId, 10);
        const commentEl = section.querySelector('.tower-comment');
        const towerComment = commentEl ? commentEl.value : '';

        const isEndTower = section.dataset.towerType === 'end';
        const sandTrapEl = section.querySelector('.end-sand-trap');
        const cleanedSandTrap = sandTrapEl ? !!sandTrapEl.checked : false;

        const towerData = {
          id: towerId,
          towerType: isEndTower ? 'end' : 'standard',
          comment: towerComment,
          cleanedSandTrap: isEndTower ? cleanedSandTrap : null,
          towerBoot: (!isEndTower && towerMeta[towerId] && towerMeta[towerId].boot) ? towerMeta[towerId].boot : null,
          towerBox: (towerMeta[towerId] && towerMeta[towerId].box) ? towerMeta[towerId].box : null,
          components: selections[towerId] || {}
        };

        formData.towers.push(towerData);
      });

      return formData;
    }

    function statusLabel(status) {
      if (status === 'good') return 'Good';
      if (status === 'warning') return 'Attention Needed';
      if (status === 'bad') return 'Needs Repair';
      return status || 'Unknown';
    }

    // ---------- CUSTOMER REPORTS ‚Üí PDF WITH COLORED PILLS ----------

    function generateCustomerReportHtml() {
      const data = gatherFormData();

      let html = '';

      html += `
        <div class="brand-header">
          <div class="brand-title">Pracht Irrigation ‚Äì Pivot Inspection Report</div>
          <div class="brand-sub">Customer-facing summary of inspection findings</div>
        </div>
      `;

      html += '<div class="cover-card">';
      html += '<h2>Inspection Summary</h2>';
      html += '<div class="info-grid">';

      function infoRow(label, value) {
        if (!value) return '';
        return `
          <div>
            <div class="info-label">${label}</div>
            <div>${value}</div>
          </div>
        `;
      }

      html += infoRow('Customer / Company', data.customerName);
      html += infoRow('System Brand', data.systemBrand);
      html += infoRow('Field Name', data.fieldName);
      html += infoRow('Location', data.location);
      html += infoRow('Date of Inspection', data.inspectionDate);
      html += infoRow('Hours on Machine', data.machineHours);
      html += infoRow('Inspection Performed By', data.inspectedBy);
      html += infoRow('Start Time', data.startTime);
      html += infoRow('End Time', data.endTime);

      html += '</div></div>';

      // Notes
      html += '<div>';
      html += '<h3 class="section-title report-section-title">System Notes</h3>';
      html += '<div class="notes-block">';

      const noteEntries = [
        ['Well Motor Oil Level', data.notes.wellMotorOil],
        ['Drip Oil System', data.notes.dripOilSystem],
        ['Well Panel', data.notes.wellPanel],
        ['Water Supply', data.notes.waterSupply],
        ['Main Control Panel', data.notes.mainControlPanel],
        ['Pivot Foundation', data.notes.pivotFoundation],
        ['Anchoring System', data.notes.anchoringSystem],
        ['Center Point Structure', data.notes.centerPointStructure],
        ['Collector Ring', data.notes.collectorRing],
        ['Tower Boot', data.notes.towerBootNote]
      ];

      noteEntries.forEach(([label, value]) => {
        if (value) {
          html += `<div><strong>${label}:</strong> ${value}</div>`;
        }
      });

      html += '</div></div>';

      // Towers
      html += '<h3 class="section-title report-section-title">Tower Findings</h3>';

      data.towers
        .sort((a, b) => a.id - b.id)
        .forEach(tower => {
          const comps = tower.components || {};
          const compKeys = Object.keys(comps);

          html += '<div class="tower-card">';
          html += `<div class="tower-header-report">Tower ${tower.id}</div>`;

          if (tower.comment) {
            html += `<div class="small-note"><strong>Notes:</strong> ${tower.comment}</div>`;
          }

          if (compKeys.length === 0) {
            html += '<div class="small-note">No components inspected on this tower.</div>';
          } else {
            html += '<table class="report-table">';
            html += '<tr><th>Component</th><th>Condition</th><th>Status</th><th>Details</th></tr>';
            compKeys.forEach(key => {
              const c = comps[key];
              if (!c) return;

              const cfg = componentConfigs[key];
              const name = cfg ? cfg.label : key;
              const status = c.status || 'good';
              const label = statusLabel(status);
              let pillClass = 'status-pill ';
              if (status === 'good') pillClass += 'status-good-pill';
              else if (status === 'warning') pillClass += 'status-warning-pill';
              else pillClass += 'status-bad-pill';
              const detail = c.psi ? `Tire PSI: ${c.psi}` : '';

              html += '<tr>';
              html += `<td>${name}</td>`;
              html += `<td>${c.condition || ''}</td>`;
              html += `<td><span class="${pillClass}">${label}</span></td>`;
              html += `<td>${detail}</td>`;
              html += '</tr>';
            });
            html += '</table>';
          }

          html += '</div>';
        });

      html += '<div class="small-note">Legend: Green = OK, Yellow = Attention Needed, Red = Needs Repair.</div>';

      return html;
    }

    function openCustomerReport() {
      const container = document.getElementById('pdfContainer');

      if (typeof html2pdf === 'undefined') {
        alert('PDF engine did not load, falling back to print.');
        openCustomerReportPrintFallback();
        return;
      }

      container.innerHTML = generateCustomerReportHtml();

      const filename = 'Customer_Report.pdf';


      const opt = {
        margin:       0.5,
        filename:     filename,
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      // Let the browser lay out the off-screen content before capture
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          html2pdf().from(container).set(opt).save();
        });
      });
}

    // Fallback: same layout, but via print window
    function openCustomerReportPrintFallback() {
      const html = generateCustomerReportHtml();
      const win = window.open('', '_blank');
      if (!win) {
        alert('Popup blocked. Please allow popups to see the report.');
        return;
      }
      const doc = win.document;
      doc.write('<html><head><title>Pivots ‚Äì Customer Report</title>  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head><body>');
      doc.write(html);
      doc.write('</body></html>');
      doc.close();
      win.focus();
      win.print();
      win.onafterprint = () => win.close();
    }

    // ---------- TECH REPORT (print-based) ----------

    function openTechReport() {
      const data = gatherFormData();
      const win = window.open('', '_blank');

      if (!win) {
        alert('Popup blocked. Please allow popups to see the report.');
        return;
      }

      const doc = win.document;

      doc.write('<html><head><title>Pivots ‚Äì Tech Report</title>');
      doc.write(`
        <style>
          body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 1rem 1.5rem;
            color: #212529;
            font-size: 0.9rem;
          }
          h1 {
            margin: 0 0 0.5rem;
            font-size: 1.35rem;
          }
          .tech-header {
            border-bottom: 2px solid #495057;
            margin-bottom: 0.5rem;
          }
          .meta {
            font-size: 0.8rem;
            color: #495057;
            margin-bottom: 0.5rem;
          }
          .tower-block {
            margin-bottom: 0.6rem;
          }
          .tower-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
          }
          ul {
            margin: 0.1rem 0 0.4rem 1.1rem;
            padding: 0;
          }
          li {
            margin-bottom: 0.1rem;
          }
          .status-good {
            color: #4caf50;
          }
          .status-warning {
            color: #ffc107;
          }
          .status-bad {
            color: #f44336;
          }
        </style>
      `);
      doc.write('  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head><body>');

      doc.write('<div class="tech-header">');
      doc.write('<h1>Pivot Inspection ‚Äì Tech Report</h1>');
      doc.write('</div>');

      doc.write('<div class="meta">');
      if (data.customerName) doc.write(`<div>Customer: ${data.customerName}</div>`);
      if (data.fieldName) doc.write(`<div>Field: ${data.fieldName}</div>`);
      if (data.location) doc.write(`<div>Location: ${data.location}</div>`);
      if (data.inspectionDate) doc.write(`<div>Date: ${data.inspectionDate}</div>`);
      doc.write('</div>');

      data.towers
        .sort((a, b) => a.id - b.id)
        .forEach(tower => {
          const comps = tower.components || {};
          const compKeys = Object.keys(comps);

          const problemItems = compKeys
            .map(key => {
              const c = comps[key];
              if (!c) return null;
              if (c.status === 'good') return null;
              return { id: key, ...c };
            })
            .filter(Boolean);

          if (problemItems.length === 0) {
            return;
          }

          doc.write('<div class="tower-block">');
          doc.write(`<div class="tower-title">Tower ${tower.id}</div>`);
          if (tower.comment) {
            doc.write(`<div><em>${tower.comment}</em></div>`);
          }
          doc.write('<ul>');
          problemItems.forEach(item => {
            const cfg = componentConfigs[item.id];
            const name = cfg ? cfg.label : item.id;
            const statusCls = `status-${item.status || 'good'}`;
            const psiPart = item.psi ? ` ‚Äì Tire PSI: ${item.psi}` : '';
            doc.write(`<li class="${statusCls}">${name}: ${item.condition || ''}${psiPart}</li>`);
          });
          doc.write('</ul>');
          doc.write('</div>');
        });

      doc.write('</body></html>');
      doc.close();

      win.focus();
      win.print();
      win.onafterprint = () => win.close();
    }

    // ---------- WIRE REPORT BUTTONS ----------

    // One button ‚Üí generate BOTH reports (local only)
    
    // ---------- IN-APP REPORT VIEWER ----------

    const reportModal = document.getElementById('reportModal');
    const reportModalBackdrop = document.getElementById('reportModalBackdrop');
    const reportModalClose = document.getElementById('reportModalClose');
    const tabCustomer = document.getElementById('tabCustomer');
    const tabTech = document.getElementById('tabTech');
    const customerReportView = document.getElementById('customerReportView');
    const techReportView = document.getElementById('techReportView');

    function openReportModal() {
      reportModal.classList.add('open');
      reportModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeReportModal() {
      reportModal.classList.remove('open');
      reportModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    function setActiveTab(which) {
      if (which === 'tech') {
        tabTech.classList.add('active');
        tabCustomer.classList.remove('active');
        techReportView.classList.add('active');
        customerReportView.classList.remove('active');
      } else {
        tabCustomer.classList.add('active');
        tabTech.classList.remove('active');
        customerReportView.classList.add('active');
        techReportView.classList.remove('active');
      }
    }

    reportModalBackdrop.addEventListener('click', closeReportModal);
    reportModalClose.addEventListener('click', closeReportModal);
    tabCustomer.addEventListener('click', () => setActiveTab('customer'));
    tabTech.addEventListener('click', () => setActiveTab('tech'));
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && reportModal.classList.contains('open')) closeReportModal();
    });

    function generateTechReportHtml() {
      const data = gatherFormData();

      let html = '';
      html += '<div class="report-page">';
      html += `
        <div style="border-bottom:2px solid #495057; padding-bottom:0.4rem; margin-bottom:0.6rem;">
          <div style="font-size:1.35rem; font-weight:700; margin:0;">Pivot Inspection ‚Äì Tech Report</div>
          <div style="font-size:0.85rem; color:#495057; margin-top:0.35rem;">
            ${data.customerName ? `<div>Customer: ${data.customerName}</div>` : ''}
            ${data.fieldName ? `<div>Field: ${data.fieldName}</div>` : ''}
            ${data.location ? `<div>Location: ${data.location}</div>` : ''}
            ${data.inspectionDate ? `<div>Date: ${data.inspectionDate}</div>` : ''}
          </div>
        </div>
      `;


      // Notes & Quick Findings (same info captured on the form)
      const noteEntries = [
        ['Well Motor Oil Level', data.notes?.wellMotorOil],
        ['Drip Oil System', data.notes?.dripOilSystem],
        ['Well Panel', data.notes?.wellPanel],
        ['Water Supply', data.notes?.waterSupply],
        ['Main Control Panel', data.notes?.mainControlPanel],
        ['Pivot Foundation', data.notes?.pivotFoundation],
        ['Anchoring System', data.notes?.anchoringSystem],
        ['Center Point Structure', data.notes?.centerPointStructure],
        ['Collector Ring', data.notes?.collectorRing],
        ['Tower Boot', data.notes?.towerBootNote]
      ];

      const hasAnyNotes = noteEntries.some(([, v]) => v && String(v).trim().length > 0);
      if (hasAnyNotes) {
        html += '<div style="margin:0.25rem 0 0.75rem; padding:0.55rem 0.65rem; border:1px solid #dee2e6; border-radius:10px; background:#f8f9fa;">';
        html += '<div style="font-weight:700; margin-bottom:0.35rem;">Notes &amp; Quick Findings</div>';
        noteEntries.forEach(([label, value]) => {
          const v = (value || '').toString().trim();
          if (!v) return;
          html += `<div style="margin-bottom:0.2rem;"><strong style="display:inline-block; min-width:170px;">${label}:</strong> ${v}</div>`;
        });
        html += '</div>';
      }


      // Tower-level notes (boot/box) and tower comments are included, plus problem components.
      const towers = (data.towers || []).slice().sort((a,b) => a.id - b.id);

      towers.forEach(tower => {
        const comps = tower.components || {};
        const compKeys = Object.keys(comps);

        const problemItems = compKeys
          .map(key => {
            const c = comps[key];
            if (!c) return null;
            if (c.status === 'good') return null;
            return { id: key, ...c };
          })
          .filter(Boolean);

        // Keep behavior: Tech report shows problem towers only
        if (problemItems.length === 0 && !tower.comment && !tower.towerBoot && !tower.towerBox) {
          return;
        }

        html += '<div style="margin-bottom:0.8rem;">';
        html += `<div style="font-weight:700; margin-bottom:0.25rem;">Tower ${tower.id}</div>`;

        // tower boot / box conditions
        if (tower.towerBoot) {
          html += `<div style="margin-bottom:0.15rem;"><strong>Tower Boot:</strong> ${tower.towerBoot.value || tower.towerBoot}</div>`;
        }
        if (tower.towerBox) {
          html += `<div style="margin-bottom:0.15rem;"><strong>Tower Box:</strong> ${tower.towerBox.value || tower.towerBox}</div>`;
        }

        if (tower.comment) {
          html += `<div style="margin:0.2rem 0 0.35rem; color:#495057;"><em>${tower.comment}</em></div>`;
        }

        if (problemItems.length > 0) {
          html += '<ul style="margin:0.1rem 0 0.4rem 1.1rem; padding:0;">';
          problemItems.forEach(item => {
            const cfg = componentConfigs[item.id];
            const name = cfg ? cfg.label : item.id;
            const color =
              item.status === 'bad' ? '#f44336' :
              item.status === 'warning' ? '#ffc107' :
              '#4caf50';
            const psiPart = item.psi ? ` ‚Äì Tire PSI: ${item.psi}` : '';
            html += `<li style="margin-bottom:0.1rem; color:${color};">${name}: ${item.condition || ''}${psiPart}</li>`;
          });
          html += '</ul>';
        } else {
          html += '<div style="font-size:0.85rem; color:#868e96;">No problem components recorded.</div>';
        }

        html += '</div>';
      });

      html += '</div>';
      return html;
    }

    // ---------- SUBMIT (IN-APP) ----------
    btnSubmitReports.addEventListener('click', () => {
      // Build both reports and show them inside the app (no popups, no downloads)
      customerReportView.innerHTML = '<div class="report-page">' + generateCustomerReportHtml() + '</div>';
      techReportView.innerHTML = generateTechReportHtml();

      setActiveTab('customer');
     openReportModal();
});

   
</script>
  <script type="module">
  // Generate a PDF from a report container
// ===================== PDF (Programmatic via pdf-lib) =====================
// We do NOT screenshot HTML. We draw the PDF from gatherFormData() so tower cards can repeat
// and never split mid-card.

function _pdfRgb(hex) {
  const h = String(hex || "#000000").replace("#", "");
  const r = parseInt(h.slice(0, 2), 16) / 255;
  const g = parseInt(h.slice(2, 4), 16) / 255;
  const b = parseInt(h.slice(4, 6), 16) / 255;
  return PDFLib.rgb(r, g, b);
}

function _wrapLines(font, size, text, maxWidth) {
  const words = String(text || "").split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";
  for (const w of words) {
    const test = line ? (line + " " + w) : w;
    if (font.widthOfTextAtSize(test, size) <= maxWidth) line = test;
    else {
      if (line) lines.push(line);
      line = w;
    }
  }
  if (line) lines.push(line);
  return lines.length ? lines : [""];
}

function _statusToPill(status) {
  if (status === "good") return { label: "OK", fill: "#2f9e44", text: "#ffffff", warn: false };
  if (status === "warning") return { label: "ATTN", fill: "#ffd43b", text: "#111111", warn: true };
  if (status === "bad") return { label: "REPAIR", fill: "#c92a2a", text: "#ffffff", warn: true };
  return { label: "‚Äî", fill: "#adb5bd", text: "#111111", warn: false };
}

function _drawText(page, x, y, text, { font, size = 10, color = "#111111" } = {}) {
  page.drawText(String(text ?? ""), { x, y, font, size, color: _pdfRgb(color) });
}

function _drawPill(page, x, yTop, text, fillHex, textHex, font, size = 9) {
  const padX = 6, padY = 3;
  const textW = font.widthOfTextAtSize(text, size);
  const w = textW + padX * 2;
  const h = size + padY * 2;
  page.drawRectangle({ x, y: yTop - h, width: w, height: h, color: _pdfRgb(fillHex), borderColor: _pdfRgb(fillHex), borderWidth: 0 });
  _drawText(page, x + padX, yTop - h + padY, text, { font, size, color: textHex });
  return { w, h };
}

function _drawWarn(page, x, y, size = 12) {
  const fill = _pdfRgb("#ffd43b");
  page.drawPolygon([{x, y}, {x:x+size, y}, {x:x+size/2, y:y+size}], { color: fill, borderColor: fill, borderWidth: 0 });
  page.drawText("!", { x: x + size*0.38, y: y + size*0.18, size: size*0.7, font: page._warnFont, color: _pdfRgb("#111111") });
}

function _newPage(doc) {
  return doc.addPage([612, 792]); // US Letter portrait
}

function _drawHeader(page, boldFont) {
  page.drawRectangle({ x: 0, y: 792 - 64, width: 612, height: 64, color: _pdfRgb("#1865ab") });
  _drawText(page, 36, 792 - 42, "Pracht Irrigation ‚Äì Pivot Inspection Report", { font: boldFont, size: 16, color: "#ffffff" });
}

function _drawInfoCard(page, yTop, data, boldFont, regularFont) {
  const x = 36, w = 612 - 72, h = 120;
  page.drawRectangle({ x, y: yTop - h, width: w, height: h, color: _pdfRgb("#f1f3f5"), borderColor: _pdfRgb("#dee2e6"), borderWidth: 1 });
  _drawText(page, x + 12, yTop - 22, "Job / Customer Info", { font: boldFont, size: 12, color: "#111111" });

  const items = [
    ["Customer", data.customerName],
    ["Field", data.fieldName],
    ["Location", data.location],
    ["Brand", data.systemBrand],
    ["Inspection Date", data.inspectionDate],
    ["Machine Hours", data.machineHours],
    ["Inspected By", data.inspectedBy],
    ["Start", data.startTime],
    ["End", data.endTime],
  ];
  const colW = (w - 24) / 3;
  let i = 0;
  for (const [label, val] of items) {
    const col = i % 3;
    const row = Math.floor(i / 3);
    const fx = x + 12 + col * colW;
    const fy = yTop - 44 - row * 26;
    _drawText(page, fx, fy, label + ":", { font: regularFont, size: 9, color: "#495057" });
    _drawText(page, fx + 70, fy, val || "", { font: regularFont, size: 9, color: "#111111" });
    i++;
  }
  return yTop - h - 16;
}

function _drawSectionBar(page, yTop, title, boldFont) {
  const x = 36, w = 612 - 72;
  page.drawRectangle({ x, y: yTop - 22, width: w, height: 22, color: _pdfRgb("#1865ab") });
  _drawText(page, x + 10, yTop - 16, title, { font: boldFont, size: 11, color: "#ffffff" });
  return yTop - 30;
}

function _drawSystemNotes(page, yTop, data, boldFont, regularFont) {
  let y = _drawSectionBar(page, yTop, "System Notes", boldFont);
  const x = 36, w = 612 - 72;
  const rows = [
    ["Well Motor Oil", data.notes?.wellMotorOil],
    ["Drip Oil System", data.notes?.dripOilSystem],
    ["Well Panel", data.notes?.wellPanel],
    ["Water Supply", data.notes?.waterSupply],
    ["Main Control Panel", data.notes?.mainControlPanel],
    ["Pivot Foundation", data.notes?.pivotFoundation],
    ["Anchoring System", data.notes?.anchoringSystem],
    ["Center Point Structure", data.notes?.centerPointStructure],
    ["Collector Ring", data.notes?.collectorRing],
    ["Tower Boot Note", data.notes?.towerBootNote],
  ];
  const boxH = rows.length * 14 + 18;
  page.drawRectangle({ x, y: y - boxH, width: w, height: boxH, color: _pdfRgb("#ffffff"), borderColor: _pdfRgb("#dee2e6"), borderWidth: 1 });
  let yy = y - 18;
  for (const [lbl, val] of rows) {
    _drawText(page, x + 10, yy, lbl + ":", { font: regularFont, size: 9, color: "#111111" });
    _drawText(page, x + 165, yy, val || "", { font: regularFont, size: 9, color: "#495057" });
    yy -= 14;
  }
  return y - boxH - 14;
}

function _estimateTowerCardHeight(tower, regularFont) {
  const base = 86;
  const comps = tower.components ? Object.keys(tower.components) : [];
  const compLines = Math.max(1, comps.length);
  const compHeight = compLines * 12 + 14;

  const lines = _wrapLines(regularFont, 9, tower.comment || "", 540);
  const commentHeight = Math.max(1, lines.length) * 11 + 16;

  const endExtra = tower.towerType === "end" ? 18 : 0;
  return base + compHeight + commentHeight + endExtra;
}

function _drawTowerCard(page, yTop, tower, boldFont, regularFont) {
  const x = 36, w = 612 - 72;
  const cardH = _estimateTowerCardHeight(tower, regularFont);
  page.drawRectangle({ x, y: yTop - cardH, width: w, height: cardH, color: _pdfRgb("#ffffff"), borderColor: _pdfRgb("#dee2e6"), borderWidth: 1 });

  const title = (tower.towerType === "end") ? `End Tower ${tower.id ?? ""}` : `Tower ${tower.id ?? ""}`;
  _drawText(page, x + 12, yTop - 20, title, { font: boldFont, size: 12 });

  const box = _statusToPill(tower.towerBox);
  const pillY = yTop - 34;
  const p1 = _drawPill(page, x + 12, pillY, `BOX: ${box.label}`, box.fill, box.text, boldFont, 9);
  if (box.warn) _drawWarn(page, x + 12 + p1.w + 6, pillY - 12, 12);

  let nextY = yTop - 54;

  if (tower.towerType !== "end") {
    const boot = _statusToPill(tower.towerBoot);
    const p2 = _drawPill(page, x + 12, nextY, `BOOT: ${boot.label}`, boot.fill, boot.text, boldFont, 9);
    if (boot.warn) _drawWarn(page, x + 12 + p2.w + 6, nextY - 12, 12);
    nextY -= 20;
  } else {
    const checked = tower.cleanedSandTrap ? "‚òë" : "‚òê";
    _drawText(page, x + 12, nextY - 10, `${checked} Cleaned Sand Trap`, { font: regularFont, size: 10 });
    nextY -= 20;
  }

  _drawText(page, x + 12, nextY - 10, "Items:", { font: boldFont, size: 10 });
  nextY -= 18;

  const comps = tower.components ? Object.entries(tower.components) : [];
  if (!comps.length) {
    _drawText(page, x + 24, nextY - 10, "‚Äî", { font: regularFont, size: 9, color: "#495057" });
    nextY -= 14;
  } else {
    for (const [k, v] of comps) {
      const line = `${k}: ${typeof v === "string" ? v : JSON.stringify(v)}`;
      const lines = _wrapLines(regularFont, 9, line, w - 60);
      for (const ln of lines) {
        _drawText(page, x + 24, nextY - 10, ln, { font: regularFont, size: 9, color: "#495057" });
        nextY -= 12;
      }
      nextY -= 2;
    }
  }

  _drawText(page, x + 12, nextY - 10, "Comments:", { font: boldFont, size: 10 });
  nextY -= 16;

  for (const ln of _wrapLines(regularFont, 9, tower.comment || "", w - 48)) {
    _drawText(page, x + 24, nextY - 10, ln, { font: regularFont, size: 9, color: "#495057" });
    nextY -= 12;
  }

  return yTop - cardH - 12;
}

async function buildCustomerPdfBytes(data) {
  const { PDFDocument, StandardFonts } = PDFLib;
  const doc = await PDFDocument.create();
  const boldFont = await doc.embedFont(StandardFonts.HelveticaBold);
  const regularFont = await doc.embedFont(StandardFonts.Helvetica);

  let page = _newPage(doc);
  page._warnFont = boldFont;
  _drawHeader(page, boldFont);

  let y = 792 - 78;
  y = _drawInfoCard(page, y, data, boldFont, regularFont);
  y = _drawSystemNotes(page, y, data, boldFont, regularFont);
  y = _drawSectionBar(page, y, "Tower Inspections", boldFont);

  for (const tower of (Array.isArray(data.towers) ? data.towers : [])) {
    const cardH = _estimateTowerCardHeight(tower, regularFont);
    if (y - cardH < 70) {
      page = _newPage(doc);
      page._warnFont = boldFont;
      _drawHeader(page, boldFont);
      y = 792 - 78;
      y = _drawSectionBar(page, y, "Tower Inspections (cont.)", boldFont);
    }
    y = _drawTowerCard(page, y, tower, boldFont, regularFont);
  }

  return await doc.save();
}

async function buildTechPdfBytes(data) {
  const { PDFDocument, StandardFonts } = PDFLib;
  const doc = await PDFDocument.create();
  const boldFont = await doc.embedFont(StandardFonts.HelveticaBold);
  const regularFont = await doc.embedFont(StandardFonts.Helvetica);

  let page = _newPage(doc);
  _drawHeader(page, boldFont);

  let y = 792 - 78;
  y = _drawInfoCard(page, y, data, boldFont, regularFont);
  y = _drawSectionBar(page, y, "Issues (Attention / Repair only)", boldFont);

  const issues = [];
  for (const t of (Array.isArray(data.towers) ? data.towers : [])) {
    const boxIssue = (t.towerBox === "warning" || t.towerBox === "bad");
    const bootIssue = (t.towerType !== "end") && (t.towerBoot === "warning" || t.towerBoot === "bad");
    if (boxIssue || bootIssue) {
      issues.push(`${t.towerType === "end" ? "End Tower" : "Tower " + t.id}: Box=${_statusToPill(t.towerBox).label}` + (t.towerType !== "end" ? `, Boot=${_statusToPill(t.towerBoot).label}` : ""));
    }
  }
  if (!issues.length) issues.push("No issues flagged.");

  for (const line of issues) {
    for (const ln of _wrapLines(regularFont, 10, line, 612 - 96)) {
      if (y < 80) {
        page = _newPage(doc);
        _drawHeader(page, boldFont);
        y = 792 - 78;
        y = _drawSectionBar(page, y, "Issues (cont.)", boldFont);
      }
      _drawText(page, 48, y - 10, "‚Ä¢ " + ln, { font: regularFont, size: 10 });
      y -= 14;
    }
    y -= 2;
  }

  return await doc.save();
}

function _downloadPdfBytes(bytes, filename) {
  const blob = new Blob([bytes], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1500);
}

async function generateReportPDF(kind = "customer") {
  if (!window.PDFLib) throw new Error("PDFLib not found. Make sure pdf-lib script is included.");
  const data = gatherFormData();
  return (kind === "tech") ? await buildTechPdfBytes(data) : await buildCustomerPdfBytes(data);
}

async function downloadReportPDF(kind = "customer") {
  const bytes = await generateReportPDF(kind);
  const filename = (kind === "tech") ? "inspection-tech-report.pdf" : "inspection-customer-report.pdf";
  _downloadPdfBytes(bytes, filename);
  return bytes;
}

// Opens a new tab immediately (gesture-friendly), then shows the PDF when ready.
window.openReportPDF = (kind = "customer") => {
  const w = window.open("about:blank", "_blank");
  (async () => {
    try {
      const bytes = await generateReportPDF(kind);
      const blob = new Blob([bytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      if (w) w.location.href = url;
      else _downloadPdfBytes(bytes, (kind === "tech") ? "inspection-tech-report.pdf" : "inspection-customer-report.pdf");
    } catch (e) {
      console.error(e);
      if (w) w.document.body.innerHTML = "<pre style='padding:12px;font-family:monospace'>" + String(e) + "</pre>";
    }
  })();
};

window.generateReportPDF = generateReportPDF;
window.downloadReportPDF = downloadReportPDF;


window.generateReportPDF = generateReportPDF;

    
</script>

</body>
</html>

