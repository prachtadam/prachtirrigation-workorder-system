<!doctype html>


<html lang="en">
<head>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../shared/supabase.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Office Dashboard (Local Demo)</title>
  <style>
    :root{
      --bg:#0f1216;
      --panel:#151a20;
      --panel2:#1b222b;
      --text:#e9eef5;
      --muted:#a9b4c2;
      --line:#2a3442;

      --blue:#2c6ed5;
      --lime:#7ad957;
      --yellow:#f2c94c;
      --orange:#f2994a;
      --red:#eb5757;
      --purple:#9b51e0;

      --cardRadius:16px;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(44,110,213,.25), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(155,81,224,.16), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    button, input, select, textarea{ font:inherit; color:inherit; }

    /* dropdown readability fix */
    select, option{ color: var(--text) !important; background: var(--panel2) !important; }

    .app{ display:grid; grid-template-columns: 320px 1fr; min-height:100vh; }

    /* Sidebar */
    .side{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(21,26,32,.96), rgba(15,18,22,.96));
      padding:18px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
    }
    .topRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; }
    .hamburger{
      width:44px; height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition:.15s;
    }
    .hamburger:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .hamburgerLines{ width:18px; height:12px; display:flex; flex-direction:column; justify-content:space-between; }
    .hamburgerLines span{ display:block; height:2px; border-radius:2px; background: rgba(233,238,245,.9); }

    .brandBtn{
      display:flex; gap:10px; align-items:center;
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
      text-align:left;
    }
    .dot{
      width:14px;height:14px;border-radius:50%;
      background: var(--blue);
      box-shadow: 0 0 0 6px rgba(44,110,213,.14);
      flex:0 0 auto;
    }
    .brandBtn h1{ font-size:15px; margin:0; letter-spacing:.3px; line-height:1.2; }
    .brandBtn p{ margin:0; font-size:12px; color:var(--muted); }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      text-align:left;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(44,110,213,.95), rgba(44,110,213,.75));
      border-color: rgba(44,110,213,.35);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(235,87,87,.92), rgba(235,87,87,.72));
      border-color: rgba(235,87,87,.35);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(122,217,87,.92), rgba(122,217,87,.72));
      border-color: rgba(122,217,87,.35);
    }
    .btn.warn{
      background: linear-gradient(180deg, rgba(242,201,76,.92), rgba(242,201,76,.72));
      border-color: rgba(242,201,76,.35);
    }
    .btn.small{ padding:8px 10px; border-radius:10px; font-size:13px; }

    .sectionTitle{
      font-size:12px;
      letter-spacing:.12em;
      color:var(--muted);
      margin:16px 0 10px;
      text-transform:uppercase;
    }
    .statusList{display:flex; flex-direction:column; gap:8px;}
    .statusItem{
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      background: rgba(255,255,255,.02);
    }
    .statusItem.active{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.05); }
    .pill{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
    }
    .dotPill{ display:inline-flex; align-items:center; gap:8px; }
    .miniDot{width:10px;height:10px;border-radius:50%}
    .miniDot.open{background: var(--lime)}
    .miniDot.paused{background: var(--red)}
    .miniDot.inprogress{background: var(--yellow)}
    .miniDot.finished{background: var(--orange)}
    .miniDot.closed{background: var(--purple)}

    /* Main */
    .main{ padding:18px 18px 24px; overflow:auto; }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .searchRow{ display:flex; gap:10px; align-items:center; flex:1; }
    .search{
      flex:1;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      color:var(--text);
    }
    .select{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      color:var(--text);
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-bottom:14px;
    }
    .card{
      grid-column: span 3;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius: var(--cardRadius);
      padding:12px;
      box-shadow: var(--shadow);
      min-height:84px;
    }
    .card .k{color:var(--muted); font-size:12px; margin-bottom:8px;}
    .card .v{font-size:22px; font-weight:750;}
    .card .sub{color:var(--muted); font-size:12px; margin-top:6px;}

    .tableWrap{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: var(--cardRadius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    th{
      color:var(--muted);
      font-weight:650;
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      background: rgba(255,255,255,.02);
    }
    tr:hover td{background: rgba(255,255,255,.03)}
    .jobTitle{ font-weight:750; margin-bottom:4px; }
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex; align-items:center; gap:7px;
      border-radius:999px; padding:4px 9px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .tag .miniDot{width:9px;height:9px}
    .rightAlign{text-align:right}
    .empty{ color:var(--muted); font-size:13px; line-height:1.4; padding:10px 0; }

    /* Pills / file views */
    .pillList{ display:flex; flex-direction:column; gap:10px; }
    .pillRow{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius: 14px;
      padding:12px;
      box-shadow: var(--shadow);
      cursor:pointer;
      transition:.15s;
    }
    .pillRow:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .pillTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .pillTop strong{ font-size:14px; }
    .pillMeta{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
      line-height:1.35;
    }
    .pillMeta.oneLine{
      margin-top:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 720px;
      line-height:1.2;
    }
    .pillBadges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .badge{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.02);
      color:var(--text);
    }

    .fileHeader{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:12px;
    }
    .fileHeader h2{ margin:0; font-size:18px; letter-spacing:.2px; }
    .fileHeader .sub{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: var(--cardRadius);
      padding:12px;
      box-shadow: var(--shadow);
      margin-bottom:12px;
    }
    .panelHead{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      margin-bottom:10px;
    }
    .panelHead .title{ font-size:12px; letter-spacing:.12em; color:var(--muted); text-transform:uppercase; }
    .kv{
      display:grid;
      grid-template-columns: 190px 1fr;
      gap:8px 10px;
      font-size:13px;
      align-items:start;
    }
    .kv div:nth-child(odd){color:var(--muted)}
    .kv div:nth-child(even){color:var(--text)}
    .input, .textarea, .select2{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      font-size:13px;
      color:var(--text);
    }
    .textarea{ min-height:90px; resize:vertical; }
    .divider{ height:1px; background: rgba(255,255,255,.06); margin:12px 0; }
    .btnRow{display:flex; gap:10px; flex-wrap:wrap}

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(18,22,28,.98);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHeader h3{margin:0; font-size:14px; letter-spacing:.2px}
    .modalBody{padding:14px}
    .formGrid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; }
    .field{ grid-column: span 6; }
    .field.third{ grid-column: span 4; }
    .field.full{ grid-column: span 12; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .help{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35; }

    /* Settings layout */
    .settingsShell{ display:grid; grid-template-columns: 260px 1fr; gap:12px; }
    .settingsNav{ border:1px solid var(--line); border-radius:16px; background: rgba(255,255,255,.02); overflow:hidden; }
    .settingsNav button{
      width:100%;
      border:none;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: transparent;
      padding:12px;
      cursor:pointer;
      text-align:left;
    }
    .settingsNav button:hover{ background: rgba(255,255,255,.03); }
    .settingsNav button.active{ background: rgba(44,110,213,.14); }
    .settingsPane{ border:1px solid var(--line); border-radius:16px; background: rgba(255,255,255,.02); padding:12px; }
    .rowLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06); }
    .rowLine:last-child{ border-bottom:none; }
    .tiny{ font-size:12px; color:var(--muted); }

    @media (max-width: 980px){
      .cards .card{ grid-column: span 6; }
    }
    @media (max-width: 760px){
      .app{grid-template-columns: 1fr}
      .side{position:relative;height:auto}
      .cards .card{ grid-column: span 12; }
      .kv{ grid-template-columns: 1fr; }
      .settingsShell{ grid-template-columns: 1fr; }
    }
  /* --- Detail title bars + description highlight --- */
.sectionBar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  background: linear-gradient(135deg, rgba(24,101,171,0.95), rgba(63,134,198,0.65));
  border: 1px solid rgba(255,255,255,0.18);
  color:#fff;
  font-weight: 900;
  letter-spacing: .2px;
}
.descHighlight{
  border: 1px solid rgba(63,134,198,0.6);
  background: rgba(63,134,198,0.10);
  border-radius: 14px;
  padding: 12px;
  margin: 10px 0 10px 0;
}
.descHighlight .label{
  font-size: 12px;
  color: rgba(255,255,255,0.75);
  font-weight: 800;
  margin-bottom: 6px;
}
.descHighlight .text{
  font-size: 14px;
  color: rgba(255,255,255,0.95);
  line-height: 1.35;
  white-space: pre-wrap;
}


/* --- SearchDropdown (type-to-search select) --- */
.sd{position:relative; width:100%;}
.sd-label{display:block; font-weight:700; margin:0 0 6px;}
.sd-btn{width:100%; display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid rgba(255,255,255,.14); border-radius:14px; background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;}
.sd-btn-text{overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left;}
.sd-caret{opacity:.7}
.sd-pop{position:absolute; z-index:9999; width:100%; margin-top:8px; border:1px solid rgba(255,255,255,.14); border-radius:14px; background:#0f141a; box-shadow:0 18px 40px rgba(0,0,0,.45); padding:10px;}
.sd-search{width:100%; padding:10px 12px; border:1px solid rgba(255,255,255,.14); border-radius:12px; background:rgba(255,255,255,.06); color:var(--text); outline:none;}
.sd-list{max-height:260px; overflow:auto; margin-top:8px;}
.sd-item{padding:10px; border-radius:12px; cursor:pointer; display:flex; justify-content:space-between; gap:10px;}
.sd-item:hover{background:rgba(255,255,255,.08);}
.sd-item small{color:rgba(255,255,255,.65);}
.sd-empty{padding:10px; color:rgba(255,255,255,.65);}

</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <!-- Supabase (shared with Tech App) -->
<script>
 console.log("OFFICE BUILD:", "Jan-7-2026", "line-check");

  // Shared Supabase config (Office Dashboard)
  window.SUPABASE_URL = "https://inwrnzkzseuymfzrpocn.supabase.co";
  window.SUPABASE_ANON_KEY = "sb_publishable_81elBWnKMo2ouw53vYQVUQ_Iyo3HHg1";
  window.SUPABASE_ORG_ID = window.SUPABASE_ORG_ID || "pracht";

  // Create a single client and reuse it everywhere
  window.sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  window.ORG_ID = window.SUPABASE_ORG_ID;
</script>
</head>

<body>
 <!-- VERSION: 2026-01-07-A -->

<div class="app">
  <!-- Sidebar -->
  <aside class="side">
    <div class="topRow">
      <button class="hamburger" id="btnMenu" title="Menu">
        <div class="hamburgerLines"><span></span><span></span><span></span></div>
      </button>

      <button class="brandBtn" id="btnHome" title="Back to Jobs">
        <div class="dot"></div>
        <div>
          <h1>Office Dashboard (Demo)</h1>
          <p>Local-only â€¢ removable preload</p>
        </div>
      </button>
    </div>

    <button class="btn primary" id="btnCreateJob">+ Create Job</button>

    <div class="sectionTitle">Quick Views</div>
    <div class="statusList" id="statusList"></div>

    <div class="statusItem" id="btnRequests" title="Requests">
      <div class="dotPill">
        <span class="miniDot inprogress"></span>
        <div>Requests</div>
      </div>
      <span class="pill" id="pillRequests">0</span>
    </div>

    <div class="statusItem" id="btnOOS" title="Out of Stock">
      <div class="dotPill">
        <span class="miniDot paused"></span>
        <div>Out of Stock</div>
      </div>
      <span class="pill" id="pillOOS">0</span>
    </div>


    <div class="sectionTitle">Data Tools</div>
    <div class="btnRow">
      <button class="btn small" id="btnLoadPre">Load Preload Data</button>
      <button class="btn small" id="btnWipe">Wipe All Data</button>
    </div>

    <div class="sectionTitle">Notes</div>
    <div class="empty">Office dashboard = jobs + customers + fields (no receipts here).</div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar" id="topbar">
      <div class="searchRow">
        <input class="search" id="q" placeholder="Search..." />
        <select class="select" id="sort"></select>
      </div>
      <div class="muted" id="clock"></div>
    </div>

    <!-- Jobs KPIs -->
    <div class="cards" id="kpisJobs">
      <div class="card">
        <div class="k">Total Jobs</div>
        <div class="v" id="kpiTotal">0</div>
        <div class="sub" id="kpiTotalSub">â€”</div>
      </div>
      <div class="card">
        <div class="k">Open</div>
        <div class="v" id="kpiOpen">0</div>
        <div class="sub">Ready / active list</div>
      </div>
      <div class="card">
        <div class="k">Paused</div>
        <div class="v" id="kpiPaused">0</div>
        <div class="sub">Waiting / hold</div>
      </div>
      <div class="card">
        <div class="k">In Progress</div>
        <div class="v" id="kpiInProgress">0</div>
        <div class="sub">On-job work</div>
      </div>
    </div>

    <!-- View: Jobs list -->
    

    <!-- Jobs: Map toolbar (above job list) -->
    <div id="jobsMapToolbar" style="display:none; justify-content:flex-end; margin:0 0 10px 0;">
      <button class="btn small" id="btnMapOpenJobs">ðŸ›° Map (Satellite)</button>
    </div>
<div class="tableWrap" id="viewJobs" style="display:none;">
      <table>
        <thead>
          <tr>
            <th style="width:34%">Job</th>
            <th style="width:26%">Customer / Field</th>
            <th style="width:18%">Type</th>
            <th style="width:14%">Status</th>
            <th class="rightAlign" style="width:16%">Updated</th>
          </tr>
        </thead>
        <tbody id="jobRows"></tbody>
      </table>
    </div>


    <!-- View: Requests -->
    <div id="viewRequests" style="display:none;">
      <div class="fileHeader">
        <div>
          <h2>Requests</h2>
          <div class="sub">Created by tech app. Click an item to resolve (delete).</div>
        </div>
        <div class="btnRow">
          <button class="btn small" id="btnReqRefresh">Refresh</button>
        </div>
      </div>
      <div class="pillList" id="requestPills"></div>
      <div class="empty" id="requestsEmpty" style="display:none;">No requests right now.</div>
    </div>

    <!-- View: Out of Stock -->
    <div id="viewOOS" style="display:none;">
      <div class="fileHeader">
        <div>
          <h2>Out of Stock</h2>
          <div class="sub">Only populates when tech flags out-of-stock from Restock.</div>
        </div>
        <div class="btnRow">
          <button class="btn small" id="btnOOSRefresh">Refresh</button>
        </div>
      </div>
      <div class="pillList" id="oosPills"></div>
      <div class="empty" id="oosEmpty" style="display:none;">No out-of-stock flags right now.</div>
    </div>

    <!-- View: Customers list -->
    <div id="viewCustomers" style="display:none;">
      <div class="fileHeader">
        <div>
          <h2>Customers</h2>
          <div class="sub">Search + sort. Select a customer to open their file.</div>
        </div>
        <div class="btnRow">
          <button class="btn small primary" id="btnAddCustomer">+ Add Customer</button>
        </div>
      </div>

      <div class="pillList" id="customerPills"></div>
      <div class="empty" id="customersEmpty" style="display:none;">No customers yet.</div>
    </div>

    <!-- View: Customer file -->
    <div id="viewCustomerFile" style="display:none;">
      <div class="fileHeader">
        <div>
          <h2 id="custFileTitle">Customer</h2>
          <div class="sub" id="custFileSub">â€”</div>
        </div>
        <div class="btnRow">
          <button class="btn small" id="btnBackToCustomers">Back</button>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div class="title">Customer Information</div>
          <div class="btnRow">
            <button class="btn small" id="btnCustomerEdit">Edit</button>
            <button class="btn small primary" id="btnCustomerAddField">+ Add Field</button>
            <button class="btn small danger" id="btnCustomerDelete">Delete</button>
          </div>
        </div>

        <div id="customerInfoBlock"></div>

        <div id="customerDeleteConfirm" style="display:none; margin-top:10px;">
          <div class="help" style="margin-bottom:8px;">
            Confirm delete: this removes the customer, all fields, and all jobs under those fields.
          </div>
          <div class="btnRow">
            <button class="btn small danger" id="btnCustomerDeleteYes">Yes, delete</button>
            <button class="btn small" id="btnCustomerDeleteNo">Cancel</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div class="title">Fields</div>
          <div class="help">Select a field to open the field file.</div>
        </div>
        <div class="pillList" id="fieldPills"></div>
        <div class="empty" id="fieldsEmpty" style="display:none;">No fields for this customer.</div>
      </div>
    </div>

    <!-- View: Field file -->
    <div id="viewFieldFile" style="display:none;">
      <div class="fileHeader">
        <div>
          <h2 id="fieldFileTitle">Field</h2>
          <div class="sub" id="fieldFileSub">â€”</div>
        </div>
        <div class="btnRow">
          <button class="btn small" id="btnBackToCustomerFile">Back</button>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div class="title">Field Information</div>
          <div class="btnRow">
            <button class="btn small" id="btnFieldEdit">Edit</button>
            <button class="btn small danger" id="btnFieldDelete">Delete</button>
          </div>
        </div>

        <div id="fieldInfoBlock"></div>

        <div id="fieldDeleteConfirm" style="display:none; margin-top:10px;">
          <div class="help" style="margin-bottom:8px;">
            Confirm delete: this removes the field and all jobs associated with it.
          </div>
          <div class="btnRow">
            <button class="btn small danger" id="btnFieldDeleteYes">Yes, delete</button>
            <button class="btn small" id="btnFieldDeleteNo">Cancel</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div class="title">Jobs for this Field</div>
          <div class="help">All jobs tied to this field (any status). Click a job to view full details.</div>
        </div>
        <div class="pillList" id="fieldJobsPills"></div>
        <div class="empty" id="fieldJobsEmpty" style="display:none;">No jobs for this field yet.</div>
      </div>
    </div>
  </main>
</div>

<!-- MENU MODAL -->
<div class="modalBackdrop" id="modalMenu">
  <div class="modal" style="width:min(560px,100%);">
    <div class="modalHeader">
      <h3>Menu</h3>
      <button class="btn small" onclick="UI.closeModal('modalMenu')">Close</button>
    </div>
    <div class="modalBody">
      <div class="btnRow" style="flex-direction:column; align-items:stretch;">
        <button class="btn" id="menuCustomers">Customers</button>
        <button class="btn" id="menuExport">Export</button>
        <button class="btn" id="menuImport">Import</button>
        <button class="btn" id="menuSettings">Settings</button>
      </div>
      <div class="help" style="margin-top:10px;">
        Settings: trucks, tools, stock, job types, techs, assignments, helpers.
      </div>
    </div>
  </div>
</div>

<!-- CREATE JOB MODAL -->
<div class="modalBackdrop" id="modalJob">
  <div class="modal">
    <div class="modalHeader">
      <h3>Create Job</h3>
      <button class="btn small" onclick="UI.closeModal('modalJob')">Close</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        
<div class="field">
  <label>Customer</label>
  <div class="sd" id="jobCustomerSD">
    <button type="button" class="sd-btn" data-role="toggle">
      <span class="sd-btn-text" data-role="selectedText">Select a customerâ€¦</span>
      <span class="sd-caret">â–¾</span>
    </button>
    <div class="sd-pop" data-role="pop" hidden>
      <input class="sd-search" data-role="search" type="text" placeholder="Type to search customersâ€¦" autocomplete="off"/>
      <div class="sd-list" data-role="list"></div>
    </div>
    <input type="hidden" id="jobCustomer" data-role="value"/>
  </div>
  <div class="help">Type to filter, then click the customer. (Stores the real customer_id.)</div>
</div>
<div class="field">
  <label>Field</label>
  <div class="sd" id="jobFieldSD">
    <button type="button" class="sd-btn" data-role="toggle">
      <span class="sd-btn-text" data-role="selectedText">Select a fieldâ€¦</span>
      <span class="sd-caret">â–¾</span>
    </button>
    <div class="sd-pop" data-role="pop" hidden>
      <input class="sd-search" data-role="search" type="text" placeholder="Type to search fieldsâ€¦" autocomplete="off"/>
      <div class="sd-list" data-role="list"></div>
    </div>
    <input type="hidden" id="jobField" data-role="value"/>
  </div>
  <div class="help">Fields are filtered by the selected customer. (Stores the real field_id.)</div>
</div>


        <div class="field">
          <label>Assigned Truck</label>
          <select class="select2" id="jobTruck"></select>
          <div class="help">This controls which truck sees the job in the tech app.</div>
        </div>

        <div class="field">
          <label>Job Type</label>
          <select class="select2" id="jobType"></select>
          <div class="help">Job types come from Settings â†’ Job Types (defaults provided).</div>
        </div>

        <div class="field full">
      <label>Job Number (auto)</label>
      <input class="input" id="jobNumberPreview" disabled />
      <div class="help">Assigned automatically from job type (example: SC1000).</div>
    </div>

        <div class="field full">
  <label>Job Description (problem)</label>
  <textarea class="textarea" id="jobDescription" placeholder="Describe the problem for the techâ€¦"></textarea>
</div>

<div class="field full">
  <label>Office Notes (optional)</label>

          <textarea class="textarea" id="jobNotes" placeholder="Anything the office wants capturedâ€¦"></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <div class="btnRow">
        <button class="btn primary" id="btnSaveJob">Save Job</button>
        <button class="btn" onclick="UI.closeModal('modalJob')">Cancel</button>
      </div>

      <div class="help">New jobs start as <strong>Open</strong>. (No job status selection here.)</div>
    </div>
  </div>
</div>

<!-- JOB DETAIL MODAL -->
<div class="modalBackdrop" id="modalJobDetail">
  <div class="modal">
    <div class="modalHeader">
      <h3 id="jdTitle">Job Detail</h3>
      <button class="btn small" onclick="UI.closeModal('modalJobDetail')">Close</button>
    </div>
    <div class="modalBody">
      <div class="panel" style="margin-bottom:12px;">
        <div class="panelHead">
          <div class="title">Office Actions</div>
          <div class="btnRow" id="jdActions"></div>
        </div>
        <div class="help">
          Office status rules: you can <strong>Mark Finished</strong>, <strong>Reopen</strong>, and <strong>Close</strong> (close only after finished).
        </div>
      </div>

      <div class="panel">
        <div class="sectionBar"><div id="jdJobBar">â€”</div></div>
        <div id="jdJob"></div>
      </div>

      <div class="panel">
        <div class="sectionBar"><div id="jdCustomerBar">â€”</div></div>
        <div id="jdCustomer"></div>
      </div>

      <div class="panel">
        <div class="sectionBar"><div id="jdFieldBar">â€”</div></div>
        <div id="jdField"></div>
      </div>
    </div>
  </div>
</div>


<!-- JOBS MAP MODAL (Satellite) -->
<div class="modalBackdrop" id="modalJobsMap">
  <div class="modal" style="width:min(1100px, 100%);">
    <div class="modalHeader">
      <h3>Jobs Map (Satellite)</h3>
      <button class="btn small" onclick="UI.closeModal('modalJobsMap')">Close</button>
    </div>

    <div class="modalBody">
      <div class="btnRow" style="justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <span class="muted" style="font-size:12px;">Select Job:</span>
          <select class="select2" id="mapJobSelect" style="min-width:320px;"></select>
        </div>

        <button class="btn small" id="btnMapOpenInGoogle">Open in Google Maps</button>
      </div>

      <div style="border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden;">
        <div id="jobsLeafletMap" style="width:100%; height:520px;"></div>
      </div>

      <div class="help" style="margin-top:10px;">
        Uses field lat/lng. If a jobâ€™s field has no lat/lng yet, it wonâ€™t appear in the dropdown.
      </div>
    </div>
  </div>
</div>


<!-- ADD CUSTOMER MODAL -->
<div class="modalBackdrop" id="modalAddCustomer">
  <div class="modal">
    <div class="modalHeader">
      <h3>Add Customer</h3>
      <button class="btn small" onclick="UI.closeModal('modalAddCustomer')">Close</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field full">
          <label>Customer Name</label>
          <input class="input" id="custName" placeholder="e.g., Hansen Farms" />
        </div>
        <div class="field">
          <label>Phone</label>
          <input class="input" id="custPhone" placeholder="(308) 555-1234" inputmode="tel" />
        </div>
        <div class="field">
          <label>Email</label>
          <input class="input" id="custEmail" placeholder="name@farm.com" inputmode="email" />
        </div>
        <div class="field">
          <label>Preference</label>
          <select class="select2" id="custPref">
            <option value="">â€”</option>
            <option value="Call">Call</option>
            <option value="Text">Text</option>
            <option value="Email">Email</option>
          </select>
        </div>
        <div class="field full">
          <label>Address</label>
          <input class="input" id="custAddr" placeholder="Street / City / State / Zip" />
        </div>

        <div class="field full">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="copyToBilling" checked />
            Same as customer contact info (billing)
          </label>
        </div>
      </div>

      <div class="divider"></div>

      <div class="btnRow">
        <button class="btn primary" id="btnDoAddCustomer">Add Customer</button>
        <button class="btn" onclick="UI.closeModal('modalAddCustomer')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD FIELD MODAL -->
<div class="modalBackdrop" id="modalAddField">
  <div class="modal">
    <div class="modalHeader">
      <h3>Add Field</h3>
      <button class="btn small" onclick="UI.closeModal('modalAddField')">Close</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Customer</label>
          <select class="select2" id="fieldCustomer"></select>
        </div>

        <div class="field">
          <label>Field Name</label>
          <input class="input" id="fieldName" placeholder="e.g., South Quarter - Pivot 3" />
        </div>

        <div class="field third">
          <label>Brand</label>
          <select class="select2" id="fieldBrand">
            <option value="">(Not set)</option>
            <option value="Reinke">Reinke</option>
            <option value="Valley">Valley</option>
            <option value="Zimmatic">Zimmatic</option>
            <option value="T&L">T&amp;L</option>
            <option value="Other">Other</option>
          </select>
        </div>

        

        <div class="field third">
          <label>Power Source</label>
          <select class="select2" id="fieldPowerSource">
            <option value="">(Not set)</option>
            <option value="Electric Utility">Electric Utility</option>
            <option value="Engine Drive Generator">Engine Drive Generator</option>
            <option value="Phase Converter">Phase Converter</option>
          </select>
        </div>
<div class="field third">
          <label>Serial Number</label>
          <input class="input" id="fieldSerial" placeholder="Serial #" />
        </div>

        <div class="field third">
          <label>Tower Count</label>
          <input class="input" id="fieldTowerCount" placeholder="e.g., 8" inputmode="numeric" />
        </div>

        <div class="field third">
          <label>Lat</label>
          <input class="input" id="fieldLat" placeholder="40.12345" inputmode="decimal" />
        </div>

        <div class="field third">
          <label>Lng</label>
          <input class="input" id="fieldLng" placeholder="-99.12345" inputmode="decimal" />
        </div>

        <div class="field third">
          <label>Sprinkler Package #</label>
          <input class="input" id="fieldSprinklerPkg" placeholder="e.g., PKG-1029" />
        </div>

        <div class="field full">
          <div class="btnRow">
            <button class="btn small" id="btnOpenSatellite">Open Google Maps (Satellite)</button>
            <button class="btn small" id="btnCenterSatellite">Open Satellite Centered on Lat/Lng</button>
          </div>
          <div class="help">Open satellite view to grab lat/lng quickly (no API key needed).</div>
        </div>

        <div class="field full">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="fieldHasTelemetry" />
            Has Telemetry
          </label>
        </div>

        <div class="field" id="telemetryMakeWrap" style="display:none;">
          <label>Telemetry Make</label>
          <input class="input" id="fieldTelemetryMake" placeholder="e.g., AgSense / FieldNET / Reinke RC" />
        </div>

        <div class="field" id="telemetrySerialWrap" style="display:none;">
          <label>Telemetry Serial</label>
          <input class="input" id="fieldTelemetrySerial" placeholder="Telemetry serial #" />
        </div>

        <div class="field full">
          <label>Additional Information</label>
          <textarea class="textarea" id="fieldNotes" placeholder="Anything else that matters about this locationâ€¦"></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <div class="btnRow">
        <button class="btn primary" id="btnDoAddField">Add Field</button>
        <button class="btn" onclick="UI.closeModal('modalAddField')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT MODAL -->
<div class="modalBackdrop" id="modalImport">
  <div class="modal">
    <div class="modalHeader">
      <h3>Import</h3>
      <button class="btn small" onclick="UI.closeModal('modalImport')">Close</button>
    </div>
    <div class="modalBody">
      <!-- CSV IMPORT CENTER -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="panelHead">
          <div class="title">Import Center (CSV)</div>
        </div>
        <div class="help">Upload <b>CSV</b> files. If you have Excel, save/export as <b>.csv</b> first. Download the template so your columns match.</div>
        <div class="divider"></div>

        <div class="formGrid two">
          <div class="field">
            <label>Import type</label>
            <select class="select2" id="impCsvType">
              <option value="customers_fields">Customers (with Fields)</option>
              <option value="jobs">Jobs</option>
              <option value="products">Products (parts list)</option>
              <option value="truck_stock_master">Truck Inventory Master (Min Stock)</option>
              <option value="truck_tools">Truck Tools</option>
            </select>
          </div>

          <div class="field" id="impTruckWrap" style="display:none;">
            <label>Truck</label>
            <select class="select2" id="impTruckSelect"></select>
          </div>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="btn" id="btnCsvTemplate">Download Template</button>
          <button class="btn" id="btnCsvPick" disabled>Choose CSV</button>
        </div>

        <div class="help" id="impCsvHint" style="margin-top:10px;"></div>
      </div>

      <div class="panel" id="csvPreviewPanel" style="display:none; margin-bottom:12px;">
        <div class="panelHead">
          <div class="title">Preview</div>
        </div>
        <div class="help" id="csvPreviewHelp"></div>
        <div class="divider"></div>
        <div class="tableWrap" style="max-height:240px; overflow:auto;">
          <table class="table" id="csvPreviewTable"></table>
        </div>
        <div class="divider"></div>
        <div class="btnRow">
          <button class="btn primary" id="btnCsvImport" disabled>Import</button>
          <button class="btn" id="btnCsvCancel">Cancel</button>
        </div>
        <div class="help" id="csvWarnings" style="margin-top:10px;"></div>
      </div>
      <!-- /CSV IMPORT CENTER -->

      <div class="panel" style="margin-bottom:12px;">
        <div class="panelHead">
          <div class="title">Choose what to import</div>
        </div>
        <div class="help">Only the checked sections will be imported from the JSON you paste.</div>
        <div class="divider"></div>
        <div class="btnRow" style="gap:14px;">
          <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="impCustomers" checked /> Customers</label>
          <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="impFields" checked /> Fields</label>
          <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="impTruckStock" checked /> Truck Inventory (Stock)</label>
          <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="impTruckTools" checked /> Truck Tool List (Tools)</label>
        </div>
        <div class="help" style="margin-top:10px;">
          If you import customers/fields, any jobs that no longer have a valid customer/field will be removed to prevent broken data.
        </div>
      </div>

      <textarea class="textarea" id="importText" placeholder="Paste exported JSON here..."></textarea>
      <div class="divider"></div>
      <div class="btnRow">
        <button class="btn primary" id="btnDoImport">Import Selected</button>
        <button class="btn" onclick="UI.closeModal('modalImport')">Cancel</button>
      </div>
      <div class="help">Tip: You can export from this dashboard (Menu â†’ Export) and then import only the pieces you want here.</div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modalBackdrop" id="modalSettings">
  <div class="modal">
    <div class="modalHeader">
      <h3>Settings</h3>
      <button class="btn small" onclick="UI.closeModal('modalSettings')">Close</button>
    </div>
    <div class="modalBody">
      <div class="settingsShell">
        <div class="settingsNav" id="settingsNav"></div>
        <div class="settingsPane" id="settingsPane"></div>
      </div>
      <div class="help" style="margin-top:10px;">
        These settings are local-only for now (stored in localStorage with the rest of the dashboard).
      </div>
    </div>
  </div>
</div>


<!-- RESOLVE MODAL (Requests / Out of Stock) -->
<div class="modalBackdrop" id="modalResolve">
  <div class="modal" style="width:min(520px,100%);">
    <div class="modalHeader">
      <h3 id="resolveTitle">Resolve</h3>
      <button class="btn small" id="btnResolveCancel">Close</button>
    </div>
    <div class="modalBody">
      <div class="help" id="resolveSub">â€”</div>
      <div class="divider"></div>
      <div class="btnRow">
        <button class="btn danger" id="btnResolveConfirm">Resolve (Delete)</button>
      </div>
    </div>
  </div>
</div>


<script>
/* ================================
   Local Demo Office Dashboard
=================================== */

const STORE_KEY = "office_demo_v5";

// Shared store keys (Office Dashboard â†” Tech App)
// Both apps must be served from the same origin (e.g., Live Server from the same folder)
const SHARED = {
  TRUCKS: "WO_TRUCKS",
  JOBS: "WO_JOBS",
  CUSTOMERS: "WO_CUSTOMERS",
  FIELDS: "WO_FIELDS"
};

function publishSharedStore(){
  try{
    // Trucks
    const trucks = (db.settings?.trucks || []).map(t => ({ id: String(t.id), name: String(t.name || t.id) }));
    localStorage.setItem(SHARED.TRUCKS, JSON.stringify(trucks));

    // Customers (flatten)
    const customers = (db.customers || []).map(c => ({
      id: String(c.id),
      name: c.customer?.name || "",
      phone: c.customer?.phone || "",
      pref: c.customer?.pref || "",
      email: c.customer?.email || "",
      address: c.customer?.address || "",
      billing: c.billing || {}
    }));
    localStorage.setItem(SHARED.CUSTOMERS, JSON.stringify(customers));

    // Fields (flatten + normalize names)
    const fields = (db.fields || []).map(f => ({
      id: String(f.id),
      customerId: String(f.customerId || ""),
      name: f.name || "",
      brand: f.brand || "",
      serial_number: f.serialNumber || "",
      tower_count: f.towerCount ?? null,
      lat: f.lat ?? null,
      lng: f.lng ?? null,
      sprinkler_package_number: f.sprinklerPackageNumber || "",
      has_telemetry: !!f.hasTelemetry,
      telemetry_make: f.telemetryMake || "",
      telemetry_serial: f.telemetrySerial || "",
      additional_info: f.notes || ""
    }));
    localStorage.setItem(SHARED.FIELDS, JSON.stringify(fields));

    // Jobs (include truck assignment)
    const jobs = (db.jobs || []).map(j => ({
      id: String(j.id),
      jobNumber: (j.jobCode || String(j.id).slice(-6).toUpperCase()),
      jobType: j.type || "Other",
      customerId: String(j.customerId || ""),
      fieldId: String(j.fieldId || ""),
      assignedTruckId: j.assignedTruckId || "",
      assignedTechId: j.assignedTechId || "",
      status: j.status || "open",
      problemDescription: (j.description || j.problemDescription || j.notesOffice || ""),
      notesOffice: j.notesOffice || "",
      createdAt: j.createdAt || "",
      updatedAt: j.updatedAt || ""
    }));
    localStorage.setItem(SHARED.JOBS, JSON.stringify(jobs));
  }catch(e){
    console.warn("publishSharedStore failed", e);
  }
}


const STATUS = [
  { key:"open",       label:"Open Jobs",     dotClass:"open" },
  { key:"paused",     label:"Paused Jobs",   dotClass:"paused" },
  { key:"inprogress", label:"In Progress",   dotClass:"inprogress" },
  { key:"finished",   label:"Finished Jobs", dotClass:"finished" },
  { key:"closed",     label:"Closed",        dotClass:"closed" },
];

const UI = {
  openModal(id){ document.getElementById(id).style.display="flex"; },
  closeModal(id){ document.getElementById(id).style.display="none"; },
  toast(msg){ alert(msg); }
};


function jobTypePrefix(jobTypeId, jobTypeName){
  const id = String(jobTypeId||"").trim().toLowerCase();
  const name = String(jobTypeName||"").trim().toLowerCase();

  // Prefer stable slug IDs first (Supabase source of truth)
  if(id==="inspection") return "PI";
  if(id==="service_call" || id==="service-call" || id==="service") return "SC";
  if(id==="repair") return "RP";
  if(id==="install" || id==="installation") return "IN";
  if(id==="electrical") return "EL";

  // Fallback to name matching (still safe; doesn't affect FK writes)
  const t = name || id;
  if(t.includes("inspection")) return "PI";
  if(t.includes("service")) return "SC";
  if(t.includes("repair")) return "RP";
  if(t.includes("install")) return "IN";
  if(t.includes("electrical")) return "EL";
  if(t.includes("trench") || t.includes("pipe")) return "TP";
  return "JB";
}

function pad4(n){ return String(n).padStart(4,"0"); }

function uid(prefix="id"){ return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`; }
function nowISO(){ return new Date().toISOString(); }
function fmtTime(ts){
  if(!ts) return "â€”";
  const d = new Date(ts);
  return d.toLocaleString(undefined, {year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
}
function safeNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

/* Phone formatting: (###) ###-#### */
function digitsOnly(s){ return String(s||"").replace(/\D/g,""); }
function formatPhone(s){
  const d = digitsOnly(s);
  const a = d.slice(0,3), b = d.slice(3,6), c = d.slice(6,10);
  if(d.length===0) return "";
  if(d.length<=3) return `(${a}`;
  if(d.length<=6) return `(${a}) ${b}`;
  return `(${a}) ${b}-${c}`;
}
function attachPhoneFormatter(input){
  if(!input) return;
  input.addEventListener("input", ()=>{
    input.value = formatPhone(input.value);
    input.setSelectionRange(input.value.length, input.value.length);
  });
}

function defaultDB(){
  return {
    meta:{ createdAt: nowISO(), updatedAt: nowISO(), isPreload:false, jobSeq: 1000 },
    customers:[],
    fields:[],
    jobs:[],
    settings:{
      trucks:[],                  // [{id,name}]
      truckStock:{},              // {truckId: [{id, partNumber, minQty}]}
      truckTools:{},              // {truckId: [{id, name, qty}]}
      products:[],                // [{partNumber, description}]
      jobTypes:[],
      techs:[],
      helpers:[],
      assignments:[]
    }
  };
}

function migrateDB(raw){
  const db = raw || defaultDB();
  db.meta = db.meta || { createdAt: nowISO(), updatedAt: nowISO(), isPreload:false, jobSeq: 1000 };
  if(typeof db.meta.jobSeq !== 'number') db.meta.jobSeq = 1000;
  db.customers = Array.isArray(db.customers) ? db.customers : [];
  db.fields = Array.isArray(db.fields) ? db.fields : [];
  db.jobs = Array.isArray(db.jobs) ? db.jobs : [];
  db.settings = db.settings || defaultDB().settings;

  db.settings.trucks = Array.isArray(db.settings.trucks) ? db.settings.trucks : [];
  db.settings.truckStock = db.settings.truckStock || {};
  db.settings.truckTools = db.settings.truckTools || {};
  db.settings.jobTypes = Array.isArray(db.settings.jobTypes) ? db.settings.jobTypes : defaultDB().settings.jobTypes;
  db.settings.techs = Array.isArray(db.settings.techs) ? db.settings.techs : [];
  db.settings.helpers = Array.isArray(db.settings.helpers) ? db.settings.helpers : [];
  db.settings.assignments = Array.isArray(db.settings.assignments) ? db.settings.assignments : [];

  db.customers = db.customers.map(c=>{
    if(c.customer && c.billing) return {
      ...c,
      customer:{...c.customer, phone: formatPhone(c.customer.phone||"")},
      billing:{...c.billing, phone: formatPhone(c.billing.phone||"")}
    };
    return {
      id: c.id || uid("cust"),
      createdAt: c.createdAt || nowISO(),
      updatedAt: c.updatedAt || c.createdAt || nowISO(),
      customer:{
        name: c.name || "",
        phone: formatPhone(c.phone || ""),
        email: c.email || "",
        pref: c.pref || "",
        address: c.address || ""
      },
      billing:{
        name: c.billingName || c.name || "",
        phone: formatPhone(c.billingPhone || c.phone || ""),
        email: c.billingEmail || c.email || "",
        address: c.billingAddress || c.address || ""
      }
    };
  });

  db.fields = db.fields.map(f=>({
    id: f.id || uid("field"),
    customerId: f.customerId || "",
    createdAt: f.createdAt || nowISO(),
    updatedAt: f.updatedAt || f.createdAt || nowISO(),
    name: f.name || "",
    brand: f.brand || "",
    serialNumber: f.serialNumber || f.serial || "",
    towerCount: (f.towerCount ?? f.towers ?? null),
    lat: (f.lat ?? null),
    lng: (f.lng ?? null),
    sprinklerPackageNumber: f.sprinklerPackageNumber || f.sprinklerPkg || "",
    hasTelemetry: !!f.hasTelemetry,
    telemetryMake: f.telemetryMake || "",
    telemetrySerial: f.telemetrySerial || "",
    notes: f.notes || ""
  }));

  db.jobs = db.jobs.map(j=>({
    id: j.id || uid("job"),
    customerId: j.customerId || "",
    fieldId: j.fieldId || "",
    type: j.type || "Other",
    jobCode: j.jobCode || j.jobNumber || j.jobTitle || "",
    title: j.title || "",
    description: j.description || j.problemDescription || "",
    status: j.status || "open",
    notesOffice: j.notesOffice || j.notes || "",
    createdAt: j.createdAt || nowISO(),
    updatedAt: j.updatedAt || j.createdAt || nowISO()
  }));

  return db;
}

function loadDB(){
  const raw = localStorage.getItem(STORE_KEY);
  if(!raw) return defaultDB();
  try{ return migrateDB(JSON.parse(raw)); }
  catch(e){ console.warn("Bad storage, resetting", e); return defaultDB(); }
}
function saveDB(db){
  db.meta.updatedAt = nowISO();
  localStorage.setItem(STORE_KEY, JSON.stringify(db));
  // Keep tech app in sync
  publishSharedStore();
}

let db = loadDB();
// Initial publish for tech app
publishSharedStore();

let state = {
  view: "jobs",
  filterStatus: "open",
  customersSort: "nameAsc",
  selectedCustomerId: null,
  selectedFieldId: null,
  customerEdit: false,
  fieldEdit: false,
  deleteArmedCustomerId: null,
  deleteArmedFieldId: null,
  settingsTab: "trucks",
  selectedJobId: null,

  // NEW: remember truck selector inside settings
  settingsStockTruckId: null,
  settingsToolsTruckId: null,
};

function ensureTruckSelections(){
  const trucks = db.settings.trucks || [];
  if(trucks.length===0){
    state.settingsStockTruckId = null;
    state.settingsToolsTruckId = null;
    return;
  }
  if(!state.settingsStockTruckId || !trucks.some(t=>t.id===state.settingsStockTruckId)){
    state.settingsStockTruckId = trucks[0].id;
  }
  if(!state.settingsToolsTruckId || !trucks.some(t=>t.id===state.settingsToolsTruckId)){
    state.settingsToolsTruckId = trucks[0].id;
  }
}

function statusByKey(k){ return STATUS.find(s=>s.key===k); }
function statusLabel(k){ return statusByKey(k)?.label || k; }

function openMapForOpenJobs(){
  // Build list of jobs that have valid field coords (ALL jobs, not just one)
  const list = db.jobs
    .map(j => {
      const f = db.fields.find(x => x.id === j.fieldId);
      const c = db.customers.find(x => x.id === j.customerId);
      const hasCoords = (f && f.lat != null && f.lng != null && !isNaN(Number(f.lat)) && !isNaN(Number(f.lng)));
      if(!hasCoords) return null;
      return {
        jobId: j.id,
        jobCode: (j.jobCode || ("#" + jobShortId(j.id))),
        customer: (c?.customer?.name || "â€”"),
        field: (f?.name || "â€”"),
        brand: (f?.brand || ""),
        lat: Number(f.lat),
        lng: Number(f.lng),
        status: (j.status || "")
      };
    })
    .filter(Boolean);

  
  // Status-colored pins (contained: no external icon URLs)
  const statusColor = (status)=>{
    const s = String(status||"").toLowerCase();
    if(s.includes("open")) return "#2ecc71";          // green
    if(s.includes("progress")) return "#f1c40f";      // yellow
    if(s.includes("on the way") || s.includes("ontheway") || s.includes("travel")) return "#f39c12"; // orange
    if(s.includes("paused") || s.includes("hold")) return "#e74c3c"; // red
    if(s.includes("closed") || s.includes("complete") || s.includes("done")) return "#8e44ad"; // purple
    return "#3498db"; // blue fallback
  };

  const pinIcon = (hex)=>{
    // Simple SVG pin (data URI) so nothing else in the app changes
    const svg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="26" height="40" viewBox="0 0 26 40">
        <path d="M13 0C5.82 0 0 5.82 0 13c0 9.67 13 27 13 27s13-17.33 13-27C26 5.82 20.18 0 13 0z" fill="${hex}"/>
        <circle cx="13" cy="13" r="5.2" fill="rgba(255,255,255,0.9)"/>
      </svg>
    `);
    return L.icon({
      iconUrl: "data:image/svg+xml;charset=UTF-8," + svg,
      iconSize: [26,40],
      iconAnchor: [13,40],
      popupAnchor: [0,-34],
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      shadowSize: [41,41],
      shadowAnchor: [12,41]
    });
  };
const sel = document.getElementById("mapJobSelect");
  const btnOpen = document.getElementById("btnMapOpenInGoogle");
  const mapEl = document.getElementById("jobsLeafletMap");

  sel.innerHTML = "";

  if(list.length === 0){
    UI.toast("No jobs have field lat/lng yet.");
    return;
  }

  // Populate dropdown
  list.forEach((item, idx) => {
    const opt = document.createElement("option");
    opt.value = item.jobId;
    opt.textContent = `${item.jobCode} â€¢ ${item.customer} â€¢ ${item.field}${item.brand ? (" ("+item.brand+")") : ""}`;
    opt.dataset.lat = item.lat;
    opt.dataset.lng = item.lng;
    sel.appendChild(opt);
    if(idx === 0) sel.value = item.jobId;
  });

  UI.openModal("modalJobsMap");

  // Leaflet map: create once, reuse
  if(!window.__jobsLeaflet){
    window.__jobsLeaflet = { map:null, markers:[], layer:null };
  }

  // If map already exists, clean markers; else create map
  if(!window.__jobsLeaflet.map){
    window.__jobsLeaflet.map = L.map(mapEl, { zoomControl:true });
    // Satellite tiles via Esri World Imagery (no API key)
    window.__jobsLeaflet.layer = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, attribution: "Tiles Â© Esri" }
    ).addTo(window.__jobsLeaflet.map);
  }else{
    // If modal was closed and reopened, Leaflet sometimes needs invalidateSize
    setTimeout(()=> window.__jobsLeaflet.map.invalidateSize(), 120);
  }

  // Remove old markers
  window.__jobsLeaflet.markers.forEach(m => {
    try{ window.__jobsLeaflet.map.removeLayer(m); }catch(e){}
  });
  window.__jobsLeaflet.markers = [];

  // Add markers for ALL jobs with coords
  list.forEach(item => {
    const popupHtml = `
      <div style="font-size:13px; line-height:1.25; max-width:260px;">
        <div style="font-weight:700; margin-bottom:6px;">${item.jobCode}</div>
        <div><b>Customer:</b> ${item.customer}</div>
        <div><b>Field:</b> ${item.field}${item.brand ? (" ("+item.brand+")") : ""}</div>
        <div><b>Status:</b> ${item.status || "â€”"}</div>

        <div style="margin-top:10px;">
          <button onclick="window.openJobFromMap(\'${item.jobId}\')" style="background:#2ecc71;color:#fff;border:0;border-radius:999px;padding:7px 12px;font-weight:700;font-size:12px;cursor:pointer;">Open Job</button>
        </div>
      </div>
    `;
    const marker = L.marker([item.lat, item.lng], { icon: pinIcon(statusColor(item.status)) }).addTo(window.__jobsLeaflet.map).bindPopup(popupHtml);

    // Clicking marker sets dropdown to that job
    marker.on("click", () => {
      sel.value = item.jobId;
      updateGoogleBtnFromSelect();
    });

    window.__jobsLeaflet.markers.push(marker);
  });

  // Fit bounds to all markers
  const bounds = L.latLngBounds(list.map(i => [i.lat, i.lng]));
  window.__jobsLeaflet.map.fitBounds(bounds, { padding:[20,20] });

  function updateGoogleBtnFromSelect(){
    const opt = sel.options[sel.selectedIndex];
    const lat = opt.dataset.lat;
    const lng = opt.dataset.lng;
    btnOpen.onclick = ()=> window.open(`https://www.google.com/maps/@${lat},${lng},18z/data=!3m1!1e3`, "_blank");
  }

  // Dropdown changes: pan to selected marker
  sel.onchange = ()=>{
    const opt = sel.options[sel.selectedIndex];
    const lat = Number(opt.dataset.lat);
    const lng = Number(opt.dataset.lng);
    updateGoogleBtnFromSelect();
    if(window.__jobsLeaflet.map){
      window.__jobsLeaflet.map.setView([lat, lng], Math.max(window.__jobsLeaflet.map.getZoom(), 17));
      // open the popup for the selected job
      const m = window.__jobsLeaflet.markers.find(mm => {
        const ll = mm.getLatLng();
        return Math.abs(ll.lat - lat) < 1e-10 && Math.abs(ll.lng - lng) < 1e-10;
      });
      if(m) m.openPopup();
    }
  };

  // Initialize Google button for first selection
  updateGoogleBtnFromSelect();

  // Ensure map renders correctly inside modal
  setTimeout(()=> {
    if(window.__jobsLeaflet.map) window.__jobsLeaflet.map.invalidateSize();
  }, 150);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s); }

function normalizeName(s){ return String(s||"").trim().toLowerCase(); }
function getProductDescByPartNumber(pn){
  const key = normalizeName(pn);
  const p = (db.settings.products||[]).find(x => normalizeName(x.partNumber)===key);
  return p ? (p.description||"") : "";
}

/* =====================
   Preload
===================== */
function buildPreload(){
  const demo = defaultDB();
  demo.meta.isPreload = true;

  const customers = [
    { name:"Hansen Farms", phone:"(308) 555-0142", email:"office@hansenfarms.com", pref:"Text", address:"Broken Bow, NE" },
    { name:"Miller Ag", phone:"(308) 555-0199", email:"millerag@outlook.com", pref:"Call", address:"Ansley, NE" },
    { name:"Blue Creek Partnership", phone:"(308) 555-0207", email:"admin@bluecreek.com", pref:"Email", address:"Sargent, NE" },
    { name:"Pine Ridge Acres", phone:"(308) 555-0131", email:"pineridge@gmail.com", pref:"Text", address:"Callaway, NE" },
    { name:"Sandhills Irrigators", phone:"(308) 555-0160", email:"ops@sandhillsirrigators.com", pref:"Call", address:"Merna, NE" },
  ].map(c=>({
    id: uid("cust"),
    createdAt: nowISO(),
    updatedAt: nowISO(),
    customer: { ...c, phone: formatPhone(c.phone) },
    billing: { name: c.name, phone: formatPhone(c.phone), email: c.email, address: c.address }
  }));
  demo.customers = customers;

  const brands = ["Reinke","Valley","Zimmatic","T&L",""];
  const sampleLatLng = [
    [41.3921,-99.0012],
    [41.2205,-99.1890],
    [41.5088,-99.4311],
    [41.1202,-99.3124],
    [41.3013,-99.0901],
  ];
  const fields = [];
  customers.forEach((cust, idx)=>{
    for(let i=1;i<=3;i++){
      const base = sampleLatLng[idx % sampleLatLng.length];
      const lat = base[0] + (i*0.012);
      const lng = base[1] - (i*0.009);
      const hasTel = (i===2);
      fields.push({
        id: uid("field"),
        customerId: cust.id,
        createdAt: nowISO(),
        updatedAt: nowISO(),
        name: `${["North","South","East"][i-1]} Field - Pivot ${i}`,
        brand: brands[(idx+i) % brands.length] || "",
        serialNumber: `SN-${idx+1}${i}0${(idx+i)*7}`,
        towerCount: 7 + ((idx+i) % 4),
        lat: Number(lat.toFixed(5)),
        lng: Number(lng.toFixed(5)),
        sprinklerPackageNumber: `PKG-${1000 + idx*10 + i}`,
        hasTelemetry: hasTel,
        telemetryMake: hasTel ? "AgSense" : "",
        telemetrySerial: hasTel ? `TEL-${idx+1}${i}99` : "",
        notes: ""
      });
    }
  });
  demo.fields = fields;

  const statuses = ["open","paused","inprogress","finished","open","open","paused","finished"];
  const titles = [
    "Tower 4 intermittent dead spot",
    "End gun not cycling / pressure drop",
    "Panel rebooting, suspect power issue",
    "Deep rut at tower 2 - alignment check",
    "Sprinkler package leaks at drop hose",
    "Safety switch tripping when starting",
    "Low pressure alarm after 20 minutes",
    "Drive unit noise - inspect gearbox"
  ];
  const types = ["Pivot Inspection","Service Call","General Repair","Build / Install","Trenching / Pipe"];

  const jobs = [];
  for(let j=0;j<14;j++){
    const cust = customers[j % customers.length];
    const field = fields.filter(f=>f.customerId===cust.id)[j % 3];
    const status = statuses[j % statuses.length];
    const created = new Date(Date.now() - (j*30*60*60*1000));
    const updated = new Date(created.getTime() + (Math.min(j,6)*4*60*60*1000));
    jobs.push({
      id: uid("job"),
      customerId: cust.id,
      fieldId: field.id,
      type: types[(j*3) % types.length],
      title: titles[(j*5) % titles.length],
      status,
      notesOffice: (status==="paused") ? "Waiting on parts approval / customer call back." :
                  (status==="finished") ? "Ready to invoice." : "",
      createdAt: created.toISOString(),
      updatedAt: updated.toISOString(),
    });
  }
  demo.jobs = jobs;

  // preload trucks + stock/tools so you can see selectors work
  const t1 = {id:uid("trk"), name:"Service Truck 1"};
  const t2 = {id:uid("trk"), name:"Service Truck 2"};
  demo.settings.trucks = [t1,t2];
  demo.settings.truckStock[t1.id] = [{id:uid("stk"), name:"2A fuse", qty:12},{id:uid("stk"), name:"Contactor", qty:2}];
  demo.settings.truckStock[t2.id] = [{id:uid("stk"), name:"Hose clamps", qty:20}];
  demo.settings.truckTools[t1.id] = [{id:uid("tool"), name:"Clamp meter"},{id:uid("tool"), name:"Crimper"}];
  demo.settings.truckTools[t2.id] = [{id:uid("tool"), name:"Puller set"}];

  return demo;
}

/* =====================
   View routing
===================== */
function setView(view){
  state.view = view;

  document.getElementById("viewJobs").style.display = (view==="jobs") ? "block" : "none";
  document.getElementById("jobsMapToolbar").style.display = (view==="jobs") ? "flex" : "none";
  document.getElementById("viewCustomers").style.display = (view==="customers") ? "block" : "none";
  document.getElementById("viewCustomerFile").style.display = (view==="customerFile") ? "block" : "none";
  document.getElementById("viewFieldFile").style.display = (view==="fieldFile") ? "block" : "none";

  document.getElementById("viewRequests").style.display = (view==="requests") ? "block" : "none";
  document.getElementById("viewOOS").style.display = (view==="oos") ? "block" : "none";

  document.getElementById("kpisJobs").style.display = (view==="jobs") ? "grid" : "none";

  const q = document.getElementById("q");
  const sort = document.getElementById("sort");

  if(view==="jobs"){
    q.placeholder = "Search jobs (job #, customer, field, type, notes)â€¦";
    sort.innerHTML = `
      <option value="updatedDesc">Sort: Recently Updated</option>
      <option value="createdDesc">Sort: Newest Created</option>
      <option value="createdAsc">Sort: Oldest Created</option>
      <option value="customerAsc">Sort: Customer Aâ†’Z</option>
      <option value="statusAsc">Sort: Status</option>
    `;
    sort.value = "updatedDesc";
  } else if(view==="customers"){
    q.placeholder = "Search customers (name, phone, email, address)â€¦";
    sort.innerHTML = `
      <option value="nameAsc">Sort: Name Aâ†’Z</option>
      <option value="nameDesc">Sort: Name Zâ†’A</option>
      <option value="fieldsDesc">Sort: Most Fields</option>
      <option value="jobsDesc">Sort: Most Jobs</option>
      <option value="updatedDesc">Sort: Recently Updated</option>
    `;
    sort.value = state.customersSort;
  } else if(view==="requests"){
    q.placeholder = "Search requestsâ€¦";
    sort.innerHTML = `<option value="createdDesc">Sort: Newest</option><option value="createdAsc">Sort: Oldest</option>`;
    sort.value = "createdDesc";
  } else if(view==="oos"){
    q.placeholder = "Search out-of-stockâ€¦";
    sort.innerHTML = `<option value="notedDesc">Sort: Newest</option><option value="notedAsc">Sort: Oldest</option>`;
    sort.value = "notedDesc";
  } else {
    q.placeholder = "Searchâ€¦";
    sort.innerHTML = `<option value="â€”">â€”</option>`;
    sort.value = "â€”";
  }

  renderAll();
}

/* =====================
   Sidebar quick views
===================== */
function renderStatusList(){
  const wrap = document.getElementById("statusList");
  wrap.innerHTML = "";
  const quick = ["open","paused","inprogress","finished"];
  quick.forEach(key=>{
    const s = statusByKey(key);
    const count = db.jobs.filter(j=>j.status===key).length;

    const div = document.createElement("div");
    div.className = "statusItem" + ((state.view==="jobs" && state.filterStatus===key) ? " active" : "");
    div.onclick = ()=>{
      state.filterStatus = key;
      setView("jobs");
    };

    const left = document.createElement("div");
    left.className = "dotPill";
    const md = document.createElement("span");
    md.className = "miniDot " + s.dotClass;
    const t = document.createElement("span");
    t.textContent = s.label;
    left.appendChild(md); left.appendChild(t);

    const pill = document.createElement("span");
    pill.className = "pill";
    pill.textContent = count;

    div.appendChild(left);
    div.appendChild(pill);
    wrap.appendChild(div);
  });
}

/* =====================
   Jobs view
===================== */
function renderKPIs(){
  const total = db.jobs.length;
  const open = db.jobs.filter(j=>j.status==="open").length;
  const paused = db.jobs.filter(j=>j.status==="paused").length;
  const inprog = db.jobs.filter(j=>j.status==="inprogress").length;

  document.getElementById("kpiTotal").textContent = total;
  document.getElementById("kpiOpen").textContent = open;
  document.getElementById("kpiPaused").textContent = paused;
  document.getElementById("kpiInProgress").textContent = inprog;

  document.getElementById("kpiTotalSub").textContent = `${db.customers.length} customers â€¢ ${db.fields.length} fields`;
}

function jobShortId(id){
  const d = String(id||"");
  return d.slice(-6).toUpperCase();
}

function jobSearchBlob(job){
  const c = db.customers.find(x=>x.id===job.customerId);
  const f = db.fields.find(x=>x.id===job.fieldId);
  
  const jb=document.getElementById("jdJobBar"); if(jb) jb.textContent = (job.jobCode || ("#" + jobShortId(job.id)));
  const cb=document.getElementById("jdCustomerBar"); if(cb) cb.textContent = (c?.customer?.name || "â€”");
  const fb=document.getElementById("jdFieldBar"); if(fb) fb.textContent = ((f?.name||"â€”") + (f?.brand?(" â€¢ "+f.brand):""));
const parts = [
    jobShortId(job.id),
    job.title, job.type, statusLabel(job.status),
    job.notesOffice || "",
    c?.customer?.name || "", c?.customer?.phone || "", c?.customer?.email || "",
    f?.name || "", f?.brand || "", f?.serialNumber || "", f?.sprinklerPackageNumber || ""
  ];
  return parts.join(" ").toLowerCase();
}

function filteredJobs(){
  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  let jobs = [...db.jobs].filter(j=>j.status===state.filterStatus);

  if(q) jobs = jobs.filter(j=>jobSearchBlob(j).includes(q));

  const sort = document.getElementById("sort").value;
  const custName = (job)=>{
    const c = db.customers.find(x=>x.id===job.customerId);
    return (c?.customer?.name || "").toLowerCase();
  };
  const statusRank = (k)=> STATUS.findIndex(s=>s.key===k);

  jobs.sort((a,b)=>{
    if(sort==="updatedDesc") return new Date(b.updatedAt) - new Date(a.updatedAt);
    if(sort==="createdDesc") return new Date(b.createdAt) - new Date(a.createdAt);
    if(sort==="createdAsc") return new Date(a.createdAt) - new Date(b.createdAt);
    if(sort==="customerAsc") return custName(a).localeCompare(custName(b));
    if(sort==="statusAsc") return statusRank(a.status) - statusRank(b.status);
    return 0;
  });

  return jobs;
}

function renderJobsTable(){
  const rows = document.getElementById("jobRows");
  rows.innerHTML = "";

  const jobs = filteredJobs();
  if(jobs.length===0){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 5;
    td.className = "muted";
    td.style.padding = "18px 12px";
    td.textContent = "No jobs match your filters/search.";
    tr.appendChild(td);
    rows.appendChild(tr);
    return;
  }

  jobs.forEach(job=>{
    const c = db.customers.find(x=>x.id===job.customerId);
    const f = db.fields.find(x=>x.id===job.fieldId);
    const s = statusByKey(job.status);

    const tr = document.createElement("tr");
    tr.style.cursor = "pointer";
    tr.onclick = ()=>openJobDetail(job.id);

    const td1 = document.createElement("td");
    td1.innerHTML = `
      <div class="jobTitle">${escapeHtml(job.jobCode || ("JB"+escapeHtml(jobShortId(job.id))))} â€¢ ${escapeHtml(job.description || job.title || "(No description)")}</div>
      <div class="muted">Created ${fmtTime(job.createdAt)}</div>
    `;

    const td2 = document.createElement("td");
    td2.innerHTML = `
      <div><strong>${escapeHtml(c?.customer?.name || "â€”")}</strong></div>
      <div class="muted">${escapeHtml(f?.name || "â€”")}</div>
    `;

    const td3 = document.createElement("td");
    td3.innerHTML = `<span class="tag"><span class="miniDot" style="background:rgba(255,255,255,.22)"></span>${escapeHtml(job.type)}</span>`;

    const td4 = document.createElement("td");
    td4.innerHTML = `<span class="tag"><span class="miniDot ${s?.dotClass || ""}"></span>${escapeHtml(s?.label || job.status)}</span>`;

    const td5 = document.createElement("td");
    td5.className = "rightAlign";
    td5.textContent = fmtTime(job.updatedAt);

    tr.append(td1, td2, td3, td4, td5);
    rows.appendChild(tr);
  });
}

/* =====================
   Customers list view
===================== */
function customerSearchBlob(c){
  const parts = [
    c.customer?.name || "",
    c.customer?.phone || "",
    c.customer?.email || "",
    c.customer?.address || "",
    c.billing?.name || "",
    c.billing?.phone || "",
    c.billing?.email || "",
    c.billing?.address || "",
  ];
  return parts.join(" ").toLowerCase();
}

function customerCounts(customerId){
  const fieldCt = db.fields.filter(f=>f.customerId===customerId).length;
  const fieldIds = new Set(db.fields.filter(f=>f.customerId===customerId).map(f=>f.id));
  const jobCt = db.jobs.filter(j=>fieldIds.has(j.fieldId)).length;
  return { fieldCt, jobCt };
}

function filteredCustomers(){
  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  let list = [...db.customers];

  if(q) list = list.filter(c=>customerSearchBlob(c).includes(q));

  const sort = document.getElementById("sort").value;
  state.customersSort = sort;

  list.sort((a,b)=>{
    const an = (a.customer?.name||"").toLowerCase();
    const bn = (b.customer?.name||"").toLowerCase();

    if(sort==="nameAsc") return an.localeCompare(bn);
    if(sort==="nameDesc") return bn.localeCompare(an);

    if(sort==="updatedDesc") return new Date(b.updatedAt||b.createdAt||0) - new Date(a.updatedAt||a.createdAt||0);

    if(sort==="fieldsDesc"){
      const ac = customerCounts(a.id).fieldCt;
      const bc = customerCounts(b.id).fieldCt;
      return bc - ac || an.localeCompare(bn);
    }
    if(sort==="jobsDesc"){
      const ac = customerCounts(a.id).jobCt;
      const bc = customerCounts(b.id).jobCt;
      return bc - ac || an.localeCompare(bn);
    }
    return 0;
  });

  return list;
}

function renderCustomersList(){
  const wrap = document.getElementById("customerPills");
  const empty = document.getElementById("customersEmpty");

  const list = filteredCustomers();
  wrap.innerHTML = "";
  empty.style.display = (list.length===0) ? "block" : "none";

  list.forEach(c=>{
    const counts = customerCounts(c.id);
    const updated = c.updatedAt || c.createdAt;

    const line = [
      c.customer?.phone ? c.customer.phone : "â€”",
      c.customer?.pref ? c.customer.pref : "",
      c.customer?.email ? c.customer.email : "â€”",
      c.customer?.address ? c.customer.address : "â€”"
    ].filter(Boolean).join(" â€¢ ");

    const pill = document.createElement("div");
    pill.className = "pillRow";
    pill.onclick = ()=>openCustomerFile(c.id);

    pill.innerHTML = `
      <div class="pillTop">
        <div style="min-width:0;">
          <strong>${escapeHtml(c.customer?.name || "(Unnamed)")}</strong>
          <div class="pillMeta oneLine" title="${escapeAttr(line)}">${escapeHtml(line)}</div>
          <div class="pillBadges">
            <span class="badge">${counts.fieldCt} fields</span>
            <span class="badge">${counts.jobCt} jobs</span>
          </div>
        </div>
        <div class="pillMeta" style="text-align:right;">
          Updated<br><span class="muted">${fmtTime(updated)}</span>
        </div>
      </div>
    `;
    wrap.appendChild(pill);
  });
}

/* =====================
   Customer file view
===================== */
function openCustomerFile(customerId){
  state.selectedCustomerId = customerId;
  state.selectedFieldId = null;
  state.customerEdit = false;
  state.deleteArmedCustomerId = null;

  setView("customerFile");
  renderCustomerFile();
}

function prefOptions(selected){
  const opts = ["","Call","Text","Email"];
  return opts.map(v=>`<option value="${escapeAttr(v)}" ${v===selected?"selected":""}>${v||"â€”"}</option>`).join("");
}
function brandOptions(selected){
  const opts = ["","Reinke","Valley","Zimmatic","T&L","Other"];
  return opts.map(v=>`<option value="${escapeAttr(v)}" ${v===selected?"selected":""}>${v||"(Not set)"}</option>`).join("");
}

function powerSourceOptions(selected){
  const opts = ["", "Electric Utility", "Engine Drive Generator", "Phase Converter"];
  return opts.map(v=>{
    const label = v ? v : "(Not set)";
    return `<option value="${escapeAttr(v)}" ${v===selected?"selected":""}>${escapeHtml(label)}</option>`;
  }).join("");
}


function updateJobNumberPreview(){
  const type = document.getElementById("jobType")?.value || "Other";
  const next = (db?.meta?.jobSeq ?? 1000);
  const typeName = document.getElementById("jobType")?.selectedOptions?.[0]?.textContent || type;
  const code = jobTypePrefix(type, typeName) + pad4(next);
  const inp = document.getElementById("jobNumberPreview");
  if(inp) inp.value = code;
}

function fillJobTruckSelect(selectedId=""){

  const sel = document.getElementById("jobTruck");
  if(!sel) return;
  const trucks = (db.settings?.trucks || []);
  if(trucks.length===0){
    sel.innerHTML = `<option value="">(No trucks in Settings)</option>`;
    sel.value = "";
    return;
  }
  sel.innerHTML = trucks.map(t=>`<option value="${escapeAttr(t.id)}" ${t.id===selectedId?"selected":""}>${escapeHtml(t.name||t.id)} (${escapeHtml(String(t.id).slice(-6).toUpperCase())})</option>`).join("");
  sel.value = selectedId || trucks[0].id;
}

function customerOptions(selectedId){
  return db.customers
    .slice()
    .sort((a,b)=>(a.customer?.name||"").toLowerCase().localeCompare((b.customer?.name||"").toLowerCase()))
    .map(c=>`<option value="${escapeAttr(c.id)}" ${c.id===selectedId?"selected":""}>${escapeHtml(c.customer?.name||"(Unnamed)")}</option>`)
    .join("");
}

function renderCustomerFile(){
  const c = db.customers.find(x=>x.id===state.selectedCustomerId);
  if(!c){ setView("customers"); return; }

  document.getElementById("custFileTitle").textContent = c.customer?.name || "Customer";
  document.getElementById("custFileSub").textContent = `Customer ID #${c.id.slice(-6).toUpperCase()} â€¢ ${db.fields.filter(f=>f.customerId===c.id).length} fields`;

  const editable = state.customerEdit;
  const block = document.getElementById("customerInfoBlock");
  block.innerHTML = `
    <div class="kv">
      <div>Name</div>
      <div><input class="input" id="cf_name" ${editable?"":"disabled"} value="${escapeAttr(c.customer?.name||"")}" /></div>

      <div>Phone</div>
      <div><input class="input" id="cf_phone" ${editable?"":"disabled"} value="${escapeAttr(c.customer?.phone||"")}" inputmode="tel" /></div>

      <div>Email</div>
      <div><input class="input" id="cf_email" ${editable?"":"disabled"} value="${escapeAttr(c.customer?.email||"")}" inputmode="email" /></div>

      <div>Preference</div>
      <div>
        <select class="select2" id="cf_pref" ${editable?"":"disabled"}>
          ${prefOptions(c.customer?.pref||"")}
        </select>
      </div>

      <div>Address</div>
      <div><input class="input" id="cf_addr" ${editable?"":"disabled"} value="${escapeAttr(c.customer?.address||"")}" /></div>

      <div style="margin-top:8px;">Billing Name</div>
      <div style="margin-top:8px;"><input class="input" id="cf_bname" ${editable?"":"disabled"} value="${escapeAttr(c.billing?.name||"")}" /></div>

      <div>Billing Phone</div>
      <div><input class="input" id="cf_bphone" ${editable?"":"disabled"} value="${escapeAttr(c.billing?.phone||"")}" inputmode="tel" /></div>

      <div>Billing Email</div>
      <div><input class="input" id="cf_bemail" ${editable?"":"disabled"} value="${escapeAttr(c.billing?.email||"")}" inputmode="email" /></div>

      <div>Billing Address</div>
      <div><input class="input" id="cf_baddr" ${editable?"":"disabled"} value="${escapeAttr(c.billing?.address||"")}" /></div>
    </div>

    ${editable ? `
      <div class="divider"></div>
      <div class="btnRow">
        <button class="btn small primary" id="btnCustomerSaveInline">Save</button>
        <div class="help">Edit mode changes only what you see here. No popup.</div>
      </div>
    ` : ``}
  `;

  if(editable){
    attachPhoneFormatter(document.getElementById("cf_phone"));
    attachPhoneFormatter(document.getElementById("cf_bphone"));
    document.getElementById("btnCustomerSaveInline").onclick = ()=> saveCustomerInline(c.id);
  }

  const confirmBox = document.getElementById("customerDeleteConfirm");
  confirmBox.style.display = (state.deleteArmedCustomerId===c.id) ? "block" : "none";

  renderCustomerFieldsPills(c.id);
}

function saveCustomerInline(customerId){
  const idx = db.customers.findIndex(x=>x.id===customerId);
  if(idx<0) return;

  db.customers[idx] = {
    ...db.customers[idx],
    updatedAt: nowISO(),
    customer:{
      name: document.getElementById("cf_name").value || "",
      phone: formatPhone(document.getElementById("cf_phone").value || ""),
      email: document.getElementById("cf_email").value || "",
      pref: document.getElementById("cf_pref").value || "",
      address: document.getElementById("cf_addr").value || "",
    },
    billing:{
      name: document.getElementById("cf_bname").value || "",
      phone: formatPhone(document.getElementById("cf_bphone").value || ""),
      email: document.getElementById("cf_bemail").value || "",
      address: document.getElementById("cf_baddr").value || "",
    }
  };
  saveDB(db);
  state.customerEdit = false;
  UI.toast("Customer saved.");
  renderCustomerFile();
}

function renderCustomerFieldsPills(customerId){
  const list = db.fields.filter(f=>f.customerId===customerId);
  const wrap = document.getElementById("fieldPills");
  const empty = document.getElementById("fieldsEmpty");

  wrap.innerHTML = "";
  empty.style.display = (list.length===0) ? "block" : "none";

  list
    .sort((a,b)=>(a.name||"").toLowerCase().localeCompare((b.name||"").toLowerCase()))
    .forEach(f=>{
      const jobsCt = db.jobs.filter(j=>j.fieldId===f.id).length;
      const pill = document.createElement("div");
      pill.className = "pillRow";
      pill.onclick = ()=>openFieldFile(f.id);

      const coords = (f.lat!=null && f.lng!=null) ? `${f.lat}, ${f.lng}` : "Lat/Lng â€”";

      pill.innerHTML = `
        <div class="pillTop">
          <div style="min-width:0;">
            <strong>${escapeHtml(f.name || "(Unnamed Field)")}</strong>
            <div class="pillMeta oneLine" title="${escapeAttr(`${f.brand || "(brand not set)"} â€¢ SN ${f.serialNumber || "â€”"} â€¢ Towers ${f.towerCount ?? "â€”"} â€¢ ${coords}`)}">
              ${escapeHtml(f.brand || "(brand not set)")} â€¢ SN ${escapeHtml(f.serialNumber || "â€”")} â€¢ Towers ${escapeHtml(f.towerCount ?? "â€”")} â€¢ ${escapeHtml(coords)}
            </div>
            <div class="pillBadges">
              <span class="badge">${jobsCt} jobs</span>
              <span class="badge">Pkg: ${escapeHtml(f.sprinklerPackageNumber || "â€”")}</span>
            </div>
          </div>
          <div class="pillMeta" style="text-align:right;">
            Updated<br><span class="muted">${fmtTime(f.updatedAt || f.createdAt)}</span>
          </div>
        </div>
      `;
      wrap.appendChild(pill);
    });
}

/* =====================
   Field file view
===================== */
function openFieldFile(fieldId){
  state.selectedFieldId = fieldId;
  state.fieldEdit = false;
  state.deleteArmedFieldId = null;

  setView("fieldFile");
  renderFieldFile();
}

function renderFieldFile(){
  const f = db.fields.find(x=>x.id===state.selectedFieldId);
  if(!f){ setView("customerFile"); return; }

  const c = db.customers.find(x=>x.id===f.customerId);

  document.getElementById("fieldFileTitle").textContent = f.name || "Field";
  document.getElementById("fieldFileSub").textContent = `${c?.customer?.name || "â€”"} â€¢ Field ID #${f.id.slice(-6).toUpperCase()}`;

  const editable = state.fieldEdit;
  const block = document.getElementById("fieldInfoBlock");
  block.innerHTML = `
    <div class="kv">
      <div>Customer</div>
      <div>
        <select class="select2" id="ff_customer" ${editable?"":"disabled"}>
          ${customerOptions(f.customerId)}
        </select>
      </div>

      <div>Field Name</div>
      <div><input class="input" id="ff_name" ${editable?"":"disabled"} value="${escapeAttr(f.name||"")}" /></div>

      <div>Brand</div>
      <div>
        <select class="select2" id="ff_brand" ${editable?"":"disabled"}>
          ${brandOptions(f.brand||"")}
        </select>
      </div>

      
      <div>Power Source</div>
      <div>
        <select class="select2" id="ff_power" ${editable?"":"disabled"}>
          ${powerSourceOptions(f.powerSource||"")}
        </select>
      </div>
<div>Serial Number</div>
      <div><input class="input" id="ff_serial" ${editable?"":"disabled"} value="${escapeAttr(f.serialNumber||"")}" /></div>

      <div>Tower Count</div>
      <div><input class="input" id="ff_towers" ${editable?"":"disabled"} value="${escapeAttr(f.towerCount ?? "")}" inputmode="numeric" /></div>

      <div>Lat</div>
      <div><input class="input" id="ff_lat" ${editable?"":"disabled"} value="${escapeAttr(f.lat ?? "")}" inputmode="decimal" /></div>

      <div>Lng</div>
      <div><input class="input" id="ff_lng" ${editable?"":"disabled"} value="${escapeAttr(f.lng ?? "")}" inputmode="decimal" /></div>

      <div>Sprinkler Package #</div>
      <div><input class="input" id="ff_pkg" ${editable?"":"disabled"} value="${escapeAttr(f.sprinklerPackageNumber||"")}" /></div>

      <div>Has Telemetry</div>
      <div>
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="ff_tel" ${editable?"":"disabled"} ${f.hasTelemetry ? "checked":""} />
          Yes
        </label>
      </div>

      <div>Telemetry Make</div>
      <div><input class="input" id="ff_telMake" ${editable?"":"disabled"} value="${escapeAttr(f.telemetryMake||"")}" /></div>

      <div>Telemetry Serial</div>
      <div><input class="input" id="ff_telSerial" ${editable?"":"disabled"} value="${escapeAttr(f.telemetrySerial||"")}" /></div>

      <div>Additional Info</div>
      <div><textarea class="textarea" id="ff_notes" ${editable?"":"disabled"}>${escapeHtml(f.notes||"")}</textarea></div>
    </div>

    ${editable ? `
      <div class="divider"></div>
      <div class="btnRow">
        <button class="btn small primary" id="btnFieldSaveInline">Save</button>
        <button class="btn small" id="btnOpenSatelliteInline">Open Satellite</button>
        <button class="btn small" id="btnCenterSatelliteInline">Open Centered</button>
      </div>
      <div class="help">Edit mode changes only what you see here. No popup.</div>
    ` : ``}
  `;

  if(editable){
    document.getElementById("btnFieldSaveInline").onclick = ()=>saveFieldInline(f.id);
    document.getElementById("btnOpenSatelliteInline").onclick = ()=>window.open("https://www.google.com/maps/@41,-99,15z/data=!3m1!1e3", "_blank");
    document.getElementById("btnCenterSatelliteInline").onclick = ()=>{
      const lat = safeNum(document.getElementById("ff_lat").value) ?? 41;
      const lng = safeNum(document.getElementById("ff_lng").value) ?? -99;
      window.open(`https://www.google.com/maps/@${lat},${lng},17z/data=!3m1!1e3`, "_blank");
    };
  }

  const confirmBox = document.getElementById("fieldDeleteConfirm");
  confirmBox.style.display = (state.deleteArmedFieldId===f.id) ? "block" : "none";

  renderJobsForField(f.id);
}

function saveFieldInline(fieldId){
  const idx = db.fields.findIndex(x=>x.id===fieldId);
  if(idx<0) return;

  const hasTelemetry = !!document.getElementById("ff_tel").checked;
  const customerId = document.getElementById("ff_customer").value;

  db.fields[idx] = {
    ...db.fields[idx],
    updatedAt: nowISO(),
    customerId,
    name: document.getElementById("ff_name").value || "",
    brand: document.getElementById("ff_brand").value || "",
    powerSource: document.getElementById("ff_power") ? (document.getElementById("ff_power").value || "") : (db.fields[idx].powerSource||""),
    serialNumber: document.getElementById("ff_serial").value || "",
    towerCount: safeNum(document.getElementById("ff_towers").value),
    lat: safeNum(document.getElementById("ff_lat").value),
    lng: safeNum(document.getElementById("ff_lng").value),
    sprinklerPackageNumber: document.getElementById("ff_pkg").value || "",
    hasTelemetry,
    telemetryMake: hasTelemetry ? (document.getElementById("ff_telMake").value || "") : "",
    telemetrySerial: hasTelemetry ? (document.getElementById("ff_telSerial").value || "") : "",
    notes: document.getElementById("ff_notes").value || ""
  };

  db.jobs = db.jobs.map(j=>{
    if(j.fieldId===fieldId){
      return { ...j, customerId, updatedAt: j.updatedAt || nowISO() };
    }
    return j;
  });

  saveDB(db);
  state.fieldEdit = false;
  UI.toast("Field saved.");
  renderFieldFile();
}

function renderJobsForField(fieldId){
  const wrap = document.getElementById("fieldJobsPills");
  const empty = document.getElementById("fieldJobsEmpty");
  const list = db.jobs.filter(j=>j.fieldId===fieldId);

  wrap.innerHTML = "";
  empty.style.display = (list.length===0) ? "block" : "none";

  list
    .sort((a,b)=>new Date(b.updatedAt||b.createdAt||0) - new Date(a.updatedAt||a.createdAt||0))
    .forEach(j=>{
      const s = statusByKey(j.status);
      const pill = document.createElement("div");
      pill.className = "pillRow";
      pill.onclick = ()=>openJobDetail(j.id);

      pill.innerHTML = `
        <div class="pillTop">
          <div style="min-width:0;">
            <strong>#${escapeHtml(jobShortId(j.id))} â€¢ ${escapeHtml(j.title || "(Untitled job)")}</strong>
            <div class="pillMeta oneLine" title="${escapeAttr(`${j.type} â€¢ ${s?.label||j.status} â€¢ Updated ${fmtTime(j.updatedAt)}`)}">
              ${escapeHtml(j.type)} â€¢ ${escapeHtml(s?.label||j.status)} â€¢ Updated ${escapeHtml(fmtTime(j.updatedAt))}
            </div>
            <div class="pillBadges">
              <span class="badge"><span class="miniDot ${s?.dotClass||""}" style="display:inline-block; width:9px; height:9px; margin-right:6px;"></span>${escapeHtml(s?.label||j.status)}</span>
            </div>
          </div>
          <div class="pillMeta" style="text-align:right;">
            Created<br><span class="muted">${fmtTime(j.createdAt)}</span>
          </div>
        </div>
      `;
      wrap.appendChild(pill);
    });
}

/* =====================
   Job detail modal + office status rules
===================== */
function openJobDetail(jobId){
  state.selectedJobId = jobId;
  const job = db.jobs.find(j=>j.id===jobId);
  const jobCode = (job?.jobCode || job?.jobNumber || ("#" + jobShortId(job?.id)));
  const jdTitleEl = document.getElementById("jdTitle");
  if(jdTitleEl) jdTitleEl.textContent = jobCode;
  if(!job) return;

  const c = db.customers.find(x=>x.id===job.customerId);
  const f = db.fields.find(x=>x.id===job.fieldId);
  const s = statusByKey(job.status);


// Title bars (values only)
const jobBar = document.getElementById("jdJobBar");
const custBar = document.getElementById("jdCustomerBar");
const fieldBar = document.getElementById("jdFieldBar");

if(jobBar) jobBar.textContent = `${jobCode} â€¢ ${job.type || "â€”"}`;

const custName = (c?.customer?.name || c?.name || "â€”");
if(custBar) custBar.textContent = custName;

const fieldName = (f?.name || "â€”");
const fieldBrand = (f?.brand ? (" â€¢ " + f.brand) : "");
if(fieldBar) fieldBar.textContent = fieldName + fieldBrand;
  const actions = document.getElementById("jdActions");
  actions.innerHTML = "";

  if(job.status !== "finished" && job.status !== "closed"){
    const b = document.createElement("button");
    b.className = "btn small warn";
    b.textContent = "Mark Finished";
    b.onclick = ()=> updateJobStatusOffice(job.id, "finished");
    actions.appendChild(b);
  }

  if(job.status === "finished"){
    const b2 = document.createElement("button");
    b2.className = "btn small good";
    b2.textContent = "Reopen (to Open)";
    b2.onclick = ()=> updateJobStatusOffice(job.id, "open");
    actions.appendChild(b2);

    const b3 = document.createElement("button");
    b3.className = "btn small danger";
    b3.textContent = "Close Job";
    b3.onclick = ()=> updateJobStatusOffice(job.id, "closed");
    actions.appendChild(b3);
  }

  if(actions.children.length===0){
    const span = document.createElement("div");
    span.className = "tiny";
    span.textContent = "No office actions available for this status.";
    actions.appendChild(span);
  }

  document.getElementById("jdJob").innerHTML = `
  <div class="descHighlight">
    <div class="label">Job Description</div>
    <div class="text">${escapeHtml(job.description || job.problemDescription || "â€”")}</div>
  </div>
  <div class="kv">
    <div>Job #</div><div>${escapeHtml(jobCode)}</div>
    <div>Type</div><div>${escapeHtml(job.type || "â€”")}</div>
    <div>Status</div><div><span class="tag"><span class="miniDot" style="background:${escapeAttr(s?.color||"#9aa0a6")}"></span>${escapeHtml(s?.label||job.status)}</span></div>
    <div>Created</div><div>${escapeHtml(fmtTime(job.createdAt))}</div>
    <div>Updated</div><div>${escapeHtml(fmtTime(job.updatedAt))}</div>
    <div>Office Notes</div><div>${escapeHtml(job.notesOffice || job.notes || "â€”")}</div>
  </div>
`;
  document.getElementById("jdCustomer").innerHTML = `
    <div class="kv">
      <div>Name</div><div>${escapeHtml(c?.customer?.name || "â€”")}</div>
      <div>Phone</div><div>${escapeHtml(c?.customer?.phone || "â€”")}${c?.customer?.pref ? ` â€¢ ${escapeHtml(c.customer.pref)}` : ""}</div>
      <div>Email</div><div>${escapeHtml(c?.customer?.email || "â€”")}</div>
      <div>Address</div><div>${escapeHtml(c?.customer?.address || "â€”")}</div>
      <div>Billing</div><div>${escapeHtml(c?.billing?.name || "â€”")} â€¢ ${escapeHtml(c?.billing?.phone || "â€”")}</div>
    </div>
  `;

  const coords = (f?.lat!=null && f?.lng!=null) ? `${f.lat}, ${f.lng}` : "â€”";
  document.getElementById("jdField").innerHTML = `
    <div class="kv">
      <div>Field</div><div>${escapeHtml(f?.name || "â€”")}</div>
      <div>Brand</div><div>${escapeHtml(f?.brand || "â€”")}</div>
      <div>Serial #</div><div>${escapeHtml(f?.serialNumber || "â€”")}</div>
      <div>Tower Count</div><div>${escapeHtml(f?.towerCount ?? "â€”")}</div>
      <div>Sprinkler Pkg #</div><div>${escapeHtml(f?.sprinklerPackageNumber || "â€”")}</div>
      <div>Lat/Lng</div><div>${escapeHtml(coords)}</div>
      <div>Telemetry</div><div>${f?.hasTelemetry ? `${escapeHtml(f.telemetryMake || "Yes")} â€¢ ${escapeHtml(f.telemetrySerial || "â€”")}` : "No"}</div>
      <div>Notes</div><div>${escapeHtml(f?.notes || "â€”")}</div>
    </div>
  `;

  UI.openModal("modalJobDetail");
}

function updateJobStatusOffice(jobId, newStatus){
  const idx = db.jobs.findIndex(j=>j.id===jobId);
  if(idx<0) return;

  const job = db.jobs[idx];
  const allowed =
    (newStatus==="finished" && job.status!=="closed") ||
    (newStatus==="open" && job.status==="finished") ||
    (newStatus==="closed" && job.status==="finished");

  if(!allowed){
    UI.toast("That status change isn't allowed from the office dashboard.");
    return;
  }

  db.jobs[idx] = { ...job, status:newStatus, updatedAt: nowISO() };
  saveDB(db);

  renderAll();
  openJobDetail(jobId);
}

/* =====================
   CRUD base
===================== */
async function addCustomer(payload){
  // TEMP DEBUG: verify payload shape
  console.log("addCustomer payload:", payload);

  const customer_id = uid("cust");
  const t = nowISO();

  // local save (keep current behavior)
  db.customers.push({
    id: customer_id,
    createdAt: t,
    updatedAt: t,
    customer: payload.customer,
    billing: payload.billing
  });

  saveDB(db);

  // ---- SUPABASE UPSERT (customer create) ----
  try{
    const sb = window.sb;
    if(!sb){ console.warn("Supabase client not ready."); return; }

    const c = payload.customer || {};
    const row = {
      org_id: window.ORG_ID || "pracht",
      customer_id: customer_id,
      name: c.name || "",
      phone: c.phone || null,
      email: c.email || null,
      address: c.address || null
    };

    const { error: customerError } = await sb
      .from("customers")
      .upsert(row, { onConflict: "customer_id" });

    if(customerError) console.error("customer insert error:", customerError);
    else console.log("customer saved to supabase");
  }catch(err){
    console.error("customer insert exception:", err);
  }
}

async function addField(payload){
  const field_id = uid("field");
  const t = nowISO();

  // local save (keep)
  db.fields.push({
    id: field_id,
    createdAt: t,
    updatedAt: t,
    ...payload
  });
  saveDB(db);

  // supabase save (new)
  try{
    const sb = window.sb;
    if(!sb){ console.warn("Supabase client not ready (field)."); return field_id; }

  const row = {
  org_id: window.ORG_ID || "pracht",
  field_id: field_id,
  customer_id: payload.customerId,
  name: payload.name,
  brand: payload.brand || null,
  power_source: payload.powerSource || null,
  serial_number: payload.serialNumber || null,
  tower_count: (payload.towerCount === "" || payload.towerCount == null) ? null : Number(payload.towerCount),
  lat: (payload.lat === "" || payload.lat == null) ? null : Number(payload.lat),
  lng: (payload.lng === "" || payload.lng == null) ? null : Number(payload.lng),
  sprinkler_package_number: payload.sprinklerPackageNumber || null,
  has_telemetry: !!payload.hasTelemetry,
  telemetry_make: payload.telemetryMake || null,
  telemetry_serial: payload.telemetrySerial || null,
  notes: payload.notes || null,
  created_at: t,
  updated_at: t
};

    const { error: fieldErr } = await sb
      .from("fields")
      .upsert(row, { onConflict: "field_id" });

    if(fieldErr) console.error("field upsert error:", fieldErr);
    else console.log("field saved to supabase:", field_id);
  }catch(err){
    console.error("field upsert exception:", err);
  }

  return field_id;
}

function addJob(payload){
  const t = nowISO();
  db.jobs.push({
    id: uid("job"),
    createdAt: t,
    updatedAt: t,
    status: "open",
    ...payload
  });
  saveDB(db);
}

/* delete */
function deleteCustomer(customerId){
  db.customers = db.customers.filter(c=>c.id!==customerId);
  const fieldIds = new Set(db.fields.filter(f=>f.customerId===customerId).map(f=>f.id));
  db.fields = db.fields.filter(f=>f.customerId!==customerId);
  db.jobs = db.jobs.filter(j=>!fieldIds.has(j.fieldId));
  saveDB(db);
}
function deleteField(fieldId){
  db.fields = db.fields.filter(x=>x.id!==fieldId);
  db.jobs = db.jobs.filter(j=>j.fieldId!==fieldId);
  saveDB(db);
}

/* =====================
   Export / Import
===================== */
function exportJSON(){
  const out = JSON.stringify(db, null, 2);
  navigator.clipboard?.writeText(out).catch(()=>{});
  UI.toast("Export copied to clipboard (and opened in a new tab).");
  const w = window.open("", "_blank");
  if(w){
    w.document.write(`<pre style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${escapeHtml(out)}</pre>`);
    w.document.title = "Office Dashboard Export";
  }
}

/* Partial import:
   - customers
   - fields
   - truckStock
   - truckTools
   Also: import trucks IF needed for stock/tools integrity.
*/
function partialImportFromJSON(str, opts){
  const parsed = migrateDB(JSON.parse(str));

  // Validate basic shape
  if(!parsed || typeof parsed !== "object") throw new Error("Invalid JSON.");

  const wantCustomers = !!opts.customers;
  const wantFields    = !!opts.fields;
  const wantStock     = !!opts.truckStock;
  const wantTools     = !!opts.truckTools;

  // 1) Customers
  if(wantCustomers){
    db.customers = Array.isArray(parsed.customers) ? parsed.customers : [];
  }

  // 2) Fields
  if(wantFields){
    db.fields = Array.isArray(parsed.fields) ? parsed.fields : [];
  }

  // If customers/fields changed, prune jobs to prevent broken references
  if(wantCustomers || wantFields){
    const customerIds = new Set(db.customers.map(c=>c.id));
    const fieldIds = new Set(db.fields.map(f=>f.id));

    db.jobs = db.jobs.filter(j=>{
      if(!customerIds.has(j.customerId)) return false;
      if(!fieldIds.has(j.fieldId)) return false;
      return true;
    });
  }

  // 3/4) Trucks + stock/tools
  // If importing stock/tools, we want trucks as well if available
  if(wantStock || wantTools){
    // If the import has trucks, bring them over (merge by id)
    if(parsed.settings && Array.isArray(parsed.settings.trucks)){
      const existing = new Map((db.settings.trucks||[]).map(t=>[t.id,t]));
      parsed.settings.trucks.forEach(t=>{
        if(t && t.id){
          existing.set(t.id, {id:t.id, name: t.name || existing.get(t.id)?.name || `Imported Truck ${t.id.slice(-6).toUpperCase()}`});
        }
      });
      db.settings.trucks = Array.from(existing.values());
    }

    db.settings.truckStock = db.settings.truckStock || {};
    db.settings.truckTools = db.settings.truckTools || {};
    db.settings.trucks = Array.isArray(db.settings.trucks) ? db.settings.trucks : [];

    const truckIdSet = new Set(db.settings.trucks.map(t=>t.id));

    // Import stock
    if(wantStock){
      const incoming = (parsed.settings && parsed.settings.truckStock) ? parsed.settings.truckStock : {};
      if(typeof incoming === "object" && incoming){
        db.settings.truckStock = incoming;
        // Ensure all truck IDs exist as trucks
        Object.keys(db.settings.truckStock).forEach(trkId=>{
          if(!truckIdSet.has(trkId)){
            db.settings.trucks.push({id:trkId, name:`Imported Truck ${trkId.slice(-6).toUpperCase()}`});
            truckIdSet.add(trkId);
          }
        });
      } else {
        db.settings.truckStock = {};
      }
    }

    // Import tools
    if(wantTools){
      const incoming = (parsed.settings && parsed.settings.truckTools) ? parsed.settings.truckTools : {};
      if(typeof incoming === "object" && incoming){
        db.settings.truckTools = incoming;
        Object.keys(db.settings.truckTools).forEach(trkId=>{
          if(!truckIdSet.has(trkId)){
            db.settings.trucks.push({id:trkId, name:`Imported Truck ${trkId.slice(-6).toUpperCase()}`});
            truckIdSet.add(trkId);
          }
        });
      } else {
        db.settings.truckTools = {};
      }
    }
  }

  // Keep selections valid
  ensureTruckSelections();

  saveDB(db);
}

/* =====================
   Select fillers
===================== */
function fillCustomerSelect(elId){
  const el = document.getElementById(elId);
  el.innerHTML = "";
  db.customers
    .slice()
    .sort((a,b)=>(a.customer?.name||"").toLowerCase().localeCompare((b.customer?.name||"").toLowerCase()))
    .forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.customer?.name || "(Unnamed)";
      el.appendChild(opt);
    });
  if(db.customers.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(No customers yet)";
    el.appendChild(opt);
  }
}
function fillFieldSelect(elId, customerId){
  const el = document.getElementById(elId);
  el.innerHTML = "";
  const fields = db.fields.filter(f=>f.customerId===customerId).slice().sort((a,b)=>(a.name||"").toLowerCase().localeCompare((b.name||"").toLowerCase()));
  fields.forEach(f=>{
    const opt = document.createElement("option");
    opt.value = f.id;
    opt.textContent = f.name || "(Unnamed Field)";
    el.appendChild(opt);
  });
  if(fields.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(No fields for this customer)";
    el.appendChild(opt);
  }
}

function fillJobTypeSelect(){
  const el = document.getElementById("jobType");
  if(!el) return;
  el.innerHTML = "";

  // Source of truth: Supabase job_types (loaded when opening Create Job)
  const list = (state._jobCreate && Array.isArray(state._jobCreate.jobTypes)) ? state._jobCreate.jobTypes : [];
  list.forEach(jt=>{
    const opt = document.createElement("option");
    opt.value = jt.job_type_id;
    opt.textContent = jt.name || jt.job_type_id;
    el.appendChild(opt);
  });
}


/* =====================
   Settings UI (live)
===================== */
const SETTINGS_TABS = [
  { key:"trucks", label:"Trucks" },
  { key:"stock", label:"Truck Stock Levels" },
  { key:"tools", label:"Truck Tool Lists" },
  { key:"jobtypes", label:"Job Types" },
  { key:"techs", label:"Techs" },
  { key:"assign", label:"Assign Techs â†’ Trucks" },
  { key:"helpers", label:"Helpers" },
];

function renderSettings(){
  ensureTruckSelections();

  const nav = document.getElementById("settingsNav");
  const pane = document.getElementById("settingsPane");

  nav.innerHTML = SETTINGS_TABS.map(t=>`
    <button class="${t.key===state.settingsTab ? "active":""}" data-tab="${t.key}">${escapeHtml(t.label)}</button>
  `).join("");

  nav.querySelectorAll("button").forEach(b=>{
    b.onclick = ()=>{
      state.settingsTab = b.dataset.tab;
      renderSettings();
    };
  });

  if(state.settingsTab==="trucks") pane.innerHTML = settingsTrucksHtml();
  if(state.settingsTab==="stock") pane.innerHTML = settingsStockHtml();
  if(state.settingsTab==="tools") pane.innerHTML = settingsToolsHtml();
  if(state.settingsTab==="jobtypes") pane.innerHTML = settingsJobTypesHtml();
  if(state.settingsTab==="techs") pane.innerHTML = settingsTechsHtml();
  if(state.settingsTab==="assign") pane.innerHTML = settingsAssignHtml();
  if(state.settingsTab==="helpers") pane.innerHTML = settingsHelpersHtml();

  wireSettingsPane();
  saveDB(db);
}

function truckSelectorHtml(selectedId, id){
  const trucks = db.settings.trucks || [];
  if(trucks.length===0) return `<div class="empty">Add a truck first (Settings â†’ Trucks).</div>`;
  const opts = trucks.map(t=>`<option value="${escapeAttr(t.id)}" ${t.id===selectedId?"selected":""}>${escapeHtml(t.name)}</option>`).join("");
  return `
    <div class="formGrid" style="margin-bottom:10px;">
      <div class="field full">
        <label>Truck</label>
        <select class="select2" id="${escapeAttr(id)}">${opts}</select>
      </div>
    </div>
  `;
}

function settingsTrucksHtml(){
  const trucks = db.settings.trucks || [];
  return `
    <div class="panelHead"><div class="title">Trucks</div></div>
    <div class="tiny">Add/remove trucks. Stock/tools are stored per truck.</div>
    <div class="divider"></div>
    <div class="btnRow">
      <input class="input" id="st_newTruck" placeholder="Truck name (e.g., Service Truck 1)" />
      <button class="btn small primary" id="st_addTruck">Add</button>
    </div>
    <div class="divider"></div>
    ${trucks.length===0 ? `<div class="empty">No trucks yet.</div>` : `
      ${trucks.map(t=>`
        <div class="rowLine">
          <div><strong>${escapeHtml(t.name)}</strong><div class="tiny">ID ${escapeHtml(t.id.slice(-6).toUpperCase())}</div></div>
          <button class="btn small danger" data-del-truck="${t.id}">Remove</button>
        </div>
      `).join("")}
    `}
  `;
}

function settingsJobTypesHtml(){
  const list = db.settings.jobTypes || [];
  return `
    <div class="panelHead"><div class="title">Job Types</div></div>
    <div class="tiny">These feed the Create Job dropdown.</div>
    <div class="divider"></div>
    <div class="btnRow">
      <input class="input" id="sj_newType" placeholder="New job type (e.g., Warranty Claim)" />
      <button class="btn small primary" id="sj_addType">Add</button>
    </div>
    <div class="divider"></div>
    ${list.map(jt=>`
      <div class="rowLine">
        <div><strong>${escapeHtml(jt.name)}</strong></div>
        <button class="btn small danger" data-del-jobtype="${jt.id}">Remove</button>
      </div>
    `).join("")}
  `;
}

function settingsTechsHtml(){
  const techs = db.settings.techs || [];
  return `
    <div class="panelHead"><div class="title">Techs</div></div>
    <div class="tiny">Add/remove techs. Assign them to trucks on the next tab.</div>
    <div class="divider"></div>
    <div class="formGrid">
      <div class="field">
        <label>Name</label>
        <input class="input" id="stc_name" placeholder="Tech name" />
      </div>
      <div class="field">
        <label>Phone</label>
        <input class="input" id="stc_phone" placeholder="(###) ###-####" inputmode="tel" />
      </div>
      <div class="field full">
        <button class="btn small primary" id="stc_add">Add Tech</button>
      </div>
    </div>
    <div class="divider"></div>
    ${techs.length===0 ? `<div class="empty">No techs yet.</div>` : `
      ${techs.map(t=>`
        <div class="rowLine">
          <div><strong>${escapeHtml(t.name)}</strong><div class="tiny">${escapeHtml(t.phone || "â€”")}</div></div>
          <button class="btn small danger" data-del-tech="${t.id}">Remove</button>
        </div>
      `).join("")}
    `}
  `;
}

function settingsHelpersHtml(){
  const helpers = db.settings.helpers || [];
  return `
    <div class="panelHead"><div class="title">Helpers</div></div>
    <div class="tiny">Simple list of helpers.</div>
    <div class="divider"></div>
    <div class="btnRow">
      <input class="input" id="sh_newHelper" placeholder="Helper name" />
      <button class="btn small primary" id="sh_addHelper">Add</button>
    </div>
    <div class="divider"></div>
    ${helpers.length===0 ? `<div class="empty">No helpers yet.</div>` : `
      ${helpers.map(h=>`
        <div class="rowLine">
          <div><strong>${escapeHtml(h.name)}</strong></div>
          <button class="btn small danger" data-del-helper="${h.id}">Remove</button>
        </div>
      `).join("")}
    `}
  `;
}

function settingsAssignHtml(){
  const techs = db.settings.techs || [];
  const trucks = db.settings.trucks || [];
  const assigns = db.settings.assignments || [];

  const techOpts = techs.map(t=>`<option value="${escapeAttr(t.id)}">${escapeHtml(t.name)}</option>`).join("");
  const truckOpts = trucks.map(t=>`<option value="${escapeAttr(t.id)}">${escapeHtml(t.name)}</option>`).join("");

  return `
    <div class="panelHead"><div class="title">Assign Techs to Trucks</div></div>
    <div class="tiny">One tech can be assigned to one truck (for now). Remove to unassign.</div>
    <div class="divider"></div>

    ${(techs.length===0 || trucks.length===0) ? `
      <div class="empty">Add at least 1 tech and 1 truck first.</div>
    ` : `
      <div class="formGrid">
        <div class="field">
          <label>Tech</label>
          <select class="select2" id="sa_tech">${techOpts}</select>
        </div>
        <div class="field">
          <label>Truck</label>
          <select class="select2" id="sa_truck">${truckOpts}</select>
        </div>
        <div class="field full">
          <button class="btn small primary" id="sa_add">Assign</button>
        </div>
      </div>
    `}

    <div class="divider"></div>

    ${assigns.length===0 ? `<div class="empty">No assignments yet.</div>` : `
      ${assigns.map(a=>{
        const tech = techs.find(t=>t.id===a.techId);
        const truck = trucks.find(t=>t.id===a.truckId);
        return `
          <div class="rowLine">
            <div><strong>${escapeHtml(tech?.name || "â€”")}</strong><div class="tiny">â†’ ${escapeHtml(truck?.name || "â€”")}</div></div>
            <button class="btn small danger" data-del-assign="${a.id}">Remove</button>
          </div>
        `;
      }).join("")}
    `}
  `;
}

/* NEW: Truck selector dropdowns in Stock/Tools */
function settingsStockHtml(){
  const trucks = db.settings.trucks || [];
  if(trucks.length===0) return `<div class="empty">Add a truck first (Settings â†’ Trucks).</div>`;

  ensureTruckSelections();
  const truckId = state.settingsStockTruckId;
  const truck = trucks.find(t=>String(t.id)===String(truckId));
  const truckName = truck?.name || "Truck";

  const list = (db.settings.truckStock[truckId] || []);

  return `
    <div class="panelHead"><div class="title">Truck Stock Levels</div></div>
    <div class="tiny">Minimum stock levels per truck. (This is the â€œmaster listâ€ for restock logic.)</div>
    <div class="divider"></div>

    <div class="pill"><b>Truck:</b> ${escapeHtml(truckName)} (ID ${escapeHtml(truckId)})</div>
    <div class="divider"></div>

    ${truckSelectorHtml(truckId, "ss_truckSel")}

    <div class="formGrid three" style="margin-top:10px;">
      <div class="field">
        <label>Part Number</label>
        <input class="input" id="ss_partNumber" placeholder="e.g., R-1234" />
      </div>
      <div class="field">
        <label>Min Qty</label>
        <input class="input" id="ss_minQty" placeholder="e.g., 2" inputmode="numeric" />
      </div>
      <div class="field full">
        <button class="btn primary" id="ss_add">Add</button>
      </div>
    </div>

    <div class="divider"></div>

    ${list.length===0 ? `<div class="empty">No minimum stock items for this truck yet.</div>` : `
      <div class="list">
        ${list.map(it=>{
          const desc = getProductDescByPartNumber(it.partNumber);
          return `
            <div class="rowLine">
              <div>
                <strong>${escapeHtml(it.partNumber||"")}</strong>
                <div class="muted">${escapeHtml(desc||"")}</div>
                <div class="tiny">Min Qty: ${escapeHtml(it.minQty ?? 0)}</div>
              </div>
              <button class="btn danger" data-del-stock="${escapeAttr(it.id)}">Remove</button>
            </div>
          `;
        }).join("")}
      </div>
    `}
  `;
}

function settingsToolsHtml(){
  const trucks = db.settings.trucks || [];
  if(trucks.length===0) return `<div class="empty">Add a truck first (Settings â†’ Trucks).</div>`;

  ensureTruckSelections();
  const truckId = state.settingsToolsTruckId;
  const truck = trucks.find(t=>String(t.id)===String(truckId));
  const truckName = truck?.name || "Truck";

  const list = (db.settings.truckTools[truckId] || []);

  return `
    <div class="panelHead"><div class="title">Truck Tool Lists</div></div>
    <div class="tiny">Tools per truck. Quantity is required (minimum 1).</div>
    <div class="divider"></div>

    <div class="pill"><b>Truck:</b> ${escapeHtml(truckName)} (ID ${escapeHtml(truckId)})</div>
    <div class="divider"></div>

    ${truckSelectorHtml(truckId, "stl_truckSel")}

    <div class="formGrid three" style="margin-top:10px;">
      <div class="field">
        <label>Tool Name</label>
        <input class="input" id="stl_name" placeholder="e.g., clamp meter" />
      </div>
      <div class="field">
        <label>Qty</label>
        <input class="input" id="stl_qty" placeholder="e.g., 1" inputmode="numeric" />
      </div>
      <div class="field full">
        <button class="btn primary" id="stl_add">Add</button>
      </div>
    </div>

    <div class="divider"></div>

    ${list.length===0 ? `<div class="empty">No tools for this truck yet.</div>` : `
      <div class="list">
        ${list.map(it=>`
          <div class="rowLine">
            <div>
              <strong>${escapeHtml(it.name||"")}</strong>
              <div class="tiny">Qty: ${escapeHtml(it.qty ?? 1)}</div>
            </div>
            <button class="btn danger" data-del-tool="${escapeAttr(it.id)}">Remove</button>
          </div>
        `).join("")}
      </div>
    `}
  `;
}

function wireSettingsPane(){
  // Trucks
  const addTruck = document.getElementById("st_addTruck");
  if(addTruck){
    addTruck.onclick = ()=>{
      const name = (document.getElementById("st_newTruck").value||"").trim();
      if(!name) return UI.toast("Truck name required.");
      const t = { id: uid("trk"), name };
      db.settings.trucks.push(t);
      db.settings.truckStock[t.id] = db.settings.truckStock[t.id] || [];
      db.settings.truckTools[t.id] = db.settings.truckTools[t.id] || [];
      saveDB(db);
      ensureTruckSelections();
      renderSettings();
    };
    document.querySelectorAll("[data-del-truck]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del-truck");
        db.settings.trucks = db.settings.trucks.filter(t=>t.id!==id);
        delete db.settings.truckStock[id];
        delete db.settings.truckTools[id];
        db.settings.assignments = db.settings.assignments.filter(a=>a.truckId!==id);
        saveDB(db);
        ensureTruckSelections();
        renderSettings();
      };
    });
  }

  // Job types
  const addType = document.getElementById("sj_addType");
  if(addType){
    addType.onclick = ()=>{
      const name = (document.getElementById("sj_newType").value||"").trim();
      if(!name) return UI.toast("Type name required.");
      db.settings.jobTypes.push({ id: uid("jt"), name });
      saveDB(db);
      renderSettings();
    };
    document.querySelectorAll("[data-del-jobtype]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del-jobtype");
        db.settings.jobTypes = db.settings.jobTypes.filter(jt=>jt.id!==id);
        saveDB(db);
        renderSettings();
      };
    });
  }

  // Techs
  const addTech = document.getElementById("stc_add");
  if(addTech){
    const phoneEl = document.getElementById("stc_phone");
    attachPhoneFormatter(phoneEl);
    addTech.onclick = ()=>{
      const name = (document.getElementById("stc_name").value||"").trim();
      const phone = formatPhone(document.getElementById("stc_phone").value||"");
      if(!name) return UI.toast("Tech name required.");
      db.settings.techs.push({ id: uid("tech"), name, phone });
      saveDB(db);
      renderSettings();
    };
    document.querySelectorAll("[data-del-tech]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del-tech");
        db.settings.techs = db.settings.techs.filter(t=>t.id!==id);
        db.settings.assignments = db.settings.assignments.filter(a=>a.techId!==id);
        saveDB(db);
        renderSettings();
      };
    });
  }

  // Helpers
  const addHelper = document.getElementById("sh_addHelper");
  if(addHelper){
    addHelper.onclick = ()=>{
      const name = (document.getElementById("sh_newHelper").value||"").trim();
      if(!name) return UI.toast("Helper name required.");
      db.settings.helpers.push({ id: uid("hlp"), name });
      saveDB(db);
      renderSettings();
    };
    document.querySelectorAll("[data-del-helper]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del-helper");
        db.settings.helpers = db.settings.helpers.filter(h=>h.id!==id);
        saveDB(db);
        renderSettings();
      };
    });
  }

  // Assignments
  const addAssign = document.getElementById("sa_add");
  if(addAssign){
    addAssign.onclick = ()=>{
      const techId = document.getElementById("sa_tech").value;
      const truckId = document.getElementById("sa_truck").value;
      if(!techId || !truckId) return UI.toast("Pick a tech and a truck.");

      db.settings.assignments = db.settings.assignments.filter(a=>a.techId!==techId);
      db.settings.assignments.push({ id: uid("as"), techId, truckId });

      saveDB(db);
      renderSettings();
    };
    document.querySelectorAll("[data-del-assign]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del-assign");
        db.settings.assignments = db.settings.assignments.filter(a=>a.id!==id);
        saveDB(db);
        renderSettings();
      };
    });
  }

  // NEW: Stock truck selector
  const ssSel = document.getElementById("ss_truckSel");
  if(ssSel){
    ssSel.onchange = ()=>{
      state.settingsStockTruckId = ssSel.value;
      renderSettings();
    };
  }

  // Stock add/remove (uses selected truck)
  const addStock = document.getElementById("ss_add");
  if(addStock) addStock.onclick = ()=>{
    const partNumber = (document.getElementById("ss_partNumber")?.value || "").trim();
    const minQty = parseInt(document.getElementById("ss_minQty")?.value || "0", 10);

    if(!partNumber) return UI.toast("Part # required.");
    if(!Number.isFinite(minQty) || minQty < 0) return UI.toast("Min qty must be 0 or higher.");

    db.settings.truckStock.push({
      id: "stk_" + Date.now() + "_" + Math.random().toString(16).slice(2),
      partNumber,
      minQty
    });

    document.getElementById("ss_partNumber").value = "";
    document.getElementById("ss_minQty").value = 0;
    saveDB(); renderSettings();
  };

const addTool = document.getElementById("stl_add");
  if(addTool){
    const truckId = state.settingsToolsTruckId;
    addTool.onclick = ()=>{
      const name = (document.getElementById("stl_name")?.value || "").trim();
      const qty = parseInt(document.getElementById("stl_qty")?.value || "1", 10);

      if(!name) return UI.toast("Tool name required.");
      if(!Number.isFinite(qty) || qty < 1) return UI.toast("Qty must be 1 or higher.");

      db.settings.truckTools[truckId] = db.settings.truckTools[truckId] || [];
      db.settings.truckTools[truckId].push({ id: uid("tool"), name, qty });

      document.getElementById("stl_name").value = "";
      document.getElementById("stl_qty").value = 1;

      saveDB(db);
      renderSettings();
    };

    document.querySelectorAll("[data-del-tool]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del-tool");
        db.settings.truckTools[truckId] = (db.settings.truckTools[truckId]||[]).filter(x=>x.id!==id);
        saveDB(db);
        renderSettings();
      };
    });
  }
}



/* =====================
   Supabase bridge: Requests + Out of Stock (minimal)
===================== */
let _sb = null;
function getSupabase(){
  if(_sb) return _sb;
  const url = window.SUPABASE_URL;
  const key = window.SUPABASE_ANON_KEY;
  if(!url || !key || !window.supabase) return null;
  _sb = window.supabase.createClient(url, key);
  return _sb;
}
function toast(msg){
  if(window.UI && typeof UI.toast==="function") UI.toast(msg);
  else alert(msg);
}
let CLOUD = { requests: [], oos: [] };
let RESOLVE = { kind:null, id:null, label:null };

async function cloudFetchRequests(){
  const sb = getSupabase();
  if(!sb){ toast("Supabase not configured yet (Requests)."); return []; }
  const org = window.SUPABASE_ORG_ID || "pracht";
  const { data, error } = await sb.from("requests").select("*").eq("org_id", org).order("created_at", {ascending:false});
  if(error){ console.error(error); toast("Cloud pull failed (Requests)."); return []; }
  CLOUD.requests = data || [];
  document.getElementById("pillRequests").textContent = String(CLOUD.requests.length);
  return CLOUD.requests;
}
async function cloudFetchOOS(){
  const sb = getSupabase();
  if(!sb){ toast("Supabase not configured yet (Out of Stock)."); return []; }
  const org = window.SUPABASE_ORG_ID || "pracht";
  const { data, error } = await sb.from("oos_events").select("*").eq("org_id", org).order("noted_at", {ascending:false});
  if(error){ console.error(error); toast("Cloud pull failed (Out of Stock)."); return []; }
  CLOUD.oos = data || [];
  document.getElementById("pillOOS").textContent = String(CLOUD.oos.length);
  return CLOUD.oos;
}

function _filter(list){
  const q = (document.getElementById("q").value||"").trim().toLowerCase();
  if(!q) return list;
  return list.filter(x=>JSON.stringify(x).toLowerCase().includes(q));
}

function renderRequests(){
  const wrap = document.getElementById("requestPills");
  const empty = document.getElementById("requestsEmpty");
  wrap.innerHTML = "";
  const items = _filter(CLOUD.requests||[]);
  empty.style.display = items.length ? "none" : "block";

  items.forEach(r=>{
    const el = document.createElement("div");
    el.className = "pill";
    const title = r.title || r.type || "Request";
    const sub = [r.truck_id, r.sub].filter(Boolean).join(" â€¢ ");
    const details = r.details || "";
    el.innerHTML = `
      <div style="font-weight:700">${escapeHtml(title)}</div>
      <div class="sub">${escapeHtml(sub)}</div>
      ${details ? `<div class="sub" style="margin-top:6px">${escapeHtml(details)}</div>` : ""}
    `;
    el.onclick = ()=>{
      RESOLVE = { kind:"request", id:r.id, label:title };
      document.getElementById("resolveTitle").textContent = "Resolve Request";
      document.getElementById("resolveSub").textContent = "Delete: " + title;
      UI.openModal("modalResolve");
    };
    wrap.appendChild(el);
  });
}

function renderOOS(){
  const wrap = document.getElementById("oosPills");
  const empty = document.getElementById("oosEmpty");
  wrap.innerHTML = "";
  const items = _filter(CLOUD.oos||[]);
  empty.style.display = items.length ? "none" : "block";

  items.forEach(o=>{
    const el = document.createElement("div");
    el.className = "pill";
    const part = o.part_name || o.pn || "Part";
    const sub = [o.truck_id, (o.noted_at ? new Date(o.noted_at).toLocaleString() : "")].filter(Boolean).join(" â€¢ ");
    const note = o.note || "";
    el.innerHTML = `
      <div style="font-weight:700">${escapeHtml(part)}</div>
      <div class="sub">${escapeHtml(sub)}</div>
      ${note ? `<div class="sub" style="margin-top:6px">${escapeHtml(note)}</div>` : ""}
    `;
    el.onclick = ()=>{
      RESOLVE = { kind:"oos", id:o.id, label:part };
      document.getElementById("resolveTitle").textContent = "Resolve Out of Stock";
      document.getElementById("resolveSub").textContent = "Delete flag: " + part;
      UI.openModal("modalResolve");
    };
    wrap.appendChild(el);
  });
}

async function resolveCurrent(){
  const sb = getSupabase();
  if(!sb){ toast("Supabase not configured."); return; }
  if(!RESOLVE.kind) return;

  if(RESOLVE.kind==="request"){
    const { error } = await sb.from("requests").delete().eq("id", RESOLVE.id);
    if(error){ console.error(error); toast("Resolve failed."); return; }
    CLOUD.requests = (CLOUD.requests||[]).filter(x=>x.id!==RESOLVE.id);
    document.getElementById("pillRequests").textContent = String(CLOUD.requests.length);
    renderRequests();
  } else if(RESOLVE.kind==="oos"){
    const { error } = await sb.from("oos_events").delete().eq("id", RESOLVE.id);
    if(error){ console.error(error); toast("Resolve failed."); return; }
    CLOUD.oos = (CLOUD.oos||[]).filter(x=>String(x.id)!==String(RESOLVE.id));
    document.getElementById("pillOOS").textContent = String(CLOUD.oos.length);
    renderOOS();
  }

  UI.closeModal("modalResolve");
  toast("Resolved.");
}


/* =====================
   SearchDropdown (type-to-search select)
===================== */
class SearchDropdown{
  constructor(rootEl, { placeholder="Selectâ€¦", onChange=null } = {}){
    this.root = rootEl;
    this.btn = rootEl.querySelector('[data-role="toggle"]');
    this.pop = rootEl.querySelector('[data-role="pop"]');
    this.search = rootEl.querySelector('[data-role="search"]');
    this.list = rootEl.querySelector('[data-role="list"]');
    this.valueEl = rootEl.querySelector('[data-role="value"]');
    this.textEl = rootEl.querySelector('[data-role="selectedText"]');
    this.placeholder = placeholder;
    this.onChange = onChange;
    this.items = [];

    if(this.textEl) this.textEl.textContent = placeholder;

    this.btn?.addEventListener("click", ()=>this.toggle());
    this.search?.addEventListener("input", ()=>this.render());

    document.addEventListener("click",(e)=>{ if(!this.root.contains(e.target)) this.close(); });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") this.close(); });
  }

  setItems(items){
    this.items = Array.isArray(items) ? items : [];
    if(this.search) this.search.value = "";
    this.render();
  }

  get value(){ return this.valueEl?.value || ""; }

  clear(){
    if(this.valueEl) this.valueEl.value = "";
    if(this.textEl) this.textEl.textContent = this.placeholder;
    if(this.search) this.search.value = "";
    this.render();
    this.onChange?.({ id:"", label:"" });
  }

  open(){
    if(this.pop) this.pop.hidden = false;
    this.search?.focus();
    this.render();
  }
  close(){ if(this.pop) this.pop.hidden = true; }
  toggle(){ (this.pop?.hidden ?? true) ? this.open() : this.close(); }

  render(){
    if(!this.list) return;
    const q = (this.search?.value || "").trim().toLowerCase();
    const filtered = !q ? this.items : this.items.filter(it=>{
      const label = (it.label||"").toLowerCase();
      const sub = (it.sub||"").toLowerCase();
      const id = (it.id||"").toLowerCase();
      return label.includes(q) || sub.includes(q) || id.includes(q);
    });

    this.list.innerHTML = "";
    if(!filtered.length){
      const empty = document.createElement("div");
      empty.className = "sd-empty";
      empty.textContent = "No matches.";
      this.list.appendChild(empty);
      return;
    }

    filtered.forEach(it=>{
      const row = document.createElement("div");
      row.className = "sd-item";
      row.innerHTML = `
        <div style="min-width:0">
          <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHTML(it.label||"")}</div>
          ${it.sub ? `<small>${escapeHTML(it.sub)}</small>` : ``}
        </div>
        <small>${escapeHTML(it.right||"")}</small>
      `;
      row.addEventListener("click", ()=>{
        if(this.valueEl) this.valueEl.value = it.id || "";
        if(this.textEl) this.textEl.textContent = it.label || this.placeholder;
        this.close();
        this.onChange?.({ id: it.id || "", label: it.label || "", item: it });
      });
      this.list.appendChild(row);
    });
  }
}

function escapeHTML(s){return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");}

/* =====================
   Clock + master render
===================== */
function renderClock(){
  const el = document.getElementById("clock");
  const d = new Date();
  el.textContent = d.toLocaleString(undefined, {weekday:"short", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
}

function renderAll(){
  renderClock();
  renderStatusList();

  if(state.view==="jobs"){
    renderKPIs();
    renderJobsTable();
  } else if(state.view==="customers"){
    renderCustomersList();
  } else if(state.view==="customerFile"){
    renderCustomerFile();
  } else if(state.view==="fieldFile"){
    renderFieldFile();
  } else if(state.view==="requests"){
    renderRequests();
  } else if(state.view==="oos"){
    renderOOS();
  }
}

/* =====================
   Wire up UI
===================== */
document.getElementById("btnMenu").onclick = ()=>UI.openModal("modalMenu");
document.getElementById("btnHome").onclick = ()=>{
  state.filterStatus = "open";
  setView("jobs");
};


// Requests / Out-of-Stock (section views)
document.getElementById("btnRequests").onclick = async ()=>{
  setView("requests");
  await cloudFetchRequests();
  renderAll();
};
document.getElementById("btnOOS").onclick = async ()=>{
  setView("oos");
  await cloudFetchOOS();
  renderAll();
};
document.getElementById("btnReqRefresh").onclick = async ()=>{ await cloudFetchRequests(); renderAll(); };
document.getElementById("btnOOSRefresh").onclick = async ()=>{ await cloudFetchOOS(); renderAll(); };

document.getElementById("btnResolveCancel").onclick = ()=>UI.closeModal("modalResolve");
document.getElementById("btnResolveConfirm").onclick = resolveCurrent;

document.getElementById("menuCustomers").onclick = ()=>{
  UI.closeModal("modalMenu");
  state.selectedCustomerId = null;
  state.selectedFieldId = null;
  setView("customers");
};
document.getElementById("menuExport").onclick = ()=>{ UI.closeModal("modalMenu"); exportJSON(); };
document.getElementById("menuImport").onclick = ()=>{
  UI.closeModal("modalMenu");
  document.getElementById("importText").value = "";
  document.getElementById("impCustomers").checked = true;
  document.getElementById("impFields").checked = true;
  document.getElementById("impTruckStock").checked = true;
  document.getElementById("impTruckTools").checked = true;
  UI.openModal("modalImport");
};
document.getElementById("menuSettings").onclick = ()=>{
  UI.closeModal("modalMenu");
  renderSettings();
  UI.openModal("modalSettings");
};


document.getElementById("btnCreateJob").onclick = async ()=>{
  const sb = (getSupabase ? getSupabase() : (window.sb || null));
  if(!sb){ UI.toast("Supabase client not ready."); return; }
  const org = window.SUPABASE_ORG_ID || "pracht";

  // Clear inputs
 const descEl = document.getElementById("jobDescription");
if (descEl) descEl.value = "";

  const notesEl = document.getElementById("jobNotes");
if (notesEl) notesEl.value = "";

  document.getElementById("jobCustomer") && (document.getElementById("jobCustomer").value = "");
  document.getElementById("jobField") && (document.getElementById("jobField").value = "");

  // Load reference lists from Supabase (source of truth)
  const [custQ, typeQ, truckQ] = await Promise.all([
    sb.from("customers").select("customer_id,name,phone").eq("org_id", org).order("name",{ascending:true}),
    sb.from("job_types").select("job_type_id,name,active").eq("org_id", org).eq("active", true).order("name",{ascending:true}),
    sb.from("trucks").select("truck_id,name,active").eq("org_id", org).eq("active", true).order("name",{ascending:true})
  ]);

  if(custQ.error){ console.error(custQ.error); UI.toast("Couldn't load customers."); return; }
  if(typeQ.error){ console.error(typeQ.error); UI.toast("Couldn't load job types."); return; }
  if(truckQ.error){ console.warn("trucks load error:", truckQ.error); }

  state._jobCreate = state._jobCreate || {};
  state._jobCreate.customers = custQ.data || [];
  state._jobCreate.jobTypes = typeQ.data || [];
  state._jobCreate.trucks = (truckQ.data || []);
  state._jobCreate.fields = [];

  // Build / refresh dropdown instances
  if(!state._jobCreate.customerDD){
    state._jobCreate.customerDD = new SearchDropdown(document.getElementById("jobCustomerSD"),{
      placeholder: "Select a customerâ€¦",
      onChange: async ({ id })=>{
        // reset field whenever customer changes
        state._jobCreate.fieldDD?.clear();
        await refreshJobFieldsForCustomer(id);
      }
    });
  }
  if(!state._jobCreate.fieldDD){
    state._jobCreate.fieldDD = new SearchDropdown(document.getElementById("jobFieldSD"),{
      placeholder: "Select a fieldâ€¦",
      onChange: ()=>{}
    });
  }

  // Load customer items
  state._jobCreate.customerDD.setItems(
    (state._jobCreate.customers||[]).map(c=>({
      id: c.customer_id,
      label: c.name || "(Unnamed)",
      sub: c.phone || "",
      right: String(c.customer_id||"").slice(-6).toUpperCase()
    }))
  );

  // Default select none (force user pick)
  state._jobCreate.customerDD.clear();
  state._jobCreate.fieldDD.clear();

  // Job Type (plain select from Supabase)
  const jtSel = document.getElementById("jobType");
  if(jtSel){
    jtSel.innerHTML = "";
    (state._jobCreate.jobTypes||[]).forEach(jt=>{
      const opt = document.createElement("option");
      opt.value = jt.job_type_id;
      opt.textContent = jt.name || jt.job_type_id;
      jtSel.appendChild(opt);
    });
    if(jtSel.options.length) jtSel.selectedIndex = 0;
  }

  // Trucks (optional) â€” auto-tag from active truck selection (URL param or storage)
  const trSel = document.getElementById("jobTruck");
  if(trSel){
    trSel.innerHTML = "";
    const optNone = document.createElement("option");
    optNone.value = "";
    optNone.textContent = "(Auto / not set)";
    trSel.appendChild(optNone);

    (state._jobCreate.trucks||[]).forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t.truck_id;
      opt.textContent = t.name || t.truck_id;
      trSel.appendChild(opt);
    });

    const url = new URL(location.href);
    const activeTruckId = url.searchParams.get("truck_id") || url.searchParams.get("truck") || localStorage.getItem("ACTIVE_TRUCK_ID") || "";
    if(activeTruckId) trSel.value = activeTruckId;
  }

  updateJobNumberPreview();
  UI.openModal("modalJob");
};


document.getElementById("jobCustomer").addEventListener("change", (e)=>{
  fillFieldSelect("jobField", e.target.value);
});


async function refreshJobFieldsForCustomer(customerId){
  const sb = (getSupabase ? getSupabase() : (window.sb || null));
  if(!sb) return;
  const org = window.SUPABASE_ORG_ID || "pracht";
  if(!customerId){
    state._jobCreate.fields = [];
    state._jobCreate.fieldDD?.setItems([]);
    return;
  }

  const { data, error } = await sb
    .from("fields")
    .select("field_id,brand,serial_number,tower_count,lat,lng")
    .eq("org_id", org)
    .eq("customer_id", customerId)
    .order("created_at",{ascending:false});

  if(error){ console.error(error); UI.toast("Couldn't load fields for that customer."); return; }

  state._jobCreate.fields = data || [];
  state._jobCreate.fieldDD?.setItems(
    (data||[]).map(f=>{
      const label = (f.brand && f.serial_number) ? `${f.brand} â€¢ ${f.serial_number}` :
                    (f.brand ? `${f.brand} â€¢ ${String(f.field_id||"").slice(-6).toUpperCase()}` :
                    `Field â€¢ ${String(f.field_id||"").slice(-6).toUpperCase()}`);
      const sub = f.tower_count ? `Towers: ${f.tower_count}` : "";
      return { id: f.field_id, label, sub, right: String(f.field_id||"").slice(-6).toUpperCase() };
    })
  );
}


document.getElementById("btnSaveJob").onclick = async ()=>{
 const { error: jobErr } = await sb.from("jobs").insert([payload]);
  const customerId = document.getElementById("jobCustomer")?.value || "";
  const fieldId = document.getElementById("jobField")?.value || "";
  const jobTypeId = document.getElementById("jobType")?.value || "";
  const jobTypeName = document.getElementById("jobType")?.selectedOptions?.[0]?.textContent || jobTypeId;
  const description = (document.getElementById("jobDescription")?.value || "").trim();
  const notesOffice = document.getElementById("jobNotes")?.value || "";

  if(!customerId){ UI.toast("Pick a customer."); return; }
  if(!fieldId){ UI.toast("Pick a field."); return; }
  if(!jobTypeId){ UI.toast("Pick a job type."); return; }

  // Job Title is automatic (example: PI1000)
  const jobCode = jobTypePrefix(jobTypeId, jobTypeName) + pad4(db.meta.jobSeq++);
  const title = jobCode;

  // Keep local view behavior (offline-friendly)
  addJob({customerId, fieldId, type: jobTypeName, jobCode, title, description, notesOffice});
  updateJobNumberPreview();
  UI.closeModal("modalJob");
  state.filterStatus = "open";
  setView("jobs");

  // SUPABASE INSERT (source of truth)
  try{
    const sb = (getSupabase ? getSupabase() : (window.sb || null));
    if(!sb){ console.warn("Supabase client not ready."); return; }

    const t = nowISO();
    const url = new URL(location.href);
    const activeTruckId = url.searchParams.get("truck_id") || url.searchParams.get("truck") || localStorage.getItem("ACTIVE_TRUCK_ID") || "";
    const truckId = (document.getElementById("jobTruck")?.value || activeTruckId || null) || null;

    const payload = {
      org_id: window.SUPABASE_ORG_ID || "pracht",
      job_id: uid("job"),
      customer_id: customerId,
      field_id: fieldId,
      truck_id: truckId,
      assigned_tech_id: null,
      job_type_id: jobTypeId,
      status: "open",
      description: description || "",
      created_at: t,
      updated_at: t
    };

    
    if(error){ console.error(error); UI.toast("Supabase insert failed (FK mismatch)."); }
  }catch(err){
    console.error(err);
  }
};



if(jobErr) console.error("jobs insert error:", jobErr);
else console.log("job saved to supabase:", job_id);


    console.error("jobs insert exception:", err);
  
};

document.getElementById("btnAddCustomer").onclick = ()=>{
  document.getElementById("custName").value = "";
  document.getElementById("custPhone").value = "";
  document.getElementById("custEmail").value = "";
  document.getElementById("custPref").value = "";
  document.getElementById("custAddr").value = "";
  document.getElementById("copyToBilling").checked = true;

  attachPhoneFormatter(document.getElementById("custPhone"));
  UI.openModal("modalAddCustomer");
};

document.getElementById("btnDoAddCustomer").onclick = ()=>{
  const name = (document.getElementById("custName").value || "").trim();
  if(!name){ UI.toast("Customer name required."); return; }

  const customer = {
    name,
    phone: formatPhone(document.getElementById("custPhone").value || ""),
    email: (document.getElementById("custEmail").value || "").trim(),
    pref: document.getElementById("custPref").value || "",
    address: (document.getElementById("custAddr").value || "").trim(),
  };

  const copy = !!document.getElementById("copyToBilling").checked;
  const billing = copy
    ? { name: customer.name, phone: customer.phone, email: customer.email, address: customer.address }
    : { name:"", phone:"", email:"", address:"" };

  addCustomer({customer, billing});
  UI.closeModal("modalAddCustomer");
  renderAll();
};

document.getElementById("btnCustomerEdit").onclick = ()=>{
  state.customerEdit = !state.customerEdit;
  document.getElementById("btnCustomerEdit").textContent = state.customerEdit ? "Cancel Edit" : "Edit";
  renderCustomerFile();
};

document.getElementById("btnCustomerAddField").onclick = ()=>{
  const custId = state.selectedCustomerId;
  if(!custId) return;
  fillCustomerSelect("fieldCustomer");
  document.getElementById("fieldCustomer").value = custId;

  document.getElementById("fieldName").value = "";
  
document.getElementById("fieldPowerSource").value = "";
document.getElementById("fieldSerial").value = "";
  document.getElementById("fieldTowerCount").value = "";
  document.getElementById("fieldLat").value = "";
  document.getElementById("fieldLng").value = "";
  document.getElementById("fieldSprinklerPkg").value = "";
  document.getElementById("fieldHasTelemetry").checked = false;
  document.getElementById("fieldTelemetryMake").value = "";
  document.getElementById("fieldTelemetrySerial").value = "";
  document.getElementById("fieldNotes").value = "";
  document.getElementById("telemetryMakeWrap").style.display = "none";
  document.getElementById("telemetrySerialWrap").style.display = "none";
  UI.openModal("modalAddField");
};

document.getElementById("btnCustomerDelete").onclick = ()=>{
  const cid = state.selectedCustomerId;
  if(!cid) return;
  state.deleteArmedCustomerId = (state.deleteArmedCustomerId===cid) ? null : cid;
  renderCustomerFile();
};
document.getElementById("btnCustomerDeleteYes").onclick = ()=>{
  const cid = state.selectedCustomerId;
  if(!cid) return;
  deleteCustomer(cid);
  state.selectedCustomerId = null;
  state.deleteArmedCustomerId = null;
  UI.toast("Customer deleted.");
  setView("customers");
};
document.getElementById("btnCustomerDeleteNo").onclick = ()=>{
  state.deleteArmedCustomerId = null;
  renderCustomerFile();
};

document.getElementById("btnBackToCustomers").onclick = ()=>{
  state.selectedCustomerId = null;
  state.customerEdit = false;
  state.deleteArmedCustomerId = null;
  setView("customers");
};

document.getElementById("btnFieldEdit").onclick = ()=>{
  state.fieldEdit = !state.fieldEdit;
  document.getElementById("btnFieldEdit").textContent = state.fieldEdit ? "Cancel Edit" : "Edit";
  renderFieldFile();
};

document.getElementById("btnFieldDelete").onclick = ()=>{
  const fid = state.selectedFieldId;
  if(!fid) return;
  state.deleteArmedFieldId = (state.deleteArmedFieldId===fid) ? null : fid;
  renderFieldFile();
};
document.getElementById("btnFieldDeleteYes").onclick = ()=>{
  const fid = state.selectedFieldId;
  const cid = state.selectedCustomerId;
  if(!fid) return;
  deleteField(fid);
  state.selectedFieldId = null;
  state.deleteArmedFieldId = null;
  UI.toast("Field deleted.");
  if(cid) setView("customerFile"); else setView("customers");
};
document.getElementById("btnFieldDeleteNo").onclick = ()=>{
  state.deleteArmedFieldId = null;
  renderFieldFile();
};

document.getElementById("btnBackToCustomerFile").onclick = ()=>{
  state.selectedFieldId = null;
  state.fieldEdit = false;
  state.deleteArmedFieldId = null;
  setView("customerFile");
};

document.getElementById("fieldHasTelemetry").addEventListener("change", (e)=>{
  const on = e.target.checked;
  document.getElementById("telemetryMakeWrap").style.display = on ? "block" : "none";
  document.getElementById("telemetrySerialWrap").style.display = on ? "block" : "none";
});

// Satellite buttons
document.getElementById("btnOpenSatellite").onclick = ()=>{
  window.open("https://www.google.com/maps/@41,-99,15z/data=!3m1!1e3", "_blank");
};
document.getElementById("btnCenterSatellite").onclick = ()=>{
  const lat = safeNum(document.getElementById("fieldLat").value) ?? 41;
  const lng = safeNum(document.getElementById("fieldLng").value) ?? -99;
  window.open(`https://www.google.com/maps/@${lat},${lng},17z/data=!3m1!1e3`, "_blank");
};

document.getElementById("btnDoAddField").onclick = ()=>{
  const customerId = document.getElementById("fieldCustomer").value;
  const name = (document.getElementById("fieldName").value || "").trim();
  if(!customerId){ UI.toast("Pick a customer."); return; }
  if(!name){ UI.toast("Field name required."); return; }

  const hasTelemetry = !!document.getElementById("fieldHasTelemetry").checked;

  addField({
    customerId,
    name,
    brand: document.getElementById("fieldBrand").value || "",
    powerSource: document.getElementById("fieldPowerSource").value || "",
    serialNumber: (document.getElementById("fieldSerial").value || "").trim(),
    towerCount: safeNum(document.getElementById("fieldTowerCount").value),
    lat: safeNum(document.getElementById("fieldLat").value),
    lng: safeNum(document.getElementById("fieldLng").value),
    sprinklerPackageNumber: (document.getElementById("fieldSprinklerPkg").value || "").trim(),
    hasTelemetry,
    telemetryMake: hasTelemetry ? (document.getElementById("fieldTelemetryMake").value || "").trim() : "",
    telemetrySerial: hasTelemetry ? (document.getElementById("fieldTelemetrySerial").value || "").trim() : "",
    notes: document.getElementById("fieldNotes").value || ""
  });

  UI.closeModal("modalAddField");
  renderAll();
};

// Import selected
document.getElementById("btnDoImport").onclick = ()=>{
  const text = document.getElementById("importText").value || "";
  const opts = {
    customers: document.getElementById("impCustomers").checked,
    fields: document.getElementById("impFields").checked,
    truckStock: document.getElementById("impTruckStock").checked,
    truckTools: document.getElementById("impTruckTools").checked,
  };

  if(!opts.customers && !opts.fields && !opts.truckStock && !opts.truckTools){
    UI.toast("Pick at least one thing to import.");
    return;
  }

  try{
    partialImportFromJSON(text, opts);
    UI.closeModal("modalImport");
    UI.toast("Imported selected sections successfully.");
    renderAll();
  }catch(e){
    UI.toast("Import failed: " + e.message);
  }
};

// Search/sort
document.getElementById("q").addEventListener("input", ()=>renderAll());
document.getElementById("sort").addEventListener("change", ()=>{
  if(state.view==="customers") state.customersSort = document.getElementById("sort").value;
  renderAll();
});

// Data tools
document.getElementById("btnLoadPre").onclick = ()=>{
  db = buildPreload();
  saveDB(db);
  state.filterStatus = "open";
  state.selectedCustomerId = null;
  state.selectedFieldId = null;
  ensureTruckSelections();
  UI.toast("Preload data loaded.");
  setView("jobs");
};
document.getElementById("btnWipe").onclick = ()=>{
  const ok = confirm("Wipe ALL local data for this dashboard? This cannot be undone.");
  if(!ok) return;
  db = defaultDB();
  saveDB(db);
  state.filterStatus = "open";
  state.selectedCustomerId = null;
  state.selectedFieldId = null;
  ensureTruckSelections();
  UI.toast("Wiped.");
  setView("jobs");
};

// Initial
setInterval(renderClock, 15000);
ensureTruckSelections();
setView("jobs");


// Map View button (Open Jobs)
const btnMapOpenJobs = document.getElementById("btnMapOpenJobs");
if(btnMapOpenJobs){
  btnMapOpenJobs.addEventListener("click", openMapForOpenJobs);
}

/* =========================
   CSV Import Center (keeps original look)
========================= */

const CSV_IMPORT_META = {
  customers_fields: {
    label: "Customers (with Fields)",
    hint: "One CSV handles both Customers and Fields. Use IsField=No for customers and IsField=Yes for fields. Fields link to ParentCustomer by name. PowerSource is field-only.",
    templateName: "customers_fields_template.csv",
    template: `IsField,CustomerName,CustomerPhone,CustomerEmail,CustomerPref,FieldName,Brand,PowerSource,Lat,Lon,ParentCustomer
No,Acme Farms,555-111-2222,office@acme.com,Text,,,,,,
Yes,,,,,North Pivot,Reinke,Electric Utility,41.1234,-98.1234,Acme Farms`
  },
  jobs: {
    label: "Jobs",
    hint: "Optional. Links by CustomerName + FieldName. Status can be open/paused/closed.",
    templateName: "jobs_template.csv",
    template: `JobNumber,CustomerName,FieldName,JobType,Description,Status,CreatedAtISO
1001,Acme Farms,North Pivot,General Repair,"No power at panel",open,2025-12-30T10:00:00Z`
  },
  products: {
    label: "Products (parts list)",
    hint: "Parts catalog only. Columns: PartNumber, Description. Kits are built inside dashboard (not imported).",
    templateName: "products_template.csv",
    template: `PartNumber,Description
R-1234,40:1 Drive Motor
R-5678,End Gun Solenoid`
  },
  truck_stock_master: {
    label: "Truck Inventory Master (Min Stock)",
    hint: "Select a truck in this import screen, then upload a CSV with PartNumber + MinQty. Existing items are skipped (no overwrite). Invalid MinQty becomes 0.",
    templateName: "truck_stock_master_template.csv",
    template: `PartNumber,MinQty
R-1234,2
R-5678,3`
  },
  truck_tools: {
    label: "Truck Tools",
    hint: "Select a truck in this import screen, then upload a CSV with ToolName + Qty. Qty forced to minimum 1. Existing tools are skipped (no overwrite).",
    templateName: "truck_tools_template.csv",
    template: `ToolName,Qty
Fluke Multimeter,1
12V Impact,1
Insulated Screwdriver Set,2`
  }
};

let _csvImport = { type:"customers_fields", headers:[], rows:[] };

function downloadTextFile(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function parseCsv(text){
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
        inQuotes=false; i++; continue;
      }
      field += c; i++; continue;
    }else{
      if(c === '"'){ inQuotes=true; i++; continue; }
      if(c === ','){ row.push(field); field=""; i++; continue; }
      if(c === '\n'){
        row.push(field); field="";
        row = row.map(x => (x||"").replace(/\r$/,""));
        if(row.some(v => String(v).trim()!=="")) rows.push(row);
        row=[]; i++; continue;
      }
      field += c; i++; continue;
    }
  }
  row.push(field);
  row = row.map(x => (x||"").replace(/\r$/,""));
  if(row.some(v => String(v).trim()!=="")) rows.push(row);
  if(!rows.length) return {headers:[], rows:[]};
  const headers = rows[0].map(h=>String(h||"").trim());
  const body = rows.slice(1).map(r=>{
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (r[idx] ?? "").trim());
    return obj;
  });
  return {headers, rows: body};
}

function getTruckList(){
  return (db?.settings?.trucks || []).map(t => ({ id: String(t.id), name: String(t.name || t.id) }));
}

function populateTruckDropdown(){
  const sel = document.getElementById("impTruckSelect");
  if(!sel) return;
  const trucks = getTruckList();
  sel.innerHTML = trucks.map(t => `<option value="${escapeAttr(t.id)}">${escapeHtml(t.name)} (ID ${escapeHtml(t.id)})</option>`).join("");
}

function setCsvHint(){
  const type = document.getElementById("impCsvType").value;
  const meta = CSV_IMPORT_META[type];
  document.getElementById("impCsvHint").innerHTML = `<b>${meta.label}</b><br>${meta.hint}`;
}

function toggleTruckRequirement(){
  const type = document.getElementById("impCsvType").value;
  const needsTruck = (type==="truck_stock_master" || type==="truck_tools");
  const wrap = document.getElementById("impTruckWrap");
  const pickBtn = document.getElementById("btnCsvPick");
  if(needsTruck){
    wrap.style.display = "";
    populateTruckDropdown();
    pickBtn.disabled = !String(document.getElementById("impTruckSelect").value||"").trim();
  }else{
    wrap.style.display = "none";
    pickBtn.disabled = false;
  }
}

function resetCsvPreview(){
  _csvImport = { type: document.getElementById("impCsvType").value, headers:[], rows:[] };
  document.getElementById("csvPreviewPanel").style.display = "none";
  document.getElementById("csvPreviewTable").innerHTML = "";
  document.getElementById("csvWarnings").textContent = "";
  document.getElementById("btnCsvImport").disabled = true;
}

function showCsvPreview(headers, rows){
  const panel = document.getElementById("csvPreviewPanel");
  const table = document.getElementById("csvPreviewTable");
  const help = document.getElementById("csvPreviewHelp");
  panel.style.display = "block";

  const type = _csvImport.type;
  const needsTruck = (type==="truck_stock_master" || type==="truck_tools");
  let truckLine = "";
  if(needsTruck){
    const tid = String(document.getElementById("impTruckSelect").value||"");
    const t = getTruckList().find(x=>x.id===tid);
    if(t) truckLine = `<div style="margin-bottom:6px;"><b>Importing for Truck:</b> ${escapeHtml(t.name)} (ID ${escapeHtml(t.id)})</div>`;
  }

  const max = Math.min(rows.length, 25);
  help.innerHTML = `${truckLine}Showing first ${max} row(s) of ${rows.length}.`;

  const th = `<tr>${headers.map(h=>`<th>${escapeHtml(h)}</th>`).join("")}</tr>`;
  const tb = rows.slice(0,max).map(r=>`<tr>${headers.map(h=>`<td>${escapeHtml(r[h]||"")}</td>`).join("")}</tr>`).join("");
  table.innerHTML = th + tb;

  document.getElementById("btnCsvImport").disabled = rows.length===0;
}

function pickCsvFile(){
  const type = document.getElementById("impCsvType").value;
  const needsTruck = (type==="truck_stock_master" || type==="truck_tools");
  if(needsTruck && !String(document.getElementById("impTruckSelect").value||"").trim()){
    return UI.toast("Select a truck first.");
  }
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = ".csv,text/csv";
  inp.onchange = ()=>{
    const file = inp.files && inp.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const parsed = parseCsv(String(reader.result||""));
      _csvImport.type = document.getElementById("impCsvType").value;
      _csvImport.headers = parsed.headers;
      _csvImport.rows = parsed.rows;
      showCsvPreview(parsed.headers, parsed.rows);
      validateCsvBeforeImport();
    };
    reader.readAsText(file);
  };
  inp.click();
}

function validateCsvBeforeImport(){
  const warnEl = document.getElementById("csvWarnings");
  warnEl.textContent = "";
  const type = _csvImport.type;
  const rows = _csvImport.rows;
  if(!rows.length) return;

  const requiredByType = {
    customers_fields: ["IsField","CustomerName","ParentCustomer","FieldName"],
    jobs: ["CustomerName","FieldName","JobType"],
    products: ["PartNumber","Description"],
    truck_stock_master: ["PartNumber","MinQty"],
    truck_tools: ["ToolName","Qty"]
  };
  const required = requiredByType[type] || [];
  const missing = required.filter(col => !_csvImport.headers.includes(col));
  if(missing.length){
    warnEl.textContent = `Missing required columns: ${missing.join(", ")}. Download the template for the correct headers.`;
    document.getElementById("btnCsvImport").disabled = true;
    return;
  }
  document.getElementById("btnCsvImport").disabled = false;
}

function doCsvImport(){
  const warnEl = document.getElementById("csvWarnings");
  warnEl.textContent = "";
  try{
    if(_csvImport.type==="products") importProductsCsv(_csvImport.rows);
    else if(_csvImport.type==="customers_fields") importCustomersFieldsCsv(_csvImport.rows);
    else if(_csvImport.type==="jobs") importJobsCsv(_csvImport.rows);
    else if(_csvImport.type==="truck_stock_master") importMasterStockCsv(_csvImport.rows);
    else if(_csvImport.type==="truck_tools") importTruckToolsCsv(_csvImport.rows);
    else throw new Error("Unknown CSV import type.");

    saveDB(db);
    UI.toast("CSV import complete.");
    resetCsvPreview();
    UI.closeModal("modalImport");
    renderSettings();
    renderView(state.view || "home");
  }catch(e){
    warnEl.textContent = "Import failed: " + e.message;
  }
}

// CSV import implementations (minimal + matches locked rules)
function importProductsCsv(rows){
  db.settings.products = db.settings.products || [];
  const byPN = new Map(db.settings.products.map(p=>[normalizeName(p.partNumber), p]));
  let mode = "update";
  const dupCount = rows.filter(r => byPN.has(normalizeName(r.PartNumber))).length;
  if(dupCount){
    mode = confirm(`${dupCount} product(s) already exist.\n\nOK = Update duplicates\nCancel = Skip duplicates`) ? "update" : "skip";
  }
  rows.forEach(r=>{
    const pn = String(r.PartNumber||"").trim();
    const desc = String(r.Description||"").trim();
    if(!pn) return;
    const key = normalizeName(pn);
    const existing = byPN.get(key);
    if(existing){
      if(mode==="update"){ existing.partNumber = pn; existing.description = desc; }
      return;
    }
    const item = { id: uid("prod"), partNumber: pn, description: desc };
    db.settings.products.push(item);
    byPN.set(key, item);
  });
}

function importCustomersFieldsCsv(rows){
  db.customers = db.customers || [];
  db.fields = db.fields || [];

  const custByName = new Map(db.customers.map(c=>[normalizeName(c.name), c]));
  const fieldByKey = new Map(db.fields.map(f=>[normalizeName((f.customerName||"")+"|"+(f.name||"")), f]));

  const dupCount =
    rows.filter(r => String(r.IsField||"").trim().toLowerCase()!=="yes" && custByName.has(normalizeName(r.CustomerName))).length +
    rows.filter(r => String(r.IsField||"").trim().toLowerCase()==="yes" && fieldByKey.has(normalizeName((r.ParentCustomer||"")+"|"+(r.FieldName||"")))).length;

  const mode = dupCount ? (confirm(`${dupCount} duplicate(s) detected.\n\nOK = Update\nCancel = Skip`) ? "update" : "skip") : "update";

  // Customers
  rows.forEach(r=>{
    const isField = String(r.IsField||"").trim().toLowerCase()==="yes";
    if(isField) return;
    const name = String(r.CustomerName||"").trim();
    if(!name) return;
    const key = normalizeName(name);
    const existing = custByName.get(key);
    const patch = {
      id: existing?.id || uid("cus"),
      name,
      phone: String(r.CustomerPhone||"").trim(),
      email: String(r.CustomerEmail||"").trim(),
      pref: String(r.CustomerPref||"").trim()
    };
    if(existing){
      if(mode==="update") Object.assign(existing, patch);
    }else{
      db.customers.push(patch);
      custByName.set(key, patch);
    }
  });

  // Fields
  rows.forEach(r=>{
    const isField = String(r.IsField||"").trim().toLowerCase()==="yes";
    if(!isField) return;
    const parentName = String(r.ParentCustomer||"").trim();
    const fieldName = String(r.FieldName||"").trim();
    if(!parentName || !fieldName) return;

    const custKey = normalizeName(parentName);
    let cust = custByName.get(custKey);
    if(!cust){
      cust = { id: uid("cus"), name: parentName, phone:"", email:"", pref:"" };
      db.customers.push(cust);
      custByName.set(custKey, cust);
    }

    const key = normalizeName(parentName+"|"+fieldName);
    const existing = fieldByKey.get(key);

    const lat = String(r.Lat||"").trim();
    const lon = String(r.Lon||"").trim();
    const patch = {
      id: existing?.id || uid("fld"),
      customerId: cust.id,
      customerName: cust.name,
      name: fieldName,
      brand: String(r.Brand||"").trim(),
      powerSource: String(r.PowerSource||"").trim() || "",
      lat: lat ? Number(lat) : (existing?.lat ?? null),
      lon: lon ? Number(lon) : (existing?.lon ?? null)
    };

    if(existing){
      if(mode==="update") Object.assign(existing, patch);
    }else{
      db.fields.push(patch);
      fieldByKey.set(key, patch);
    }
  });
}

function importJobsCsv(rows){
  db.jobs = db.jobs || [];
  const existingByNum = new Map(db.jobs.filter(j=>j.jobNumber).map(j=>[normalizeName(j.jobNumber), j]));
  const dupCount = rows.filter(r=> String(r.JobNumber||"").trim() && existingByNum.has(normalizeName(r.JobNumber))).length;
  const mode = dupCount ? (confirm(`${dupCount} job(s) already exist by JobNumber.\n\nOK = Update\nCancel = Skip`) ? "update":"skip") : "update";
  rows.forEach(r=>{
    const jn = String(r.JobNumber||"").trim();
    const customerName = String(r.CustomerName||"").trim();
    const fieldName = String(r.FieldName||"").trim();
    const jobType = String(r.JobType||"").trim();
    if(!customerName || !fieldName || !jobType) return;

    const item = {
      id: uid("job"),
      jobNumber: jn || null,
      customerName,
      fieldName,
      jobType,
      description: String(r.Description||"").trim(),
      status: String(r.Status||"open").trim().toLowerCase(),
      createdAt: String(r.CreatedAtISO||nowISO()).trim(),
      updatedAt: nowISO()
    };

    if(jn){
      const ex = existingByNum.get(normalizeName(jn));
      if(ex){
        if(mode==="update") Object.assign(ex, item, {id: ex.id});
        return;
      }
    }
    db.jobs.push(item);
    if(jn) existingByNum.set(normalizeName(jn), item);
  });
}

function importMasterStockCsv(rows){
  db.settings.truckStock = db.settings.truckStock || {};
  const truckId = String(document.getElementById("impTruckSelect").value||"").trim();
  if(!truckId) throw new Error("Select a truck first.");

  db.settings.truckStock[truckId] = db.settings.truckStock[truckId] || [];
  const list = db.settings.truckStock[truckId];

  // Build products index
  db.settings.products = db.settings.products || [];
  const prodByPN = new Map(db.settings.products.map(p=>[normalizeName(p.partNumber), p]));

  // Missing parts prompt
  const unknown = new Set();
  rows.forEach(r=>{
    const pn = String(r.PartNumber||"").trim();
    if(pn && !prodByPN.has(normalizeName(pn))) unknown.add(pn);
  });
  if(unknown.size){
    const add = confirm(`Warning: ${unknown.size} part(s) are not in Products.\n\nOK = Add missing parts to Products\nCancel = Skip those rows`);
    if(add){
      unknown.forEach(pn=>{
        const key = normalizeName(pn);
        if(!prodByPN.has(key)){
          const item = { id: uid("prod"), partNumber: pn, description: "" };
          db.settings.products.push(item);
          prodByPN.set(key, item);
        }
      });
    }
  }

  let forcedCount = 0;
  let skippedExisting = 0;

  rows.forEach(r=>{
    const pn = String(r.PartNumber||"").trim();
    if(!pn) return;
    if(!prodByPN.has(normalizeName(pn))) return;

    let minQty = Number(String(r.MinQty||"").trim());
    let forced = false;
    if(!Number.isFinite(minQty) || minQty < 0){ minQty = 0; forced = true; }
    if(forced) forcedCount++;

    const exists = list.find(x=>normalizeName(x.partNumber)===normalizeName(pn));
    if(exists){ skippedExisting++; return; } // skip existing (no overwrite)

    list.push({ id: uid("min"), partNumber: pn, minQty });
  });

  if(forcedCount) UI.toast(`${forcedCount} row(s) had invalid MinQty and were auto-set to 0.`);
  if(skippedExisting) UI.toast(`${skippedExisting} existing min item(s) were skipped (no overwrite).`);
}

function importTruckToolsCsv(rows){
  db.settings.truckTools = db.settings.truckTools || {};
  const truckId = String(document.getElementById("impTruckSelect").value||"").trim();
  if(!truckId) throw new Error("Select a truck first.");

  db.settings.truckTools[truckId] = db.settings.truckTools[truckId] || [];
  const list = db.settings.truckTools[truckId];

  let forcedCount = 0;
  let skippedExisting = 0;

  rows.forEach(r=>{
    const name = String(r.ToolName||"").trim();
    if(!name) return;
    let qty = Number(String(r.Qty||"").trim());
    let forced = false;
    if(!Number.isFinite(qty) || qty < 1){ qty = 1; forced = true; }
    if(forced) forcedCount++;

    const exists = list.find(x=>normalizeName(x.name||"")===normalizeName(name));
    if(exists){ skippedExisting++; return; } // skip existing (no overwrite)

    list.push({ id: uid("tool"), name, qty });
  });

  if(forcedCount) UI.toast(`${forcedCount} tool row(s) had Qty < 1 and were auto-set to 1.`);
  if(skippedExisting) UI.toast(`${skippedExisting} existing tool(s) were skipped (no overwrite).`);
}

// Wire CSV import UI
(function(){
  const typeSel = document.getElementById("impCsvType");
  const tSel = document.getElementById("impTruckSelect");

  if(!typeSel) return;

  typeSel.onchange = ()=>{ resetCsvPreview(); setCsvHint(); toggleTruckRequirement(); };
  document.getElementById("btnCsvTemplate").onclick = ()=>{
    const type = typeSel.value;
    const meta = CSV_IMPORT_META[type];
    downloadTextFile(meta.templateName, meta.template);
  };
  document.getElementById("btnCsvPick").onclick = pickCsvFile;
  document.getElementById("btnCsvCancel").onclick = resetCsvPreview;
  document.getElementById("btnCsvImport").onclick = doCsvImport;
  if(tSel){
    tSel.onchange = ()=>{ toggleTruckRequirement(); resetCsvPreview(); };
  }

  // init
  setCsvHint();
  toggleTruckRequirement();
})();
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
</script>

<script>
  // Called from Leaflet popup button
  window.openJobFromMap = function(jobId){
    try{ UI.closeModal("modalJobsMap"); }catch(e){}
    try{ setView("jobs"); }catch(e){}
    // Open the same job info modal used by clicking a job in the dashboard
    setTimeout(()=> {
      try{ openJobDetail(jobId); }
      catch(err){
        console.error("openJobFromMap -> openJobDetail failed", err);
        try{ UI.toast("Couldn't open job info."); }catch(_){}
      }
    }, 120);
  };
</script>
</body>
</html>

