<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shelf Mapping – Inventory</title>
  <style>
    :root{
      --bg0:#070A0F;
      --bg1:#0B1020;
      --bg2:#0D1220;
      --card:rgba(18,24,38,.86);
      --card2:rgba(12,16,26,.78);
      --line:rgba(148,163,184,.14);
      --line2:rgba(148,163,184,.22);
      --text:#EAF0FF;
      --muted:rgba(226,232,240,.68);
      --accent:#5CC8FF;
      --accent2:#7C5CFF;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --chip:rgba(15,23,42,.72);
      --chip2:rgba(2,6,23,.55);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:22px;

      --cat-default:#94a3b8;
      --cat-hardware:#60a5fa;
      --cat-electrical:#a78bfa;
      --cat-plumbing:#34d399;
      --cat-paint:#fbbf24;
      --cat-safety:#fb7185;
      --cat-tools:#f97316;
      --cat-misc:#22d3ee;

      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 12% 10%, rgba(124,92,255,.18), transparent 55%),
        radial-gradient(900px 520px at 82% 16%, rgba(92,200,255,.16), transparent 60%),
        radial-gradient(900px 520px at 52% 90%, rgba(34,197,94,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 42%, var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }

    header{
      position:sticky; top:0; z-index:30;
      background:linear-gradient(180deg, rgba(7,10,15,.92), rgba(7,10,15,.70));
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--line);
      padding:12px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:220px}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 22% 24%, rgba(255,255,255,.55), transparent 55%),
        linear-gradient(135deg, rgba(92,200,255,1), rgba(124,92,255,1));
      display:grid;place-items:center;
      box-shadow: 0 10px 24px rgba(124,92,255,.22);
      font-weight:900;
      letter-spacing:.4px;
      color:#021018;
    }
    .title{line-height:1.05}
    .title b{display:block; font-size:14px}
    .title span{font-size:12px;color:var(--muted)}
    .nav{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,24,38,.85), rgba(10,14,24,.82));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      font-weight:750;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      transition: transform .08s ease, border-color .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{border-color:var(--line2); filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:
        radial-gradient(18px 18px at 22% 20%, rgba(255,255,255,.32), transparent 55%),
        linear-gradient(135deg, rgba(92,200,255,1), rgba(124,92,255,1));
      border-color:transparent;
      color:#061017;
    }
    .btn.ghost{background:transparent; box-shadow:none}
    .btn.danger{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.40); box-shadow:none}
    .btn.good{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.40); box-shadow:none}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:13px}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    main{max-width:1180px;margin:0 auto;padding:14px 14px 72px}

    .grid{display:grid; gap:12px}
    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px}
    .card{
      background:linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:14px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 200px at 15% 0%, rgba(92,200,255,.10), transparent 55%),
                  radial-gradient(600px 200px at 85% 0%, rgba(124,92,255,.10), transparent 55%);
      pointer-events:none;
    }
    .card > *{position:relative}
    .card h2,.card h3{margin:0 0 10px 0}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row.space{justify-content:space-between}
    .stack{display:flex; flex-direction:column; gap:10px}

    input, select, textarea{
      width:100%;
      background:rgba(2,6,23,.62);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    input:focus, select:focus, textarea:focus{border-color:rgba(92,200,255,.38); box-shadow:0 0 0 3px rgba(92,200,255,.12)}
    textarea{min-height:84px; resize:vertical}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    .field{display:flex; flex-direction:column; gap:6px; flex:1}
    .help{font-size:12px; color:var(--muted)}

    .chip{
      display:inline-flex; align-items:center; gap:7px;
      padding:7px 10px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(15,23,42,.75), rgba(2,6,23,.50));
      border:1px solid var(--line);
      color:var(--text);
      font-size:12px;
      font-weight:750;
      white-space:nowrap;
    }
    .chip.dot:before{
      content:"";
      width:8px;height:8px;border-radius:99px;
      background:var(--cat-default);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .chip.bad{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12)}
    .chip.good{border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12)}
    .chip.warn{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.12)}
    .chip.soft{background:rgba(148,163,184,.08)}
    .chip.click{cursor:pointer}
    .chip.click:hover{border-color:var(--line2)}

    .breadcrumb{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .sep{color:var(--muted)}

    .imgbox{
      width:100%; aspect-ratio: 16/9;
      border-radius:16px; border:1px dashed var(--line2);
      background:rgba(2,6,23,.52);
      display:grid; place-items:center; overflow:hidden;
    }
    .imgbox img{width:100%; height:100%; object-fit:cover; opacity:.98}
    .imgbox .ph{color:var(--muted); font-size:12px; padding:10px}

    .levels{display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:10px;}
    .levelbtn{
      background:rgba(2,6,23,.60);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      text-align:center;
      font-weight:900;
      transition: border-color .12s ease, transform .08s ease;
    }
    .levelbtn:hover{border-color:var(--line2)}
    .levelbtn:active{transform:translateY(1px)}
    .levelbtn.active{
      border-color:rgba(92,200,255,.55);
      box-shadow:0 0 0 3px rgba(92,200,255,.12) inset;
    }

    .bins{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:10px;
    }
    .bin{
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(2,6,23,.62);
      padding:12px;
      cursor:pointer;
      display:flex; flex-direction:column; gap:10px;
      transition: transform .08s ease, border-color .12s ease, filter .12s ease;
      overflow:hidden;
      position:relative;
    }
    .bin:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(280px 110px at 20% 0%, rgba(92,200,255,.09), transparent 55%),
                  radial-gradient(260px 100px at 80% 0%, rgba(124,92,255,.09), transparent 55%);
      pointer-events:none;
    }
    .bin > *{position:relative}
    .bin:hover{border-color:var(--line2); filter:brightness(1.04)}
    .bin:active{transform:translateY(1px)}
    .bin.empty{opacity:.72}
    .bin.oos{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.08)}
    .bin.low{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.06)}
    .bin.ok{border-color:rgba(34,197,94,.38); background:rgba(34,197,94,.06)}
    .binhead{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .binlabel{font-weight:950; letter-spacing:.2px}
    .countbig{font-size:30px; font-weight:950; letter-spacing:.2px}
    .sell{font-size:12px; color:var(--muted)}
    .thumb{
      width:100%;
      aspect-ratio: 4/3;
      border-radius:16px;
      overflow:hidden;
      background:rgba(7,10,15,.55);
      border:1px solid var(--line);
      display:grid; place-items:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover}
    .thumb .ph{color:var(--muted); font-size:12px; padding:10px}

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:920px){ .split{grid-template-columns:1fr} }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0; background:rgba(0,0,0,.60);
      display:none; align-items:center; justify-content:center; z-index:60;
      padding:14px;
    }
    .modal{
      width:min(980px,100%);
      max-height:92vh;
      overflow:auto;
      background:linear-gradient(180deg, rgba(18,24,38,.92), rgba(10,14,24,.92));
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      box-shadow: 0 24px 80px rgba(0,0,0,.65);
      position:relative;
    }
    .modal:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 200px at 15% 0%, rgba(92,200,255,.10), transparent 55%),
                  radial-gradient(600px 200px at 85% 0%, rgba(124,92,255,.10), transparent 55%);
      pointer-events:none;
      border-radius:24px;
    }
    .modal > *{position:relative}
    .modalTop{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .modalTop h3{margin:0}
    .two{display:grid; grid-template-columns: 1.1fr .9fr; gap:12px}
    @media (max-width:860px){.two{grid-template-columns:1fr}}
    .keyvals{display:grid; grid-template-columns: 150px 1fr; gap:8px 12px; font-size:13px}
    .keyvals div:nth-child(odd){color:var(--muted)}
    .numPad{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .num{
      width:160px;
      font-size:24px;
      font-weight:950;
      text-align:center;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(2,6,23,.65);
      color:var(--text);
    }

    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:16px;
      background:rgba(2,6,23,.78);
      border:1px solid var(--line2);
      padding:10px 12px;
      border-radius:999px;
      display:none;
      z-index:80;
      box-shadow: 0 16px 40px rgba(0,0,0,.55);
      color:var(--text);
      font-weight:800;
      backdrop-filter: blur(10px);
    }

    .table{width:100%; border-collapse:separate; border-spacing:0 10px}
    .table td, .table th{padding:10px 10px; text-align:left; font-size:13px}
    .table th{color:var(--muted); font-weight:900}
    .tr{
      background:rgba(2,6,23,.62);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }

    .pillRow{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:rgba(148,163,184,.10);
      border:1px solid var(--line);
      border-radius:10px;
      padding:4px 8px;
      font-size:12px;
      color:rgba(226,232,240,.85);
    }

    .footerHint{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 14px;
      background:linear-gradient(180deg, transparent, rgba(7,10,15,.90));
      border-top:1px solid rgba(148,163,184,.10);
      color:rgba(226,232,240,.70);
      display:flex; justify-content:center;
      pointer-events:none;
      font-size:12px;
    }

    .divider{
      height:1px; background:rgba(148,163,184,.12);
      margin:10px 0;
    }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(148,163,184,.08);
      border:1px solid rgba(148,163,184,.16);
      color:rgba(226,232,240,.84);
      font-size:12px;
      font-weight:850;
      white-space:nowrap;
    }

    .right{margin-left:auto}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .dangerText{color: #fecaca}
    .goodText{color:#bbf7d0}
    .warnText{color:#fde68a}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">SM</div>
    <div class="title">
      <b>Shelf Mapping</b>
      <span>Visual counting + fast “where is it?”</span>
    </div>
  </div>

  <div class="nav">
    <button class="btn ghost" id="nav_home" onclick="go('home')">Home</button>
    <button class="btn ghost" id="nav_count" onclick="go('map')">Map</button>
    <button class="btn ghost" id="nav_find" onclick="go('find')">Find</button>
    <button class="btn ghost" id="nav_report" onclick="go('report')">Report</button>
    <button class="btn" id="nav_setup" onclick="go('setup')">Setup</button>
  </div>
</header>

<main id="app"></main>

<div class="modalWrap" id="modalWrap" onclick="if(event.target.id==='modalWrap') closeModal()">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalTop">
      <h3 id="modalTitle">Details</h3>
      <div class="row">
        <button class="btn ghost" onclick="closeModal()">Close</button>
      </div>
    </div>
    <div id="modalBody" style="margin-top:10px"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="footerHint" id="footerHint"></div>

<script>
/* =========================================================
   Shelf Map v3 (visual map + shelves + bins + inventory runs)
   Built to preserve the existing styling + components.
   Data is stored in localStorage under the same key as v2,
   with an automatic migration (L -> S) on first run.
   ========================================================= */

const LS_KEY = "shelfmap_v2"; // keep same key so existing data is preserved

const DEFAULT_STATE = {
  // Levels (floors/areas): user selects this before seeing aisles
  levels: [{ id:"L1", name:"Level 1" }],

  // Aisles (map objects). v2 had STATE.aisles = [{id,name}]
  // v3: aisle also has levelId + orientation
  aisles: [],

  // Shelves per (aisle,side): { "aisleId|A": [ {id, name, bins:[binId,...]} ... ] }
  shelves: {},

  // Products catalog (same as v2): { [sku]: {sku,name,desc,reorderPoint,category,image,oos} }
  products: {},

  // Bin -> assigned sku (same idea, new binId format)
  binAssignments: {},

  // Bin -> qty (system qty)
  binQty: {},

  // Extra counts per SKU (kept from v2)
  extraCounts: {},

  // Settings (kept from v2)
  settings: {
    lowThresholdDefault: 2,
  },

  // UI nav + last selections
  lastNav: {
    levelId: "L1",
    aisleId: "",
    side: "A",
    shelfId: "",
  },

  // Highlight target (used by Find -> jump & highlight)
  highlight: null, // { aisleId, side, shelfId, binId, sku }

  // Inventory sessions & progress
  inventory: {
    sessions: [],        // [{id, startedAt, endedAt, levelId}]
    counts: {},          // { [sessionId]: [{binId, sku, expectedQty, physicalQty, at}] }
    progress: null       // {sessionId, levelId, idx, orderedBinIds}
  }
};

let STATE = loadState();
let ROUTE = "map";
let ROUTE_PARAMS = {}; // for aisle/shelf/inventory step routes
let NAV_STACK = [];    // for back button

/* ---------- Small utils (kept style-friendly) ---------- */
function structuredCloneSafe(obj){ return JSON.parse(JSON.stringify(obj)); }
function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function n2(x){ const v = Number(x); return Number.isFinite(v) ? v : 0; }
function uid(prefix="id"){ return prefix + "_" + Date.now() + "_" + Math.random().toString(16).slice(2); }

function toast(msg, ms=1600){
  const t = document.getElementById("toast");
  if(!t) return;
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> t.style.display="none", ms);
}
function setFooterHint(html){
  const el = document.getElementById("footerHint");
  if(!el) return;
  el.innerHTML = html || "";
  el.style.display = html ? "flex" : "none";
}

function openModal(title, bodyHTML){
  document.getElementById("modalTitle").textContent = title || "Details";
  document.getElementById("modalBody").innerHTML = bodyHTML || "";
  document.getElementById("modalWrap").style.display = "flex";
}
function closeModal(){
  document.getElementById("modalWrap").style.display = "none";
  document.getElementById("modalBody").innerHTML = "";
}

/* ---------- Load/save + migration from v2 ---------- */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredCloneSafe(DEFAULT_STATE);
    const obj = JSON.parse(raw);

    // Merge defaults (shallow + for nested we override)
    let merged = {
      ...structuredCloneSafe(DEFAULT_STATE),
      ...obj,
      settings: { ...DEFAULT_STATE.settings, ...(obj.settings||{}) },
      lastNav: { ...DEFAULT_STATE.lastNav, ...(obj.lastNav||{}) },
      inventory: { ...DEFAULT_STATE.inventory, ...(obj.inventory||{}) }
    };

    // v2 -> v3 migration:
    // v2 had layout keyed by "aisleId|A" with levels [{n,bins}]
    // and binId format: "aisle|A|L1|B3"
    // We interpret each old level as a Shelf number, and convert binId to "aisle|A|S1|B3"
    const hasShelves = merged.shelves && Object.keys(merged.shelves).length;
    if(!hasShelves){
      merged.shelves = merged.shelves || {};
      // ensure levels exists
      if(!merged.levels || !merged.levels.length){
        merged.levels = [{ id:"L1", name:"Level 1" }];
      }
      // ensure aisles have levelId + orientation
      merged.aisles = (merged.aisles||[]).map(a => ({
        ...a,
        levelId: a.levelId || "L1",
        orientation: a.orientation || "NS"
      }));

      // Convert old layout -> shelves
      const layout = merged.layout || {}; // v2 structure
      for(const k of Object.keys(layout)){
        const lay = layout[k] || {};
        const lvls = Array.isArray(lay.levels) ? lay.levels : [];
        const shelvesArr = [];
        for(const lvl of lvls){
          const sn = Number(lvl.n);
          if(!Number.isFinite(sn)) continue;
          const shelfId = "S" + sn;
          const binCount = Math.max(0, parseInt(lvl.bins||0,10) || 0);
          const bins = [];
          for(let i=1;i<=binCount;i++){
            bins.push(binIdFromParts({ aisleId: k.split("|")[0], side: k.split("|")[1], shelfId, bin:i }));
          }
          shelvesArr.push({ id: shelfId, name: "Shelf " + sn, bins });
        }
        // If no layout existed, still create empty shelves list
        merged.shelves[k] = shelvesArr.sort((a,b)=> shelfNum(a.id)-shelfNum(b.id));
      }

      // Convert assignments + qty keys L -> S
      const convertKey = (oldId)=>{
        if(typeof oldId !== "string") return oldId;
        // aisle|A|L1|B3  -> aisle|A|S1|B3
        return oldId.replace("|L", "|S");
      };
      const newAssign = {};
      for(const [b, sku] of Object.entries(merged.binAssignments||{})){
        newAssign[convertKey(b)] = sku;
      }
      merged.binAssignments = newAssign;

      const newQty = {};
      for(const [b, q] of Object.entries(merged.binQty||{})){
        newQty[convertKey(b)] = q;
      }
      merged.binQty = newQty;

      // Clean up: keep merged.layout for now (harmless), but the app uses shelves going forward
      toast("Upgraded your map to shelves + bins.", 2200);
    }

    // Ensure lastNav aisle/level exists
    if(!merged.levels?.some(l=>l.id===merged.lastNav.levelId)){
      merged.lastNav.levelId = merged.levels?.[0]?.id || "L1";
    }
    if(merged.aisles?.length && (!merged.lastNav.aisleId || !merged.aisles.some(a=>a.id===merged.lastNav.aisleId))){
      merged.lastNav.aisleId = merged.aisles[0].id;
    }
    if(merged.lastNav.side!=="A" && merged.lastNav.side!=="B") merged.lastNav.side = "A";

    return merged;
  }catch(e){
    console.warn("loadState failed", e);
    return structuredCloneSafe(DEFAULT_STATE);
  }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(STATE)); }

/* ---------- Data helpers ---------- */
function levelById(id){ return (STATE.levels||[]).find(l=>l.id===id) || null; }
function aisleById(id){ return (STATE.aisles||[]).find(a=>a.id===id) || null; }
function shelvesKey(aisleId, side){ return `${aisleId}|${side}`; }
function getShelves(aisleId, side){
  const k = shelvesKey(aisleId, side);
  if(!STATE.shelves[k]) STATE.shelves[k] = [];
  return STATE.shelves[k];
}
function shelfNum(shelfId){
  // "S12" -> 12
  const n = Number((shelfId||"").replace("S",""));
  return Number.isFinite(n) ? n : 0;
}
function binIdFromParts({aisleId, side, shelfId, bin}){
  return `${aisleId}|${side}|${shelfId}|B${bin}`;
}
function parseBinId(id){
  // aisle|A|S1|B3
  const [aisleId, side, shelfId, B] = (id||"").split("|");
  const bin = Number((B||"").replace("B",""));
  return { aisleId, side, shelfId, bin };
}
function productBySku(sku){ return STATE.products?.[sku] || null; }
function totalForSku(sku){
  let total = 0;
  for(const [b, s] of Object.entries(STATE.binAssignments||{})){
    if(s === sku) total += n2(STATE.binQty?.[b]);
  }
  const extra = STATE.extraCounts?.[sku] || [];
  total += extra.reduce((a,e)=>a + n2(e.qty), 0);
  return total;
}

/* ---------- Category color chips (same mapping as v2) ---------- */
function catColor(category){
  const c = (category||"").toLowerCase().trim();
  if(!c) return "var(--cat-default)";
  const map = {
    "hardware":"var(--cat-hardware)",
    "electrical":"var(--cat-electrical)",
    "plumbing":"var(--cat-plumbing)",
    "paint":"var(--cat-paint)",
    "safety":"var(--cat-safety)",
    "tools":"var(--cat-tools)",
    "misc":"var(--cat-misc)",
  };
  return map[c] || "var(--cat-default)";
}
function statusPillsForSku(sku){
  const p = productBySku(sku);
  const total = totalForSku(sku);
  const threshold = (+p?.reorderPoint>0) ? (+p.reorderPoint) : (STATE.settings.lowThresholdDefault||2);
  const isOos = (p?.oos===true) || total<=0;
  const isLow = (!isOos && total<=threshold);
  const cat = (p?.category||"").trim() || "default";
  const dot = catColor(cat);
  const status = isOos ? `<span class="chip bad">OOS</span>` : isLow ? `<span class="chip warn">LOW</span>` : `<span class="chip good">OK</span>`;
  return `
    <span class="chip dot" style="--cat-default:${dot}">${esc(cat.toUpperCase())}</span>
    <span class="chip soft">Total: <b>${total}</b></span>
    ${status}
  `;
}

/* ---------- Routing / nav stack ---------- */
function go(route, params={}){
  // push current for back
  if(route !== ROUTE){
    NAV_STACK.push({ route: ROUTE, params: structuredCloneSafe(ROUTE_PARAMS) });
  }
  ROUTE = route;
  ROUTE_PARAMS = params || {};
  render();
}
function back(){
  if(closeModal && document.getElementById("modalWrap")?.style?.display==="flex"){
    closeModal(); return;
  }
  const prev = NAV_STACK.pop();
  if(prev){
    ROUTE = prev.route;
    ROUTE_PARAMS = prev.params || {};
    render();
    return;
  }
  // fallback
  ROUTE = "map";
  ROUTE_PARAMS = {};
  render();
}

function activeNav(){
  ["home","count","find","report","setup"].forEach(r=>{
    const b = document.getElementById("nav_"+r);
    if(!b) return;
    const routeForBtn = (r==="count") ? "map" : r;
    if(routeForBtn===ROUTE){
      b.classList.add("primary");
      b.classList.remove("ghost");
    }else{
      b.classList.remove("primary");
      if(r!=="setup") b.classList.add("ghost");
      if(r==="setup"){ /* keep normal */ }
    }
  });
}

function appEl(){ return document.getElementById("app"); }

/* ---------- Views ---------- */
function render(){
  activeNav();
  const el = appEl();
  if(!el) return;

  if(ROUTE==="home") el.innerHTML = viewHome(); // keep a simple dashboard
  if(ROUTE==="map") el.innerHTML = viewMap();
  if(ROUTE==="aisle") el.innerHTML = viewAisle(ROUTE_PARAMS.aisleId);
  if(ROUTE==="shelf") el.innerHTML = viewShelf(ROUTE_PARAMS.aisleId, ROUTE_PARAMS.side, ROUTE_PARAMS.shelfId);
  if(ROUTE==="inventory") el.innerHTML = viewInventory();
  if(ROUTE==="find") el.innerHTML = viewFind();
  if(ROUTE==="setup") el.innerHTML = viewSetup();
  if(ROUTE==="report") el.innerHTML = viewReport();

  afterRender();
}

function topBar(title, rightHTML=""){
  return `
    <div class="row space" style="align-items:flex-start">
      <div>
        <h2 style="margin-bottom:6px">${title}</h2>
      </div>
      <div class="row" style="flex-wrap:wrap">
        <button class="btn" onclick="back()">Back</button>
        ${rightHTML||""}
      </div>
    </div>
    <div class="divider"></div>
  `;
}

/* Home: lightweight stats, but Map is the real main */
function viewHome(){
  const aisleCount = STATE.aisles.length;
  const skuCount = Object.keys(STATE.products||{}).length;
  const assignedBins = Object.keys(STATE.binAssignments||{}).length;
  return `
    <div class="grid">
      <div class="card">
        <div class="row space">
          <div>
            <h2 style="margin-bottom:6px">Shelf Map</h2>
            <div class="muted">Use <b>Map</b> for the visual layout and inventory runs.</div>
          </div>
          <div class="row">
            <button class="btn primary" onclick="go('map')">Open Map</button>
            <button class="btn" onclick="go('inventory')">${STATE.inventory?.progress ? "Resume Inventory" : "Start Inventory"}</button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row" style="gap:10px; flex-wrap:wrap">
          <span class="chip soft">Aisles: <b>${aisleCount}</b></span>
          <span class="chip soft">SKUs: <b>${skuCount}</b></span>
          <span class="chip soft">Assigned bins: <b>${assignedBins}</b></span>
        </div>
      </div>
    </div>
  `;
}

/* MAP: level dropdown + overhead aisle map */
function viewMap(){
  setFooterHint(`Tip: <span class="kbd">Shift</span> + <span class="kbd">/</span> opens Find • Click an aisle to drill down`);
  const levelId = STATE.lastNav.levelId || (STATE.levels?.[0]?.id || "L1");
  const aisles = (STATE.aisles||[]).filter(a => (a.levelId||"L1") === levelId);

  const levelOptions = (STATE.levels||[]).map(l=>`<option value="${esc(l.id)}" ${l.id===levelId?"selected":""}>${esc(l.name)}</option>`).join("");

  const cards = aisles.map(a=>{
    const sideA = getShelves(a.id,"A").length;
    const sideB = getShelves(a.id,"B").length;
    const hi = STATE.highlight && STATE.highlight.aisleId===a.id;
    const border = hi ? "box-shadow: 0 0 0 2px rgba(112,184,255,.55), 0 0 0 6px rgba(112,184,255,.12);" : "";
    return `
      <div class="card" style="cursor:pointer; ${border}" onclick="selectAisle('${esc(a.id)}')">
        <div class="row space">
          <div>
            <div style="font-weight:800; font-size:1.05rem">${esc(a.name||a.id)}</div>
            <div class="muted">Orientation: <b>${esc(a.orientation||"NS")}</b></div>
          </div>
          <div class="row" style="gap:8px">
            <span class="chip soft">A: <b>${sideA}</b> shelves</span>
            <span class="chip soft">B: <b>${sideB}</b> shelves</span>
          </div>
        </div>
      </div>
    `;
  }).join("");

  const invLabel = STATE.inventory?.progress ? "Resume Inventory" : "Start Inventory";

  return `
    <div class="grid">
      <div class="card">
        <div class="row space" style="align-items:flex-start">
          <div>
            <h2 style="margin-bottom:6px">Map view</h2>
            <div class="muted">Select a level, then tap an aisle. (Your doc layout is used as a guide, not literal text.)</div>
          </div>
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" onclick="go('find')">Find</button>
            <button class="btn" onclick="go('setup')">Setup</button>
            <button class="btn primary" onclick="go('inventory')">${invLabel}</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row space" style="align-items:center; flex-wrap:wrap">
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <span class="chip soft">Level</span>
            <select class="input" style="min-width:200px" onchange="setLevel(this.value)">
              ${levelOptions}
            </select>
          </div>
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="addLevel()">Add level</button>
            <button class="btn" onclick="addAisle()">Add aisle</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr));">
          ${cards || `<div class="muted">No aisles yet on this level. Click “Add aisle”.</div>`}
        </div>
      </div>
    </div>
  `;
}

function setLevel(levelId){
  STATE.lastNav.levelId = levelId;
  saveState();
  // clear highlight if not on this level
  if(STATE.highlight){
    const a = aisleById(STATE.highlight.aisleId);
    if(a && (a.levelId||"L1") !== levelId) STATE.highlight = null;
  }
  render();
}

function addLevel(){
  openModal("Add level", `
    <div class="grid">
      <div class="row">
        <div style="flex:1">
          <div class="muted" style="margin-bottom:6px">Level name</div>
          <input class="input" id="newLevelName" placeholder="Level 2" />
        </div>
      </div>
      <div class="row space">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="confirmAddLevel()">Add</button>
      </div>
    </div>
  `);
  setTimeout(()=>document.getElementById("newLevelName")?.focus(), 50);
}
function confirmAddLevel(){
  const name = (document.getElementById("newLevelName")?.value || "").trim();
  if(!name){ toast("Enter a level name"); return; }
  const id = "L" + (STATE.levels.length+1) + "_" + Math.random().toString(16).slice(2,6);
  STATE.levels.push({id, name});
  STATE.lastNav.levelId = id;
  saveState();
  closeModal();
  render();
}

function addAisle(){
  openModal("Add aisle", `
    <div class="grid">
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <div style="flex:1; min-width:220px">
          <div class="muted" style="margin-bottom:6px">Aisle name</div>
          <input class="input" id="newAisleName" placeholder="Aisle 1" />
        </div>
        <div style="min-width:180px">
          <div class="muted" style="margin-bottom:6px">Orientation</div>
          <select class="input" id="newAisleOrient">
            <option value="NS">NS</option>
            <option value="EW">EW</option>
          </select>
        </div>
      </div>
      <div class="row space">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="confirmAddAisle()">Add</button>
      </div>
    </div>
  `);
  setTimeout(()=>document.getElementById("newAisleName")?.focus(), 50);
}
function confirmAddAisle(){
  const name = (document.getElementById("newAisleName")?.value || "").trim();
  const orientation = (document.getElementById("newAisleOrient")?.value || "NS");
  if(!name){ toast("Enter an aisle name"); return; }
  const id = uid("aisle");
  const levelId = STATE.lastNav.levelId || "L1";
  STATE.aisles.push({id, name, levelId, orientation});
  // create empty shelves containers
  STATE.shelves[shelvesKey(id,"A")] = STATE.shelves[shelvesKey(id,"A")] || [];
  STATE.shelves[shelvesKey(id,"B")] = STATE.shelves[shelvesKey(id,"B")] || [];
  STATE.lastNav.aisleId = id;
  saveState();
  closeModal();
  render();
}

function selectAisle(aisleId){
  STATE.lastNav.aisleId = aisleId;
  STATE.lastNav.side = STATE.lastNav.side || "A";
  saveState();
  go("aisle", { aisleId });
}

/* AISLE: select side + shelves list */
function viewAisle(aisleId){
  const aisle = aisleById(aisleId);
  if(!aisle) return `<div class="grid"><div class="card">${topBar("Aisle not found")}<div class="muted">Missing aisle.</div></div></div>`;

  const side = (ROUTE_PARAMS.side || STATE.lastNav.side || "A");
  const shelves = getShelves(aisle.id, side).slice().sort((a,b)=> shelfNum(a.id)-shelfNum(b.id));

  const sideBtn = (s)=> `<button class="btn ${side===s?"primary":"ghost"}" onclick="setSide('${esc(s)}')">Side ${esc(s)}</button>`;
  const orientBtn = (o)=> `<button class="btn ${((aisle.orientation||"NS")===o)?"primary":"ghost"}" onclick="setOrientation('${esc(aisle.id)}','${esc(o)}')">${esc(o)}</button>`;

  const rows = shelves.map(sh=>{
    const isHi = STATE.highlight && STATE.highlight.shelfId===sh.id && STATE.highlight.aisleId===aisle.id && STATE.highlight.side===side;
    const border = isHi ? "box-shadow: 0 0 0 2px rgba(112,184,255,.55), 0 0 0 6px rgba(112,184,255,.12);" : "";
    return `
      <div class="card" style="cursor:pointer; ${border}" onclick="openShelf('${esc(aisle.id)}','${esc(side)}','${esc(sh.id)}')">
        <div class="row space">
          <div style="font-weight:800">${esc(sh.name || sh.id)}</div>
          <span class="chip soft">${sh.bins?.length||0} bins</span>
        </div>
      </div>
    `;
  }).join("");

  return `
    <div class="grid">
      <div class="card">
        ${topBar(`${esc(aisle.name||"Aisle")} — shelves`, `
          <button class="btn" onclick="go('map')">Back to Map</button>
        `)}

        <div class="row space" style="flex-wrap:wrap">
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <span class="chip soft">Orientation</span>
            ${orientBtn("NS")}
            ${orientBtn("EW")}
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <span class="chip soft">Side</span>
            ${sideBtn("A")}
            ${sideBtn("B")}
          </div>
        </div>

        <div class="divider"></div>

        <div class="row space">
          <div class="muted">Tap a shelf to see bins left → right.</div>
          <button class="btn primary" onclick="addShelf('${esc(aisle.id)}','${esc(side)}')">Add shelf</button>
        </div>

        <div class="divider"></div>

        <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr));">
          ${rows || `<div class="muted">No shelves yet on Side ${esc(side)}. Click “Add shelf”.</div>`}
        </div>
      </div>
    </div>
  `;
}
function setSide(side){
  STATE.lastNav.side = side;
  saveState();
  go("aisle", { aisleId: ROUTE_PARAMS.aisleId, side });
}
function setOrientation(aisleId, orient){
  const a = aisleById(aisleId);
  if(!a) return;
  a.orientation = orient;
  saveState();
  render();
}
function addShelf(aisleId, side){
  const shelves = getShelves(aisleId, side);
  const next = (shelves.map(s=>shelfNum(s.id)).sort((a,b)=>a-b).pop() || 0) + 1;
  openModal("Add shelf", `
    <div class="grid">
      <div class="muted">Shelf name</div>
      <input class="input" id="newShelfName" value="Shelf ${next}" />
      <div class="muted" style="margin-top:10px">Initial bin count</div>
      <input class="input" id="newShelfBins" type="number" min="0" value="0" />
      <div class="row space" style="margin-top:12px">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="confirmAddShelf('${esc(aisleId)}','${esc(side)}','${next}')">Add</button>
      </div>
    </div>
  `);
  setTimeout(()=>document.getElementById("newShelfName")?.focus(), 50);
}
function confirmAddShelf(aisleId, side, nextNum){
  const name = (document.getElementById("newShelfName")?.value || "").trim() || ("Shelf " + nextNum);
  const binsN = Math.max(0, parseInt(document.getElementById("newShelfBins")?.value||"0",10) || 0);
  const shelfId = "S" + nextNum;
  const bins = [];
  for(let i=1;i<=binsN;i++) bins.push(binIdFromParts({aisleId, side, shelfId, bin:i}));
  getShelves(aisleId, side).push({ id: shelfId, name, bins });
  STATE.lastNav.shelfId = shelfId;
  saveState();
  closeModal();
  go("shelf", { aisleId, side, shelfId });
}
function openShelf(aisleId, side, shelfId){
  STATE.lastNav.aisleId = aisleId;
  STATE.lastNav.side = side;
  STATE.lastNav.shelfId = shelfId;
  saveState();
  go("shelf", { aisleId, side, shelfId });
}

/* SHELF: bins left -> right, drag reorder, add bin (adds right), bin modal */
function viewShelf(aisleId, side, shelfId){
  const aisle = aisleById(aisleId);
  if(!aisle) return `<div class="grid"><div class="card">${topBar("Shelf not found")}<div class="muted">Missing aisle.</div></div></div>`;
  const shelves = getShelves(aisleId, side);
  const shelf = shelves.find(s=>s.id===shelfId);
  if(!shelf) return `<div class="grid"><div class="card">${topBar("Shelf not found")}<div class="muted">Missing shelf.</div></div></div>`;

  const bins = (shelf.bins||[]).map((bId, idx)=>{
    const sku = STATE.binAssignments[bId] || "";
    const qty = n2(STATE.binQty[bId]);
    const p = sku ? productBySku(sku) : null;
    const hi = STATE.highlight && STATE.highlight.binId===bId;
    const border = hi ? "box-shadow: 0 0 0 2px rgba(112,184,255,.55), 0 0 0 6px rgba(112,184,255,.12);" : "";
    const cls = sku ? "ok" : (qty>0 ? "low" : "empty");
    return `
      <div class="bin ${cls}" draggable="true"
           data-bin="${esc(bId)}"
           ondragstart="binDragStart(event)"
           ondragover="binDragOver(event)"
           ondrop="binDrop(event)"
           onclick="openBin('${esc(bId)}')"
           style="min-width:240px; ${border}">
        <div class="binhead">
          <div class="binlabel">Bin ${idx+1}</div>
          ${sku ? `<span class="chip soft mono">${esc(sku)}</span>` : `<span class="chip soft">Unassigned</span>`}
        </div>
        <div class="row" style="justify-content:space-between; gap:10px">
          <div class="countbig">${qty}</div>
          ${sku ? `<div class="sell">${esc(p?.name||"")}</div>` : `<div class="sell">Tap to assign SKU</div>`}
        </div>
        <div class="thumb">
          ${p?.image ? `<img alt="" src="${p.image}">` : `<div class="ph">${sku ? "No product image" : "No product assigned"}</div>`}
        </div>
        <div class="pillRow">
          ${sku ? statusPillsForSku(sku) : `<span class="chip soft">Set SKU • set qty</span>`}
        </div>
      </div>
    `;
  }).join("");

  return `
    <div class="grid">
      <div class="card">
        ${topBar(`${esc(aisle.name||"Aisle")} • Side ${esc(side)} • ${esc(shelf.name||shelf.id)}`, `
          <button class="btn" onclick="go('aisle',{aisleId:'${esc(aisleId)}', side:'${esc(side)}'})">Back to Shelves</button>
        `)}
        <div class="row space" style="flex-wrap:wrap">
          <div class="muted">Bins are left → right. Drag bins to re-order.</div>
          <button class="btn primary" onclick="addBin('${esc(aisleId)}','${esc(side)}','${esc(shelfId)}')">Add bin</button>
        </div>
        <div class="divider"></div>
        <div class="bins" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
          ${bins || `<div class="muted">No bins yet. Click “Add bin”.</div>`}
        </div>
      </div>
    </div>
  `;
}

let _dragBinId = null;
function binDragStart(ev){
  const id = ev.currentTarget?.dataset?.bin;
  _dragBinId = id || null;
  ev.dataTransfer?.setData("text/plain", id||"");
}
function binDragOver(ev){ ev.preventDefault(); }
function binDrop(ev){
  ev.preventDefault();
  const targetId = ev.currentTarget?.dataset?.bin;
  const src = _dragBinId || ev.dataTransfer?.getData("text/plain");
  if(!src || !targetId || src===targetId) return;

  const { aisleId, side, shelfId } = parseBinId(src);
  const shelves = getShelves(aisleId, side);
  const shelf = shelves.find(s=>s.id===shelfId);
  if(!shelf) return;

  const a = shelf.bins.indexOf(src);
  const b = shelf.bins.indexOf(targetId);
  if(a<0 || b<0) return;

  shelf.bins.splice(b, 0, shelf.bins.splice(a,1)[0]);
  saveState();
  render();
}

function addBin(aisleId, side, shelfId){
  const shelves = getShelves(aisleId, side);
  const shelf = shelves.find(s=>s.id===shelfId);
  if(!shelf) return;

  const next = (shelf.bins?.length || 0) + 1;
  const bId = binIdFromParts({aisleId, side, shelfId, bin: next});
  shelf.bins.push(bId);
  saveState();

  // Immediately prompt to add/assign product
  openBin(bId, {forceAssign:true});
  render();
}

/* Bin modal: assign SKU + qty, or create product */
function openBin(binId, opts={}){
  const p = parseBinId(binId);
  const aisle = aisleById(p.aisleId);
  const sku = STATE.binAssignments[binId] || "";
  const qty = n2(STATE.binQty[binId]);
  const prod = sku ? productBySku(sku) : null;

  const skuOptions = Object.values(STATE.products||{})
    .sort((a,b)=>(a.sku||"").localeCompare(b.sku||""))
    .map(x=>`<option value="${esc(x.sku)}" ${x.sku===sku?"selected":""}>${esc(x.sku)} — ${esc(x.name||"")}</option>`)
    .join("");

  const title = `${aisle?.name||p.aisleId} • Side ${p.side} • ${p.shelfId} • Bin ${p.bin}`;

  openModal(title, `
    <div class="grid">
      <div class="row" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
        <div style="flex:1; min-width:260px">
          <div class="muted" style="margin-bottom:6px">Assigned SKU</div>
          <select class="input" id="binSkuSelect">
            <option value="">(Unassigned)</option>
            ${skuOptions}
          </select>
        </div>
        <div style="min-width:180px">
          <div class="muted" style="margin-bottom:6px">Bin qty</div>
          <input class="input" id="binQtyInput" type="number" value="${qty}" />
        </div>
        <div class="row" style="gap:10px">
          <button class="btn" onclick="openNewProduct('${esc(binId)}')">New product</button>
        </div>
      </div>

      <div class="divider"></div>

      ${sku ? `
        <div class="card">
          <div class="row space">
            <div>
              <div style="font-weight:900">${esc(prod?.name||"")}</div>
              <div class="muted mono">${esc(sku)}</div>
            </div>
            <div class="row" style="gap:8px; flex-wrap:wrap">
              ${statusPillsForSku(sku)}
            </div>
          </div>
          <div class="divider"></div>
          <div class="muted">${esc(prod?.desc||"")}</div>
        </div>
      ` : `<div class="muted">No product assigned to this bin yet.</div>`}

      <div class="row space">
        <button class="btn" onclick="closeModal()">Close</button>
        <button class="btn primary" onclick="saveBin('${esc(binId)}')">Save</button>
      </div>
    </div>
  `);

  if(opts.forceAssign){
    setTimeout(()=>document.getElementById("binSkuSelect")?.focus(), 50);
  }
}
function saveBin(binId){
  const sku = (document.getElementById("binSkuSelect")?.value || "").trim();
  const qty = n2(document.getElementById("binQtyInput")?.value);

  if(sku){
    STATE.binAssignments[binId] = sku;
  }else{
    delete STATE.binAssignments[binId];
  }
  STATE.binQty[binId] = qty;
  saveState();
  toast("Saved bin");
  closeModal();
  render();
}

function openNewProduct(binId){
  openModal("New product", `
    <div class="grid">
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <div style="flex:1; min-width:200px">
          <div class="muted" style="margin-bottom:6px">SKU</div>
          <input class="input" id="pSku" placeholder="SKU123" />
        </div>
        <div style="flex:2; min-width:260px">
          <div class="muted" style="margin-bottom:6px">Name</div>
          <input class="input" id="pName" placeholder="Part name" />
        </div>
      </div>

      <div class="muted" style="margin-top:10px; margin-bottom:6px">Description</div>
      <textarea class="input" id="pDesc" rows="3" placeholder="What is it / notes"></textarea>

      <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px">
        <div style="min-width:200px">
          <div class="muted" style="margin-bottom:6px">Re-order point</div>
          <input class="input" id="pRp" type="number" value="0" />
        </div>
        <div style="min-width:240px">
          <div class="muted" style="margin-bottom:6px">Category</div>
          <input class="input" id="pCat" placeholder="hardware / electrical / ..." />
        </div>
      </div>

      <div class="muted" style="margin-top:10px; margin-bottom:6px">Photo (URL or paste image data URL)</div>
      <input class="input" id="pImg" placeholder="https://..." />

      <div class="row space" style="margin-top:12px">
        <button class="btn" onclick="openBin('${esc(binId)}')">Back</button>
        <button class="btn primary" onclick="saveNewProductAndAssign('${esc(binId)}')">Save product</button>
      </div>
    </div>
  `);
  setTimeout(()=>document.getElementById("pSku")?.focus(), 50);
}
function saveNewProductAndAssign(binId){
  const sku = (document.getElementById("pSku")?.value || "").trim();
  const name = (document.getElementById("pName")?.value || "").trim();
  const desc = (document.getElementById("pDesc")?.value || "").trim();
  const reorderPoint = n2(document.getElementById("pRp")?.value);
  const category = (document.getElementById("pCat")?.value || "").trim();
  const image = (document.getElementById("pImg")?.value || "").trim();

  if(!sku){ toast("SKU is required"); return; }
  if(STATE.products[sku]){ toast("SKU already exists"); return; }
  STATE.products[sku] = { sku, name, desc, reorderPoint, category, image, oos:false };
  STATE.binAssignments[binId] = sku;
  saveState();
  toast("Product saved");
  openBin(binId);
}

/* FIND: search + show locations + jump/highlight (per your doc) */
function locationsForSku(sku){
  const locs = [];
  for(const [b, s] of Object.entries(STATE.binAssignments||{})){
    if(s === sku){
      const p = parseBinId(b);
      const aisle = aisleById(p.aisleId);
      locs.push({ binId:b, aisleId:p.aisleId, aisleName: aisle?.name || p.aisleId, side:p.side, shelfId:p.shelfId, bin:p.bin, qty: n2(STATE.binQty[b]) });
    }
  }
  return locs.sort((a,b)=> a.aisleName.localeCompare(b.aisleName) || a.side.localeCompare(b.side) || shelfNum(a.shelfId)-shelfNum(b.shelfId) || a.bin-b.bin);
}
function viewFind(){
  setFooterHint(`Find: search by SKU or name • <span class="kbd">Enter</span> opens top result`);
  const q = (viewFind._q || "").trim();
  const all = Object.values(STATE.products||{});
  let results = [];
  if(q){
    const qq = q.toLowerCase();
    results = all.filter(p =>
      (p.sku||"").toLowerCase().includes(qq) ||
      (p.name||"").toLowerCase().includes(qq) ||
      (p.category||"").toLowerCase().includes(qq)
    );
  }else{
    results = all.sort((a,b)=>(a.sku||"").localeCompare(b.sku||"")).slice(0,24);
  }
  results = results.slice(0,60);

  const items = results.map(p=>{
    const locs = locationsForSku(p.sku);
    const locHTML = locs.length ? locs.slice(0,5).map(l=>{
      return `
        <div class="row space" style="gap:10px; flex-wrap:wrap">
          <span class="chip soft">${esc(l.aisleName)} • ${esc(l.side)} • ${esc(l.shelfId)} • Bin ${l.bin}</span>
          <span class="chip soft">Qty: <b>${l.qty}</b></span>
          <button class="btn" onclick="jumpToBin('${esc(l.binId)}','${esc(p.sku)}')">Go</button>
        </div>
      `;
    }).join("") : `<div class="muted">No locations assigned yet.</div>`;

    return `
      <div class="card">
        <div class="row space">
          <div>
            <div style="font-weight:900">${esc(p.name||"")}</div>
            <div class="muted mono">${esc(p.sku)}</div>
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            ${statusPillsForSku(p.sku)}
          </div>
        </div>
        <div class="divider"></div>
        ${locHTML}
      </div>
    `;
  }).join("");

  return `
    <div class="grid">
      <div class="card">
        ${topBar("Find", `
          <button class="btn" onclick="go('map')">Back to Map</button>
        `)}
        <div class="row space" style="gap:10px; flex-wrap:wrap">
          <input class="input" style="flex:1; min-width:260px" placeholder="Search SKU, name, or category…"
                 value="${esc(q)}"
                 oninput="viewFind._q=this.value; render()"
                 onkeydown="if(event.key==='Enter') openTopFindResult()" />
          <button class="btn" onclick="viewFind._q=''; render()">Clear</button>
        </div>
      </div>

      ${items || `<div class="card"><div class="muted">No products yet. Go to Setup to add products.</div></div>`}
    </div>
  `;
}
function openTopFindResult(){
  const q = (viewFind._q || "").trim();
  if(!q) return;
  const qq = q.toLowerCase();
  const all = Object.values(STATE.products||{});
  const res = all.filter(p =>
    (p.sku||"").toLowerCase().includes(qq) ||
    (p.name||"").toLowerCase().includes(qq) ||
    (p.category||"").toLowerCase().includes(qq)
  )[0];
  if(!res) return;
  const locs = locationsForSku(res.sku);
  if(locs[0]) jumpToBin(locs[0].binId, res.sku);
}
function jumpToBin(binId, sku){
  const p = parseBinId(binId);
  const aisle = aisleById(p.aisleId);
  if(!aisle){ toast("Aisle not found"); return; }

  // Set highlight & navigate in the order you described (aisle -> shelf -> bin)
  STATE.highlight = { aisleId:p.aisleId, side:p.side, shelfId:p.shelfId, binId, sku };
  STATE.lastNav.levelId = aisle.levelId || "L1";
  STATE.lastNav.aisleId = p.aisleId;
  STATE.lastNav.side = p.side;
  STATE.lastNav.shelfId = p.shelfId;
  saveState();

  // Go to map first so aisle highlights, then go aisle, then shelf (bin highlights there)
  NAV_STACK = []; // clean back stack for a sane experience
  ROUTE = "map"; ROUTE_PARAMS = {};
  render();
  setTimeout(()=>{ go("aisle", { aisleId:p.aisleId, side:p.side }); }, 50);
  setTimeout(()=>{ go("shelf", { aisleId:p.aisleId, side:p.side, shelfId:p.shelfId }); }, 120);
  setTimeout(()=>{ /* keep highlight until user clicks */ }, 200);
}

/* INVENTORY: guided counting with pause/resume and timestamped history */
function orderedBinsForLevel(levelId){
  const aisles = (STATE.aisles||[]).filter(a => (a.levelId||"L1") === levelId);
  // Keep aisle insertion order; if you want alphabetical, swap sort below
  // aisles.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  const ordered = [];
  for(const a of aisles){
    for(const side of ["A","B"]){
      const shelves = getShelves(a.id, side).slice().sort((x,y)=> shelfNum(x.id)-shelfNum(y.id));
      for(const sh of shelves){
        for(const bId of (sh.bins||[])){
          ordered.push(bId);
        }
      }
    }
  }
  return ordered;
}
function startInventory(){
  const levelId = STATE.lastNav.levelId || (STATE.levels?.[0]?.id || "L1");
  const orderedBinIds = orderedBinsForLevel(levelId);
  if(!orderedBinIds.length){ toast("No bins to count yet. Build your map first."); return; }

  const sessionId = uid("inv");
  const now = new Date().toISOString();
  STATE.inventory.sessions.unshift({ id: sessionId, levelId, startedAt: now, endedAt: "" });
  STATE.inventory.counts[sessionId] = [];
  STATE.inventory.progress = { sessionId, levelId, idx: 0, orderedBinIds };
  saveState();
  go("inventory");
}
function resumeInventory(){
  if(!STATE.inventory.progress){ startInventory(); return; }
  go("inventory");
}
function pauseInventory(){
  saveState();
  toast("Paused. You can resume anytime.");
  go("map");
}
function finishInventory(){
  const prog = STATE.inventory.progress;
  if(!prog) return;
  const ses = STATE.inventory.sessions.find(s=>s.id===prog.sessionId);
  if(ses) ses.endedAt = new Date().toISOString();
  STATE.inventory.progress = null;
  saveState();
  toast("Inventory complete");
  go("map");
}

function viewInventory(){
  setFooterHint(`Inventory: Next saves a timestamped count record • Pause returns to Map`);
  const prog = STATE.inventory.progress;

  // If no progress, show start UI + history
  if(!prog){
    const levelId = STATE.lastNav.levelId || (STATE.levels?.[0]?.id || "L1");
    const history = (STATE.inventory.sessions||[]).slice(0,12).map(s=>{
      const lvl = levelById(s.levelId);
      const started = s.startedAt ? new Date(s.startedAt).toLocaleString() : "";
      const ended = s.endedAt ? new Date(s.endedAt).toLocaleString() : "—";
      const cnt = (STATE.inventory.counts?.[s.id]?.length || 0);
      return `
        <div class="row space" style="gap:10px; flex-wrap:wrap">
          <span class="chip soft">${esc(lvl?.name||s.levelId)}</span>
          <span class="chip soft">Started: <b>${esc(started)}</b></span>
          <span class="chip soft">Ended: <b>${esc(ended)}</b></span>
          <span class="chip soft">Entries: <b>${cnt}</b></span>
          <button class="btn" onclick="openInventorySession('${esc(s.id)}')">View</button>
        </div>
      `;
    }).join("");

    return `
      <div class="grid">
        <div class="card">
          ${topBar("Inventory counting", `<button class="btn" onclick="go('map')">Back to Map</button>`)}
          <div class="row space" style="flex-wrap:wrap">
            <div class="muted">Guides you Level → Aisle → Side → Shelf → Bin. Each Next saves a timestamped record.</div>
            <button class="btn primary" onclick="startInventory()">Start Inventory (Level: ${esc(levelById(levelId)?.name||levelId)})</button>
          </div>
          <div class="divider"></div>
          <div class="muted" style="margin-bottom:10px">Recent sessions</div>
          ${history || `<div class="muted">No sessions yet.</div>`}
        </div>
      </div>
    `;
  }

  // Active progress step
  const { sessionId, levelId, idx, orderedBinIds } = prog;
  const binId = orderedBinIds[idx];
  if(!binId){
    return `
      <div class="grid">
        <div class="card">
          ${topBar("Inventory")}
          <div class="muted">Nothing to count.</div>
        </div>
      </div>
    `;
  }

  const p = parseBinId(binId);
  const aisle = aisleById(p.aisleId);
  const sku = STATE.binAssignments[binId] || "";
  const prod = sku ? productBySku(sku) : null;
  const expectedQty = n2(STATE.binQty[binId]);
  const progressPct = Math.round(((idx+1)/orderedBinIds.length)*100);

  return `
    <div class="grid">
      <div class="card">
        <div class="row space" style="align-items:flex-start">
          <div>
            <h2 style="margin-bottom:6px">Inventory counting</h2>
            <div class="muted">Session: <span class="mono">${esc(sessionId)}</span></div>
          </div>
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" onclick="pauseInventory()">Pause</button>
            <button class="btn" onclick="go('map')">Map</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row space" style="gap:10px; flex-wrap:wrap">
          <span class="chip soft">Progress: <b>${idx+1}/${orderedBinIds.length}</b> (${progressPct}%)</span>
          <span class="chip soft">${esc(levelById(levelId)?.name||levelId)}</span>
          <span class="chip soft">${esc(aisle?.name||p.aisleId)} • Side ${esc(p.side)} • ${esc(p.shelfId)} • Bin ${p.bin}</span>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="row space" style="align-items:flex-start">
            <div>
              <div style="font-weight:900">${sku ? esc(prod?.name||"") : "Unassigned bin"}</div>
              <div class="muted mono">${sku ? esc(sku) : "No SKU assigned"}</div>
            </div>
            <div class="row" style="gap:8px; flex-wrap:wrap">
              ${sku ? statusPillsForSku(sku) : `<span class="chip warn">ASSIGN SKU</span>`}
              <span class="chip soft">Expected: <b>${expectedQty}</b></span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
            <div style="min-width:240px">
              <div class="muted" style="margin-bottom:6px">Physical count</div>
              <input class="input" id="physicalCount" type="number" value="${expectedQty}" />
            </div>
            <button class="btn" onclick="openBin('${esc(binId)}')">Open bin</button>
          </div>
        </div>

        <div class="row space" style="margin-top:12px">
          <button class="btn" onclick="invPrev()">Previous</button>
          <button class="btn primary" onclick="invNext()">Next</button>
        </div>
      </div>
    </div>
  `;
}
function invPrev(){
  const prog = STATE.inventory.progress;
  if(!prog) return;
  prog.idx = Math.max(0, prog.idx-1);
  saveState();
  render();
}
function invNext(){
  const prog = STATE.inventory.progress;
  if(!prog) return;
  const binId = prog.orderedBinIds[prog.idx];
  const physicalQty = n2(document.getElementById("physicalCount")?.value);
  const expectedQty = n2(STATE.binQty[binId]);
  const sku = STATE.binAssignments[binId] || "";

  const rec = { binId, sku, expectedQty, physicalQty, at: new Date().toISOString() };
  (STATE.inventory.counts[prog.sessionId] = STATE.inventory.counts[prog.sessionId] || []).push(rec);

  // Optional: also update live qty to physical (common inventory behavior)
  STATE.binQty[binId] = physicalQty;

  prog.idx += 1;
  saveState();

  if(prog.idx >= prog.orderedBinIds.length){
    finishInventory();
  }else{
    render();
  }
}
function openInventorySession(sessionId){
  const ses = STATE.inventory.sessions.find(s=>s.id===sessionId);
  const lvl = levelById(ses?.levelId);
  const rows = (STATE.inventory.counts?.[sessionId] || []).slice(0,200).map(r=>{
    const p = parseBinId(r.binId);
    const aisle = aisleById(p.aisleId);
    const when = r.at ? new Date(r.at).toLocaleString() : "";
    return `
      <div class="row space" style="gap:10px; flex-wrap:wrap">
        <span class="chip soft">${esc(when)}</span>
        <span class="chip soft">${esc(aisle?.name||p.aisleId)} • ${esc(p.side)} • ${esc(p.shelfId)} • Bin ${p.bin}</span>
        <span class="chip soft mono">${esc(r.sku||"")}</span>
        <span class="chip soft">Expected: <b>${n2(r.expectedQty)}</b></span>
        <span class="chip soft">Physical: <b>${n2(r.physicalQty)}</b></span>
        <button class="btn" onclick="jumpToBin('${esc(r.binId)}','${esc(r.sku||"")}')">Go</button>
      </div>
    `;
  }).join("");

  openModal(`Inventory session — ${esc(lvl?.name||ses?.levelId||"")}`, `
    <div class="grid">
      <div class="muted">Started: ${esc(ses?.startedAt ? new Date(ses.startedAt).toLocaleString() : "")}</div>
      <div class="muted">Ended: ${esc(ses?.endedAt ? new Date(ses.endedAt).toLocaleString() : "—")}</div>
      <div class="divider"></div>
      ${rows || `<div class="muted">No entries.</div>`}
      <div class="row space" style="margin-top:12px">
        <button class="btn" onclick="closeModal()">Close</button>
      </div>
    </div>
  `);
}

/* SETUP + REPORT:
   For now, we keep lightweight versions so your existing flow stays intact.
   (You can expand these later; styling stays consistent.) */
function viewSetup(){
  setFooterHint(`Setup: add products here • Map is where you build the layout`);
  const items = Object.values(STATE.products||{}).sort((a,b)=>(a.sku||"").localeCompare(b.sku||"")).slice(0,100).map(p=>{
    return `
      <div class="row space" style="gap:10px; flex-wrap:wrap">
        <span class="chip soft mono">${esc(p.sku)}</span>
        <span class="chip soft">${esc(p.name||"")}</span>
        <button class="btn" onclick="editProduct('${esc(p.sku)}')">Edit</button>
      </div>
    `;
  }).join("");

  return `
    <div class="grid">
      <div class="card">
        ${topBar("Setup", `<button class="btn" onclick="go('map')">Back to Map</button>`)}
        <div class="row space" style="flex-wrap:wrap">
          <div class="muted">Add/edit products. Assign products to bins from the Shelf view.</div>
          <button class="btn primary" onclick="createProduct()">Add product</button>
        </div>
        <div class="divider"></div>
        ${items || `<div class="muted">No products yet.</div>`}
      </div>
    </div>
  `;
}
function createProduct(){
  openModal("Add product", `
    <div class="grid">
      <div class="muted">SKU</div><input class="input" id="spSku" />
      <div class="muted">Name</div><input class="input" id="spName" />
      <div class="muted">Description</div><textarea class="input" id="spDesc" rows="3"></textarea>
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <div style="min-width:180px">
          <div class="muted">Reorder point</div><input class="input" id="spRp" type="number" value="0" />
        </div>
        <div style="min-width:220px">
          <div class="muted">Category</div><input class="input" id="spCat" placeholder="hardware" />
        </div>
      </div>
      <div class="muted">Photo</div><input class="input" id="spImg" placeholder="https://..." />
      <div class="row space" style="margin-top:12px">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="saveSetupProduct()">Save</button>
      </div>
    </div>
  `);
}
function saveSetupProduct(){
  const sku = (document.getElementById("spSku")?.value||"").trim();
  const name = (document.getElementById("spName")?.value||"").trim();
  const desc = (document.getElementById("spDesc")?.value||"").trim();
  const reorderPoint = n2(document.getElementById("spRp")?.value);
  const category = (document.getElementById("spCat")?.value||"").trim();
  const image = (document.getElementById("spImg")?.value||"").trim();
  if(!sku){ toast("SKU required"); return; }
  STATE.products[sku] = { sku, name, desc, reorderPoint, category, image, oos:false };
  saveState();
  closeModal();
  render();
}
function editProduct(sku){
  const p = productBySku(sku);
  if(!p) return;
  openModal("Edit product", `
    <div class="grid">
      <div class="muted">SKU</div><input class="input" value="${esc(p.sku)}" disabled />
      <div class="muted">Name</div><input class="input" id="epName" value="${esc(p.name||"")}" />
      <div class="muted">Description</div><textarea class="input" id="epDesc" rows="3">${esc(p.desc||"")}</textarea>
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <div style="min-width:180px">
          <div class="muted">Reorder point</div><input class="input" id="epRp" type="number" value="${n2(p.reorderPoint)}" />
        </div>
        <div style="min-width:220px">
          <div class="muted">Category</div><input class="input" id="epCat" value="${esc(p.category||"")}" />
        </div>
      </div>
      <div class="muted">Photo</div><input class="input" id="epImg" value="${esc(p.image||"")}" />
      <div class="row space" style="margin-top:12px">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="saveEditProduct('${esc(sku)}')">Save</button>
      </div>
    </div>
  `);
}
function saveEditProduct(sku){
  const p = productBySku(sku);
  if(!p) return;
  p.name = (document.getElementById("epName")?.value||"").trim();
  p.desc = (document.getElementById("epDesc")?.value||"").trim();
  p.reorderPoint = n2(document.getElementById("epRp")?.value);
  p.category = (document.getElementById("epCat")?.value||"").trim();
  p.image = (document.getElementById("epImg")?.value||"").trim();
  saveState();
  closeModal();
  render();
}

function viewReport(){
  setFooterHint(`Report: quick view of recent inventory sessions`);
  const sessions = (STATE.inventory.sessions||[]).slice(0,20).map(s=>{
    const lvl = levelById(s.levelId);
    const started = s.startedAt ? new Date(s.startedAt).toLocaleString() : "";
    const ended = s.endedAt ? new Date(s.endedAt).toLocaleString() : "—";
    const cnt = (STATE.inventory.counts?.[s.id]?.length || 0);
    return `
      <div class="card">
        <div class="row space" style="gap:10px; flex-wrap:wrap">
          <div>
            <div style="font-weight:900">${esc(lvl?.name||s.levelId)}</div>
            <div class="muted">Started: ${esc(started)} • Ended: ${esc(ended)}</div>
          </div>
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <span class="chip soft">Entries: <b>${cnt}</b></span>
            <button class="btn" onclick="openInventorySession('${esc(s.id)}')">Open</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  return `
    <div class="grid">
      <div class="card">
        ${topBar("Report", `<button class="btn" onclick="go('map')">Back to Map</button>`)}
        ${sessions || `<div class="muted">No inventory sessions yet.</div>`}
      </div>
    </div>
  `;
}

/* ---------- After render: global keyboard shortcuts ---------- */
function afterRender(){
  // Clear highlight once user navigates manually (optional)
}
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape"){
    if(document.getElementById("modalWrap")?.style?.display==="flex") closeModal();
  }
  // Shift+/ opens Find
  if(e.shiftKey && e.key==="/"){
    e.preventDefault();
    go("find");
  }
});

/* ---------- Boot ---------- */
(function boot(){
  // if no aisles, seed a couple to make it feel alive (optional)
  if(!STATE.aisles.length){
    // keep empty by default; user can add
  }
  render();
})();
</script>
</body>
</html>
